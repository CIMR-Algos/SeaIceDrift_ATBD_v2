%% Generated by Sphinx.
\def\sphinxdocclass{jupyterBook}
\documentclass[letterpaper,10pt,english]{jupyterBook}
\ifdefined\pdfpxdimen
   \let\sphinxpxdimen\pdfpxdimen\else\newdimen\sphinxpxdimen
\fi \sphinxpxdimen=.75bp\relax
\ifdefined\pdfimageresolution
    \pdfimageresolution= \numexpr \dimexpr1in\relax/\sphinxpxdimen\relax
\fi
%% let collapsible pdf bookmarks panel have high depth per default
\PassOptionsToPackage{bookmarksdepth=5}{hyperref}
%% turn off hyperref patch of \index as sphinx.xdy xindy module takes care of
%% suitable \hyperpage mark-up, working around hyperref-xindy incompatibility
\PassOptionsToPackage{hyperindex=false}{hyperref}
%% memoir class requires extra handling
\makeatletter\@ifclassloaded{memoir}
{\ifdefined\memhyperindexfalse\memhyperindexfalse\fi}{}\makeatother

\PassOptionsToPackage{booktabs}{sphinx}
\PassOptionsToPackage{colorrows}{sphinx}

\PassOptionsToPackage{warn}{textcomp}

\catcode`^^^^00a0\active\protected\def^^^^00a0{\leavevmode\nobreak\ }
\usepackage{cmap}
\usepackage{fontspec}
\defaultfontfeatures[\rmfamily,\sffamily,\ttfamily]{}
\usepackage{amsmath,amssymb,amstext}
\usepackage{polyglossia}
\setmainlanguage{english}



\setmainfont{FreeSerif}[
  Extension      = .otf,
  UprightFont    = *,
  ItalicFont     = *Italic,
  BoldFont       = *Bold,
  BoldItalicFont = *BoldItalic
]
\setsansfont{FreeSans}[
  Extension      = .otf,
  UprightFont    = *,
  ItalicFont     = *Oblique,
  BoldFont       = *Bold,
  BoldItalicFont = *BoldOblique,
]
\setmonofont{FreeMono}[
  Extension      = .otf,
  UprightFont    = *,
  ItalicFont     = *Oblique,
  BoldFont       = *Bold,
  BoldItalicFont = *BoldOblique,
]



\usepackage[Bjarne]{fncychap}
\usepackage[,numfigreset=1,mathnumfig]{sphinx}

\fvset{fontsize=\small}
\usepackage{geometry}


% Include hyperref last.
\usepackage{hyperref}
% Fix anchor placement for figures with captions.
\usepackage{hypcap}% it must be loaded after hyperref.
% Set up styles of URL: it should be placed after hyperref.
\urlstyle{same}


\usepackage{sphinxmessages}


\usepackage{etoolbox}
\AtBeginEnvironment{figure}{\pretocmd{\hyperlink}{\protect}{}{}}

        % Start of preamble defined in sphinx-jupyterbook-latex %
         \usepackage[Latin,Greek]{ucharclasses}
        \usepackage{unicode-math}
        % fixing title of the toc
        \addto\captionsenglish{\renewcommand{\contentsname}{Contents}}
        \hypersetup{
            pdfencoding=auto,
            psdextra
        }
        % End of preamble defined in sphinx-jupyterbook-latex %
        

\title{CIMR L2 Sea Ice Drift ATBD v2}
\date{Jul 01, 2024}
\release{}
\author{Thomas Lavergne and Emily Down, \\Norwegian Meteorological Institute}
\newcommand{\sphinxlogo}{\vbox{}}
\renewcommand{\releasename}{}
\makeindex
\begin{document}

\pagestyle{empty}
\sphinxmaketitle
\pagestyle{plain}
\sphinxtableofcontents
\pagestyle{normal}
\phantomsection\label{\detokenize{intro::doc}}


\sphinxAtStartPar
This document describes the algorithm theoretical basis for the Sea Ice Drift (SID) Level\sphinxhyphen{}2 product.
\begin{itemize}
\item {} 
\sphinxAtStartPar
{\hyperref[\detokenize{abstract::doc}]{\sphinxcrossref{Abstract}}}

\item {} 
\sphinxAtStartPar
{\hyperref[\detokenize{applicable_ref_docs::doc}]{\sphinxcrossref{Applicable and Reference Documents}}}

\item {} 
\sphinxAtStartPar
{\hyperref[\detokenize{acronyms::doc}]{\sphinxcrossref{Acronyms}}}

\item {} 
\sphinxAtStartPar
{\hyperref[\detokenize{definitions::doc}]{\sphinxcrossref{Definitions}}}

\item {} 
\sphinxAtStartPar
{\hyperref[\detokenize{introduction_purpose_scope::doc}]{\sphinxcrossref{Introduction, purpose and scope}}}

\item {} 
\sphinxAtStartPar
{\hyperref[\detokenize{background_justification_algorithm::doc}]{\sphinxcrossref{Background and justification of selected algorithm}}}

\item {} 
\sphinxAtStartPar
{\hyperref[\detokenize{L2_product_definition::doc}]{\sphinxcrossref{Level\sphinxhyphen{}2 product definition}}}

\item {} 
\sphinxAtStartPar
{\hyperref[\detokenize{baseline_algorithm_definition::doc}]{\sphinxcrossref{Baseline Algorithm Definition}}}

\item {} 
\sphinxAtStartPar
{\hyperref[\detokenize{algorithm_input_output_data_definition::doc}]{\sphinxcrossref{Algorithm Input and Output Data Definition (IODD)}}}

\item {} 
\sphinxAtStartPar
{\hyperref[\detokenize{CIMR_L2_Sea_Ice_Drift_preproc::doc}]{\sphinxcrossref{Prototype Algorithm Preprocessing (ATBD v2)}}}

\item {} 
\sphinxAtStartPar
{\hyperref[\detokenize{CIMR_L2_Sea_Ice_Drift_algorithm::doc}]{\sphinxcrossref{Prototype Algorithm Implementation (ATBD v2)}}}

\item {} 
\sphinxAtStartPar
{\hyperref[\detokenize{CIMR_L2_Sea_Ice_Drift_performanceAssessment::doc}]{\sphinxcrossref{Prototype Performance Assessment (ATBD v2)}}}

\item {} 
\sphinxAtStartPar
{\hyperref[\detokenize{roadmap_for_future_atbd_developments::doc}]{\sphinxcrossref{Roadmap for future ATBD developments (ATBD v2)}}}

\item {} 
\sphinxAtStartPar
{\hyperref[\detokenize{references::doc}]{\sphinxcrossref{References}}}

\end{itemize}

\sphinxstepscope


\chapter{Abstract}
\label{\detokenize{abstract:abstract}}\label{\detokenize{abstract::doc}}
\sphinxAtStartPar
Pushed by winds and ocean currents, sea ice is always on the move. Satellite remote sensing is an effective tool to monitor this motion, especially from microwave imagery.

\sphinxAtStartPar
Monitoring of sea ice drift vectors by means of passive microwave is commonly based on motion tracking algorithms working from pairs of brightness temperature imagery in both horizontal and vertical polarization.
Depending on the satellite missions, different microwave frequencies have been used, but one generally expects higher accuracy from the higher resolution channels.
Accordingly, this version of the Sea Ice Drift Level\sphinxhyphen{}2 product focuses on the K and Ka imagery.

\sphinxAtStartPar
Contrarily to other existing operational sea\sphinxhyphen{}ice drift product (such as those of IFREMER Cersat or EUMETSAT OSI SAF), the CIMR sea\sphinxhyphen{}ice drift product is a Level\sphinxhyphen{}2 product. It is thus computed from pairs of
overlapping swaths, not from pairs of daily averaged maps. This “swath\sphinxhyphen{}to\sphinxhyphen{}swath” setup was introduced in Lavergne \sphinxstyleemphasis{et al.} {[}\hyperlink{cite.references:id20}{2021}{]}.

\sphinxAtStartPar
Key assets of CIMR in terms of Sea Ice Drift monitoring are 1) its increased spatial resolution at K\sphinxhyphen{} and Ka\sphinxhyphen{}band (more accurate drift vectors), 2) larger swath (more drift vectors) and 3) the forward
and backward scans (better quality control). The main source of uncertainty for the CIMR Sea Ice Drift product will probably be the geolocation uncertainty, hence the importance of the pointing
accuracy (in orbit) and geolocation correction steps (in Level\sphinxhyphen{}1).

\sphinxAtStartPar
Sea\sphinxhyphen{}ice drift vectors are assessed against trajectories from in situ buoy deployed on the ice. A sufficient number of these buoys must be ensured throughout the lifetime of the mission, both in the northern and
southern hemisphere. Sea\sphinxhyphen{}ice drift vectors from Synthetic Aperture Radar (SAR) as derived in the Copernicus Marine Service Sea Ice Thematic Assembly Center from Sentinel\sphinxhyphen{}1 (in the future S1\sphinxhyphen{}NG and ROSE\sphinxhyphen{}L) can also
be used for validation.

\sphinxstepscope


\chapter{Applicable and reference documents}
\label{\detokenize{applicable_ref_docs:applicable-and-reference-documents}}\label{\detokenize{applicable_ref_docs::doc}}
\sphinxAtStartPar
List of applicable documents (AD) and reference documents (RD).


\begin{savenotes}\sphinxattablestart
\sphinxthistablewithglobalstyle
\centering
\begin{tabulary}{\linewidth}[t]{TT}
\sphinxtoprule
\sphinxstyletheadfamily 
\sphinxAtStartPar
ID
&\sphinxstyletheadfamily 
\sphinxAtStartPar
Document
\\
\sphinxmidrule
\sphinxtableatstartofbodyhook
\sphinxAtStartPar
AD\sphinxhyphen{}1  
&
\sphinxAtStartPar
C. J. Donlon, 2019. The Copernicus Imaging Microwave Radiometer (CIMR) Mission Requirements Document v4.0, available \sphinxhref{https://esamultimedia.esa.int/docs/EarthObservation/CIMR-MRD-v4.0-20201006\_Issued.pdf}{here}
\\
\sphinxbottomrule
\end{tabulary}
\sphinxtableafterendhook\par
\sphinxattableend\end{savenotes}

\sphinxstepscope


\chapter{Acronyms}
\label{\detokenize{acronyms:acronyms}}\label{\detokenize{acronyms::doc}}
\sphinxAtStartPar
Here follows a formatted list of acronyms
\begin{description}
\sphinxlineitem{ATBD\index{ATBD@\spxentry{ATBD}|spxpagem}\phantomsection\label{\detokenize{acronyms:term-ATBD}}}
\sphinxAtStartPar
Algorithm Theoretical Basis Document

\sphinxlineitem{EASE2\index{EASE2@\spxentry{EASE2}|spxpagem}\phantomsection\label{\detokenize{acronyms:term-EASE2}}}
\sphinxAtStartPar
{\hyperref[\detokenize{definitions:term-Equal-Area-Scalable-Earth-v2}]{\sphinxtermref{\DUrole{xref,std,std-term}{Equal Area Scalable Earth v2}}}}

\sphinxlineitem{IODD\index{IODD@\spxentry{IODD}|spxpagem}\phantomsection\label{\detokenize{acronyms:term-IODD}}}
\sphinxAtStartPar
Input/Output Data Definition

\sphinxlineitem{PSD\index{PSD@\spxentry{PSD}|spxpagem}\phantomsection\label{\detokenize{acronyms:term-PSD}}}
\sphinxAtStartPar
Product Specification Document

\sphinxlineitem{PVP\index{PVP@\spxentry{PVP}|spxpagem}\phantomsection\label{\detokenize{acronyms:term-PVP}}}
\sphinxAtStartPar
Product Validation Plan

\sphinxlineitem{MRC\index{MRC@\spxentry{MRC}|spxpagem}\phantomsection\label{\detokenize{acronyms:term-MRC}}}
\sphinxAtStartPar
Mission Requirement Consolidation

\sphinxlineitem{SIC\index{SIC@\spxentry{SIC}|spxpagem}\phantomsection\label{\detokenize{acronyms:term-SIC}}}
\sphinxAtStartPar
{\hyperref[\detokenize{definitions:term-Sea-Ice-Concentration}]{\sphinxtermref{\DUrole{xref,std,std-term}{Sea Ice Concentration}}}}

\sphinxlineitem{CIMR\index{CIMR@\spxentry{CIMR}|spxpagem}\phantomsection\label{\detokenize{acronyms:term-CIMR}}}
\sphinxAtStartPar
{\hyperref[\detokenize{definitions:term-Copernicus-Imaging-Microwave-Radiometer}]{\sphinxtermref{\DUrole{xref,std,std-term}{Copernicus Imaging Microwave Radiometer}}}}

\sphinxlineitem{TB\index{TB@\spxentry{TB}|spxpagem}\phantomsection\label{\detokenize{acronyms:term-TB}}}
\sphinxAtStartPar
{\hyperref[\detokenize{definitions:term-Brightness-Temperature}]{\sphinxtermref{\DUrole{xref,std,std-term}{Brightness Temperature}}}}

\end{description}

\sphinxstepscope


\chapter{Definitions used in this ATBD}
\label{\detokenize{definitions:definitions-used-in-this-atbd}}\label{\detokenize{definitions::doc}}
\sphinxAtStartPar
Here follows a glossary, or list of definitions
\begin{description}
\sphinxlineitem{Sea Ice Concentration\index{Sea Ice Concentration@\spxentry{Sea Ice Concentration}|spxpagem}\phantomsection\label{\detokenize{definitions:term-Sea-Ice-Concentration}}}\sphinxlineitem{The Sea Ice Concentration is the fraction of the sea surface covered by sea ice. It is a measure of the amount of sea ice in a given area. It is usually expressed as a percentage.\index{The Sea Ice Concentration is the fraction of the sea surface covered by sea ice. It is a measure of the amount of sea ice in a given area. It is usually expressed as a percentage.@\spxentry{The Sea Ice Concentration is the fraction of the sea surface covered by sea ice. It is a measure of the amount of sea ice in a given area. It is usually expressed as a percentage.}|spxpagem}\phantomsection\label{\detokenize{definitions:term-The-Sea-Ice-Concentration-is-the-fraction-of-the-sea-surface-covered-by-sea-ice.-It-is-a-measure-of-the-amount-of-sea-ice-in-a-given-area.-It-is-usually-expressed-as-a-percentage.}}}\sphinxlineitem{Sea Ice Motion\index{Sea Ice Motion@\spxentry{Sea Ice Motion}|spxpagem}\phantomsection\label{\detokenize{definitions:term-Sea-Ice-Motion}}}\sphinxlineitem{Sea Ice Drift\index{Sea Ice Drift@\spxentry{Sea Ice Drift}|spxpagem}\phantomsection\label{\detokenize{definitions:term-Sea-Ice-Drift}}}\sphinxlineitem{Sea Ice Motion and Sea Ice Drift are used interchangeably to characterize the horizontal motion of sea ice above the ocean. It is at minimum described by a vector.\index{Sea Ice Motion and Sea Ice Drift are used interchangeably to characterize the horizontal motion of sea ice above the ocean. It is at minimum described by a vector.@\spxentry{Sea Ice Motion and Sea Ice Drift are used interchangeably to characterize the horizontal motion of sea ice above the ocean. It is at minimum described by a vector.}|spxpagem}\phantomsection\label{\detokenize{definitions:term-Sea-Ice-Motion-and-Sea-Ice-Drift-are-used-interchangeably-to-characterize-the-horizontal-motion-of-sea-ice-above-the-ocean.-It-is-at-minimum-described-by-a-vector.}}}
\sphinxlineitem{Copernicus Imaging Microwave Radiometer\index{Copernicus Imaging Microwave Radiometer@\spxentry{Copernicus Imaging Microwave Radiometer}|spxpagem}\phantomsection\label{\detokenize{definitions:term-Copernicus-Imaging-Microwave-Radiometer}}}\sphinxlineitem{The Copernicus Imaging Microwave Radiometer is a Microwave Radiometer which launch is planned by ESA in 2028.\index{The Copernicus Imaging Microwave Radiometer is a Microwave Radiometer which launch is planned by ESA in 2028.@\spxentry{The Copernicus Imaging Microwave Radiometer is a Microwave Radiometer which launch is planned by ESA in 2028.}|spxpagem}\phantomsection\label{\detokenize{definitions:term-The-Copernicus-Imaging-Microwave-Radiometer-is-a-Microwave-Radiometer-which-launch-is-planned-by-ESA-in-2028.}}}\sphinxlineitem{Brightness Temperature\index{Brightness Temperature@\spxentry{Brightness Temperature}|spxpagem}\phantomsection\label{\detokenize{definitions:term-Brightness-Temperature}}}\sphinxlineitem{The Brightness Temperature is the temperature of a surface as seen by a passive microwave sensor. It is a measure of the amount of energy emitted by a surface. It is usually expressed in Kelvin.\index{The Brightness Temperature is the temperature of a surface as seen by a passive microwave sensor. It is a measure of the amount of energy emitted by a surface. It is usually expressed in Kelvin.@\spxentry{The Brightness Temperature is the temperature of a surface as seen by a passive microwave sensor. It is a measure of the amount of energy emitted by a surface. It is usually expressed in Kelvin.}|spxpagem}\phantomsection\label{\detokenize{definitions:term-The-Brightness-Temperature-is-the-temperature-of-a-surface-as-seen-by-a-passive-microwave-sensor.-It-is-a-measure-of-the-amount-of-energy-emitted-by-a-surface.-It-is-usually-expressed-in-Kelvin.}}}\sphinxlineitem{Equal Area Scalable Earth v2\index{Equal Area Scalable Earth v2@\spxentry{Equal Area Scalable Earth v2}|spxpagem}\phantomsection\label{\detokenize{definitions:term-Equal-Area-Scalable-Earth-v2}}}\sphinxlineitem{Equal area projection grid definition based on a Lambert Azimuthal projection and a WGS84 datum. Defined in {[}\hyperlink{cite.references:id3}{Brodzik \sphinxstyleemphasis{et al.}, 2012}{]}.\index{Equal area projection grid definition based on a Lambert Azimuthal projection and a WGS84 datum. Defined in brodzik:2012:ease2.@\spxentry{Equal area projection grid definition based on a Lambert Azimuthal projection and a WGS84 datum. Defined in brodzik:2012:ease2.}|spxpagem}\phantomsection\label{\detokenize{definitions:term-Equal-area-projection-grid-definition-based-on-a-Lambert-Azimuthal-projection-and-a-WGS84-datum.-Defined-in-brodzik-2012-ease2.}}}
\end{description}

\sphinxstepscope


\chapter{Introduction, purpose and scope}
\label{\detokenize{introduction_purpose_scope:introduction-purpose-and-scope}}\label{\detokenize{introduction_purpose_scope::doc}}
\sphinxAtStartPar
The balance between air drag, ocean drag and lateral forces controls the motion of sea ice {[}\hyperlink{cite.references:id21}{Leppäranta, 2011}{]}.
At the local scale, sea\sphinxhyphen{}ice motion can both be a facilitator and impediment to ship navigation, opening and closing routes, opening leads, or forming pressure ridges.
At the larger regional to basin scales, sea\sphinxhyphen{}ice motion (a.k.a. sea\sphinxhyphen{}ice drift) exports sea ice to lower latitudes where it melts, contributing to the redistribution of fresh water {[}\hyperlink{cite.references:id8}{Haine, 2015}{]}.
Inside the Arctic Ocean, re\sphinxhyphen{}circulation of sea\sphinxhyphen{}ice (e.g. in the Beaufort Sea) leads to the ageing and thickening of the ice pack towards the northern coasts of the Canadian Arctic Archipelago and Greenland {[}\hyperlink{cite.references:id31}{Timmermans and Marshall, 2020}{]}.
Sea\sphinxhyphen{}ice drift also plays a role in sea\sphinxhyphen{}ice formation and ocean circulation via the formation of coastal latent heat polynyas {[}\hyperlink{cite.references:id28}{Ohshima \sphinxstyleemphasis{et al.}, 2016}{]}, as well as in the transport of sediments and other tracers across ocean basins
{[}\hyperlink{cite.references:id12}{Krumpen \sphinxstyleemphasis{et al.}, 2019}{]}. With climate change, the area and thickness of sea ice is reduced in the Arctic, which leads to a more mobile sea\sphinxhyphen{}ice cover and positive trends in sea\sphinxhyphen{}ice velocity {[}\hyperlink{cite.references:id16}{Kwok \sphinxstyleemphasis{et al.}, 2013}, \hyperlink{cite.references:id30}{Spreen \sphinxstyleemphasis{et al.}, 2011}{]}.
Trends in sea\sphinxhyphen{}ice motion, linked to trends in wind speed, are also observed in the Southern Hemisphere (SH) {[}\hyperlink{cite.references:id10}{Holland and Kwok, 2012}, \hyperlink{cite.references:id17}{Kwok \sphinxstyleemphasis{et al.}, 2017}{]}.

\sphinxAtStartPar
Satellite remote sensing has developed as an attractive option to monitor sea\sphinxhyphen{}ice drift consistently across the polar sea\sphinxhyphen{}ice cover at a daily to sub\sphinxhyphen{}daily frequency.
The initial work by Ninnis \sphinxstyleemphasis{et al.} {[}\hyperlink{cite.references:id25}{1986}{]} was followed by many investigators using a variety of satellite imaging sensor technologies as input, including visible and infrared radiometry {[}\hyperlink{cite.references:id6}{Emery \sphinxstyleemphasis{et al.}, 1991}{]},
microwave radiometry and scatterometry {[}\hyperlink{cite.references:id2}{Agnew \sphinxstyleemphasis{et al.}, 1997}, \hyperlink{cite.references:id7}{Girard\sphinxhyphen{}Ardhuin and Ezraty, 2012}, \hyperlink{cite.references:id14}{Kwok \sphinxstyleemphasis{et al.}, 1998}, \hyperlink{cite.references:id19}{Lavergne \sphinxstyleemphasis{et al.}, 2010}, \hyperlink{cite.references:id22}{Liu \sphinxstyleemphasis{et al.}, 1999}{]},
and synthetic aperture radar (SAR) {[}\hyperlink{cite.references:id11}{Komarov and Barber, 2014}, \hyperlink{cite.references:id13}{Kwok \sphinxstyleemphasis{et al.}, 1990}, \hyperlink{cite.references:id23}{Muckenhuber \sphinxstyleemphasis{et al.}, 2016}{]}. The various imaging technologies however lead to sea\sphinxhyphen{}ice motion fields with different characteristics, e.g.
medium spatial resolution (∼ 20 km) and coverage limited by cloud cover for the visible and infrared radiometry, high spatial resolution (∼ 5–10 km) but coverage limited by acquisition repeat cycles for the SAR imagery,
and coarse spatial resolution (> 30 km) and daily complete coverage for the microwave radiometers and scatterometers. Despite the imaging technologies being very different from each other, the motion tracking algorithms
employed are quite similar and stem from the maximum cross\sphinxhyphen{}correlation (MCC) technique {[}\hyperlink{cite.references:id4}{Emery \sphinxstyleemphasis{et al.}, 1986}{]}.

\begin{sphinxadmonition}{note}{Note:}
\sphinxAtStartPar
The characteristics of the CIMR mission, and especially the spatial resolution obtained at K (5 km)
and Ka (4 km) should allow global, year\sphinxhyphen{}round (irrespective of solar illumination and cloud cover), sub\sphinxhyphen{}daily moniroting at medium spatial resolution (25 km), which is unprecedented.
\end{sphinxadmonition}

\sphinxAtStartPar
The Level\sphinxhyphen{}2 sea\sphinxhyphen{}ice drift product described in this ATBD has been specifically designed to fully exploit the CIMR mission, in particular:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
the CIMR sea\sphinxhyphen{}ice drift product is a Level\sphinxhyphen{}2 product, adopting a swath\sphinxhyphen{}to\sphinxhyphen{}swath approach {[}\hyperlink{cite.references:id20}{Lavergne \sphinxstyleemphasis{et al.}, 2021}{]}. This is conversely to all existing sea\sphinxhyphen{}ice drift products from passive microwave missions (OSI SAF, IFREMER, NSIDC, etc…) that are Level\sphinxhyphen{}3 products (available once a day from daily averaged maps of brightness temperatures). SAR\sphinxhyphen{}based products (e.g. from the CMEMS Sea Ice Thematic Assembly Center) are generally swath\sphinxhyphen{}to\sphinxhyphen{}swath products (but with spatial coverage limited by the coverage of the SAR missions).

\item {} 
\sphinxAtStartPar
the CIMR sea\sphinxhyphen{}ice drift product aims at a 25 km grid spacing, taking full advantage of the K and Ka imagery.

\item {} 
\sphinxAtStartPar
sea\sphinxhyphen{}ice drift is derived both from the forward and backward scans separately to improve quality control (filtering of “rogue” vectors)

\end{enumerate}

\sphinxstepscope


\chapter{Background and justification of selected algorithm}
\label{\detokenize{background_justification_algorithm:background-and-justification-of-selected-algorithm}}\label{\detokenize{background_justification_algorithm::doc}}

\section{The Continuous Maximum Cross\sphinxhyphen{}Correlation method (CMCC)}
\label{\detokenize{background_justification_algorithm:the-continuous-maximum-cross-correlation-method-cmcc}}
\sphinxAtStartPar
As for many other motion tracking methods applied in geophysics
{[}\hyperlink{cite.references:id27}{Maslanik \sphinxstyleemphasis{et al.}, 1998}, \hyperlink{cite.references:id26}{Notarstefano \sphinxstyleemphasis{et al.}, 2007}{]}, sea ice
drift is tracked from a pair of images, with a block\sphinxhyphen{}based strategy.
Each block (\sphinxstyleemphasis{feature}, \sphinxstyleemphasis{sub\sphinxhyphen{}image}, …) is composed of a limited
ensemble of pixels from the first image (the \sphinxstyleemphasis{reference} block) and
centred at a tracking location, for which the most similar block in the
second image (the \sphinxstyleemphasis{candidate} block) is looked for. The degree of
similarity is assessed by a metric, which often is the correlation
coefficient between the reference and candidate blocks. The maximum
correlation indicates the best match and the two\sphinxhyphen{}dimensional offset
between the centre points of the two blocks is the drift vector.

\sphinxAtStartPar
The description given above applies to the well known Maximum Cross
Correlation (MCC) technique which has been successfully applied by many
investigators {[}\hyperlink{cite.references:id6}{Emery \sphinxstyleemphasis{et al.}, 1991}, \hyperlink{cite.references:id9}{Haarpaintner, 2006}, \hyperlink{cite.references:id14}{Kwok \sphinxstyleemphasis{et al.}, 1998}, \hyperlink{cite.references:id25}{Ninnis \sphinxstyleemphasis{et al.}, 1986}, \hyperlink{cite.references:id26}{Notarstefano \sphinxstyleemphasis{et al.}, 2007}, \hyperlink{cite.references:id29}{Schmetz \sphinxstyleemphasis{et al.}, 1993}{]},
among others). In the MCC, wthe search for the best candidate block is
\sphinxstyleemphasis{discrete} and \sphinxstyleemphasis{exhaustive}. Discrete since the offsets between the
centre points are in whole number of pixels and exhaustive because all
candidate blocks are evaluated before the best can be chosen.

\sphinxAtStartPar
The same description applies to the Continuous Maximum Cross Correlation technique (CMCC)
method introduced by Lavergne \sphinxstyleemphasis{et al.} {[}\hyperlink{cite.references:id19}{2010}{]}. CMCC is the strategy developed and
implemented first for the low resolution sea ice drift product of the EUMETSAT OSI SAF.
Conversely to the MCC, the search for the best candidate vector is
performed in a continuous manner over the two\sphinxhyphen{}dimensional plane and, as
a consequence, the search algorithm is not exhaustive.

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{CMCC_vs_MCC}.png}
\caption{Example se\sphinxhyphen{}ice displacements from AMSR\sphinxhyphen{}E (37 GHz H and V channels) over the Beaufort Sea and Canadian Basin from 29 to 31 January 2008. The product was processed with the (left) Continuous Maximum Cross Correlation (CMCC) and (right) Maximum Cross Correlation (MCC) method from the same satellite images. On the MCC product, zero\sphinxhyphen{}length vectors are depicted with a small square symbol while tiny arrows are used for the CMCC product. The MCC product clearly exhibits a quantization noise. Such an artifact is not present in the CMCC drift data set (reproduced from {[}\hyperlink{cite.references:id19}{Lavergne \sphinxstyleemphasis{et al.}, 2010}{]}).}\label{\detokenize{background_justification_algorithm:fig-cmcc-vs-mcc}}\end{figure}

\sphinxAtStartPar
Although more complex to implement and, by nature, potentially less
robust than the MCC technique, the CMCC has the advantage of removing
the \sphinxstyleemphasis{quantization noise} which has hindered the retrieval of smooth
motion vector fields when the time span between the images is shortened
{[}\hyperlink{cite.references:id5}{Ezraty \sphinxstyleemphasis{et al.}, 2007}, \hyperlink{cite.references:id9}{Haarpaintner, 2006}, \hyperlink{cite.references:id14}{Kwok \sphinxstyleemphasis{et al.}, 1998}{]}.
\sphinxstylestrong{This is particularly important when the CIMR Level\sphinxhyphen{}2 product aims at sub\sphinxhyphen{}daily drift detection.}


\section{Choice of K and Ka as main microwave frequencies}
\label{\detokenize{background_justification_algorithm:choice-of-k-and-ka-as-main-microwave-frequencies}}
\sphinxAtStartPar
As introduced above, sea\sphinxhyphen{}ice motion tracking from pairs of satellite images does not require specific microwave frequencies to work. As long as
the frequency allows a mostly unperturbed view of the sea\sphinxhyphen{}ice surface (window channels), the accuracy of the sea\sphinxhyphen{}ice drift retrieval does not
depend on the frequency per se, but rather on the spatial resolution achieved. Imagery with higher spatial resolution should result in higher
accuracy of the motion vectors.

\sphinxAtStartPar
This is the reason why the primary microwave frequencies for the Level\sphinxhyphen{}2 sea\sphinxhyphen{}ice drift product are the K (18.7 GHz) and Ka (36.5 GHz) channels
that will achieve spatial resolution of 5 km and better. Experience from the EUMETSAT OSI SAF near\sphinxhyphen{}real\sphinxhyphen{}time and climate processing confirms that
the Ka\sphinxhyphen{}band imagery of AMSR2 provides the best results. In CIMR, the spatial resolution of the K\sphinxhyphen{}band imagery will be only slightly worse than at
Ka\sphinxhyphen{}band, so that it should be included in the main processing. Kwok {[}\hyperlink{cite.references:id15}{2008}{]} showed that the K\sphinxhyphen{}band imagery of AMSR2 provided
valuable sea\sphinxhyphen{}ice motion information during the summer melt season, but Lavergne \sphinxstyleemphasis{et al.} {[}\hyperlink{cite.references:id20}{2021}{]} did not find better performance of summer
sea\sphinxhyphen{}ice motion retrievals from K compared with Ka.

\sphinxAtStartPar
The lower frequency channels of CIMR (L, C, X) could possibly contribute to sea\sphinxhyphen{}ice motion tracking, but two challenges are their coarser spatial
resolution and the lack of intensity patterns to track from one image to the next (K and Ka imagery are sensitive to snow and sea\sphinxhyphen{}ice type, which has
large variability across the polar sea\sphinxhyphen{}ice and is stable over the tracking window of 0,5 to 2 days). This ATBD thus focus on K and Ka imagery but leaves
the door open for later inclusion of at least C and X.


\section{Exploitation of the forward and backward scan}
\label{\detokenize{background_justification_algorithm:exploitation-of-the-forward-and-backward-scan}}
\sphinxAtStartPar
In the past (e.g. Girard\sphinxhyphen{}Ardhuin and Ezraty {[}\hyperlink{cite.references:id7}{2012}{]}, Haarpaintner {[}\hyperlink{cite.references:id9}{2006}{]}, Kwok \sphinxstyleemphasis{et al.} {[}\hyperlink{cite.references:id14}{1998}{]}, among others), one sea\sphinxhyphen{}ice motion vector field would have been processed
for each microwave channel as input, i.e. one vector field from the K\sphinxhyphen{}H band, one from K\sphinxhyphen{}V, etc… the different vector fields would then be merged together a\sphinxhyphen{}posteriori.

\sphinxAtStartPar
Lavergne \sphinxstyleemphasis{et al.} {[}\hyperlink{cite.references:id19}{2010}{]} introduced a different approach where a single sea\sphinxhyphen{}ice drift motion field is processed in one go from all the available imagery channels. This \sphinxstyleemphasis{implicit} merging
it implemented at the core of the motion tracking algorithm, by solving for the maximum value of the sum of the cross\sphinxhyphen{}correlation of several imagery channels, instead of just one imagery channel.

\sphinxAtStartPar
For CIMR, this can be further extended by considering the imagery from \sphinxstyleemphasis{forward} and \sphinxstyleemphasis{backward} scans as independent imaging channels. There are thus two images with K\sphinxhyphen{}H, two with K\sphinxhyphen{}V, etc… in
total eight imaging channels for each swath. When doing sea\sphinxhyphen{}ice motion tracking with CIMR, one can thus do an implicit merging with 16 pairs of images (fwd\sphinxhyphen{}fwd, fwd\sphinxhyphen{}bck, bck\sphinxhyphen{}fwd, and fwd\sphinxhyphen{}bck) for each of
K\sphinxhyphen{}V, K\sphinxhyphen{}H, Ka\sphinxhyphen{}V, and Ka\sphinxhyphen{}H. It is expected that using the forward and backward scans as part of the implicit merging will be benefitial to reduce the retrieval uncertainty and limit the number of
rogue vectors. This will have to be validated in the product development phase since CIMR is the first passive microwave mission offering full scans for sea\sphinxhyphen{}ice motion tracking.


\section{Swath\sphinxhyphen{}to\sphinxhyphen{}swath Motion Tracking (Level\sphinxhyphen{}2 strategy)}
\label{\detokenize{background_justification_algorithm:swath-to-swath-motion-tracking-level-2-strategy}}
\sphinxAtStartPar
One of the key characteristics of the CIMR Level\sphinxhyphen{}2 sea\sphinxhyphen{}ice drift product is that it will be a “swath\sphinxhyphen{}to\sphinxhyphen{}swath” product, thus computed at the intersection of individual swaths. \hyperref[\detokenize{background_justification_algorithm:fig-s2s}]{Fig.\@ \ref{\detokenize{background_justification_algorithm:fig-s2s}}} illustrates the concept.

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[width=0.750\linewidth]{{swath_to_swath}.png}
\caption{(a) Daily average map of AMSR2 36.5 GHz V\sphinxhyphen{}pol TB on 1 December 2019 (greys) for the Arctic and two individual gridded swaths on the same day (blues: 01:16:34 UTC; reds: 19:24:55 UTC). The sea\sphinxhyphen{}ice region of overlap between the two swaths is highlighted in greens and is where S2S drift vectors can be computed. (b) Similar but for the Antarctic on 15 August 2019 (blues: 01:43:45 UTC; reds: 16:31:28 UTC). Reproduced from {[}\hyperlink{cite.references:id20}{Lavergne \sphinxstyleemphasis{et al.}, 2021}{]}.}\label{\detokenize{background_justification_algorithm:fig-s2s}}\end{figure}

\sphinxAtStartPar
The advantages of choosing a swath\sphinxhyphen{}to\sphinxhyphen{}swath approach (instead of a daily L3 product) are presented in Lavergne \sphinxstyleemphasis{et al.} {[}\hyperlink{cite.references:id20}{2021}{]}. We reproduce their conclusions below:
\begin{quote}

\sphinxAtStartPar
We investigate the feasibility and impact of adopting a swath\sphinxhyphen{}to\sphinxhyphen{}swath (S2S) vs. daily map (DM) framework for the processing of sea\sphinxhyphen{}ice motion from modern passive microwave satellite missions such as JAXA’s AMSR2 in preparation for the future CIMR mission. We find that S2S sea\sphinxhyphen{}ice drift vectors obtained from AMSR2 imagery are more accurate than the corresponding DM vectors when compared to GPS trajectories from on\sphinxhyphen{}ice buoys in both the Arctic and Antarctic. An S2S configuration also results in many more drift vectors on a daily basis: the number varies with latitude and depends on the orbital and swath characteristics of the satellite mission. Since S2S drift vectors can be prepared for each new incoming swath, this configuration yields much better timeliness, which is beneficial for several operational applications such as support to navigation and short\sphinxhyphen{}term sea\sphinxhyphen{}ice forecasting. One potential limitation to the S2S configuration is that it is more sensitive to inaccurate geolocation, especially if the geolocation errors are systematic (e.g. a shift in the flight direction).

\sphinxAtStartPar
As far the CIMR mission is concerned, we recommend the adoption of an S2S configuration for the Level\sphinxhyphen{}2 sea\sphinxhyphen{}ice drift product in the operational ground segment. Considering the microwave frequency channels, target spatial resolution, swath width and geolocation accuracy specified for the CIMR imagery, its Level\sphinxhyphen{}2 sea\sphinxhyphen{}ice drift product will allow for unprecedented spatial resolution, coverage and accuracy for a microwave radiometer mission. Several other new characteristics of the CIMR mission (e.g. the relatively high spatial resolution at 6.9 and 10.8 GHz, the backward and forward scans) will also contribute to an enhanced sea\sphinxhyphen{}ice drift product, but this requires further research.
\end{quote}

\sphinxstepscope


\chapter{Level\sphinxhyphen{}2 product definition}
\label{\detokenize{L2_product_definition:level-2-product-definition}}\label{\detokenize{L2_product_definition::doc}}
\sphinxAtStartPar
\hyperref[\detokenize{L2_product_definition:l2-variables}]{Table \ref{\detokenize{L2_product_definition:l2-variables}}}, \hyperref[\detokenize{L2_product_definition:l2-attributes}]{Table \ref{\detokenize{L2_product_definition:l2-attributes}}}, \hyperref[\detokenize{L2_product_definition:l2-global-attributes}]{Table \ref{\detokenize{L2_product_definition:l2-global-attributes}}} define the content (TBC) of the Level\sphinxhyphen{}2 sea\sphinxhyphen{}ice drift product files. Their structure
is inspired by that of the EUMETSAT OSI SAF products.


\begin{savenotes}\sphinxattablestart
\sphinxthistablewithglobalstyle
\centering
\sphinxcapstartof{table}
\sphinxthecaptionisattop
\sphinxcaption{NetCDF Group: Processed data (TBC)}\label{\detokenize{L2_product_definition:l2-variables}}
\sphinxaftertopcaption
\begin{tabulary}{\linewidth}[t]{TTTT}
\sphinxtoprule
\sphinxstyletheadfamily 
\sphinxAtStartPar
name
&\sphinxstyletheadfamily 
\sphinxAtStartPar
description
&\sphinxstyletheadfamily 
\sphinxAtStartPar
units
&\sphinxstyletheadfamily 
\sphinxAtStartPar
dimensions
\\
\sphinxmidrule
\sphinxtableatstartofbodyhook
\sphinxAtStartPar
crs
&
\sphinxAtStartPar
Definition of the EASE2 product grid
&
\sphinxAtStartPar
n/a
&
\sphinxAtStartPar
n/a
\\
\sphinxhline
\sphinxAtStartPar
dX
&
\sphinxAtStartPar
Component of the drift along the X\sphinxhyphen{}axis of the EASE2 grid
&
\sphinxAtStartPar
m
&
\sphinxAtStartPar
(nx,ny)
\\
\sphinxhline
\sphinxAtStartPar
dY
&
\sphinxAtStartPar
Component of the drift along the Y\sphinxhyphen{}axis of the EASE2 grid
&
\sphinxAtStartPar
m
&
\sphinxAtStartPar
(nx,ny)
\\
\sphinxhline
\sphinxAtStartPar
lat\_1
&
\sphinxAtStartPar
Latitude of the end point of the drift vector
&
\sphinxAtStartPar
degrees North
&
\sphinxAtStartPar
(nx,ny)
\\
\sphinxhline
\sphinxAtStartPar
lon\_1
&
\sphinxAtStartPar
Longitude of the end point of the drift vector
&
\sphinxAtStartPar
degrees East
&
\sphinxAtStartPar
(nx,ny)
\\
\sphinxhline
\sphinxAtStartPar
sX
&
\sphinxAtStartPar
Uncertainty (one standard deviation) of the dX component
&
\sphinxAtStartPar
m
&
\sphinxAtStartPar
(nx,ny)
\\
\sphinxhline
\sphinxAtStartPar
sY
&
\sphinxAtStartPar
Uncertainty (one standard deviation) of the dY component
&
\sphinxAtStartPar
m
&
\sphinxAtStartPar
(nx,ny)
\\
\sphinxhline
\sphinxAtStartPar
cXY
&
\sphinxAtStartPar
Correlation between the uncertainty in dX and in dY
&
\sphinxAtStartPar
m
&
\sphinxAtStartPar
(nx,ny)
\\
\sphinxhline
\sphinxAtStartPar
status\_flag
&
\sphinxAtStartPar
A flag indicating status of retrieval, e.g. “nominal”, “over land”, “close to ice edge”, “over ocean”, “corrected from rogue vector”,…
&
\sphinxAtStartPar
n/a
&
\sphinxAtStartPar
(nx,ny)
\\
\sphinxbottomrule
\end{tabulary}
\sphinxtableafterendhook\par
\sphinxattableend\end{savenotes}

\begin{sphinxadmonition}{note}{Note:}
\sphinxAtStartPar
The {\hyperref[\detokenize{acronyms:term-CIMR}]{\sphinxtermref{\DUrole{xref,std,std-term}{CIMR}}}} Level\sphinxhyphen{}2 {\hyperref[\detokenize{definitions:term-Sea-Ice-Drift}]{\sphinxtermref{\DUrole{xref,std,std-term}{Sea Ice Drift}}}} product is an Earth\sphinxhyphen{}gridded product. The dimensions of each variable in the Level\sphinxhyphen{}2 file
refer to the (nx,ny) dimensions of the product grid in an {\hyperref[\detokenize{acronyms:term-EASE2}]{\sphinxtermref{\DUrole{xref,std,std-term}{EASE2}}}} polar projection (see \hyperref[\detokenize{baseline_algorithm_definition:grids}]{Table \ref{\detokenize{baseline_algorithm_definition:grids}}}).
\end{sphinxadmonition}

\sphinxAtStartPar
Each data variable in the \sphinxcode{\sphinxupquote{Processed data}} group holds conventional attributes following CF\sphinxhyphen{}1.7 or above:


\begin{savenotes}\sphinxattablestart
\sphinxthistablewithglobalstyle
\centering
\sphinxcapstartof{table}
\sphinxthecaptionisattop
\sphinxcaption{Standard variable attributes (TBC)}\label{\detokenize{L2_product_definition:l2-attributes}}
\sphinxaftertopcaption
\begin{tabulary}{\linewidth}[t]{TT}
\sphinxtoprule
\sphinxstyletheadfamily 
\sphinxAtStartPar
name
&\sphinxstyletheadfamily 
\sphinxAtStartPar
description
\\
\sphinxmidrule
\sphinxtableatstartofbodyhook
\sphinxAtStartPar
standard\_name
&
\sphinxAtStartPar
A standard name that references a description of a variable”s content
\\
\sphinxhline
\sphinxAtStartPar
long\_name
&
\sphinxAtStartPar
A descriptive name that indicates a variable”s content
\\
\sphinxhline
\sphinxAtStartPar
\_FillValue
&
\sphinxAtStartPar
value that will appear in the dataset when the data is either missing or undefined
\\
\sphinxhline
\sphinxAtStartPar
units
&
\sphinxAtStartPar
unit of measure
\\
\sphinxbottomrule
\end{tabulary}
\sphinxtableafterendhook\par
\sphinxattableend\end{savenotes}


\begin{savenotes}\sphinxattablestart
\sphinxthistablewithglobalstyle
\centering
\sphinxcapstartof{table}
\sphinxthecaptionisattop
\sphinxcaption{Some global attributes in the Level\sphinxhyphen{}2 product files (TBC)}\label{\detokenize{L2_product_definition:l2-global-attributes}}
\sphinxaftertopcaption
\begin{tabulary}{\linewidth}[t]{TT}
\sphinxtoprule
\sphinxstyletheadfamily 
\sphinxAtStartPar
name
&\sphinxstyletheadfamily 
\sphinxAtStartPar
description
\\
\sphinxmidrule
\sphinxtableatstartofbodyhook
\sphinxAtStartPar
title
&
\sphinxAtStartPar
CIMR L2 Sea Ice Drift product
\\
\sphinxhline
\sphinxAtStartPar
processing\_level
&
\sphinxAtStartPar
Level\sphinxhyphen{}2
\\
\sphinxhline
\sphinxAtStartPar
time\_coverage\_start
&
\sphinxAtStartPar
valid \sphinxstyleemphasis{start} time of the product
\\
\sphinxhline
\sphinxAtStartPar
time\_coverage\_end
&
\sphinxAtStartPar
valid \sphinxstyleemphasis{end} time of the product
\\
\sphinxhline
\sphinxAtStartPar
area
&
\sphinxAtStartPar
(Northern or Southern) Hemisphere
\\
\sphinxhline
\sphinxAtStartPar
TBD
&
\sphinxAtStartPar
TBD
\\
\sphinxbottomrule
\end{tabulary}
\sphinxtableafterendhook\par
\sphinxattableend\end{savenotes}

\sphinxstepscope


\chapter{Baseline Algorithm Definition}
\label{\detokenize{baseline_algorithm_definition:baseline-algorithm-definition}}\label{\detokenize{baseline_algorithm_definition::doc}}
\sphinxAtStartPar
In the following sections, the Level\sphinxhyphen{}2 sea\sphinxhyphen{}ice drift algorithm is further
described. It consists in those steps:
\begin{itemize}
\item {} 
\sphinxAtStartPar
resampling of Level\sphinxhyphen{}1b data;

\item {} 
\sphinxAtStartPar
selection of tracking locations and preliminary screening;

\item {} 
\sphinxAtStartPar
block\sphinxhyphen{}based maximization of the correlation metric via the CMCC;

\item {} 
\sphinxAtStartPar
filtering and correction step;

\item {} 
\sphinxAtStartPar
assign status flags and per\sphinxhyphen{}vector uncertainties.

\end{itemize}

\sphinxAtStartPar
Sea\sphinxhyphen{}ice motion tracking is performed at the intersection of two swaths. The motion tracking itself requires that the brightness temperature imagery
is first resampled to a common grid. This makes the level\sphinxhyphen{}2 sea\sphinxhyphen{}ice drift product quite different from other level\sphinxhyphen{}2 products in that:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
the Level\sphinxhyphen{}1b data must be remapped to a common (polar) grid as part of the processing, e.g. an EASE2 grid;

\item {} 
\sphinxAtStartPar
as a consequence, the Level\sphinxhyphen{}2 sea\sphinxhyphen{}ice drift product is presented on an EASE2 grid (not in a swath projection);

\item {} 
\sphinxAtStartPar
the algorithm operates not with one, but with at least \sphinxstylestrong{two} Level\sphinxhyphen{}1b files as input;

\item {} 
\sphinxAtStartPar
for each incoming Level\sphinxhyphen{}1b file, one can generate more than one Level\sphinxhyphen{}2 sea\sphinxhyphen{}ice drift product (consider the swath intersection with the most recent Level\sphinxhyphen{}1b swath, the one before, etc…)

\end{enumerate}


\section{CIMR Level\sphinxhyphen{}1b re\sphinxhyphen{}sampling approach}
\label{\detokenize{baseline_algorithm_definition:cimr-level-1b-re-sampling-approach}}
\sphinxAtStartPar
The re\sphinxhyphen{}sampling approach for resampling CIMR Level\sphinxhyphen{}1b K and Ka band imagery is not defined at this stage. From experience with sea\sphinxhyphen{}ice motion tracking from other passive
microwave mission, the Level\sphinxhyphen{}1b re\sphinxhyphen{}sampling approach does not have a large influence on the results. At this stage, the following characteristics are expected from the
re\sphinxhyphen{}sampling:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
Remap incoming Level\sphinxhyphen{}1b files on two EASE2 polar grids (one covering Northern Hemisphere, the other covering the Southern Hemisphere);

\item {} 
\sphinxAtStartPar
Remap 4 imagery channels (K\sphinxhyphen{}V, K\sphinxhyphen{}H, Ka\sphinxhyphen{}V, Ka\sphinxhyphen{}H);

\item {} 
\sphinxAtStartPar
Remap the forward and backward scans separately;

\item {} 
\sphinxAtStartPar
Aim at a grid spacing close to 5 km (TBC).

\end{enumerate}

\sphinxAtStartPar
\hyperref[\detokenize{baseline_algorithm_definition:grids}]{Table \ref{\detokenize{baseline_algorithm_definition:grids}}} defines four grids, two for the Northern Hemisphere, two for the Southern Hemisphere. nx (ny) is the number of grid cells in x (y) dimension, Ax (Ay) is the grid spacing, and Cx (Cy) is the coordinate
of the upper\sphinxhyphen{}left corner of the upper\sphinxhyphen{}left cell in the grid. Grids \sphinxcode{\sphinxupquote{(n,s)h\_ease2\sphinxhyphen{}005}} have 5 km grid spacing and are candidate target grids on which to remap the Level\sphinxhyphen{}1b imagery. Grids \sphinxcode{\sphinxupquote{(n,s)h\_ease2\sphinxhyphen{}250}} have 25 km grid spacing
and are candidate grids for the resulting Level\sphinxhyphen{}2 sea\sphinxhyphen{}ice drift product. By construction, the center of the cells of the two ‘250’ grids fall exactly at the center of one every five grid cells of the ‘005’ grids. This
ensures that drift vectors (at every grid cell of the ‘250’ grids) use image blocks (from the ‘005’ grids) that are perfectly aligned.


\begin{savenotes}\sphinxattablestart
\sphinxthistablewithglobalstyle
\centering
\sphinxcapstartof{table}
\sphinxthecaptionisattop
\sphinxcaption{Definition of EASE2 grids used in the Level\sphinxhyphen{}2 sea\sphinxhyphen{}ice drift processing (TBC)}\label{\detokenize{baseline_algorithm_definition:grids}}
\sphinxaftertopcaption
\begin{tabulary}{\linewidth}[t]{TTTTTTT}
\sphinxtoprule
\sphinxstyletheadfamily 
\sphinxAtStartPar
Id
&\sphinxstyletheadfamily 
\sphinxAtStartPar
nx
&\sphinxstyletheadfamily 
\sphinxAtStartPar
ny
&\sphinxstyletheadfamily 
\sphinxAtStartPar
Ax {[}km{]}
&\sphinxstyletheadfamily 
\sphinxAtStartPar
Ay {[}km{]}
&\sphinxstyletheadfamily 
\sphinxAtStartPar
Cx {[}km{]}
&\sphinxstyletheadfamily 
\sphinxAtStartPar
Cy {[}km{]}
\\
\sphinxmidrule
\sphinxtableatstartofbodyhook
\sphinxAtStartPar
\sphinxcode{\sphinxupquote{nh\_ease2\sphinxhyphen{}250}}, \sphinxcode{\sphinxupquote{sh\_ease2\sphinxhyphen{}250}}
&
\sphinxAtStartPar
432
&
\sphinxAtStartPar
432
&
\sphinxAtStartPar
25.0
&
\sphinxAtStartPar
25.0
&
\sphinxAtStartPar
\sphinxhyphen{}5400.0
&
\sphinxAtStartPar
\sphinxhyphen{}5400.0
\\
\sphinxhline
\sphinxAtStartPar
\sphinxcode{\sphinxupquote{nh\_ease2\sphinxhyphen{}005}}, \sphinxcode{\sphinxupquote{sh\_ease2\sphinxhyphen{}005}}
&
\sphinxAtStartPar
2160
&
\sphinxAtStartPar
2160
&
\sphinxAtStartPar
5.0
&
\sphinxAtStartPar
5.0
&
\sphinxAtStartPar
\sphinxhyphen{}5400.0
&
\sphinxAtStartPar
\sphinxhyphen{}5400.0
\\
\sphinxbottomrule
\end{tabulary}
\sphinxtableafterendhook\par
\sphinxattableend\end{savenotes}

\sphinxAtStartPar
Such a ‘1\sphinxhyphen{}every\sphinxhyphen{}5’ construct is not a requirement of the sea\sphinxhyphen{}ice drift algorithm, but a simplification used in many motion extraction algorithms. Other alternatives are to grid the Level\sphinxhyphen{}1b data with
4 km spacing and consider a ‘1\sphinxhyphen{}every\sphinxhyphen{}6’ ratio (Level\sphinxhyphen{}2 grid spacing at 24 km) or keep a ‘1\sphinxhyphen{}every\sphinxhyphen{}5’ ratio (Level\sphinxhyphen{}2 grid spacing at 20 km).

\sphinxAtStartPar
The remaining of the algorithm description does not depend on this choice, which can easily be changed in the course of the product development.

\sphinxAtStartPar
Each incoming Level\sphinxhyphen{}1b file thus results in 16 gridded fields of brightness temperature: 2 hemispheres x 2 scans x 4 bands. These can be written in two L1C\sphinxhyphen{}like netCDF files (1 per hemisphere) or
directly entered the motion tracking algorithm. They must be written to netCDF files at one point so that they are available for sea\sphinxhyphen{}ice drift processing when the next Level\sphinxhyphen{}1b swath file arrives.


\section{Algorithm Assumptions and Simplifications}
\label{\detokenize{baseline_algorithm_definition:algorithm-assumptions-and-simplifications}}
\sphinxAtStartPar
All block\sphinxhyphen{}based motion have similar assumptions and simplifications. They assume that each pixel in a block moves at a constant rate from one image to the next: what is retrieved are the \sphinxcode{\sphinxupquote{dx}} and \sphinxcode{\sphinxupquote{dy}}
components of the motion vector. In case of rotational motion within the area of the image block, the retrieved components will be those representing most faithfully the change in intensity between
the two images, but the rotation rate is not measured. By the same token, if deformation (convergence / divergence / shear) occurs within the area of the image blocks, this will not be detected.
Rotation and deformation between image blocks (between neighboring pixels) can of course be detected.

\sphinxAtStartPar
To detect and possibly correct “rogue” vectors in the motion field, we have to assume that the motion field is spatially coherent in a neighborhood. This is because we detect anomalous motion vectors
by their distance to the local average motion. One must be careful with this assumption as to not artificially smooth the motion fields and remove actual diverging / converging motion.


\section{Level\sphinxhyphen{}2 end to end algorithm functional flow diagram}
\label{\detokenize{baseline_algorithm_definition:level-2-end-to-end-algorithm-functional-flow-diagram}}
\sphinxAtStartPar
\hyperref[\detokenize{baseline_algorithm_definition:fig-flow-diagram}]{Fig.\@ \ref{\detokenize{baseline_algorithm_definition:fig-flow-diagram}}} shows the flow diagram for the CIMR Level\sphinxhyphen{}2 sea\sphinxhyphen{}ice drift algorithm. Note the structure in two chains: preprocessing of the image, and sea\sphinxhyphen{}ice motion tracking per se.

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[width=1.000\linewidth]{{CIMR_L2_Sea_Ice_Drift_Flow_Diagram}.png}
\caption{End\sphinxhyphen{}to\sphinxhyphen{}end algorithm flow diagram of the CIMR Level\sphinxhyphen{}2 sea\sphinxhyphen{}ice drift algorithm}\label{\detokenize{baseline_algorithm_definition:fig-flow-diagram}}\end{figure}


\section{Functional description of each Algorithm step}
\label{\detokenize{baseline_algorithm_definition:functional-description-of-each-algorithm-step}}

\subsection{Pre\sphinxhyphen{}processing}
\label{\detokenize{baseline_algorithm_definition:pre-processing}}

\subsubsection{Prepare ice/ocean/land mask}
\label{\detokenize{baseline_algorithm_definition:prepare-ice-ocean-land-mask}}
\sphinxAtStartPar
The Level\sphinxhyphen{}2 sea\sphinxhyphen{}ice drift algorithm shall only be applied over sea\sphinxhyphen{}ice portions of the image. We thus need to prepare an ice/ocean mask as well
as a land\sphinxhyphen{}mask to only process over sea ice.


\paragraph{Input data}
\label{\detokenize{baseline_algorithm_definition:input-data}}
\sphinxAtStartPar
The latitude and longitude of the image grids \sphinxcode{\sphinxupquote{nh\_ease2\sphinxhyphen{}005}} and \sphinxcode{\sphinxupquote{sh\_ease2\sphinxhyphen{}005}}.


\paragraph{Output data}
\label{\detokenize{baseline_algorithm_definition:output-data}}
\sphinxAtStartPar
A 2D field of ice/no\sphinxhyphen{}ice/land on the image grids.


\paragraph{Auxiliary data}
\label{\detokenize{baseline_algorithm_definition:auxiliary-data}}
\sphinxAtStartPar
A source of sea\sphinxhyphen{}ice concentration (can be from CIMR Level\sphinxhyphen{}2 Sea Ice Concentration product, or Level\sphinxhyphen{}2 Integrated\sphinxhyphen{}Retrieval product).


\subsubsection{Remap Level\sphinxhyphen{}1b brightness temperatures to the EASE2 image grids}
\label{\detokenize{baseline_algorithm_definition:remap-level-1b-brightness-temperatures-to-the-ease2-image-grids}}
\sphinxAtStartPar
The Level\sphinxhyphen{}1b data (brightness temperature at K\sphinxhyphen{}V, K\sphinxhyphen{}H, Ka\sphinxhyphen{}V, Ka\sphinxhyphen{}H) are remapped onto the EASE2 image grids \sphinxcode{\sphinxupquote{nh\_ease2\sphinxhyphen{}005}} and \sphinxcode{\sphinxupquote{sh\_ease2\sphinxhyphen{}005}}. The forward and backward scans
are remapped independently.

\sphinxAtStartPar
A \sphinxstyleemphasis{valid time} is associated to the remapped imagery. It can be defined as the mean time of all the Level\sphinxhyphen{}1b samples remapped onto the image grid or the time of the observation closest to the (North or South Pole).
The exact definition is not critical, neither is the accuracy, so that a single valid time is associated to all 8 remapped imagery bands in the Northern Hemisphere, and a single (different) time to the 8
remapped imagery bands in the Southern Hemisphere.


\paragraph{Mathematical description}
\label{\detokenize{baseline_algorithm_definition:mathematical-description}}
\sphinxAtStartPar
Remapping is the process of computing the Level\sphinxhyphen{}1b brightness temperature onto a regular Earth\sphinxhyphen{}based grid. The values in the image grid can generally be described as a weighted sum of
the values in the Level\sphinxhyphen{}1b swath projection. The mathematical description is TBD and will depend on the selected remapping strategy.


\paragraph{Input data}
\label{\detokenize{baseline_algorithm_definition:id1}}
\sphinxAtStartPar
The latitude and longitude of the image grids \sphinxcode{\sphinxupquote{nh\_ease2\sphinxhyphen{}005}} and \sphinxcode{\sphinxupquote{sh\_ease2\sphinxhyphen{}005}}.

\sphinxAtStartPar
The Level\sphinxhyphen{}1b brightness temperatures of all samples in the input Level\sphinxhyphen{}1b file, split in a forward and a backward scan.


\paragraph{Output data}
\label{\detokenize{baseline_algorithm_definition:id2}}
\sphinxAtStartPar
16 2D field of brightness temperature on the image grids (2 grids x 2 scans x 4 channels).


\paragraph{Ancillary data}
\label{\detokenize{baseline_algorithm_definition:ancillary-data}}
\sphinxAtStartPar
The latitude and longitude of all the Level\sphinxhyphen{}1b samples.


\subsubsection{Image preprocessing (Laplacian filter)}
\label{\detokenize{baseline_algorithm_definition:image-preprocessing-laplacian-filter}}
\sphinxAtStartPar
The remapped brightness temperatures are not used directly as input to the sea\sphinxhyphen{}ice motion tracking step. Instead, a filter is first applied to the remapped imagery to
enhance and stabilize intensity patterns.

\sphinxAtStartPar
At the end of the step, the Laplacian processed imagery are saved to disk, e.g. in netCDF files (two separated files for the two hemispheres).


\paragraph{Mathematical description}
\label{\detokenize{baseline_algorithm_definition:id3}}
\sphinxAtStartPar
A common filter, used by Girard\sphinxhyphen{}Ardhuin and Ezraty {[}\hyperlink{cite.references:id7}{2012}{]} and Lavergne \sphinxstyleemphasis{et al.} {[}\hyperlink{cite.references:id19}{2010}{]}, is the Laplace filter, that is based on computing the second derivatives of the image intensity.
\begin{equation}\label{equation:baseline_algorithm_definition:eq_laplace}
\begin{split}
\begin{split}
\mathcal{L}[i,j] &= \frac{1}{N^{+}} \sum_{n=i-1}^{i+1} \sum_{m=j-1}^{j+1}
                       \delta_{\textrm{na}}(n,m) \delta_{\textrm{ice}}(n,m) \delta_1^{i,j}(n,m) \mathcal{I}[n,m] \\
                 &- \frac{1}{N^{-}} \sum_{n=i-2}^{i+2} \sum_{m=j-2}^{j+2}
               \delta_{\textrm{na}}(n,m) \delta_{\textrm{ice}}(n,m) \delta_2^{i,j}(n,m) \mathcal{I}[n,m] 
\end{split}
\end{split}
\end{equation}
\sphinxAtStartPar
with
\begin{equation}\label{equation:baseline_algorithm_definition:eq_laplace2}
\begin{split}
\begin{aligned}
\delta_k^{i,j}(n,m) & = & \left\{ \begin{array}{ll} 1 & \mbox{if $|i-n| = k$ or $|j-m| = k$};\\ \nonumber
             0 & \mbox{otherwise}.\end{array} \right.   \\ \nonumber
N^{+} &=& \sum_{n=i-1}^{i+1} \sum_{m=j-1}^{j+1} \delta_{\textrm{na}}(n,m) \delta_{\textrm{ice}}(n,m) \delta_1^{i,j}(n,m)  \leq  8 \\ \nonumber
N^{-} &=& \sum_{n=i-2}^{i+2} \sum_{m=j-2}^{j+2} \delta_{\textrm{na}}(n,m) \delta_{\textrm{ice}}(n,m) \delta_2^{i,j}(n,m)  \leq  16 \nonumber
\end{aligned}
\end{split}
\end{equation}
\sphinxAtStartPar
In Eq. \eqref{equation:baseline_algorithm_definition:eq_laplace} and \eqref{equation:baseline_algorithm_definition:eq_laplace2}, \(\delta_{\textrm{na}}(n,m)\) has value \(0\) if \(\mathcal{I}[n,m]\) is
non\sphinxhyphen{}available (a missing value in the swath, or missing values outside the coverage of the swath) and
\(\delta_{\textrm{ice}}(n,m)\) is \(1\) only over ice pixels, as
specified by the ice/water/land mask. It means that only \sphinxstyleemphasis{valid}, \sphinxstyleemphasis{sea ice}
pixels enter the Laplacian field in order to limit spurious features
along the ice edge, coastline or at the border of the swath coverage.

\sphinxAtStartPar
\(\mathcal{L}[i,j]\) is only computed if the centre cell \([i,j]\) is itself
over sea ice, \(\delta_{\textrm{ice}}(i,j)=1\).

\sphinxAtStartPar
In the event when \(N^{+} < 5\) or \(N^{-} < 9\), not enough pixels are
available for computing \(\mathcal{L}\) and a missing value is stored at
grid cell \([i,j]\).


\paragraph{Input data}
\label{\detokenize{baseline_algorithm_definition:id6}}
\sphinxAtStartPar
The remapped brightness temperatures on the image grids (16 2D fields).


\paragraph{Output data}
\label{\detokenize{baseline_algorithm_definition:id7}}
\sphinxAtStartPar
16 2D field of laplacian\sphinxhyphen{}filtered brightness temperature on the image grids.


\paragraph{Ancillary data}
\label{\detokenize{baseline_algorithm_definition:id8}}
\sphinxAtStartPar
The ice/water/land mask on the image grids.


\subsection{Sea\sphinxhyphen{}ice motion tracking}
\label{\detokenize{baseline_algorithm_definition:sea-ice-motion-tracking}}
\sphinxAtStartPar
To compute sea\sphinxhyphen{}ice drift vectors require two images. A \sphinxstyleemphasis{start} and an \sphinxstyleemphasis{end} image. In the near\sphinxhyphen{}real\sphinxhyphen{}time Level\sphinxhyphen{}2 processing context, the end image is the (Laplacian filtered) remapped imagery
from the input Level\sphinxhyphen{}1b file. Start images are taken from a running pool of remapped imagery from the previous runs of the sea\sphinxhyphen{}ice drift algorithm. In principle, many start images can be selected
and run into the sea\sphinxhyphen{}ice motion tracking against the end image. The difference between the valid time of the start and end imagery determines the drift duration (\sphinxstyleemphasis{aka} time span) of the Level\sphinxhyphen{}2
drift vectors.

\sphinxAtStartPar
At minimum (and in priority), the Level\sphinxhyphen{}2 sea\sphinxhyphen{}ice drift algorithm should be applied once with a start image with valid time approximately 24 hours before the valid time of the end image. This results in 24 hours drift vectors.
Ideally, the sea\sphinxhyphen{}ice motion tracking algorithm described below is applied for several (start, end) image pair to obtain a good temporal sampling of the sea\sphinxhyphen{}ice motion (e.g. 24 hours, 18 hours, 12 hours, 6 hours, etc…). At max,
the sea\sphinxhyphen{}ice motion tracking algorithm would be applied with all (start, end) image pairs for which the valid time of the start image is less or equal to 24 hours from the valid time of the end image. Each (start, end) image pair
will correspond to different area of intersect between the two swaths, and thus to different numbers of resulting sea\sphinxhyphen{}ice drift vectors. Pairs with too limited overlaps could be discarded up\sphinxhyphen{}front to favor processing pairs
with a large overlap. Because swath\sphinxhyphen{}to\sphinxhyphen{}swath motion tracking is very sensitive to (systematic) geolocation errors {[}\hyperlink{cite.references:id20}{Lavergne \sphinxstyleemphasis{et al.}, 2021}{]} it might be preferable to not process some pairs (e.g. ascending vs descending) that
would have larger uncertainties.

\sphinxAtStartPar
A hard limit is that the processing of all the image pairs must happen before the next input Level\sphinxhyphen{}1b input file is available for processing. Parallel computing strategy will help reduce the
total processing time (since each image pair can be processed independently of each others). A scheduling strategy must be designed to afford the maximum number of image pairs before it causes a problem for product latency.

\sphinxAtStartPar
At this stage it is TBD if each (start, end) image pairs results in individual Level\sphinxhyphen{}2 product files (better for the latency) or if all the sea\sphinxhyphen{}ice drift vectors (with different time spans) are concatenated in a single
Level\sphinxhyphen{}2 product file.

\sphinxAtStartPar
In any case, the description below is for a single (start, end) image pair, and for each image grid (nh and sh) separately.


\subsubsection{Select grid locations where to apply the CMCC algorithm}
\label{\detokenize{baseline_algorithm_definition:select-grid-locations-where-to-apply-the-cmcc-algorithm}}
\sphinxAtStartPar
The CMCC can only be applied where the two swaths (start and end images) overlap over sea ice. A first step in the processing is thus to go through all the positions in the \sphinxcode{\sphinxupquote{(n,s)h\_ease2\sphinxhyphen{}250}} grid and test if
there is sufficient overlap between the two images, and if the overlap is over sea ice.


\paragraph{Logical description}
\label{\detokenize{baseline_algorithm_definition:logical-description}}
\sphinxAtStartPar
For each grid position in the Level\sphinxhyphen{}2 product grid, the following tests are performed.

\sphinxAtStartPar
Masking of land pixel (step 1)
\begin{itemize}
\item {} 
\sphinxAtStartPar
Blocks whose centre pixel is over land are discarded;

\end{itemize}

\sphinxAtStartPar
Masking of pixels with not enough sea ice (step 2)
\begin{itemize}
\item {} 
\sphinxAtStartPar
The start and end blocks of the two ice/water/land masks are loaded. Discard
the grid locations whose start and end blocks are not entirely over ice.

\end{itemize}

\sphinxAtStartPar
Masking of pixels with missing data (step 3)
\begin{itemize}
\item {} 
\sphinxAtStartPar
The start and end blocks of the Laplacian images are loaded.
Discard the grid locations whose blocks hold missing data.

\end{itemize}

\sphinxAtStartPar
The positions that are not discarded after those three steps are passed to the next processing step (CMCC).


\paragraph{Input data}
\label{\detokenize{baseline_algorithm_definition:id10}}
\sphinxAtStartPar
The two (start and end) ice/ocean/land masks on the image grid \sphinxcode{\sphinxupquote{(n,s)h\_ease2\sphinxhyphen{}005}}.

\sphinxAtStartPar
The two (start and end) Laplacian\sphinxhyphen{}filtered brightness temperature maps on the image grid \sphinxcode{\sphinxupquote{(n,s)h\_ease2\sphinxhyphen{}005}}.

\sphinxAtStartPar
The diameter of the sub\sphinxhyphen{}image (\sphinxstyleemphasis{aka} image block) to be used in the CMCC, in number of pixels.

\sphinxAtStartPar
The definition of the Level\sphinxhyphen{}2 product grid \sphinxcode{\sphinxupquote{(n,s)h\_ease2\sphinxhyphen{}025}}.


\paragraph{Output data}
\label{\detokenize{baseline_algorithm_definition:id11}}
\sphinxAtStartPar
A 2D field of status flags recording the status at the end of this selection step (in particular recording where and why CMCC will not be attempted).


\subsubsection{Run the CMCC algorithm}
\label{\detokenize{baseline_algorithm_definition:run-the-cmcc-algorithm}}
\sphinxAtStartPar
The CMCC is the core sea\sphinxhyphen{}ice motion algorithm


\paragraph{Mathematical description}
\label{\detokenize{baseline_algorithm_definition:id12}}
\sphinxAtStartPar
We note \(\mathcal{L}_0(x,y)[i]\) the \(i^{th}\) pixel of the \sphinxstyleemphasis{start}
sub\sphinxhyphen{}image centered at point \((x,y)\), extracted from the \(\mathcal{L}_0\)
image. \((x,y)\) are the coordinates expressed in the underpinning EASE2
projection (units km).

\sphinxAtStartPar
The total number of pixels \(N\) in a sub\sphinxhyphen{}image depends on the diameter of the sub\sphinxhyphen{}image (input parameter).

\sphinxAtStartPar
The mean and standard deviation values for a given sub\sphinxhyphen{}image are:
\begin{equation*}
\begin{split}
\begin{aligned}
\langle \mathcal{L}_0(x,y) \rangle & = & \frac{1}{N} \sum_{i=1}^{N} \mathcal{L}_0(x,y)[i] \nonumber \\
\sigma ( \mathcal{L}_0(x,y) ) & = & \sqrt{\langle \mathcal{L}^2_0(x,y) \rangle - \langle \mathcal{L}_0(x,y) \rangle^2}  \nonumber
\end{aligned}
\end{split}
\end{equation*}
\sphinxAtStartPar
Similar values can be computed for a \sphinxstyleemphasis{end} sub\sphinxhyphen{}image centred at
\((u,v)\): \(\langle \mathcal{L}_1(u,v) \rangle\) and
\(\sigma ( \mathcal{L}_1(u,v) )\).

\sphinxAtStartPar
The match between a start and a stop sub\sphinxhyphen{}image is evaluated via the correlation metric:
\begin{equation}\label{equation:baseline_algorithm_definition:eq_rho}
\begin{split}
\rho(x,y,\delta_x,\delta_y) =
\frac{
\sum_{i=1}^{N} (\mathcal{L}_0(x,y)[i]-\langle \mathcal{L}_0(x,y) \rangle) (\mathcal{L}_1(x+\delta_x,y+\delta_y)[i]-\langle \mathcal{L}_1(x+\delta_x,y+\delta_y) \rangle)
}{\sigma ( \mathcal{L}_0(x,y) ) \sigma ( \mathcal{L}_1(x+\delta_x,y+\delta_y) )}
\end{split}
\end{equation}
\sphinxAtStartPar
By construction, \(\rho(x,y,\delta_x,\delta_y)\) takes
values between \(-1\) and \(+1\). High values indicate a good match between
the sub\sphinxhyphen{}images. This is further interpreted as having found the offsets
\(\delta_x = u - x\) and \(\delta_y = v - y\) which best explain the local
change in intensity between the two sub\sphinxhyphen{}images. \((\delta_x,\delta_y)\) is
the drift vector.

\sphinxAtStartPar
Pixels of the candidate block \(\mathcal{L}_1(x+\delta_x,y+\delta_y)\) are
computed from bi\sphinxhyphen{}linear interpolations of the pixels of \(\mathcal{L}_1\).
For example, \(\mathcal{L}_1(u,v)[i]\) is given by:
\begin{equation}\label{equation:baseline_algorithm_definition:eq_imginterp}
\begin{split}
\begin{split}
\mathcal{L}_1(u,v)[i] & = (1 - \epsilon_{u}) \times (1 - \epsilon_{v}) \times \mathcal{L}_1(\bar{u},\bar{v})[i] \\
        &+  (1 - \epsilon_{u}) \times \epsilon_{v} \times  \mathcal{L}_1(\bar{u},\bar{v}+s_{v})[i] \\
        &+ \epsilon_{u} \times (1 - \epsilon_{v}) \times  \mathcal{L}_1(\bar{u}+s_{u},\bar{v})[i] \\
        &+ \epsilon_{u} \times \epsilon_{v} \times \mathcal{L}_1(\bar{u}+s_{u},\bar{v}+s_{v})[i]
\end{split}
\end{split}
\end{equation}
\sphinxAtStartPar
where
\begin{equation*}
\begin{split}
\begin{aligned}
\bar{t} & = & \operatorname{Trunc}(t) \\
\epsilon_t & = & |t - \bar{t}| \\
s_t        & = & \frac{t}{|t|}
\end{aligned}
\end{split}
\end{equation*}
\sphinxAtStartPar
For example, for \(t=-2.8\), \(\bar{t}=-2\), \(\epsilon_t=0.8\) and \(s_t=-1\). Eq. \eqref{equation:baseline_algorithm_definition:eq_imginterp} permits computing \sphinxstyleemphasis{virtual}
sub\sphinxhyphen{}images at continuously varying centre points \((u,v)\) and thus building a continuous optimization framework to the estimation of motion
vectors from a pair of images.

\sphinxAtStartPar
Finding the motion vector \((\delta_x,\delta_y)\) at position \((x,y)\) can
be expressed as the following maximization problem:
\begin{equation}\label{equation:baseline_algorithm_definition:eq_maximonech}
\begin{split}
\max_{(x,y)\in\mathcal{D}} \rho(x,y,\delta_x,\delta_y)
\end{split}
\end{equation}
\sphinxAtStartPar
which is solved at all grid positions where the motion vector is searched for (see previous step). Each optimization is conducted independently
from the others. \(\mathcal{D}\) is a validity domain for \((\delta_x,\delta_y)\). Eq. \eqref{equation:baseline_algorithm_definition:eq_maximonech} thus defines a two dimensional optimization
problem with domain constraint.

\sphinxAtStartPar
Eq. \eqref{equation:baseline_algorithm_definition:eq_maximonech} is valid for one pair of images. In the CIMR sea\sphinxhyphen{}ice drift algorithm, we however envision not one pair of (start, end) images but 16 pairs
(fwd\sphinxhyphen{}fwd, fwd\sphinxhyphen{}bck, bck\sphinxhyphen{}fwd, and fwd\sphinxhyphen{}bck) for each of K\sphinxhyphen{}V, K\sphinxhyphen{}H, Ka\sphinxhyphen{}V, and Ka\sphinxhyphen{}H considering the foward and backward scans as separate images. Following Lavergne \sphinxstyleemphasis{et al.} {[}\hyperlink{cite.references:id19}{2010}{]}
we implement an inplicit merging of the information content of the 16 imaging channels by maximizing a sum of cross\sphinxhyphen{}correlation functions:
\begin{equation}\label{equation:baseline_algorithm_definition:eq_maxim}
\begin{split}
\max_{(x,y)\in\mathcal{D}} \frac{1}{N_{ch}} \sum_{c=1}^{c=N_{ch}} \rho^{c}(x,y,\delta_x,\delta_y)
\end{split}
\end{equation}
\sphinxAtStartPar
where \(N_{ch}\) is the number of channels (\(N_{ch} = 16\)).

\sphinxAtStartPar
Eq. \eqref{equation:baseline_algorithm_definition:eq_maxim} is solved by the Nelder\sphinxhyphen{}Mead algorithm {[}\hyperlink{cite.references:id24}{Nelder and Mead, 1968}{]}. This algorithm is
chosen since it is simple to implement and does not require computing the gradients of the function to be minimized. It furthermore has good convergence
and computational properties in problems with low dimensionality {[}\hyperlink{cite.references:id18}{Lagarias \sphinxstyleemphasis{et al.}, 1998}{]}.

\sphinxAtStartPar
Starting points for the optimization are sampled on a length\sphinxhyphen{}angle regular grid around point \((0,0)\) as on \hyperref[\detokenize{baseline_algorithm_definition:fig-startpoints}]{Fig.\@ \ref{\detokenize{baseline_algorithm_definition:fig-startpoints}}}.

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[width=0.500\linewidth]{{CMCC_startpoints}.png}
\caption{Initialization points for the Nelder\sphinxhyphen{}Mead algorithm, chosen on a regular length\sphinxhyphen{}angle grid aroung point \((0,0)\).}\label{\detokenize{baseline_algorithm_definition:fig-startpoints}}\end{figure}

\sphinxAtStartPar
The length increment is set to \(10\)km and the angular increment to
\(45^{\circ}\). The circle has radius \(\mathbf{L}\), the maximum drift
distance defining \(\mathcal{D}\).

\sphinxAtStartPar
\(\rho(x,y,\delta_x,\delta_y)\) is computed at each of those points and the best 3 vertexes are kept for initialising the Nelder\sphinxhyphen{}Mead
optimization.

\sphinxAtStartPar
Termination and convergence is tested upon via a relative difference of function values at the current \sphinxstyleemphasis{best} and \sphinxstyleemphasis{worst} vertexes, \(f_b\) and
\(f_w\). Specifically, the algorithm is said to have converged if and only if \(| f_b - f_w | < (f_b + f_w) \times \tau + \epsilon\), with \(\tau\) and
\(\epsilon\) small and positive floating point values. As a safeguard, the maximum number of iterations is set to 1000.

\sphinxAtStartPar
In Eq. \eqref{equation:baseline_algorithm_definition:eq_maxim} \(\mathcal{D}\) is a disc shaped domain expressing the \sphinxstyleemphasis{a\sphinxhyphen{}priori}
knowledge we bring to the optimization problem. Its purpose is to limit
the search area for the solution vector during the optimization process. It is defined by a centre point \((x_c,y_c)\) and radius \(\mathbf{L}\).
\begin{equation}\label{equation:baseline_algorithm_definition:eq_domain}
\begin{split}
(\delta_x,\delta_y) \in \mathcal{D}_{x_c,y_c} \Leftrightarrow d(x_c,y_c;\delta_x,\delta_y) < \mathbf{L}
\end{split}
\end{equation}
\sphinxAtStartPar
In Eq. \eqref{equation:baseline_algorithm_definition:eq_domain}, \(d(x_c,y_c;\delta_x,\delta_y)\) is the distance
(great circle) between the centre point of \(\mathcal{D}\) and
the tip of the drift vector \((\delta_x,\delta_y)\). \((x_c,y_c)\)
represents our best \sphinxstyleemphasis{a\sphinxhyphen{}priori} knowledge at the time of performing the
optimization. It is initially set to \((0,0)\).

\sphinxAtStartPar
Eq. \eqref{equation:baseline_algorithm_definition:eq_domain} cannot be used \sphinxstyleemphasis{as is} in the optimization routine since it leads to
abrupt and non\sphinxhyphen{}linear behavior. \(\mathcal{D}\) is instead implemented as a \sphinxstyleemphasis{soft} constraint based on a
mono\sphinxhyphen{}dimensional sigmoid function \(W(d)\):
\begin{equation}\label{equation:baseline_algorithm_definition:eq_sigmoid}
\begin{split}
W(d)   = \frac{1}{1 + e^{k(d - \mathbf{L})}} 
\end{split}
\end{equation}
\sphinxAtStartPar
In Eq. \eqref{equation:baseline_algorithm_definition:eq_sigmoid}, \(k\) is a parameter controlling the steepness
of the sigmoid around the cut\sphinxhyphen{}off value \(\mathbf{L}\). By construction,
\(W(\mathbf{L}) = 0.5\). By using a large enough value for \(k\), the \(W\)
can be made arbitrarily close to the Heaviside step function, yet
remaining smooth and continuous.

\sphinxAtStartPar
Eq. \eqref{equation:baseline_algorithm_definition:eq_penalising} illustrate how the penalty is applied to the correlation function
\(\rho^c(x,y,\delta_x,\delta_y)\) (Eq. \eqref{equation:baseline_algorithm_definition:eq_maxim}).
\begin{equation}\label{equation:baseline_algorithm_definition:eq_penalising}
\begin{split}
\rho^c_D(x,y,\delta_x,\delta_y) = (\rho^c(x,y,\delta_x,\delta_y) + 1) \times W(d(x_c,y_c;\delta_x,\delta_y)) - 1
\end{split}
\end{equation}
\sphinxAtStartPar
\hyperref[\detokenize{baseline_algorithm_definition:fig-sigmoids}]{Fig.\@ \ref{\detokenize{baseline_algorithm_definition:fig-sigmoids}}} plots a mono\sphinxhyphen{}dimensional example of applying a sigmoid penalty function
to a synthetic correlation function. Evaluations for \(x\) lower than L
are dominated by the correlation value \(\rho(x)\) while those occurring
outside the domain (\(x\) larger than \(L\)) return very bad scores, that is
close to \(-1\).

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[width=0.500\linewidth]{{sigmoids}.png}
\caption{Example soft constraint implemented with a sigmoid penalization function \(W\) and its application on a synthetic,
mono\sphinxhyphen{}dimensional correlation signal \(\rho\). Here, the \(\mathbf{L}\) parameter is \(1.3\) and \(k\) is \(20\).\}}\label{\detokenize{baseline_algorithm_definition:fig-sigmoids}}\end{figure}

\sphinxAtStartPar
In Eq. \eqref{equation:baseline_algorithm_definition:eq_penalising}, \(\rho_D\) is the penalised correlation function. Finding the maximum
of \(\rho_D\) is taken as a proxy for solving the original, constrained,
optimization problem of Eq. \eqref{equation:baseline_algorithm_definition:eq_maxim}. \(\rho_D\) is the function entering the Nelder\sphinxhyphen{}Mead
algorithm instead of \(\rho\).

\sphinxAtStartPar
It is customary to compute \(\mathbf{L}\) as a maximum expected speed
\(v_{max}\), multiplied by the time separation between the valid times of the two images
\(\mathbf{T}_1\) \sphinxhyphen{} \(\mathbf{T}_0\). \(\mathbf{L}\) is thus the maximum
expected straight\sphinxhyphen{}line distance that can be covered in the given time.


\paragraph{Input data}
\label{\detokenize{baseline_algorithm_definition:id16}}
\sphinxAtStartPar
The diameter of the sub\sphinxhyphen{}image (\sphinxstyleemphasis{aka} image block) to be used in the CMCC, in number of pixels.

\sphinxAtStartPar
The maximum allowed drift speed \(v_{max}\) (to define \(\mathbf{L}\)) and \textbackslash{}mathcal\{D\}).

\sphinxAtStartPar
The 8 imagery bands for the start and end images, as well as the associated valid times \(\mathbf{T}\).


\paragraph{Output data}
\label{\detokenize{baseline_algorithm_definition:id17}}
\sphinxAtStartPar
A 2D field of drift vectors (\(\delta_x\) and \(\delta_y\) components) on the \sphinxcode{\sphinxupquote{(n,s)h\_ease2\sphinxhyphen{}250}} grid.

\sphinxAtStartPar
A 2D field of maximum cross\sphinxhyphen{}correlation value for each vector.

\sphinxAtStartPar
A 2D field of status flags recording the status at the end of the CMCC optimization.


\subsubsection{Quality Control: detect and correct outliers (“rogue” vectors)}
\label{\detokenize{baseline_algorithm_definition:quality-control-detect-and-correct-outliers-rogue-vectors}}
\sphinxAtStartPar
Once the CMCC described above has been applied once to each of the
start positions selected by the preliminary checks, a filtering step
is taken to detect, correct or remove obviously erroneous vectors (so called “rogue” vectors).

\sphinxAtStartPar
Causes for those erroneous vectors include:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
convergence of the Nelder Mead algorithm in a local maximum;

\item {} 
\sphinxAtStartPar
noise in the sub\sphinxhyphen{}images;

\item {} 
\sphinxAtStartPar
edge effects in the sub\sphinxhyphen{}images.

\end{enumerate}

\sphinxAtStartPar
Whatever the reason be, the filtering step is based on the
distance from individual displacement vectors to the average of its
neighboring vectors. If this distance is less than a fixed threshold,
the displacement vector being tested is validated and another vector is
tested upon. Otherwise, a new CMCC motion tracking optimization is triggered.

\sphinxAtStartPar
In this new CMCC optimization, the Nelder Mead algorithm is initialised and run like in the previous
section, except that the validity domain \(\mathbf{D}\) is adapted (center and radius) to translate the new constraint.

\sphinxAtStartPar
Erroneous vectors are detected and corrected one by one, from the “most erroneous” (see below) until
all vectors are either corrected or flagged as bad.


\paragraph{Mathematical description}
\label{\detokenize{baseline_algorithm_definition:id18}}
\sphinxAtStartPar
Let \(\Delta_{\textrm{avg}}\) be the distance between the tip of the
current drift vector \((\delta_x,\delta_y)\) and the tip of the zonal
average drift vector
\((\delta^{\textrm{avg}}_x,\delta^{\textrm{avg}}_y)\). The average drift
vector is computed from the 8 neighboring drift vectors, that is the 8
closest vectors \sphinxstyleemphasis{not including the current one}. The local \(\mathbf{D}\)
domain is then the disc with centre
\((\delta^{\textrm{avg}}_x,\delta^{\textrm{avg}}_y)\) and radius
\(\Delta^{\textrm{avg}}_{\textrm{max}}\). \(\Delta^{\textrm{avg}}_{\textrm{max}}\) is set to \(10\)km.
Neighboring vectors with a maximum correlation value of less than \(0.5\) are not
used, to avoid degrading the average drift field with possibly wrong
estimates.

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[width=0.500\linewidth]{{filter}.png}
\caption{Example case where the current drift vector (in red) is obviously erroneous, considered the smoother vector field from the first estimate from
CMCC (in black). The locally averaged vector field is plotted in green. \(\Delta^{\textrm{avg}}\) is the length of the dashed red line.
The red disc has radius \(\Delta^{\textrm{avg}}_{\textrm{max}}\) and is the validity domain \$\textbackslash{}mathbf\{D\} that is used to re\sphinxhyphen{}optimise the drift vector.}\label{\detokenize{baseline_algorithm_definition:fig-filter}}\end{figure}

\sphinxAtStartPar
\hyperref[\detokenize{baseline_algorithm_definition:fig-filter}]{Fig.\@ \ref{\detokenize{baseline_algorithm_definition:fig-filter}}} illustrates a typical case where a single erroneous vector is surrounded by a smooth vector field. Since the central estimate is not used in the
average, isolated wrong vectors stand out very easily in terms of their \(\Delta_{\textrm{avg}}\).

\sphinxAtStartPar
During this second CMCC optimization, the search for the maximum is limited to the area enclosed by the red circle. If a satisfying maximum
correlation is found inside \(\mathbf{D}\) it is kept and the surrounding average vectors are immediately updated, as well as each
\(\Delta_{\textrm{avg}}\) lengths. If the constrained optimization does not converge or if the new vector does not have a good enough maximum
correlation value, both the old and new vectors are discarded and the average vectors, as well as \(\Delta_{\textrm{avg}}\) at the neighboring
locations are updated.

\sphinxAtStartPar
Although the method described above works in many cases, it sometimes fail when several erroneous vectors are close one to each other. This
happens especially when noise dominates the signal in a large region of one of the image. If the case, the order in which the vectors are
corrected has an influence on the final efficiency for the filtering.

\sphinxAtStartPar
To minimize this influence, motion vectors are first sorted from the largest to the shortest \(\Delta_{\textrm{avg}}\) and the filtering is
applied to the vector exhibiting the worst of those distances. Since, changing a vector has an influence on its direct neighbors, the sorting
is repeated after each correction. A mechanism is put in place to avoid falling into an infinite loop. This strategy also ensures that the good
vectors around an erroneous estimate are not modified before the latter is actually processed through the filter.

\sphinxAtStartPar
In the case where the new optimization does not lead to an acceptable maximum cross\sphinxhyphen{}correlation value (value below the threshold, non\sphinxhyphen{}convergence of the CMCC with the new contraint),
the vector position is recorded as non\sphinxhyphen{}feasible in the status flags, and the fields of drift vectors get a fill value.

\sphinxAtStartPar
This detection / correction process continues until all vectors are either corrected or flagged as non\sphinxhyphen{}feasible.


\paragraph{Input data}
\label{\detokenize{baseline_algorithm_definition:id19}}
\sphinxAtStartPar
The 2D field of drift vectors (\(\delta_x\) and \(\delta_y\) components) on the \sphinxcode{\sphinxupquote{(n,s)h\_ease2\sphinxhyphen{}250}} grid from the initial CMCC run.

\sphinxAtStartPar
The 2D field of maximum cross\sphinxhyphen{}correlation value for each vector from the initial CMCC run.

\sphinxAtStartPar
The 2D field of status flags recording the status at the end of the initial CMCC optimization.


\paragraph{Output data}
\label{\detokenize{baseline_algorithm_definition:id20}}
\sphinxAtStartPar
Updates:

\sphinxAtStartPar
The 2D field of drift vectors (\(\delta_x\) and \(\delta_y\) components) on the \sphinxcode{\sphinxupquote{(n,s)h\_ease2\sphinxhyphen{}250}} grid from the initial CMCC run.

\sphinxAtStartPar
The 2D field of maximum cross\sphinxhyphen{}correlation value for each vector from the initial CMCC run.

\sphinxAtStartPar
The 2D field of status flags recording the status at the end of the initial CMCC optimization.

\sphinxstepscope


\chapter{Algorithm Input and Output Data Definition (IODD)}
\label{\detokenize{algorithm_input_output_data_definition:algorithm-input-and-output-data-definition-iodd}}\label{\detokenize{algorithm_input_output_data_definition::doc}}
\sphinxAtStartPar
Except for the input L1B TB data, the auxiliary and output data are all on {\hyperref[\detokenize{acronyms:term-EASE2}]{\sphinxtermref{\DUrole{xref,std,std-term}{EASE2}}}} grids. Refer to \hyperref[\detokenize{baseline_algorithm_definition:grids}]{Table \ref{\detokenize{baseline_algorithm_definition:grids}}}.


\section{Input data}
\label{\detokenize{algorithm_input_output_data_definition:input-data}}

\begin{savenotes}\sphinxattablestart
\sphinxthistablewithglobalstyle
\centering
\begin{tabulary}{\linewidth}[t]{TTT}
\sphinxtoprule
\sphinxstyletheadfamily 
\sphinxAtStartPar
Field
&\sphinxstyletheadfamily 
\sphinxAtStartPar
Description
&\sphinxstyletheadfamily 
\sphinxAtStartPar
Shape/Amount
\\
\sphinxmidrule
\sphinxtableatstartofbodyhook
\sphinxAtStartPar
L1B TB
&
\sphinxAtStartPar
L1B Brightness Temperature at K and KA\sphinxhyphen{}bands (both H and V polarization)
&
\sphinxAtStartPar
full swath or section of it (Nscans, Npos)
\\
\sphinxhline
\sphinxAtStartPar
L1B NeΔT
&
\sphinxAtStartPar
Random radiometric uncertainty of the channels
&
\sphinxAtStartPar
full swath or section of it (Nscans, Npos)
\\
\sphinxbottomrule
\end{tabulary}
\sphinxtableafterendhook\par
\sphinxattableend\end{savenotes}


\section{Output data}
\label{\detokenize{algorithm_input_output_data_definition:output-data}}

\begin{savenotes}\sphinxattablestart
\sphinxthistablewithglobalstyle
\centering
\begin{tabulary}{\linewidth}[t]{TTT}
\sphinxtoprule
\sphinxstyletheadfamily 
\sphinxAtStartPar
Field
&\sphinxstyletheadfamily 
\sphinxAtStartPar
Description
&\sphinxstyletheadfamily 
\sphinxAtStartPar
Shape/Amount
\\
\sphinxmidrule
\sphinxtableatstartofbodyhook
\sphinxAtStartPar
sea\sphinxhyphen{}ice drift vectors
&
\sphinxAtStartPar
dX and dY components of the motion vectors.
&
\sphinxAtStartPar
(nx,ny) on the \sphinxcode{\sphinxupquote{(n,s)h\_ease2\sphinxhyphen{}250}} grid.
\\
\sphinxhline
\sphinxAtStartPar
sea\sphinxhyphen{}ice drift vectors uncertainty
&
\sphinxAtStartPar
dX and dY components of the uncertainty vector (1\sphinxhyphen{}sigma).
&
\sphinxAtStartPar
(nx,ny) on the \sphinxcode{\sphinxupquote{(n,s)h\_ease2\sphinxhyphen{}250}} grid.
\\
\sphinxhline
\sphinxAtStartPar
status flags
&
\sphinxAtStartPar
indicate the reasons for missing, bad, or nominal vectors.
&
\sphinxAtStartPar
(nx,ny) on the \sphinxcode{\sphinxupquote{(n,s)h\_ease2\sphinxhyphen{}250}} grid.
\\
\sphinxbottomrule
\end{tabulary}
\sphinxtableafterendhook\par
\sphinxattableend\end{savenotes}


\section{Auxiliary data}
\label{\detokenize{algorithm_input_output_data_definition:auxiliary-data}}

\begin{savenotes}\sphinxattablestart
\sphinxthistablewithglobalstyle
\centering
\begin{tabulary}{\linewidth}[t]{TTT}
\sphinxtoprule
\sphinxstyletheadfamily 
\sphinxAtStartPar
Field
&\sphinxstyletheadfamily 
\sphinxAtStartPar
Description
&\sphinxstyletheadfamily 
\sphinxAtStartPar
Shape/Amount
\\
\sphinxmidrule
\sphinxtableatstartofbodyhook
\sphinxAtStartPar
sea\sphinxhyphen{}ice and land mask
&
\sphinxAtStartPar
A recent sea\sphinxhyphen{}ice concentration field including land information
&
\sphinxAtStartPar
SIC and land\sphinxhyphen{}mask on the \sphinxcode{\sphinxupquote{(n,s)h\_ease2\sphinxhyphen{}005}} grid.
\\
\sphinxbottomrule
\end{tabulary}
\sphinxtableafterendhook\par
\sphinxattableend\end{savenotes}

\sphinxstepscope


\chapter{Preprocessing}
\label{\detokenize{CIMR_L2_Sea_Ice_Drift_preproc:preprocessing}}\label{\detokenize{CIMR_L2_Sea_Ice_Drift_preproc::doc}}
\sphinxAtStartPar
This notebook implements a prototype for a Level\sphinxhyphen{}2 SIED algorithm for the CIMR mission.

\sphinxAtStartPar
We refer to the corresponding \sphinxhref{https://cimr-algos.github.io/SeaIceDrift\_ATBD/intro.html}{ATBD} and especially the \sphinxhref{https://cimr-algos.github.io/SeaIceDrift\_ATBD/baseline\_algorithm\_definition.html\#baseline-algorithm-definition}{Baseline Algorithm Definition}.

\sphinxAtStartPar
In particular, the figure below illustrates the overall concept of the processing:



\section{Settings}
\label{\detokenize{CIMR_L2_Sea_Ice_Drift_preproc:settings}}
\sphinxAtStartPar
Imports and general settings

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Paths}

\PYG{c+c1}{\PYGZsh{} Getting the path of the notebook (NOTE: not totally safe)}

\PYG{c+c1}{\PYGZsh{} The paths assume that there is an umbrella CIMR directory (of any name) containing SeaIceDrift\PYGZus{}ATBD\PYGZus{}v2/ ,}
\PYG{c+c1}{\PYGZsh{} the CIMR Tools/ directory, and a directory data/L1B/ containing the L1B data, and data/conc/ containing}
\PYG{c+c1}{\PYGZsh{} a concentration file}
\PYG{k+kn}{import} \PYG{n+nn}{os}
\PYG{n}{cpath} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{os}\PYG{o}{.}\PYG{n}{getcwd}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{../..}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{algpath} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{cpath}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{SeaIceDrift\PYGZus{}ATBD\PYGZus{}v2/algorithm/src\PYGZus{}sied}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{toolpath} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{cpath}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Tools}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{l1bpath} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{cpath}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{data/L1B}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{griddeffile} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{cpath}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Overall\PYGZus{}ATBD/etc/grids\PYGZus{}py.def}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Creating a directory structure for processing}
\PYG{n}{concpath} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{cpath}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{data/conc}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{icemaskpath} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{cpath}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{data/icemask}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{swathpath} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{cpath}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{data/swaths}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{procpath} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{cpath}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{data/processing}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{driftpath} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{cpath}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{data/icedrift}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{logpath} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{cpath}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{data/logs}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{figpath} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{cpath}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{data/figs}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{k}{for} \PYG{n}{pth} \PYG{o+ow}{in} \PYG{p}{[}\PYG{n}{concpath}\PYG{p}{,} \PYG{n}{icemaskpath}\PYG{p}{,} \PYG{n}{swathpath}\PYG{p}{,} \PYG{n}{procpath}\PYG{p}{,} \PYG{n}{driftpath}\PYG{p}{,} \PYG{n}{logpath}\PYG{p}{,} \PYG{n}{figpath}\PYG{p}{]}\PYG{p}{:}
    \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{isdir}\PYG{p}{(}\PYG{n}{pth}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{os}\PYG{o}{.}\PYG{n}{makedirs}\PYG{p}{(}\PYG{n}{pth}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}
\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Imports}
\PYG{k+kn}{from} \PYG{n+nn}{importlib} \PYG{k+kn}{import} \PYG{n}{reload}
\PYG{k+kn}{import} \PYG{n+nn}{sys}
\PYG{k+kn}{import} \PYG{n+nn}{warnings}
\PYG{k+kn}{from} \PYG{n+nn}{datetime} \PYG{k+kn}{import} \PYG{n}{datetime}\PYG{p}{,} \PYG{n}{timedelta}
\PYG{k+kn}{from} \PYG{n+nn}{dateutil}\PYG{n+nn}{.}\PYG{n+nn}{relativedelta} \PYG{k+kn}{import} \PYG{n}{relativedelta}
\PYG{k+kn}{import} \PYG{n+nn}{numpy} \PYG{k}{as} \PYG{n+nn}{np}
\PYG{k+kn}{import} \PYG{n+nn}{xarray} \PYG{k}{as} \PYG{n+nn}{xr}
\PYG{k+kn}{from} \PYG{n+nn}{netCDF4} \PYG{k+kn}{import} \PYG{n}{Dataset}
\PYG{k+kn}{from} \PYG{n+nn}{matplotlib} \PYG{k+kn}{import} \PYG{n}{pylab} \PYG{k}{as} \PYG{n}{plt}
\PYG{k+kn}{import} \PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{cm} \PYG{k}{as} \PYG{n+nn}{cm}
\PYG{k+kn}{from} \PYG{n+nn}{pyresample} \PYG{k+kn}{import} \PYG{n}{parse\PYGZus{}area\PYGZus{}file}
\PYG{k+kn}{from} \PYG{n+nn}{scipy}\PYG{n+nn}{.}\PYG{n+nn}{ndimage} \PYG{k+kn}{import} \PYG{n}{laplace}

\PYG{c+c1}{\PYGZsh{} Local modules contain software code that implement the SIED algorithm}
\PYG{k}{if} \PYG{n}{algpath} \PYG{o+ow}{not} \PYG{o+ow}{in} \PYG{n}{sys}\PYG{o}{.}\PYG{n}{path}\PYG{p}{:}
    \PYG{n}{sys}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{insert}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{algpath}\PYG{p}{)}
\PYG{k+kn}{from} \PYG{n+nn}{process\PYGZus{}ice\PYGZus{}mask} \PYG{k+kn}{import} \PYG{n}{process\PYGZus{}ice\PYGZus{}mask}
\PYG{k+kn}{from} \PYG{n+nn}{cp\PYGZus{}and\PYGZus{}date\PYGZus{}change\PYGZus{}iceconc} \PYG{k+kn}{import} \PYG{n}{cp\PYGZus{}and\PYGZus{}date\PYGZus{}change\PYGZus{}iceconc}

\PYG{c+c1}{\PYGZsh{} Prototype re\PYGZhy{}gridding toolbox to handle the L1B input}
\PYG{k}{if} \PYG{n}{toolpath} \PYG{o+ow}{not} \PYG{o+ow}{in} \PYG{n}{sys}\PYG{o}{.}\PYG{n}{path}\PYG{p}{:}
    \PYG{n}{sys}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{insert}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{toolpath}\PYG{p}{)}
\PYG{k+kn}{from} \PYG{n+nn}{tools} \PYG{k+kn}{import} \PYG{n}{io\PYGZus{}handler} \PYG{k}{as} \PYG{n}{io}
\PYG{k+kn}{from} \PYG{n+nn}{tools} \PYG{k+kn}{import} \PYG{n}{collocation} \PYG{k}{as} \PYG{n}{coll}
\PYG{k+kn}{from} \PYG{n+nn}{tools} \PYG{k+kn}{import} \PYG{n}{l2\PYGZus{}format} \PYG{k}{as} \PYG{n}{l2}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}
\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Plot settings}

\PYG{k+kn}{import} \PYG{n+nn}{matplotlib}
\PYG{n}{matplotlib}\PYG{o}{.}\PYG{n}{rc}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{xtick}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{labelsize}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)} 
\PYG{n}{matplotlib}\PYG{o}{.}\PYG{n}{rc}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ytick}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{labelsize}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)} 
\PYG{n}{matplotlib}\PYG{o}{.}\PYG{n}{rcParams}\PYG{o}{.}\PYG{n}{update}\PYG{p}{(}\PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{font.size}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{12}\PYG{p}{\PYGZcb{}}\PYG{p}{)}
\PYG{n}{matplotlib}\PYG{o}{.}\PYG{n}{rcParams}\PYG{o}{.}\PYG{n}{update}\PYG{p}{(}\PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{axes.labelsize}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{12}\PYG{p}{\PYGZcb{}}\PYG{p}{)}

\PYG{n}{font} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{family}\PYG{l+s+s1}{\PYGZsq{}} \PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{sans}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{weight}\PYG{l+s+s1}{\PYGZsq{}} \PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{normal}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{size}\PYG{l+s+s1}{\PYGZsq{}}   \PYG{p}{:} \PYG{l+m+mi}{12}\PYG{p}{\PYGZcb{}}
\PYG{n}{matplotlib}\PYG{o}{.}\PYG{n}{rc}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{font}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{o}{*}\PYG{o}{*}\PYG{n}{font}\PYG{p}{)}

\PYG{n}{cmap} \PYG{o}{=} \PYG{n}{cm}\PYG{o}{.}\PYG{n}{viridis}
\PYG{n}{cmapland} \PYG{o}{=} \PYG{n}{matplotlib}\PYG{o}{.}\PYG{n}{colors}\PYG{o}{.}\PYG{n}{ListedColormap}\PYG{p}{(}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{none}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{grey}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}

\PYG{n}{gridin} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{\PYGZhy{}ease2\PYGZhy{}050}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{gridout} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{\PYGZhy{}ease2\PYGZhy{}250}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{c+c1}{\PYGZsh{} Some region parameters hard\PYGZhy{}coded to show only the relevant region}
\PYG{c+c1}{\PYGZsh{} Overall shape of input grid (4320, 4320)}
\PYG{n}{sl} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{1050}\PYG{p}{,} \PYG{l+m+mi}{1400}\PYG{p}{,} \PYG{l+m+mi}{1050}\PYG{p}{,} \PYG{l+m+mi}{1400}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}

\section{Parametrize the run}
\label{\detokenize{CIMR_L2_Sea_Ice_Drift_preproc:parametrize-the-run}}
\sphinxAtStartPar
User\sphinxhyphen{}set parameters for the running of the whole notebook. Note that here a helper script is used to copy a starter ice concentration file from the MET Norway thredds server and change the dates in this. The date changes are required due to the sample input file having a date in the future (2028).

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{hemi} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{nh}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{algos} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{KU}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{channels}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{tb19v}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{tb19h}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{target\PYGZus{}band}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{KU}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
         \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{KA}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{channels}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{tb37v}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{tb37h}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{target\PYGZus{}band}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{KA}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{\PYGZcb{}}\PYG{p}{\PYGZcb{}}
\PYG{n}{wbs} \PYG{o}{=} \PYG{n+nb}{list}\PYG{p}{(}\PYG{n}{algos}\PYG{o}{.}\PYG{n}{keys}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{fwdbck} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{fw}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{bk}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
\PYG{n}{polarisation} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{V}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{H}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{1}\PYG{p}{\PYGZcb{}}
\PYG{n}{pols} \PYG{o}{=} \PYG{n+nb}{list}\PYG{p}{(}\PYG{n}{polarisation}\PYG{o}{.}\PYG{n}{keys}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}

\PYG{n}{test\PYGZus{}card} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{radiometric}\PYG{l+s+s2}{\PYGZdq{}}
\PYG{k}{if} \PYG{n}{test\PYGZus{}card} \PYG{o}{==} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{geometric}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} DEVALGO\PYGZsq{}s simulated geometric test card}
    \PYG{n}{l1bfn} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{W\PYGZus{}PT\PYGZhy{}DME\PYGZhy{}Lisbon\PYGZhy{}SAT\PYGZhy{}CIMR\PYGZhy{}1B\PYGZus{}C\PYGZus{}DME\PYGZus{}20230417T105425\PYGZus{}LD\PYGZus{}20280110T114800\PYGZus{}20280110T115700\PYGZus{}TN.nc}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{k}{elif} \PYG{n}{test\PYGZus{}card} \PYG{o}{==} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{radiometric}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} DEVALGO\PYGZsq{}s simulated radiometric test card}
    \PYG{n}{l1bfn} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{W\PYGZus{}PT\PYGZhy{}DME\PYGZhy{}Lisbon\PYGZhy{}SAT\PYGZhy{}CIMR\PYGZhy{}1B\PYGZus{}C\PYGZus{}DME\PYGZus{}20230420T103323\PYGZus{}LD\PYGZus{}20280110T114800\PYGZus{}20280110T115700\PYGZus{}TN.nc}\PYG{l+s+s1}{\PYGZsq{}}

\PYG{n}{l1bfile} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{l1bpath}\PYG{p}{,} \PYG{n}{l1bfn}\PYG{p}{)}

\PYG{n}{pdate} \PYG{o}{=} \PYG{n}{datetime}\PYG{o}{.}\PYG{n}{strptime}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{20280110}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{Y}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{m}\PYG{l+s+si}{\PYGZpc{}d}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{tdate} \PYG{o}{=} \PYG{n}{pdate} \PYG{o}{\PYGZhy{}} \PYG{n}{relativedelta}\PYG{p}{(}\PYG{n}{years}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}
\PYG{n}{qdate} \PYG{o}{=} \PYG{n}{pdate} \PYG{o}{+} \PYG{n}{timedelta}\PYG{p}{(}\PYG{n}{days}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Icemask data and output locations}
\PYG{n}{icemaskinputdir} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{https://thredds.met.no/thredds/dodsC/osisaf/met.no/reprocessed/ice/conc\PYGZus{}450a\PYGZus{}files/}\PYG{l+s+s1}{\PYGZob{}}\PYG{l+s+s1}{:}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{Y\PYGZcb{}/}\PYG{l+s+s1}{\PYGZob{}}\PYG{l+s+s1}{:}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{m\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{tdate}\PYG{p}{,} \PYG{n}{tdate}\PYG{p}{)}
\PYG{n}{icemaskinputfile} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ice\PYGZus{}conc\PYGZus{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{\PYGZus{}ease2\PYGZhy{}250\PYGZus{}cdr\PYGZhy{}v3p0\PYGZus{}}\PYG{l+s+s1}{\PYGZob{}}\PYG{l+s+s1}{:}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{Y}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{m}\PYG{l+s+si}{\PYGZpc{}d}\PYG{l+s+s1}{\PYGZcb{}1200.nc}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{hemi}\PYG{p}{,} \PYG{n}{tdate}\PYG{p}{)}
\PYG{n}{icemaskinput} \PYG{o}{=} \PYG{n}{cp\PYGZus{}and\PYGZus{}date\PYGZus{}change\PYGZus{}iceconc}\PYG{p}{(}\PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{icemaskinputdir}\PYG{p}{,} \PYG{n}{icemaskinputfile}\PYG{p}{)}\PYG{p}{,} \PYG{n}{concpath}\PYG{p}{,} \PYG{n}{pdate}\PYG{p}{)}

\PYG{n}{algo\PYGZus{}version} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{0.1}\PYG{l+s+s1}{\PYGZsq{}}

\PYG{n}{pixshx} \PYG{o}{=} \PYG{l+m+mi}{3}
\PYG{n}{pixshy} \PYG{o}{=} \PYG{l+m+mi}{4}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
Written a version of https://thredds.met.no/thredds/dodsC/osisaf/met.no/reprocessed/ice/conc\PYGZus{}450a\PYGZus{}files/2018/01/ice\PYGZus{}conc\PYGZus{}nh\PYGZus{}ease2\PYGZhy{}250\PYGZus{}cdr\PYGZhy{}v3p0\PYGZus{}201801101200.nc to /home/emilyjd/cimr\PYGZhy{}devalgo/SeaIceDrift\PYGZus{}ATBD\PYGZus{}v2/algorithm/../../data/conc/ice\PYGZus{}conc\PYGZus{}nh\PYGZus{}ease2\PYGZhy{}250\PYGZus{}cdr\PYGZhy{}v3p0\PYGZus{}202801101200.nc
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}

\section{Step 1:  Creating and regridding the ice mask}
\label{\detokenize{CIMR_L2_Sea_Ice_Drift_preproc:step-1-creating-and-regridding-the-ice-mask}}
\sphinxAtStartPar
A land/ocean/ice mask is required to define the areas with ice to the algorithm. This is created from a concentration file, and is stored for future use. Since there can be multiple ice drift calculations per day on different swaths, the mask can be reused once created.

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Creating the ice mask}
\PYG{n}{gridname} \PYG{o}{=} \PYG{n}{gridin}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{hemi}\PYG{p}{)}
\PYG{n}{icemaskname} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{icemaskpath}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{icemask\PYGZhy{}multi\PYGZhy{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{\PYGZhy{}}\PYG{l+s+s1}{\PYGZob{}}\PYG{l+s+s1}{:}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{Y}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{m}\PYG{l+s+si}{\PYGZpc{}d}\PYG{l+s+s1}{\PYGZcb{}12.nc}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{gridname}\PYG{p}{,} \PYG{n}{pdate}\PYG{p}{)}\PYG{p}{)}
\PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{isfile}\PYG{p}{(}\PYG{n}{icemaskname}\PYG{p}{)}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} Suppress the proj4 string warning on this}
    \PYG{k}{with} \PYG{n}{warnings}\PYG{o}{.}\PYG{n}{catch\PYGZus{}warnings}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{warnings}\PYG{o}{.}\PYG{n}{simplefilter}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ignore}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n}{process\PYGZus{}ice\PYGZus{}mask}\PYG{p}{(}\PYG{n}{icemaskinput}\PYG{p}{,} \PYG{n}{icemaskpath}\PYG{p}{,} \PYG{n}{griddeffile}\PYG{p}{,} \PYG{n}{gridname}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Reading in the ice mask}
\PYG{n}{ie\PYGZus{}data} \PYG{o}{=} \PYG{n}{Dataset}\PYG{p}{(}\PYG{n}{icemaskname}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ie} \PYG{o}{=} \PYG{n}{ie\PYGZus{}data}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ice\PYGZus{}edge}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} And the same for the output grid}
\PYG{n}{gridnameout} \PYG{o}{=} \PYG{n}{gridout}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{hemi}\PYG{p}{)}
\PYG{n}{icemasknameout} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{icemaskpath}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{icemask\PYGZhy{}multi\PYGZhy{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{\PYGZhy{}}\PYG{l+s+s1}{\PYGZob{}}\PYG{l+s+s1}{:}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{Y}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{m}\PYG{l+s+si}{\PYGZpc{}d}\PYG{l+s+s1}{\PYGZcb{}12.nc}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{gridnameout}\PYG{p}{,} \PYG{n}{pdate}\PYG{p}{)}\PYG{p}{)}
\PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{isfile}\PYG{p}{(}\PYG{n}{icemasknameout}\PYG{p}{)}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} Suppress the proj4 string warning on this}
    \PYG{k}{with} \PYG{n}{warnings}\PYG{o}{.}\PYG{n}{catch\PYGZus{}warnings}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{warnings}\PYG{o}{.}\PYG{n}{simplefilter}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ignore}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
        \PYG{n}{process\PYGZus{}ice\PYGZus{}mask}\PYG{p}{(}\PYG{n}{icemaskinput}\PYG{p}{,} \PYG{n}{icemaskpath}\PYG{p}{,} \PYG{n}{griddeffile}\PYG{p}{,} \PYG{n}{gridnameout}\PYG{p}{)}
\PYG{n}{ie\PYGZus{}data\PYGZus{}out} \PYG{o}{=} \PYG{n}{Dataset}\PYG{p}{(}\PYG{n}{icemasknameout}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ieout} \PYG{o}{=} \PYG{n}{ie\PYGZus{}data\PYGZus{}out}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ice\PYGZus{}edge}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Plotting the ice mask}
\PYG{n}{fig} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,}\PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{ax1} \PYG{o}{=} \PYG{n}{fig}\PYG{o}{.}\PYG{n}{add\PYGZus{}subplot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{)}
\PYG{n}{c1} \PYG{o}{=} \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{ie}\PYG{p}{[}\PYG{p}{:}\PYG{p}{]}\PYG{p}{,} \PYG{n}{interpolation} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{none}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{n}{cmap}\PYG{p}{)}
\PYG{n}{ax1}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Ice mask}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{ax1}\PYG{o}{.}\PYG{n}{xaxis}\PYG{o}{.}\PYG{n}{set\PYGZus{}tick\PYGZus{}params}\PYG{p}{(}\PYG{n}{labelbottom}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}
\PYG{n}{ax1}\PYG{o}{.}\PYG{n}{yaxis}\PYG{o}{.}\PYG{n}{set\PYGZus{}tick\PYGZus{}params}\PYG{p}{(}\PYG{n}{labelleft}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}
\PYG{n}{ax1}\PYG{o}{.}\PYG{n}{set\PYGZus{}xticks}\PYG{p}{(}\PYG{p}{[}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{ax1}\PYG{o}{.}\PYG{n}{set\PYGZus{}yticks}\PYG{p}{(}\PYG{p}{[}\PYG{p}{]}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Input landmask}
\PYG{n}{landmask} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros\PYGZus{}like}\PYG{p}{(}\PYG{n}{ie}\PYG{p}{)}
\PYG{n}{landmask}\PYG{p}{[}\PYG{n}{ie} \PYG{o}{==} \PYG{l+m+mi}{9}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{1}

\PYG{c+c1}{\PYGZsh{} Output landmask}
\PYG{n}{landmaskout} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros\PYGZus{}like}\PYG{p}{(}\PYG{n}{ieout}\PYG{p}{)}
\PYG{n}{landmaskout}\PYG{p}{[}\PYG{n}{ieout} \PYG{o}{==} \PYG{l+m+mi}{9}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{1}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\noindent\sphinxincludegraphics{{1154b83df23d79e4dfb95aba3a677889659318052d1675f0ce77a28ec75deade}.png}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}

\section{Step 2: Loading the data}
\label{\detokenize{CIMR_L2_Sea_Ice_Drift_preproc:step-2-loading-the-data}}
\sphinxAtStartPar
The L1B data is read in and split into forward and backward scans using software from the \sphinxcode{\sphinxupquote{Tools/}} repository (a prototype CIMR Regridding Toolbox developed in the CIMR DEVALGO study). These forward and backward scans can be used independently in the algorithm in the same way as different channels and polarisations.

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Read the bands needed of the L1B data}
\PYG{n}{reload}\PYG{p}{(}\PYG{n}{io}\PYG{p}{)}

\PYG{n}{tb\PYGZus{}dict} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{tb01}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{L}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{tb06}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{C}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{tb10}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{X}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{tb19}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{KU}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{tb37}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{KA}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{\PYGZcb{}}
\PYG{n}{rev\PYGZus{}tb\PYGZus{}dict} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{n}{v}\PYG{p}{:}\PYG{n}{k} \PYG{k}{for} \PYG{n}{k}\PYG{p}{,}\PYG{n}{v} \PYG{o+ow}{in} \PYG{n}{tb\PYGZus{}dict}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{\PYGZcb{}}
\PYG{n}{bands\PYGZus{}needed} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
\PYG{k}{for} \PYG{n}{alg} \PYG{o+ow}{in} \PYG{n}{algos}\PYG{o}{.}\PYG{n}{keys}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{bands\PYGZus{}needed} \PYG{o}{+}\PYG{o}{=} \PYG{n}{algos}\PYG{p}{[}\PYG{n}{alg}\PYG{p}{]}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{channels}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
\PYG{n}{bands\PYGZus{}needed} \PYG{o}{=} \PYG{n+nb}{list}\PYG{p}{(}\PYG{n+nb}{set}\PYG{p}{(}\PYG{p}{[}\PYG{n}{tb\PYGZus{}dict}\PYG{p}{[}\PYG{n}{b}\PYG{p}{[}\PYG{p}{:}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{]} \PYG{k}{for} \PYG{n}{b} \PYG{o+ow}{in} \PYG{n}{bands\PYGZus{}needed}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}

\PYG{n}{full\PYGZus{}l1b} \PYG{o}{=} \PYG{n}{io}\PYG{o}{.}\PYG{n}{CIMR\PYGZus{}L1B}\PYG{p}{(}\PYG{n}{l1bfile}\PYG{p}{,} \PYG{n}{selected\PYGZus{}bands}\PYG{o}{=}\PYG{n}{bands\PYGZus{}needed}\PYG{p}{,} \PYG{n}{keep\PYGZus{}calibration\PYGZus{}view}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}
\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Split into forward / backward scan}

\PYG{n}{l1b} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
\PYG{n}{l1b}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{fw}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{l1b}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{bk}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{full\PYGZus{}l1b}\PYG{o}{.}\PYG{n}{split\PYGZus{}forward\PYGZus{}backward\PYGZus{}scans}\PYG{p}{(}\PYG{n}{method}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{horn\PYGZus{}scan\PYGZus{}angle}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}

\section{Step 3: Regridding the data}
\label{\detokenize{CIMR_L2_Sea_Ice_Drift_preproc:step-3-regridding-the-data}}
\sphinxAtStartPar
The horns are interleaved, and then the data is regridded. These are again done with software from \sphinxcode{\sphinxupquote{Tools/}}. The ice drift will be calculated individually on 8 fields based on the forward and backward scans, waveband (Ku or Ka), and polarity (V or H). A fine EASE2 grid spacing of 5km is chosen for this regridding.

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Regridding the data}

\PYG{n}{reload}\PYG{p}{(}\PYG{n}{coll}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Reshaping}
\PYG{n}{l1b\PYGZus{}r} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
\PYG{k}{for} \PYG{n}{fb} \PYG{o+ow}{in} \PYG{n}{fwdbck}\PYG{p}{:}
    \PYG{n}{l1b\PYGZus{}r}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]} \PYG{o}{=} \PYG{n}{l1b}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{o}{.}\PYG{n}{reshape\PYGZus{}interleave\PYGZus{}feed}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Loading the target grid information}
\PYG{n}{gridname} \PYG{o}{=} \PYG{n}{gridin}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{hemi}\PYG{p}{)}
\PYG{n}{new\PYGZus{}area\PYGZus{}def} \PYG{o}{=} \PYG{n}{parse\PYGZus{}area\PYGZus{}file}\PYG{p}{(}\PYG{n}{griddeffile}\PYG{p}{,} \PYG{n}{gridname}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
\PYG{n}{new\PYGZus{}lons}\PYG{p}{,} \PYG{n}{new\PYGZus{}lats} \PYG{o}{=} \PYG{n}{new\PYGZus{}area\PYGZus{}def}\PYG{o}{.}\PYG{n}{get\PYGZus{}lonlats}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Getting the input lat/lons}
\PYG{n}{lonlats} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
\PYG{k}{for} \PYG{n}{ll} \PYG{o+ow}{in} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lon}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lat}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{:}
    \PYG{n}{lonlats}\PYG{p}{[}\PYG{n}{ll}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    \PYG{k}{for} \PYG{n}{fb} \PYG{o+ow}{in} \PYG{n}{fwdbck}\PYG{p}{:}
        \PYG{n}{lonlats}\PYG{p}{[}\PYG{n}{ll}\PYG{p}{]}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
        \PYG{k}{for} \PYG{n}{wb} \PYG{o+ow}{in} \PYG{n}{wbs}\PYG{p}{:}
            \PYG{n}{lonlats}\PYG{p}{[}\PYG{n}{ll}\PYG{p}{]}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]} \PYG{o}{=} \PYG{n}{l1b\PYGZus{}r}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{o}{.}\PYG{n}{data}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{ll}\PYG{p}{]}\PYG{o}{.}\PYG{n}{data}

\PYG{c+c1}{\PYGZsh{} Creating data arrays with the V and H layers}
\PYG{n}{what} \PYG{o}{=} \PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{brightness\PYGZus{}temperature\PYGZus{}v}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{brightness\PYGZus{}temperature\PYGZus{}h}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{params} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{method}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gauss}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{sigmas}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}\PYG{l+m+mi}{25000}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{neighbours}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}\PYG{l+m+mi}{55}\PYG{p}{\PYGZcb{}}
\PYG{n}{stack\PYGZus{}shape} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
\PYG{n}{stack} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
\PYG{n}{regrid} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
\PYG{k}{for} \PYG{n}{fb} \PYG{o+ow}{in} \PYG{n}{fwdbck}\PYG{p}{:}
    \PYG{n}{stack\PYGZus{}shape}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    \PYG{n}{stack}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    \PYG{n}{regrid}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    \PYG{k}{for} \PYG{n}{wb} \PYG{o+ow}{in} \PYG{n}{wbs}\PYG{p}{:}
        \PYG{n}{stack\PYGZus{}shape}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]} \PYG{o}{=} \PYG{n+nb}{tuple}\PYG{p}{(}\PYG{n+nb}{list}\PYG{p}{(}\PYG{n}{lonlats}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lat}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{)} \PYG{o}{+} \PYG{p}{[}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{what}\PYG{p}{)}\PYG{p}{,}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{stack}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{empty}\PYG{p}{(}\PYG{n}{stack\PYGZus{}shape}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{)}
        \PYG{k}{for} \PYG{n}{iw}\PYG{p}{,} \PYG{n}{w} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{what}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{stack}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{[}\PYG{o}{.}\PYG{o}{.}\PYG{o}{.}\PYG{p}{,}\PYG{n}{iw}\PYG{p}{]} \PYG{o}{=} \PYG{n}{l1b\PYGZus{}r}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{o}{.}\PYG{n}{data}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{w}\PYG{p}{]}\PYG{o}{.}\PYG{n}{data}
            \PYG{c+c1}{\PYGZsh{} Regridding}
            \PYG{c+c1}{\PYGZsh{} TODO \PYGZhy{} Add passing of params, currently a nearest\PYGZhy{}neighbour approach with ROI 15000 is used}
            \PYG{n}{regrid}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]} \PYG{o}{=} \PYG{n}{coll}\PYG{o}{.}\PYG{n}{\PYGZus{}regrid\PYGZus{}fields}\PYG{p}{(}\PYG{n}{new\PYGZus{}lons}\PYG{p}{,} \PYG{n}{new\PYGZus{}lats}\PYG{p}{,} 
                                                 \PYG{n}{lonlats}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lon}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{,} \PYG{n}{lonlats}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lat}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{,} \PYG{n}{stack}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}
\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Plot regridded}

\PYG{n}{fig} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,}\PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{ax} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
\PYG{n}{c} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
\PYG{n}{shapelayout} \PYG{o}{=} \PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{fwdbck}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{wbs}\PYG{p}{)} \PYG{o}{*} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{pols}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{axindex} \PYG{o}{=} \PYG{l+m+mi}{1}
\PYG{k}{for} \PYG{n}{fb} \PYG{o+ow}{in} \PYG{n}{fwdbck}\PYG{p}{:}
    \PYG{k}{for} \PYG{n}{wb} \PYG{o+ow}{in} \PYG{n}{wbs}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{pol} \PYG{o+ow}{in} \PYG{n}{pols}\PYG{p}{:}
            \PYG{n}{ax}\PYG{p}{[}\PYG{n}{axindex}\PYG{p}{]} \PYG{o}{=} \PYG{n}{fig}\PYG{o}{.}\PYG{n}{add\PYGZus{}subplot}\PYG{p}{(}\PYG{o}{*}\PYG{n}{shapelayout}\PYG{p}{,} \PYG{n}{axindex}\PYG{p}{)}
            \PYG{n}{c}\PYG{p}{[}\PYG{n}{axindex}\PYG{p}{]} \PYG{o}{=} \PYG{n}{ax}\PYG{p}{[}\PYG{n}{axindex}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{regrid}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{n}{polarisation}\PYG{p}{[}\PYG{n}{pol}\PYG{p}{]}\PYG{p}{]}\PYG{p}{[}\PYG{n}{sl}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{:}\PYG{n}{sl}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{sl}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{:}\PYG{n}{sl}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,} 
                                            \PYG{n}{interpolation} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{none}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{origin}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lower}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{n}{cmap}\PYG{p}{)}
            \PYG{n}{overland} \PYG{o}{=} \PYG{n}{ax}\PYG{p}{[}\PYG{n}{axindex}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{landmask}\PYG{p}{[}\PYG{n}{sl}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{:}\PYG{n}{sl}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{sl}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{:}\PYG{n}{sl}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,} \PYG{n}{interpolation}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{none}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
                                          \PYG{n}{origin}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lower}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{n}{cmapland}\PYG{p}{)}            
            \PYG{n}{ax}\PYG{p}{[}\PYG{n}{axindex}\PYG{p}{]}\PYG{o}{.}\PYG{n}{invert\PYGZus{}yaxis}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{ax}\PYG{p}{[}\PYG{n}{axindex}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s2}{ }\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s2}{ }\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{wb}\PYG{p}{,} \PYG{n}{pol}\PYG{p}{,} \PYG{n}{fb}\PYG{p}{)}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{12}\PYG{p}{)}
            \PYG{n}{ax}\PYG{p}{[}\PYG{n}{axindex}\PYG{p}{]}\PYG{o}{.}\PYG{n}{xaxis}\PYG{o}{.}\PYG{n}{set\PYGZus{}tick\PYGZus{}params}\PYG{p}{(}\PYG{n}{labelbottom}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}
            \PYG{n}{ax}\PYG{p}{[}\PYG{n}{axindex}\PYG{p}{]}\PYG{o}{.}\PYG{n}{yaxis}\PYG{o}{.}\PYG{n}{set\PYGZus{}tick\PYGZus{}params}\PYG{p}{(}\PYG{n}{labelleft}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}
            \PYG{n}{ax}\PYG{p}{[}\PYG{n}{axindex}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xticks}\PYG{p}{(}\PYG{p}{[}\PYG{p}{]}\PYG{p}{)}
            \PYG{n}{ax}\PYG{p}{[}\PYG{n}{axindex}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}yticks}\PYG{p}{(}\PYG{p}{[}\PYG{p}{]}\PYG{p}{)}
            \PYG{n}{axindex} \PYG{o}{+}\PYG{o}{=} \PYG{l+m+mi}{1}

\PYG{n}{fig}\PYG{o}{.}\PYG{n}{subplots\PYGZus{}adjust}\PYG{p}{(}\PYG{n}{right}\PYG{o}{=}\PYG{l+m+mf}{0.8}\PYG{p}{)}
\PYG{n}{cbar\PYGZus{}ax} \PYG{o}{=} \PYG{n}{fig}\PYG{o}{.}\PYG{n}{add\PYGZus{}axes}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mf}{0.85}\PYG{p}{,} \PYG{l+m+mf}{0.25}\PYG{p}{,} \PYG{l+m+mf}{0.02}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{fig}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{c}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{cax}\PYG{o}{=}\PYG{n}{cbar\PYGZus{}ax}\PYG{p}{,} \PYG{n}{shrink}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZlt{}matplotlib.colorbar.Colorbar at 0x7fc98da9a190\PYGZgt{}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{dea07a3f183c37952dee3e6dd84b34d24f999b897587b737be11a583fb630c6a}.png}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}

\section{Step 4: Laplacian pre\sphinxhyphen{}processing}
\label{\detokenize{CIMR_L2_Sea_Ice_Drift_preproc:step-4-laplacian-pre-processing}}
\sphinxAtStartPar
Instead of directly using the brightness temperatures in the motion tracking algorithm, the ice features are stabilised and enhanced by applying a Laplacian filter (see ATBD for mathmatical description).

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Replace fill value by NaN and remove mask}
\PYG{k}{def} \PYG{n+nf}{\PYGZus{}get\PYGZus{}nans}\PYG{p}{(}\PYG{n}{img}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{img\PYGZus{}masked} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ma}\PYG{o}{.}\PYG{n}{asarray}\PYG{p}{(}\PYG{n}{img}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{img\PYGZus{}masked}\PYG{o}{.}\PYG{n}{filled}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{nan}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Replace NaN by fill value and add mask}
\PYG{k}{def} \PYG{n+nf}{\PYGZus{}mask\PYGZus{}nans}\PYG{p}{(}\PYG{n}{img}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{return} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ma}\PYG{o}{.}\PYG{n}{masked\PYGZus{}invalid}\PYG{p}{(}\PYG{n}{img}\PYG{p}{)}

\PYG{n}{nan} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
\PYG{n}{lap} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
\PYG{n}{fv} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
\PYG{k}{for} \PYG{n}{fb} \PYG{o+ow}{in} \PYG{n}{fwdbck}\PYG{p}{:}
    \PYG{n}{nan}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    \PYG{n}{lap}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    \PYG{n}{fv}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    \PYG{k}{for} \PYG{n}{wb} \PYG{o+ow}{in} \PYG{n}{wbs}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Convert fill values to NaNs}
        \PYG{n}{nan}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]} \PYG{o}{=} \PYG{n}{\PYGZus{}get\PYGZus{}nans}\PYG{p}{(}\PYG{n}{regrid}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{)}
        \PYG{c+c1}{\PYGZsh{} Laplacian transform}
        \PYG{n}{lap}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]} \PYG{o}{=} \PYG{n}{laplace}\PYG{p}{(}\PYG{n}{nan}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{)}
        \PYG{c+c1}{\PYGZsh{} Converting NaNs to fill values}
        \PYG{n}{fv}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]} \PYG{o}{=} \PYG{n}{\PYGZus{}mask\PYGZus{}nans}\PYG{p}{(}\PYG{n}{lap}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Creating a flag field}
\PYG{c+c1}{\PYGZsh{}define TCIMAGE\PYGZus{}OUTSIDE\PYGZus{}GRID              \PYGZhy{}2}
\PYG{c+c1}{\PYGZsh{}define TCIMAGE\PYGZus{}NODATA                    \PYGZhy{}1}
\PYG{c+c1}{\PYGZsh{}define TCIMAGE\PYGZus{}OK                         0}
\PYG{c+c1}{\PYGZsh{}define TCIMAGE\PYGZus{}UNPROCESSED                1}
\PYG{c+c1}{\PYGZsh{}define TCIMAGE\PYGZus{}FAILED                     2}
\PYG{n}{flag} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
\PYG{k}{for} \PYG{n}{fb} \PYG{o+ow}{in} \PYG{n}{fwdbck}\PYG{p}{:}
    \PYG{n}{flag}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    \PYG{k}{for} \PYG{n}{wb} \PYG{o+ow}{in} \PYG{n}{wbs}\PYG{p}{:}
        \PYG{n}{flag}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros\PYGZus{}like}\PYG{p}{(}\PYG{n}{fv}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{)}
        \PYG{c+c1}{\PYGZsh{} Masking where the Laplacian didn\PYGZsq{}t work}
        \PYG{n}{flag}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{fv}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{o}{.}\PYG{n}{mask}\PYG{p}{]} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}
        \PYG{c+c1}{\PYGZsh{} Masking where the land and ocean is}
        \PYG{n}{landocean} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{logical\PYGZus{}or}\PYG{p}{(}\PYG{n}{ie} \PYG{o}{==} \PYG{l+m+mi}{9}\PYG{p}{,} \PYG{n}{ie} \PYG{o}{==} \PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{n}{flag}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{landocean}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{1}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}
\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Plot Laplacian}

\PYG{n}{vmin} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{100}
\PYG{n}{vmax} \PYG{o}{=} \PYG{l+m+mi}{100}

\PYG{n}{fig} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,}\PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{ax} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
\PYG{n}{c} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
\PYG{n}{shapelayout} \PYG{o}{=} \PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{fwdbck}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{wbs}\PYG{p}{)} \PYG{o}{*} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{pols}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{axindex} \PYG{o}{=} \PYG{l+m+mi}{1}
\PYG{k}{for} \PYG{n}{fb} \PYG{o+ow}{in} \PYG{n}{fwdbck}\PYG{p}{:}
    \PYG{k}{for} \PYG{n}{wb} \PYG{o+ow}{in} \PYG{n}{wbs}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{pol} \PYG{o+ow}{in} \PYG{n}{pols}\PYG{p}{:}
            \PYG{n}{ax}\PYG{p}{[}\PYG{n}{axindex}\PYG{p}{]} \PYG{o}{=} \PYG{n}{fig}\PYG{o}{.}\PYG{n}{add\PYGZus{}subplot}\PYG{p}{(}\PYG{o}{*}\PYG{n}{shapelayout}\PYG{p}{,} \PYG{n}{axindex}\PYG{p}{)}
            \PYG{n}{c}\PYG{p}{[}\PYG{n}{axindex}\PYG{p}{]} \PYG{o}{=} \PYG{n}{ax}\PYG{p}{[}\PYG{n}{axindex}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{fv}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{n}{polarisation}\PYG{p}{[}\PYG{n}{pol}\PYG{p}{]}\PYG{p}{]}\PYG{p}{[}\PYG{n}{sl}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{:}\PYG{n}{sl}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{sl}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{:}\PYG{n}{sl}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,} 
                                            \PYG{n}{interpolation} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{none}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{origin}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lower}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{n}{cmap}\PYG{p}{,} 
                                            \PYG{n}{vmin}\PYG{o}{=}\PYG{n}{vmin}\PYG{p}{,} \PYG{n}{vmax}\PYG{o}{=}\PYG{n}{vmax}\PYG{p}{)}
            \PYG{n}{overland} \PYG{o}{=} \PYG{n}{ax}\PYG{p}{[}\PYG{n}{axindex}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{landmask}\PYG{p}{[}\PYG{n}{sl}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{:}\PYG{n}{sl}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{sl}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{:}\PYG{n}{sl}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,} \PYG{n}{interpolation}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{none}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
                                          \PYG{n}{origin}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lower}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{n}{cmapland}\PYG{p}{)}            
            \PYG{n}{ax}\PYG{p}{[}\PYG{n}{axindex}\PYG{p}{]}\PYG{o}{.}\PYG{n}{invert\PYGZus{}yaxis}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{ax}\PYG{p}{[}\PYG{n}{axindex}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s2}{ }\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s2}{ }\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{wb}\PYG{p}{,} \PYG{n}{pol}\PYG{p}{,} \PYG{n}{fb}\PYG{p}{)}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{12}\PYG{p}{)}
            \PYG{n}{ax}\PYG{p}{[}\PYG{n}{axindex}\PYG{p}{]}\PYG{o}{.}\PYG{n}{xaxis}\PYG{o}{.}\PYG{n}{set\PYGZus{}tick\PYGZus{}params}\PYG{p}{(}\PYG{n}{labelbottom}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}
            \PYG{n}{ax}\PYG{p}{[}\PYG{n}{axindex}\PYG{p}{]}\PYG{o}{.}\PYG{n}{yaxis}\PYG{o}{.}\PYG{n}{set\PYGZus{}tick\PYGZus{}params}\PYG{p}{(}\PYG{n}{labelleft}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}
            \PYG{n}{ax}\PYG{p}{[}\PYG{n}{axindex}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xticks}\PYG{p}{(}\PYG{p}{[}\PYG{p}{]}\PYG{p}{)}
            \PYG{n}{ax}\PYG{p}{[}\PYG{n}{axindex}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}yticks}\PYG{p}{(}\PYG{p}{[}\PYG{p}{]}\PYG{p}{)}
            \PYG{n}{axindex} \PYG{o}{+}\PYG{o}{=} \PYG{l+m+mi}{1}

\PYG{n}{fig}\PYG{o}{.}\PYG{n}{subplots\PYGZus{}adjust}\PYG{p}{(}\PYG{n}{right}\PYG{o}{=}\PYG{l+m+mf}{0.8}\PYG{p}{)}
\PYG{n}{cbar\PYGZus{}ax} \PYG{o}{=} \PYG{n}{fig}\PYG{o}{.}\PYG{n}{add\PYGZus{}axes}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mf}{0.85}\PYG{p}{,} \PYG{l+m+mf}{0.25}\PYG{p}{,} \PYG{l+m+mf}{0.02}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{fig}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{c}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{cax}\PYG{o}{=}\PYG{n}{cbar\PYGZus{}ax}\PYG{p}{,} \PYG{n}{shrink}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZlt{}matplotlib.colorbar.Colorbar at 0x7fc98787f4f0\PYGZgt{}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{9c5eb92e51b62c9765ecd176d8dcd1cddb7d7e4fc17cad0a6ec349697f7cc8ac}.png}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}

\section{Step 5: Writing out the file}
\label{\detokenize{CIMR_L2_Sea_Ice_Drift_preproc:step-5-writing-out-the-file}}
\sphinxAtStartPar
For ice drift, it is not possible to keep the data only internally. Since two gridded files at different timepoints are required to create each gridded map of icedrift vectors, it is necessary to write each gridded swath file to disk so that it can be read in to be compared with other gridded swath files.

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Note: It is deprecated, but the wrapper and C code still expect a input proj4\PYGZus{}string, so accept the }
\PYG{c+c1}{\PYGZsh{} deprecation warning for now.}
\PYG{k}{with} \PYG{n}{warnings}\PYG{o}{.}\PYG{n}{catch\PYGZus{}warnings}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{warnings}\PYG{o}{.}\PYG{n}{simplefilter}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ignore}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
    \PYG{n}{crs\PYGZus{}info} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{proj4\PYGZus{}string}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{new\PYGZus{}area\PYGZus{}def}\PYG{o}{.}\PYG{n}{proj4\PYGZus{}string}\PYG{p}{,}
                 \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{area\PYGZus{}id}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{new\PYGZus{}area\PYGZus{}def}\PYG{o}{.}\PYG{n}{area\PYGZus{}id}\PYG{p}{,}
                 \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{semi\PYGZus{}major\PYGZus{}axis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{6378137.}\PYG{p}{,}
                 \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{semi\PYGZus{}minor\PYGZus{}axis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{6356752.31424518}\PYG{p}{,}
                 \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{inverse\PYGZus{}flattening}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{298.257223563}\PYG{p}{,}
                 \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{reference\PYGZus{}ellipsoid\PYGZus{}name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{WGS 84}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                 \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{longitude\PYGZus{}of\PYGZus{}prime\PYGZus{}meridian}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{0.}\PYG{p}{,}
                 \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{prime\PYGZus{}meridian\PYGZus{}name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Greenwich}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                 \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{geographic\PYGZus{}crs\PYGZus{}name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{unknown}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                 \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{horizontal\PYGZus{}datum\PYGZus{}name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{World Geodetic System 1984}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                 \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{projected\PYGZus{}crs\PYGZus{}name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{unknown}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                 \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{grid\PYGZus{}mapping\PYGZus{}name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{lambert\PYGZus{}azimuthal\PYGZus{}equal\PYGZus{}area}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                 \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{latitude\PYGZus{}of\PYGZus{}projection\PYGZus{}origin}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{90.}\PYG{p}{,}
                 \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{longitude\PYGZus{}of\PYGZus{}projection\PYGZus{}origin}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{0.}\PYG{p}{,}
                 \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{false\PYGZus{}easting}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{0.}\PYG{p}{,}
                 \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{false\PYGZus{}northing}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{0.}\PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}
\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{reload}\PYG{p}{(}\PYG{n}{l2}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Get a template L2 format (netCDF/CF) from the Tools module}
\PYG{n}{ds\PYGZus{}l2} \PYG{o}{=} \PYG{n}{l2}\PYG{o}{.}\PYG{n}{get\PYGZus{}CIMR\PYGZus{}L2\PYGZus{}template}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{grid}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{geo\PYGZus{}def}\PYG{o}{=}\PYG{n}{new\PYGZus{}area\PYGZus{}def}\PYG{p}{,} \PYG{n}{add\PYGZus{}time}\PYG{o}{=}\PYG{p}{[}\PYG{n}{pdate}\PYG{o}{.}\PYG{n}{timestamp}\PYG{p}{(}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Create data arrays for the brightness temperatures, laplacian processed and status flags from the template}
\PYG{n}{shp} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{o}{*}\PYG{n}{regrid}\PYG{p}{[}\PYG{n}{fwdbck}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wbs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{]}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{n}{polarisation}\PYG{p}{[}\PYG{n}{pol}\PYG{p}{]}\PYG{p}{]}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{)}
\PYG{n}{ds\PYGZus{}tb} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
\PYG{n}{ds\PYGZus{}lap} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
\PYG{n}{ds\PYGZus{}flag} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
\PYG{k}{for} \PYG{n}{fb} \PYG{o+ow}{in} \PYG{n}{fwdbck}\PYG{p}{:}
    \PYG{n}{ds\PYGZus{}tb}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    \PYG{n}{ds\PYGZus{}lap}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    \PYG{n}{ds\PYGZus{}flag}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    \PYG{k}{for} \PYG{n}{wb} \PYG{o+ow}{in} \PYG{n}{wbs}\PYG{p}{:}
        \PYG{n}{ds\PYGZus{}tb}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
        \PYG{n}{ds\PYGZus{}lap}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
        \PYG{n}{ds\PYGZus{}flag}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
        \PYG{k}{for} \PYG{n}{pol} \PYG{o+ow}{in} \PYG{n}{pols}\PYG{p}{:}
            \PYG{n}{chan} \PYG{o}{=} \PYG{n}{algos}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{channels}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{[}\PYG{n}{polarisation}\PYG{p}{[}\PYG{n}{pol}\PYG{p}{]}\PYG{p}{]}
            \PYG{n}{ds\PYGZus{}tb}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{pol}\PYG{p}{]} \PYG{o}{=} \PYG{n}{xr}\PYG{o}{.}\PYG{n}{DataArray}\PYG{p}{(}\PYG{n}{regrid}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{n}{polarisation}\PYG{p}{[}\PYG{n}{pol}\PYG{p}{]}\PYG{p}{]}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{n}{shp}\PYG{p}{)}\PYG{p}{,}
                                              \PYG{n}{coords}\PYG{o}{=}\PYG{n}{ds\PYGZus{}l2}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{template}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{coords}\PYG{p}{,} \PYG{n}{dims}\PYG{o}{=}\PYG{n}{ds\PYGZus{}l2}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{template}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{dims}\PYG{p}{,}
                                              \PYG{n}{attrs}\PYG{o}{=}\PYG{n}{ds\PYGZus{}l2}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{template}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{,} \PYG{n}{name}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{chan}\PYG{p}{,} \PYG{n}{fb}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{ds\PYGZus{}tb}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{pol}\PYG{p}{]}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{standard\PYGZus{}name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{brightness\PYGZus{}temperature}\PYG{l+s+s1}{\PYGZsq{}}
            \PYG{n}{ds\PYGZus{}tb}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{pol}\PYG{p}{]}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{long\PYGZus{}name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Brightness temperature }\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{chan}\PYG{p}{,} \PYG{n}{fb}\PYG{p}{)}
            \PYG{n}{ds\PYGZus{}tb}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{pol}\PYG{p}{]}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{coverage\PYGZus{}content\PYGZus{}type}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{physicalMeasurement}\PYG{l+s+s1}{\PYGZsq{}}
            \PYG{n}{ds\PYGZus{}tb}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{pol}\PYG{p}{]}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{units}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{K}\PYG{l+s+s1}{\PYGZsq{}}
            \PYG{n}{ds\PYGZus{}l2} \PYG{o}{=} \PYG{n}{ds\PYGZus{}l2}\PYG{o}{.}\PYG{n}{merge}\PYG{p}{(}\PYG{n}{ds\PYGZus{}tb}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{pol}\PYG{p}{]}\PYG{p}{)}
            
            \PYG{n}{ds\PYGZus{}lap}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{pol}\PYG{p}{]} \PYG{o}{=} \PYG{n}{xr}\PYG{o}{.}\PYG{n}{DataArray}\PYG{p}{(}\PYG{n}{fv}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{n}{polarisation}\PYG{p}{[}\PYG{n}{pol}\PYG{p}{]}\PYG{p}{]}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{n}{shp}\PYG{p}{)}\PYG{p}{,}
                                               \PYG{n}{coords}\PYG{o}{=}\PYG{n}{ds\PYGZus{}l2}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{template}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{coords}\PYG{p}{,} \PYG{n}{dims}\PYG{o}{=}\PYG{n}{ds\PYGZus{}l2}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{template}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{dims}\PYG{p}{,}
                                               \PYG{n}{attrs}\PYG{o}{=}\PYG{n}{ds\PYGZus{}l2}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{template}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{,} \PYG{n}{name}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{\PYGZus{}lap}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{chan}\PYG{p}{,} \PYG{n}{fb}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{ds\PYGZus{}lap}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{pol}\PYG{p}{]}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{long\PYGZus{}name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Laplacian of brightness temperature }\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{chan}\PYG{p}{,} \PYG{n}{fb}\PYG{p}{)}
            \PYG{n}{ds\PYGZus{}lap}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{pol}\PYG{p}{]}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{coverage\PYGZus{}content\PYGZus{}type}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{auxiliaryInformation}\PYG{l+s+s1}{\PYGZsq{}}
            \PYG{n}{ds\PYGZus{}lap}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{pol}\PYG{p}{]}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{units}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{1}
            \PYG{n}{ds\PYGZus{}l2} \PYG{o}{=} \PYG{n}{ds\PYGZus{}l2}\PYG{o}{.}\PYG{n}{merge}\PYG{p}{(}\PYG{n}{ds\PYGZus{}lap}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{pol}\PYG{p}{]}\PYG{p}{)}
            
            \PYG{n}{ds\PYGZus{}flag}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{pol}\PYG{p}{]} \PYG{o}{=} \PYG{n}{xr}\PYG{o}{.}\PYG{n}{DataArray}\PYG{p}{(}\PYG{n}{flag}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{n}{polarisation}\PYG{p}{[}\PYG{n}{pol}\PYG{p}{]}\PYG{p}{]}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{n}{shp}\PYG{p}{)}\PYG{p}{,}
                                                \PYG{n}{coords}\PYG{o}{=}\PYG{n}{ds\PYGZus{}l2}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{template}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{coords}\PYG{p}{,} \PYG{n}{dims}\PYG{o}{=}\PYG{n}{ds\PYGZus{}l2}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{template}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{dims}\PYG{p}{,}
                                                \PYG{n}{attrs}\PYG{o}{=}\PYG{n}{ds\PYGZus{}l2}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{template}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{,} 
                                                \PYG{n}{name}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{\PYGZus{}lap\PYGZus{}flag}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{chan}\PYG{p}{,} \PYG{n}{fb}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{ds\PYGZus{}flag}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{pol}\PYG{p}{]}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{standard\PYGZus{}name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{status\PYGZus{}flag}\PYG{l+s+s1}{\PYGZsq{}}
            \PYG{n}{ds\PYGZus{}flag}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{pol}\PYG{p}{]}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{long\PYGZus{}name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Status flag for Laplacian of brightness temperature }\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{chan}\PYG{p}{,} \PYG{n}{fb}\PYG{p}{)}
            \PYG{n}{ds\PYGZus{}flag}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{pol}\PYG{p}{]}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{coverage\PYGZus{}content\PYGZus{}type}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{qualityInformation}\PYG{l+s+s1}{\PYGZsq{}}
            \PYG{n}{ds\PYGZus{}flag}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{pol}\PYG{p}{]}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{units}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{1}
            \PYG{n}{ds\PYGZus{}l2} \PYG{o}{=} \PYG{n}{ds\PYGZus{}l2}\PYG{o}{.}\PYG{n}{merge}\PYG{p}{(}\PYG{n}{ds\PYGZus{}flag}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{pol}\PYG{p}{]}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Create a data array for dtime from the template}
\PYG{n}{dtime} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{full\PYGZus{}like}\PYG{p}{(}\PYG{n}{regrid}\PYG{p}{[}\PYG{n}{fwdbck}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wbs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{]}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{pdate}\PYG{o}{.}\PYG{n}{timestamp}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{n}{shp}\PYG{p}{)}
\PYG{n}{ds\PYGZus{}dtime} \PYG{o}{=} \PYG{n}{xr}\PYG{o}{.}\PYG{n}{DataArray}\PYG{p}{(}\PYG{n}{dtime}\PYG{p}{,} \PYG{n}{coords}\PYG{o}{=}\PYG{n}{ds\PYGZus{}l2}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{template}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{coords}\PYG{p}{,} \PYG{n}{dims}\PYG{o}{=}\PYG{n}{ds\PYGZus{}l2}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{template}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{dims}\PYG{p}{,}
                        \PYG{n}{attrs}\PYG{o}{=}\PYG{n}{ds\PYGZus{}l2}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{template}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{,} \PYG{n}{name}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{dtime}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ds\PYGZus{}dtime}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{long\PYGZus{}name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{ds\PYGZus{}dtime}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{standard\PYGZus{}name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{time}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{ds\PYGZus{}dtime}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{coverage\PYGZus{}content\PYGZus{}type}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{auxiliaryInformation}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{ds\PYGZus{}dtime}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{units}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{seconds since 1970\PYGZhy{}01\PYGZhy{}01 00:00:00}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{ds\PYGZus{}l2} \PYG{o}{=} \PYG{n}{ds\PYGZus{}l2}\PYG{o}{.}\PYG{n}{merge}\PYG{p}{(}\PYG{n}{ds\PYGZus{}dtime}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Create a data array for ice edge from the template}
\PYG{n}{ds\PYGZus{}ie} \PYG{o}{=} \PYG{n}{xr}\PYG{o}{.}\PYG{n}{DataArray}\PYG{p}{(}\PYG{n}{ie}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{n}{shp}\PYG{p}{)}\PYG{p}{,} \PYG{n}{coords}\PYG{o}{=}\PYG{n}{ds\PYGZus{}l2}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{template}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{coords}\PYG{p}{,} \PYG{n}{dims}\PYG{o}{=}\PYG{n}{ds\PYGZus{}l2}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{template}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{dims}\PYG{p}{,}
                     \PYG{n}{attrs}\PYG{o}{=}\PYG{n}{ds\PYGZus{}l2}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{template}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{,} \PYG{n}{name}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ice\PYGZus{}edge}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ds\PYGZus{}ie}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{long\PYGZus{}name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Ice edge}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{ds\PYGZus{}ie}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{coverage\PYGZus{}content\PYGZus{}type}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{auxiliaryInformation}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{ds\PYGZus{}ie}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{units}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{1}
\PYG{n}{ds\PYGZus{}l2} \PYG{o}{=} \PYG{n}{ds\PYGZus{}l2}\PYG{o}{.}\PYG{n}{merge}\PYG{p}{(}\PYG{n}{ds\PYGZus{}ie}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Create a data array for time, needed by the C code}
\PYG{n}{timedata} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{full\PYGZus{}like}\PYG{p}{(}\PYG{n}{regrid}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{pdate}\PYG{o}{.}\PYG{n}{timestamp}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{ds\PYGZus{}l2}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{vtime}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{p}{(}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{time}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,} \PYG{n}{timedata}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{ds\PYGZus{}l2}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{time}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{attrs} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{units}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{seconds since 1970\PYGZhy{}01\PYGZhy{}01 00:00:00}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{\PYGZcb{}}
\PYG{n}{ds\PYGZus{}l2}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{long\PYGZus{}name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Time}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{ds\PYGZus{}l2}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{coverage\PYGZus{}content\PYGZus{}type}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{auxiliaryInformation}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{ds\PYGZus{}l2}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{units}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{seconds since 1970\PYGZhy{}01\PYGZhy{}01 00:00:00}\PYG{l+s+s2}{\PYGZdq{}}

\PYG{c+c1}{\PYGZsh{} Customize the global attributes}
\PYG{n}{ds\PYGZus{}l2}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{title}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{CIMR intermediate brightness temperatures for ice drift calculation}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{ds\PYGZus{}l2}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{summary}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Intermediate brightness temperatures and Laplacian\PYGZhy{}processed fields with their status flags, written as intermadiate\PYGZhy{}processing file for ice drift calculations}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{ds\PYGZus{}l2}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{l1b\PYGZus{}file}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{l1bfn}
\PYG{n}{ds\PYGZus{}l2}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{algorithm\PYGZus{}version}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{algo\PYGZus{}version}
\PYG{n}{ds\PYGZus{}l2}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{creator\PYGZus{}name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Emily Down}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{ds\PYGZus{}l2}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{creator\PYGZus{}email}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{emilyjd@met.no}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{ds\PYGZus{}l2}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{institution}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Norwegian Meteorological Institute}\PYG{l+s+s1}{\PYGZsq{}}

\PYG{c+c1}{\PYGZsh{} CRS information needed for C code}
\PYG{n}{ds\PYGZus{}l2}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{crs}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{attrs} \PYG{o}{=} \PYG{n}{crs\PYGZus{}info}

\PYG{c+c1}{\PYGZsh{} Need to rename x and y to xc and yc for X code}
\PYG{n}{ds\PYGZus{}l2}\PYG{o}{=} \PYG{n}{ds\PYGZus{}l2}\PYG{o}{.}\PYG{n}{rename}\PYG{p}{(}\PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{x}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{xc}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{yc}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{\PYGZcb{}}\PYG{p}{)}
    
\PYG{c+c1}{\PYGZsh{} Remove the \PYGZsq{}template\PYGZsq{} variable (we don\PYGZsq{}t need it anymore)}
\PYG{c+c1}{\PYGZsh{}ds\PYGZus{}l2 = ds\PYGZus{}l2.drop(\PYGZsq{}template\PYGZsq{})}

\PYG{c+c1}{\PYGZsh{} Write to file}
\PYG{n}{dsname} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{procpath}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{bt\PYGZus{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{\PYGZus{}}\PYG{l+s+s1}{\PYGZob{}}\PYG{l+s+s1}{:}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{Y}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{m}\PYG{l+s+si}{\PYGZpc{}d}\PYG{l+s+s1}{\PYGZcb{}.nc}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{gridname}\PYG{p}{,} \PYG{n}{pdate}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{ds\PYGZus{}l2}\PYG{o}{.}\PYG{n}{to\PYGZus{}netcdf}\PYG{p}{(}\PYG{n}{dsname}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{w}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n+nb}{format}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{NETCDF4\PYGZus{}CLASSIC}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Written }\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{dsname}\PYG{p}{)}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Setting this up for potential reruns}
\PYG{n}{ds\PYGZus{}l2\PYGZus{}copy} \PYG{o}{=} \PYG{n}{ds\PYGZus{}l2}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
Written /home/emilyjd/cimr\PYGZhy{}devalgo/SeaIceDrift\PYGZus{}ATBD\PYGZus{}v2/algorithm/../../data/processing/bt\PYGZus{}nh\PYGZhy{}ease2\PYGZhy{}050\PYGZus{}20280110.nc
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}

\section{Step 6 (temporary): Creating a test gridded file with “time difference” 24h and pixel shifts added in each x and y}
\label{\detokenize{CIMR_L2_Sea_Ice_Drift_preproc:step-6-temporary-creating-a-test-gridded-file-with-time-difference-24h-and-pixel-shifts-added-in-each-x-and-y}}
\sphinxAtStartPar
This is a temporary part of this notebook, to create a “test” file with different gridded brightness temperatures and a different timepoint. This is required for calculation of ice drift vectors. In this example, a constant shift of +3 pixels in the x\sphinxhyphen{}direction and +4 pixels in the y\sphinxhyphen{}direction is chosen. In operation, two swaths at different timepoints will be processed in the algorithm to retrieve the icedrift.

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Create a shifted file with fixed pixels.}

\PYG{c+c1}{\PYGZsh{} Take a copy of the data xarray}
\PYG{n}{ds\PYGZus{}shift} \PYG{o}{=} \PYG{n}{ds\PYGZus{}l2\PYGZus{}copy}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Add the Laplacian mask variable}
\PYG{n}{ds\PYGZus{}msk} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
\PYG{n}{ds\PYGZus{}msk} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
\PYG{n}{ds\PYGZus{}msk} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
\PYG{k}{for} \PYG{n}{fb} \PYG{o+ow}{in} \PYG{n}{fwdbck}\PYG{p}{:}
    \PYG{n}{ds\PYGZus{}msk}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    \PYG{k}{for} \PYG{n}{wb} \PYG{o+ow}{in} \PYG{n}{wbs}\PYG{p}{:}
        \PYG{n}{ds\PYGZus{}msk}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
        \PYG{k}{for} \PYG{n}{pol} \PYG{o+ow}{in} \PYG{n}{pols}\PYG{p}{:}
            \PYG{n}{chan} \PYG{o}{=} \PYG{n}{algos}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{channels}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{[}\PYG{n}{polarisation}\PYG{p}{[}\PYG{n}{pol}\PYG{p}{]}\PYG{p}{]}
            \PYG{n}{ds\PYGZus{}msk}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{pol}\PYG{p}{]} \PYG{o}{=} \PYG{n}{xr}\PYG{o}{.}\PYG{n}{DataArray}\PYG{p}{(}\PYG{n}{fv}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{n}{polarisation}\PYG{p}{[}\PYG{n}{pol}\PYG{p}{]}\PYG{p}{]}\PYG{o}{.}\PYG{n}{mask}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{n}{shp}\PYG{p}{)}\PYG{p}{,}
                                               \PYG{n}{coords}\PYG{o}{=}\PYG{n}{ds\PYGZus{}shift}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{template}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{coords}\PYG{p}{,} \PYG{n}{dims}\PYG{o}{=}\PYG{n}{ds\PYGZus{}shift}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{template}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{dims}\PYG{p}{,}
                                               \PYG{n}{attrs}\PYG{o}{=}\PYG{n}{ds\PYGZus{}shift}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{template}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{,} \PYG{n}{name}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{\PYGZus{}msk}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{chan}\PYG{p}{,} \PYG{n}{fb}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{ds\PYGZus{}msk}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{pol}\PYG{p}{]}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{long\PYGZus{}name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Mask for Laplacian of brightness temperature }\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{chan}\PYG{p}{,} \PYG{n}{fb}\PYG{p}{)}
            \PYG{n}{ds\PYGZus{}msk}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{pol}\PYG{p}{]}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{coverage\PYGZus{}content\PYGZus{}type}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{auxiliaryInformation}\PYG{l+s+s1}{\PYGZsq{}}
            \PYG{n}{ds\PYGZus{}msk}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{pol}\PYG{p}{]}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{units}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{1}
            \PYG{n}{ds\PYGZus{}shift} \PYG{o}{=} \PYG{n}{ds\PYGZus{}shift}\PYG{o}{.}\PYG{n}{merge}\PYG{p}{(}\PYG{n}{ds\PYGZus{}msk}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{pol}\PYG{p}{]}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Shifting the data pixels of the arrays}
\PYG{n}{ds\PYGZus{}shift\PYGZus{}tb} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
\PYG{n}{ds\PYGZus{}shift\PYGZus{}lap} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
\PYG{n}{ds\PYGZus{}shift\PYGZus{}flag} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
\PYG{k}{for} \PYG{n}{fb} \PYG{o+ow}{in} \PYG{n}{fwdbck}\PYG{p}{:}
    \PYG{n}{ds\PYGZus{}shift\PYGZus{}tb}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    \PYG{n}{ds\PYGZus{}shift\PYGZus{}lap}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    \PYG{n}{ds\PYGZus{}shift\PYGZus{}flag}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    \PYG{k}{for} \PYG{n}{wb} \PYG{o+ow}{in} \PYG{n}{wbs}\PYG{p}{:}
        \PYG{n}{ds\PYGZus{}shift\PYGZus{}tb}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
        \PYG{n}{ds\PYGZus{}shift\PYGZus{}lap}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
        \PYG{n}{ds\PYGZus{}shift\PYGZus{}flag}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
        \PYG{k}{for} \PYG{n}{pol} \PYG{o+ow}{in} \PYG{n}{pols}\PYG{p}{:}
            \PYG{n}{chan} \PYG{o}{=} \PYG{n}{algos}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{channels}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{[}\PYG{n}{polarisation}\PYG{p}{[}\PYG{n}{pol}\PYG{p}{]}\PYG{p}{]}
            \PYG{c+c1}{\PYGZsh{} Shift can be used in xarray to shift dimension by number of pix. Note that the dimensions must be}
            \PYG{c+c1}{\PYGZsh{} called x and y within xarray}
            \PYG{n}{chan} \PYG{o}{=} \PYG{n}{algos}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{channels}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{[}\PYG{n}{polarisation}\PYG{p}{[}\PYG{n}{pol}\PYG{p}{]}\PYG{p}{]}
            \PYG{n}{tbname} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{chan}\PYG{p}{,} \PYG{n}{fb}\PYG{p}{)}
            \PYG{n}{ds\PYGZus{}shift\PYGZus{}tb}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]} \PYG{o}{=} \PYG{n}{ds\PYGZus{}shift}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{n}{tbname}\PYG{p}{)}\PYG{o}{.}\PYG{n}{shift}\PYG{p}{(}\PYG{n}{xc}\PYG{o}{=}\PYG{n}{pixshx}\PYG{p}{,} \PYG{n}{yc}\PYG{o}{=}\PYG{n}{pixshy}\PYG{p}{)}
            \PYG{n}{ds\PYGZus{}shift}\PYG{p}{[}\PYG{n}{tbname}\PYG{p}{]}\PYG{o}{.}\PYG{n}{data} \PYG{o}{=} \PYG{n}{ds\PYGZus{}shift\PYGZus{}tb}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}
            \PYG{c+c1}{\PYGZsh{} Shifting the Laplacian field}
            \PYG{n}{lapname} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{\PYGZus{}lap}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{chan}\PYG{p}{,} \PYG{n}{fb}\PYG{p}{)}
            \PYG{n}{ds\PYGZus{}shift\PYGZus{}lap}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]} \PYG{o}{=} \PYG{n}{ds\PYGZus{}shift}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{n}{lapname}\PYG{p}{)}\PYG{o}{.}\PYG{n}{shift}\PYG{p}{(}\PYG{n}{xc}\PYG{o}{=}\PYG{n}{pixshx}\PYG{p}{,} \PYG{n}{yc}\PYG{o}{=}\PYG{n}{pixshy}\PYG{p}{)}
            \PYG{n}{ds\PYGZus{}shift}\PYG{p}{[}\PYG{n}{lapname}\PYG{p}{]}\PYG{o}{.}\PYG{n}{data} \PYG{o}{=} \PYG{n}{ds\PYGZus{}shift\PYGZus{}lap}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}
            \PYG{c+c1}{\PYGZsh{} Flag field (want the data shifted, the landmask not)  }
            \PYG{n}{flagname} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{\PYGZus{}lap\PYGZus{}flag}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{chan}\PYG{p}{,} \PYG{n}{fb}\PYG{p}{)}
            \PYG{n}{ds\PYGZus{}shift\PYGZus{}flag}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros\PYGZus{}like}\PYG{p}{(}\PYG{n}{ds\PYGZus{}shift\PYGZus{}lap}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{)}
            \PYG{c+c1}{\PYGZsh{} Masking where the Laplacian failed}
            \PYG{n}{maskname} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{\PYGZus{}msk}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{chan}\PYG{p}{,} \PYG{n}{fb}\PYG{p}{)}
            \PYG{n}{fmsk\PYGZus{}shft} \PYG{o}{=} \PYG{n}{ds\PYGZus{}shift}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{n}{maskname}\PYG{p}{)}\PYG{o}{.}\PYG{n}{shift}\PYG{p}{(}\PYG{n}{xc}\PYG{o}{=}\PYG{n}{pixshx}\PYG{p}{,} \PYG{n}{yc}\PYG{o}{=}\PYG{n}{pixshy}\PYG{p}{)}
            \PYG{n}{ds\PYGZus{}shift\PYGZus{}flag}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{fmsk\PYGZus{}shft} \PYG{o}{==} \PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}
            \PYG{c+c1}{\PYGZsh{} Masking where the land and ocean is}
            \PYG{n}{landocean} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{logical\PYGZus{}or}\PYG{p}{(}\PYG{n}{ie} \PYG{o}{==} \PYG{l+m+mi}{9}\PYG{p}{,} \PYG{n}{ie} \PYG{o}{==} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{n}{shp}\PYG{p}{)}
            \PYG{p}{(}\PYG{n}{ds\PYGZus{}shift\PYGZus{}flag}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{)}\PYG{p}{[}\PYG{n}{landocean}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{1}
            \PYG{n}{ds\PYGZus{}shift}\PYG{p}{[}\PYG{n}{flagname}\PYG{p}{]}\PYG{o}{.}\PYG{n}{data} \PYG{o}{=} \PYG{n}{ds\PYGZus{}shift\PYGZus{}flag}\PYG{p}{[}\PYG{n}{fb}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Shift time by 24h}
\PYG{n}{ds\PYGZus{}shift}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{dtime}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{data} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{full\PYGZus{}like}\PYG{p}{(}\PYG{n}{regrid}\PYG{p}{[}\PYG{n}{fwdbck}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{]}\PYG{p}{[}\PYG{n}{wbs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{]}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{qdate}\PYG{o}{.}\PYG{n}{timestamp}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{n}{shp}\PYG{p}{)}
\PYG{n}{ds\PYGZus{}shift}\PYG{o}{.}\PYG{n}{assign\PYGZus{}coords}\PYG{p}{(}\PYG{n}{time} \PYG{o}{=} \PYG{p}{[}\PYG{n}{qdate}\PYG{o}{.}\PYG{n}{timestamp}\PYG{p}{(}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Remove the mask variables (we don\PYGZsq{}t need them anymore)}
\PYG{k}{for} \PYG{n}{fb} \PYG{o+ow}{in} \PYG{n}{fwdbck}\PYG{p}{:}
    \PYG{k}{for} \PYG{n}{wb} \PYG{o+ow}{in} \PYG{n}{wbs}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{pol} \PYG{o+ow}{in} \PYG{n}{pols}\PYG{p}{:}
            \PYG{n}{chan} \PYG{o}{=} \PYG{n}{algos}\PYG{p}{[}\PYG{n}{wb}\PYG{p}{]}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{channels}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{[}\PYG{n}{polarisation}\PYG{p}{[}\PYG{n}{pol}\PYG{p}{]}\PYG{p}{]}
            \PYG{n}{maskname} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{\PYGZus{}msk}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{chan}\PYG{p}{,} \PYG{n}{fb}\PYG{p}{)}
            \PYG{n}{ds\PYGZus{}shift} \PYG{o}{=} \PYG{n}{ds\PYGZus{}shift}\PYG{o}{.}\PYG{n}{drop\PYGZus{}vars}\PYG{p}{(}\PYG{n}{maskname}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Write to file}
\PYG{n}{dsname2} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{procpath}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{bt\PYGZus{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{\PYGZus{}}\PYG{l+s+s1}{\PYGZob{}}\PYG{l+s+s1}{:}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{Y}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{m}\PYG{l+s+si}{\PYGZpc{}d}\PYG{l+s+s1}{\PYGZcb{}.nc}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{gridname}\PYG{p}{,} \PYG{n}{qdate}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{ds\PYGZus{}shift}\PYG{o}{.}\PYG{n}{to\PYGZus{}netcdf}\PYG{p}{(}\PYG{n}{dsname2}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{w}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n+nb}{format}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{NETCDF4\PYGZus{}CLASSIC}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Written }\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{dsname2}\PYG{p}{)}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
Written /home/emilyjd/cimr\PYGZhy{}devalgo/SeaIceDrift\PYGZus{}ATBD\PYGZus{}v2/algorithm/../../data/processing/bt\PYGZus{}nh\PYGZhy{}ease2\PYGZhy{}050\PYGZus{}20280111.nc
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}
\sphinxstepscope


\chapter{Algorithm}
\label{\detokenize{CIMR_L2_Sea_Ice_Drift_algorithm:algorithm}}\label{\detokenize{CIMR_L2_Sea_Ice_Drift_algorithm::doc}}
\sphinxAtStartPar
This notebook implements a prototype for a Level\sphinxhyphen{}2 SIED algorithm for the CIMR mission.

\sphinxAtStartPar
We refer to the corresponding \sphinxhref{https://cimr-algos.github.io/SeaIceDrift\_ATBD/intro.html}{ATBD} and especially the \sphinxhref{https://cimr-algos.github.io/SeaIceDrift\_ATBD/baseline\_algorithm\_definition.html\#baseline-algorithm-definition}{Baseline Algorithm Definition}.

\sphinxAtStartPar
In particular, the figure below illustrates the overall concept of the processing:



\section{Settings}
\label{\detokenize{CIMR_L2_Sea_Ice_Drift_algorithm:settings}}
\sphinxAtStartPar
Imports and general settings

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{o}{\PYGZpc{}}\PYG{k}{load\PYGZus{}ext} cython
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}
\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Paths}

\PYG{c+c1}{\PYGZsh{} Getting the path of the notebook (NOTE: not totally safe)}

\PYG{c+c1}{\PYGZsh{} The paths assume that there is an umbrella CIMR directory (of any name) containing SeaIceDrift\PYGZus{}ATBD\PYGZus{}v2/ ,}
\PYG{c+c1}{\PYGZsh{} the CIMR Tools/ directory, and a directory data/L1B/ containing the L1B data, and data/conc/ containing}
\PYG{c+c1}{\PYGZsh{} a concentration file}
\PYG{k+kn}{import} \PYG{n+nn}{os}
\PYG{n}{cpath} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{os}\PYG{o}{.}\PYG{n}{getcwd}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{../..}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{algpath} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{cpath}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{SeaIceDrift\PYGZus{}ATBD\PYGZus{}v2/algorithm/src\PYGZus{}sied}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{toolpath} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{cpath}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Tools}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{l1bpath} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{cpath}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{data/L1B}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{griddeffile} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{cpath}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Overall\PYGZus{}ATBD/etc/grids\PYGZus{}py.def}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Processing directories}
\PYG{n}{procpath} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{cpath}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{data/processing}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{driftpath} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{cpath}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{data/icedrift}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{logpath} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{cpath}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{data/logs}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{figpath} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{cpath}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{data/figs}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}
\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Imports}

\PYG{k+kn}{from} \PYG{n+nn}{importlib} \PYG{k+kn}{import} \PYG{n}{reload}
\PYG{k+kn}{import} \PYG{n+nn}{sys}
\PYG{k+kn}{import} \PYG{n+nn}{shutil}
\PYG{k+kn}{import} \PYG{n+nn}{warnings}
\PYG{k+kn}{import} \PYG{n+nn}{math}
\PYG{k+kn}{import} \PYG{n+nn}{numpy} \PYG{k}{as} \PYG{n+nn}{np}
\PYG{k+kn}{import} \PYG{n+nn}{numpy}\PYG{n+nn}{.}\PYG{n+nn}{ma} \PYG{k}{as} \PYG{n+nn}{ma}
\PYG{k+kn}{import} \PYG{n+nn}{xarray} \PYG{k}{as} \PYG{n+nn}{xr}
\PYG{c+c1}{\PYGZsh{}from netCDF4 import Dataset}
\PYG{k+kn}{from} \PYG{n+nn}{matplotlib} \PYG{k+kn}{import} \PYG{n}{pylab} \PYG{k}{as} \PYG{n}{plt}
\PYG{k+kn}{import} \PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{ticker} \PYG{k}{as} \PYG{n+nn}{mticker}
\PYG{k+kn}{from} \PYG{n+nn}{mpl\PYGZus{}toolkits}\PYG{n+nn}{.}\PYG{n+nn}{axes\PYGZus{}grid1}\PYG{n+nn}{.}\PYG{n+nn}{axes\PYGZus{}divider} \PYG{k+kn}{import} \PYG{n}{make\PYGZus{}axes\PYGZus{}locatable}
\PYG{k+kn}{import} \PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{cm} \PYG{k}{as} \PYG{n+nn}{cm}
\PYG{c+c1}{\PYGZsh{}import cmocean}
\PYG{c+c1}{\PYGZsh{}import cartopy}
\PYG{k+kn}{import} \PYG{n+nn}{cartopy}\PYG{n+nn}{.}\PYG{n+nn}{crs} \PYG{k}{as} \PYG{n+nn}{ccrs}
\PYG{k+kn}{from} \PYG{n+nn}{pyresample} \PYG{k+kn}{import} \PYG{n}{parse\PYGZus{}area\PYGZus{}file}
\PYG{k+kn}{from} \PYG{n+nn}{datetime} \PYG{k+kn}{import} \PYG{n}{datetime}\PYG{p}{,} \PYG{n}{timedelta}
\PYG{k+kn}{from} \PYG{n+nn}{dateutil}\PYG{n+nn}{.}\PYG{n+nn}{relativedelta} \PYG{k+kn}{import} \PYG{n}{relativedelta}

\PYG{c+c1}{\PYGZsh{} Local modules contain software code that implement the SIED algorithm}
\PYG{k}{if} \PYG{n}{algpath} \PYG{o+ow}{not} \PYG{o+ow}{in} \PYG{n}{sys}\PYG{o}{.}\PYG{n}{path}\PYG{p}{:}
    \PYG{n}{sys}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{insert}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{algpath}\PYG{p}{)}
\PYG{k+kn}{from} \PYG{n+nn}{icedrift\PYGZus{}wrapper} \PYG{k+kn}{import} \PYG{n}{icedrift\PYGZus{}wrapper}
\PYG{c+c1}{\PYGZsh{}from process\PYGZus{}ice\PYGZus{}mask import process\PYGZus{}ice\PYGZus{}mask}
\PYG{c+c1}{\PYGZsh{}from cp\PYGZus{}and\PYGZus{}date\PYGZus{}change\PYGZus{}iceconc import cp\PYGZus{}and\PYGZus{}date\PYGZus{}change\PYGZus{}iceconc}

\PYG{c+c1}{\PYGZsh{} Prototype re\PYGZhy{}gridding toolbox to handle the L1B input}
\PYG{k}{if} \PYG{n}{toolpath} \PYG{o+ow}{not} \PYG{o+ow}{in} \PYG{n}{sys}\PYG{o}{.}\PYG{n}{path}\PYG{p}{:}
    \PYG{n}{sys}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{insert}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{toolpath}\PYG{p}{)}
\PYG{c+c1}{\PYGZsh{}from tools import io\PYGZus{}handler as io}
\PYG{c+c1}{\PYGZsh{}from tools import collocation as coll}
\PYG{k+kn}{from} \PYG{n+nn}{tools} \PYG{k+kn}{import} \PYG{n}{l2\PYGZus{}format} \PYG{k}{as} \PYG{n}{l2}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}
\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Plot settings}

\PYG{k+kn}{import} \PYG{n+nn}{matplotlib}
\PYG{n}{matplotlib}\PYG{o}{.}\PYG{n}{rc}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{xtick}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{labelsize}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)} 
\PYG{n}{matplotlib}\PYG{o}{.}\PYG{n}{rc}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ytick}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{labelsize}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)} 
\PYG{n}{matplotlib}\PYG{o}{.}\PYG{n}{rcParams}\PYG{o}{.}\PYG{n}{update}\PYG{p}{(}\PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{font.size}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{12}\PYG{p}{\PYGZcb{}}\PYG{p}{)}
\PYG{n}{matplotlib}\PYG{o}{.}\PYG{n}{rcParams}\PYG{o}{.}\PYG{n}{update}\PYG{p}{(}\PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{axes.labelsize}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{12}\PYG{p}{\PYGZcb{}}\PYG{p}{)}

\PYG{n}{font} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{family}\PYG{l+s+s1}{\PYGZsq{}} \PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{sans}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{weight}\PYG{l+s+s1}{\PYGZsq{}} \PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{normal}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{size}\PYG{l+s+s1}{\PYGZsq{}}   \PYG{p}{:} \PYG{l+m+mi}{12}\PYG{p}{\PYGZcb{}}
\PYG{n}{matplotlib}\PYG{o}{.}\PYG{n}{rc}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{font}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{o}{*}\PYG{o}{*}\PYG{n}{font}\PYG{p}{)}

\PYG{n}{cmap} \PYG{o}{=} \PYG{n}{cm}\PYG{o}{.}\PYG{n}{viridis}
\PYG{c+c1}{\PYGZsh{}cmapland = matplotlib.colors.ListedColormap([\PYGZsq{}none\PYGZsq{}, \PYGZsq{}grey\PYGZsq{}])}

\PYG{n}{gridtype} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ease}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{gridin} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{\PYGZhy{}ease2\PYGZhy{}050}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{gridout} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{\PYGZhy{}ease2\PYGZhy{}250}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{c+c1}{\PYGZsh{} Some region parameters hard\PYGZhy{}coded to show only the relevant region}
\PYG{c+c1}{\PYGZsh{} Overall shape of input grid (4320, 4320)}
\PYG{c+c1}{\PYGZsh{}sl = (1050, 1400, 1050, 1400)}
\PYG{n}{slo} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{200}\PYG{p}{,} \PYG{l+m+mi}{290}\PYG{p}{,} \PYG{l+m+mi}{200}\PYG{p}{,} \PYG{l+m+mi}{290}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} EASE plotting region}
\PYG{n}{lon\PYGZus{}min} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{15}
\PYG{n}{lon\PYGZus{}max} \PYG{o}{=} \PYG{l+m+mi}{95}
\PYG{n}{lat\PYGZus{}min} \PYG{o}{=} \PYG{l+m+mi}{74}
\PYG{n}{lat\PYGZus{}max} \PYG{o}{=} \PYG{l+m+mi}{90}

\PYG{c+c1}{\PYGZsh{} Settings for gridlines}
\PYG{n}{lon\PYGZus{}step} \PYG{o}{=} \PYG{l+m+mi}{10}
\PYG{n}{lat\PYGZus{}step} \PYG{o}{=} \PYG{l+m+mi}{5}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}

\section{Parametrize the run}
\label{\detokenize{CIMR_L2_Sea_Ice_Drift_algorithm:parametrize-the-run}}
\sphinxAtStartPar
User\sphinxhyphen{}set parameters for the running of the whole notebook. Note that here a helper script is used to copy a starter ice concentration file from the MET Norway thredds server and change the dates in this. The date changes are required due to the sample input file having a date in the future (2028).

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{hemi} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{nh}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{c+c1}{\PYGZsh{}algos = \PYGZob{}\PYGZsq{}KU\PYGZsq{}: \PYGZob{}\PYGZsq{}channels\PYGZsq{}:(\PYGZsq{}tb19v\PYGZsq{}, \PYGZsq{}tb19h\PYGZsq{}), \PYGZsq{}target\PYGZus{}band\PYGZsq{}:\PYGZsq{}KU\PYGZsq{}\PYGZcb{},}
\PYG{c+c1}{\PYGZsh{}         \PYGZsq{}KA\PYGZsq{}: \PYGZob{}\PYGZsq{}channels\PYGZsq{}:(\PYGZsq{}tb37v\PYGZsq{}, \PYGZsq{}tb37h\PYGZsq{}), \PYGZsq{}target\PYGZus{}band\PYGZsq{}:\PYGZsq{}KA\PYGZsq{}\PYGZcb{}\PYGZcb{}}
\PYG{c+c1}{\PYGZsh{}wbs = list(algos.keys())}
\PYG{c+c1}{\PYGZsh{}fwdbck = [\PYGZsq{}fw\PYGZsq{}, \PYGZsq{}bk\PYGZsq{}]}
\PYG{c+c1}{\PYGZsh{}polarisation = \PYGZob{}\PYGZsq{}V\PYGZsq{}: 0, \PYGZsq{}H\PYGZsq{}: 1\PYGZcb{}}
\PYG{c+c1}{\PYGZsh{}pols = list(polarisation.keys())}

\PYG{n}{test\PYGZus{}card} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{radiometric}\PYG{l+s+s2}{\PYGZdq{}}
\PYG{k}{if} \PYG{n}{test\PYGZus{}card} \PYG{o}{==} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{geometric}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} DEVALGO\PYGZsq{}s simulated geometric test card}
    \PYG{n}{l1bfn} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{W\PYGZus{}PT\PYGZhy{}DME\PYGZhy{}Lisbon\PYGZhy{}SAT\PYGZhy{}CIMR\PYGZhy{}1B\PYGZus{}C\PYGZus{}DME\PYGZus{}20230417T105425\PYGZus{}LD\PYGZus{}20280110T114800\PYGZus{}20280110T115700\PYGZus{}TN.nc}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{k}{elif} \PYG{n}{test\PYGZus{}card} \PYG{o}{==} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{radiometric}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} DEVALGO\PYGZsq{}s simulated radiometric test card}
    \PYG{n}{l1bfn} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{W\PYGZus{}PT\PYGZhy{}DME\PYGZhy{}Lisbon\PYGZhy{}SAT\PYGZhy{}CIMR\PYGZhy{}1B\PYGZus{}C\PYGZus{}DME\PYGZus{}20230420T103323\PYGZus{}LD\PYGZus{}20280110T114800\PYGZus{}20280110T115700\PYGZus{}TN.nc}\PYG{l+s+s1}{\PYGZsq{}}

\PYG{c+c1}{\PYGZsh{}dt = datetime.strptime(\PYGZsq{}20230420T103323\PYGZsq{}, \PYGZsq{}\PYGZpc{}Y\PYGZpc{}m\PYGZpc{}dT\PYGZpc{}H\PYGZpc{}M\PYGZpc{}S\PYGZsq{})}

\PYG{n}{l1bfile} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{l1bpath}\PYG{p}{,} \PYG{n}{l1bfn}\PYG{p}{)}

\PYG{n}{pdate} \PYG{o}{=} \PYG{n}{datetime}\PYG{o}{.}\PYG{n}{strptime}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{20280110}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{Y}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{m}\PYG{l+s+si}{\PYGZpc{}d}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{tdate} \PYG{o}{=} \PYG{n}{pdate} \PYG{o}{\PYGZhy{}} \PYG{n}{relativedelta}\PYG{p}{(}\PYG{n}{years}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}
\PYG{n}{qdate} \PYG{o}{=} \PYG{n}{pdate} \PYG{o}{+} \PYG{n}{timedelta}\PYG{p}{(}\PYG{n}{days}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Icemask data and output locations}
\PYG{c+c1}{\PYGZsh{}icemaskinputdir = \PYGZsq{}https://thredds.met.no/thredds/dodsC/osisaf/met.no/reprocessed/ice/conc\PYGZus{}450a\PYGZus{}files/\PYGZob{}:\PYGZpc{}Y\PYGZcb{}/\PYGZob{}:\PYGZpc{}m\PYGZcb{}\PYGZsq{}.format(tdate, tdate)}
\PYG{c+c1}{\PYGZsh{}icemaskinputfile = \PYGZsq{}ice\PYGZus{}conc\PYGZus{}\PYGZob{}\PYGZcb{}\PYGZus{}ease2\PYGZhy{}250\PYGZus{}cdr\PYGZhy{}v3p0\PYGZus{}\PYGZob{}:\PYGZpc{}Y\PYGZpc{}m\PYGZpc{}d\PYGZcb{}1200.nc\PYGZsq{}.format(hemi, tdate)}
\PYG{c+c1}{\PYGZsh{}icemaskinput = cp\PYGZus{}and\PYGZus{}date\PYGZus{}change\PYGZus{}iceconc(os.path.join(icemaskinputdir, icemaskinputfile), concpath, pdate)}

\PYG{n}{algo\PYGZus{}version} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{0.1}\PYG{l+s+s1}{\PYGZsq{}}

\PYG{n}{plotfigs} \PYG{o}{=} \PYG{k+kc}{True}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}

\section{Step 1: Cross\sphinxhyphen{}correlation algorithm to find ice drift}
\label{\detokenize{CIMR_L2_Sea_Ice_Drift_algorithm:step-1-cross-correlation-algorithm-to-find-ice-drift}}
\sphinxAtStartPar
For the Continuous Maximum Cross\sphinxhyphen{}Correlation algorithm, two brightness temperature gridded files, enhanced by the Laplacian algorithm and with different timestamps, are required. The algorithm matches features between these images on a fractional pixel grid.

\sphinxAtStartPar
The steps of the cross\sphinxhyphen{}correlation algorithm are:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
Determination of which pixels should be included in the cross\sphinxhyphen{}correlation, excluding land and ocean pixels.

\item {} 
\sphinxAtStartPar
Fractional pixel cross\sphinxhyphen{}correlation simultaneously on the gridded swaths \sphinxhyphen{} forward/back scans, V and H polarisations, K and Ka channels.

\item {} 
\sphinxAtStartPar
Correction of erroneous vectors using the nearest neighbour method and creation of status flags.

\end{enumerate}

\sphinxAtStartPar
Currently the C code has limited memory for channels, so the Ka\sphinxhyphen{}band forward and backward scans with V and H polarisations are accepted by the code. It should be possible to add K\sphinxhyphen{}band later.

\sphinxAtStartPar
In addition, the forward and backward scans are treated here as having the same timestamp, later it can be refined to include the 7\sphinxhyphen{}minute delay between these two.

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Copying the files with new names, to interface with the C\PYGZhy{}code}

\PYG{n}{gridname} \PYG{o}{=} \PYG{n}{gridin}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{hemi}\PYG{p}{)}
\PYG{n}{chanstr} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{tb19hfw\PYGZhy{}tb19vfw\PYGZhy{}tb19hbk\PYGZhy{}tb19vbk\PYGZhy{}tb37hfw\PYGZhy{}tb37vfw\PYGZhy{}tb37hbk\PYGZhy{}tb37vbk}\PYG{l+s+s1}{\PYGZsq{}}

\PYG{n}{dsname} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{procpath}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{bt\PYGZus{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{\PYGZus{}}\PYG{l+s+s1}{\PYGZob{}}\PYG{l+s+s1}{:}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{Y}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{m}\PYG{l+s+si}{\PYGZpc{}d}\PYG{l+s+s1}{\PYGZcb{}.nc}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{gridname}\PYG{p}{,} \PYG{n}{pdate}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{dsname2} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{procpath}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{bt\PYGZus{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{\PYGZus{}}\PYG{l+s+s1}{\PYGZob{}}\PYG{l+s+s1}{:}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{Y}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{m}\PYG{l+s+si}{\PYGZpc{}d}\PYG{l+s+s1}{\PYGZcb{}.nc}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{gridname}\PYG{p}{,} \PYG{n}{qdate}\PYG{p}{)}\PYG{p}{)}

\PYG{n}{newname1} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{tc\PYGZus{}wght\PYGZus{}cimr\PYGZhy{}cimr\PYGZus{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{\PYGZus{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{\PYGZus{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{12.nc}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{chanstr}\PYG{p}{,} \PYG{n}{gridin}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{hemi}\PYG{p}{)}\PYG{p}{,} \PYG{n}{datetime}\PYG{o}{.}\PYG{n}{strftime}\PYG{p}{(}\PYG{n}{pdate}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{Y}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{m}\PYG{l+s+si}{\PYGZpc{}d}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{newname2} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{tc\PYGZus{}wght\PYGZus{}cimr\PYGZhy{}cimr\PYGZus{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{\PYGZus{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{\PYGZus{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{12.nc}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{chanstr}\PYG{p}{,} \PYG{n}{gridin}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{hemi}\PYG{p}{)}\PYG{p}{,} \PYG{n}{datetime}\PYG{o}{.}\PYG{n}{strftime}\PYG{p}{(}\PYG{n}{qdate}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{Y}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{m}\PYG{l+s+si}{\PYGZpc{}d}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{shutil}\PYG{o}{.}\PYG{n}{copyfile}\PYG{p}{(}\PYG{n}{dsname}\PYG{p}{,} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{dirname}\PYG{p}{(}\PYG{n}{dsname}\PYG{p}{)}\PYG{p}{,} \PYG{n}{newname1}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{shutil}\PYG{o}{.}\PYG{n}{copyfile}\PYG{p}{(}\PYG{n}{dsname2}\PYG{p}{,} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{dirname}\PYG{p}{(}\PYG{n}{dsname}\PYG{p}{)}\PYG{p}{,} \PYG{n}{newname2}\PYG{p}{)}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYGZsq{}/home/emilyjd/cimr\PYGZhy{}devalgo/SeaIceDrift\PYGZus{}ATBD\PYGZus{}v2/algorithm/../../data/processing/tc\PYGZus{}wght\PYGZus{}cimr\PYGZhy{}cimr\PYGZus{}tb19hfw\PYGZhy{}tb19vfw\PYGZhy{}tb19hbk\PYGZhy{}tb19vbk\PYGZhy{}tb37hfw\PYGZhy{}tb37vfw\PYGZhy{}tb37hbk\PYGZhy{}tb37vbk\PYGZus{}nh\PYGZhy{}ease2\PYGZhy{}050\PYGZus{}2028011112.nc\PYGZsq{}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}
\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{o}{\PYGZpc{}}\PYG{k}{load\PYGZus{}ext} autoreload
\PYG{o}{\PYGZpc{}}\PYG{k}{autoreload}

\PYG{k+kn}{from} \PYG{n+nn}{icedrift\PYGZus{}wrapper} \PYG{k+kn}{import} \PYG{n}{icedrift\PYGZus{}wrapper}
\PYG{n}{rad} \PYG{o}{=} \PYG{l+m+mf}{100.}
\PYG{n}{rad\PYGZus{}neigh} \PYG{o}{=} \PYG{l+m+mf}{150.}
\PYG{c+c1}{\PYGZsh{} Original rad=75. rad\PYGZus{}neigh=125.}
\PYG{c+c1}{\PYGZsh{} Worked with rad=100. rad\PYGZus{}neigh=150.}
\PYG{c+c1}{\PYGZsh{} rad = 25. rad\PYGZus{}neigh=150. has lots of corrected by neighbours, but a better field}
\PYG{n}{chan\PYGZus{}list} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{tb37hfw\PYGZus{}lap}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{tb37vfw\PYGZus{}lap}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{tb37hbk\PYGZus{}lap}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{tb37vbk\PYGZus{}lap}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
\PYG{c+c1}{\PYGZsh{} Suppress the proj4 string warning on this}
\PYG{k}{with} \PYG{n}{warnings}\PYG{o}{.}\PYG{n}{catch\PYGZus{}warnings}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{warnings}\PYG{o}{.}\PYG{n}{simplefilter}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{ignore}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

    \PYG{n}{idrift} \PYG{o}{=} \PYG{n}{icedrift\PYGZus{}wrapper}\PYG{p}{(}\PYG{n}{pdate}\PYG{p}{,} \PYG{n}{qdate}\PYG{p}{,} \PYG{n}{procpath}\PYG{p}{,} \PYG{n}{procpath}\PYG{p}{,} \PYG{n}{driftpath}\PYG{p}{,} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{logpath}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{cmcc\PYGZhy{}test.log}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}
                          \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{cimr\PYGZhy{}cimr}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{gridin}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{hemi}\PYG{p}{)}\PYG{p}{,} \PYG{n}{chan\PYGZus{}list}\PYG{p}{,} \PYG{n}{rad}\PYG{p}{,} \PYG{n}{rad\PYGZus{}neigh}\PYG{p}{,} 
                          \PYG{n}{area\PYGZus{}out}\PYG{o}{=}\PYG{n}{gridout}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{hemi}\PYG{p}{)}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
Daily maps found (cimr\PYGZhy{}cimr):

	Day 1 : /home/emilyjd/cimr\PYGZhy{}devalgo/SeaIceDrift\PYGZus{}ATBD\PYGZus{}v2/algorithm/../../data/processing/tc\PYGZus{}wght\PYGZus{}cimr\PYGZhy{}cimr\PYGZus{}tb19hfw\PYGZhy{}tb19vfw\PYGZhy{}tb19hbk\PYGZhy{}tb19vbk\PYGZhy{}tb37hfw\PYGZhy{}tb37vfw\PYGZhy{}tb37hbk\PYGZhy{}tb37vbk\PYGZus{}nh\PYGZhy{}ease2\PYGZhy{}050\PYGZus{}2028011012.nc 

	Day 2 : /home/emilyjd/cimr\PYGZhy{}devalgo/SeaIceDrift\PYGZus{}ATBD\PYGZus{}v2/algorithm/../../data/processing/tc\PYGZus{}wght\PYGZus{}cimr\PYGZhy{}cimr\PYGZus{}tb19hfw\PYGZhy{}tb19vfw\PYGZhy{}tb19hbk\PYGZhy{}tb19vbk\PYGZhy{}tb37hfw\PYGZhy{}tb37vfw\PYGZhy{}tb37hbk\PYGZhy{}tb37vbk\PYGZus{}nh\PYGZhy{}ease2\PYGZhy{}050\PYGZus{}2028011112.nc 



Calling the C core code...
 
 LOGMSG [icedrift\PYGZus{}solve\PYGZus{}core 2024\PYGZhy{}06\PYGZhy{}27 11:22]:
	Start processing.
 
	Log file is \PYGZlt{}/home/emilyjd/cimr\PYGZhy{}devalgo/SeaIceDrift\PYGZus{}ATBD\PYGZus{}v2/algorithm/../../data/logs/cmcc\PYGZhy{}test.log\PYGZgt{}
	Radius for pattern \PYGZsh{}0 is 100.0km
	Radius for pattern \PYGZsh{}1 is 50.0km
	Maximum drift distance is 38.88km
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}

\section{Step 2: Format L2 file and write to disk}
\label{\detokenize{CIMR_L2_Sea_Ice_Drift_algorithm:step-2-format-l2-file-and-write-to-disk}}
\sphinxAtStartPar
The output icedrift file is processed and written, with metadata.

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{driftx} \PYG{o}{=} \PYG{n}{ma}\PYG{o}{.}\PYG{n}{asarray}\PYG{p}{(}\PYG{n}{idrift}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{drift\PYGZus{}x}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{driftx}\PYG{o}{.}\PYG{n}{mask} \PYG{o}{=} \PYG{n}{driftx} \PYG{o}{\PYGZlt{}} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{1e9}
\PYG{n}{drifty} \PYG{o}{=} \PYG{n}{ma}\PYG{o}{.}\PYG{n}{asarray}\PYG{p}{(}\PYG{n}{idrift}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{drift\PYGZus{}y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{drifty}\PYG{o}{.}\PYG{n}{mask} \PYG{o}{=} \PYG{n}{drifty} \PYG{o}{\PYGZlt{}} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{1e9}
\PYG{n}{flag} \PYG{o}{=} \PYG{n}{ma}\PYG{o}{.}\PYG{n}{asarray}\PYG{p}{(}\PYG{n}{idrift}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{flag}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}

\PYG{n}{dms} \PYG{o}{=} \PYG{n}{driftx}\PYG{o}{.}\PYG{n}{shape}
\PYG{n}{ddx} \PYG{o}{=} \PYG{n}{driftx}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{dms}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{dms}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{ddy} \PYG{o}{=} \PYG{n}{drifty}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{dms}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{dms}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{stdx} \PYG{o}{=} \PYG{n}{ma}\PYG{o}{.}\PYG{n}{asarray}\PYG{p}{(}\PYG{n}{idrift}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{std\PYGZus{}x}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{stdx}\PYG{o}{.}\PYG{n}{mask} \PYG{o}{=} \PYG{n}{stdx} \PYG{o}{\PYGZlt{}} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{1e9}
\PYG{n}{stdx} \PYG{o}{=} \PYG{n}{stdx}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{dms}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{dms}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{stdy} \PYG{o}{=} \PYG{n}{ma}\PYG{o}{.}\PYG{n}{asarray}\PYG{p}{(}\PYG{n}{idrift}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{std\PYGZus{}y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{stdy}\PYG{o}{.}\PYG{n}{mask} \PYG{o}{=} \PYG{n}{stdy} \PYG{o}{\PYGZlt{}} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{1e9}
\PYG{n}{stdy} \PYG{o}{=} \PYG{n}{stdy}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{dms}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{dms}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{dflag} \PYG{o}{=} \PYG{n}{ma}\PYG{o}{.}\PYG{n}{asarray}\PYG{p}{(}\PYG{n}{idrift}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{flag}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{dflag} \PYG{o}{=} \PYG{n}{flag}\PYG{o}{.}\PYG{n}{reshape}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{dms}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{dms}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}
\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{reload}\PYG{p}{(}\PYG{n}{l2}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Output grid}
\PYG{n}{og} \PYG{o}{=} \PYG{n}{gridout}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{hemi}\PYG{p}{)}
\PYG{n}{out\PYGZus{}area\PYGZus{}def} \PYG{o}{=} \PYG{n}{parse\PYGZus{}area\PYGZus{}file}\PYG{p}{(}\PYG{n}{griddeffile}\PYG{p}{,} \PYG{n}{og}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
\PYG{n}{olons}\PYG{p}{,} \PYG{n}{olats} \PYG{o}{=} \PYG{n}{out\PYGZus{}area\PYGZus{}def}\PYG{o}{.}\PYG{n}{get\PYGZus{}lonlats}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Get a template L2 format (netCDF/CF) from the Tools module}
\PYG{n}{ds\PYGZus{}l2} \PYG{o}{=} \PYG{n}{l2}\PYG{o}{.}\PYG{n}{get\PYGZus{}CIMR\PYGZus{}L2\PYGZus{}template}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{grid}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{geo\PYGZus{}def}\PYG{o}{=}\PYG{n}{out\PYGZus{}area\PYGZus{}def}\PYG{p}{,} \PYG{n}{add\PYGZus{}time}\PYG{o}{=}\PYG{p}{[}\PYG{n}{pdate}\PYG{o}{.}\PYG{n}{timestamp}\PYG{p}{(}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Create a DataArray for x and y icedrift from the template}
\PYG{n}{da\PYGZus{}dx} \PYG{o}{=} \PYG{n}{xr}\PYG{o}{.}\PYG{n}{DataArray}\PYG{p}{(}\PYG{n}{ddx}\PYG{p}{,} \PYG{n}{coords}\PYG{o}{=}\PYG{n}{ds\PYGZus{}l2}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{template}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{coords}\PYG{p}{,} \PYG{n}{dims}\PYG{o}{=}\PYG{n}{ds\PYGZus{}l2}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{template}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{dims}\PYG{p}{,}
                       \PYG{n}{attrs}\PYG{o}{=}\PYG{n}{ds\PYGZus{}l2}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{template}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{,} \PYG{n}{name}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{driftX}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{da\PYGZus{}dx}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{long\PYGZus{}name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{x\PYGZhy{}component of Sea Ice Drift from the CIMR ice drift algorithm v}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{algo\PYGZus{}version}\PYG{p}{)}
\PYG{n}{da\PYGZus{}dx}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{standard\PYGZus{}name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{x\PYGZus{}component\PYGZus{}sea\PYGZus{}ice\PYGZus{}drift}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{da\PYGZus{}dx}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{units}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{km}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{da\PYGZus{}dx}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{coverage\PYGZus{}content\PYGZus{}type}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{physicalMeasurement}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{da\PYGZus{}dx}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{auxiliary\PYGZus{}variables}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{status\PYGZus{}flag}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{da\PYGZus{}dy} \PYG{o}{=} \PYG{n}{xr}\PYG{o}{.}\PYG{n}{DataArray}\PYG{p}{(}\PYG{n}{ddy}\PYG{p}{,} \PYG{n}{coords}\PYG{o}{=}\PYG{n}{ds\PYGZus{}l2}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{template}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{coords}\PYG{p}{,} \PYG{n}{dims}\PYG{o}{=}\PYG{n}{ds\PYGZus{}l2}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{template}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{dims}\PYG{p}{,}
                       \PYG{n}{attrs}\PYG{o}{=}\PYG{n}{ds\PYGZus{}l2}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{template}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{,} \PYG{n}{name}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{driftY}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{da\PYGZus{}dy}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{long\PYGZus{}name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y\PYGZhy{}component of Sea Ice Drift from the CIMR ice drift algorithm v}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{algo\PYGZus{}version}\PYG{p}{)}
\PYG{n}{da\PYGZus{}dy}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{standard\PYGZus{}name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y\PYGZus{}component\PYGZus{}sea\PYGZus{}ice\PYGZus{}drift}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{da\PYGZus{}dy}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{units}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{km}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{da\PYGZus{}dy}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{coverage\PYGZus{}content\PYGZus{}type}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{physicalMeasurement}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{da\PYGZus{}dy}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{auxiliary\PYGZus{}variables}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{status\PYGZus{}flag}\PYG{l+s+s1}{\PYGZsq{}}

\PYG{c+c1}{\PYGZsh{} Create a DataArray for std x and y icedrift from the template}
\PYG{n}{da\PYGZus{}stddx} \PYG{o}{=} \PYG{n}{xr}\PYG{o}{.}\PYG{n}{DataArray}\PYG{p}{(}\PYG{n}{stdx}\PYG{p}{,} \PYG{n}{coords}\PYG{o}{=}\PYG{n}{ds\PYGZus{}l2}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{template}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{coords}\PYG{p}{,} \PYG{n}{dims}\PYG{o}{=}\PYG{n}{ds\PYGZus{}l2}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{template}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{dims}\PYG{p}{,}
                       \PYG{n}{attrs}\PYG{o}{=}\PYG{n}{ds\PYGZus{}l2}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{template}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{,} \PYG{n}{name}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{stdX}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{da\PYGZus{}stddx}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{long\PYGZus{}name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Standard deviation of x\PYGZhy{}component of Sea Ice Drift from the CIMR ice drift algorithm v}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{algo\PYGZus{}version}\PYG{p}{)}
\PYG{n}{da\PYGZus{}stddx}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{units}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{km}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{da\PYGZus{}stddx}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{coverage\PYGZus{}content\PYGZus{}type}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{auxiliaryInformation}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{da\PYGZus{}stddx}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{auxiliary\PYGZus{}variables}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{status\PYGZus{}flag}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{da\PYGZus{}stddy} \PYG{o}{=} \PYG{n}{xr}\PYG{o}{.}\PYG{n}{DataArray}\PYG{p}{(}\PYG{n}{stdy}\PYG{p}{,} \PYG{n}{coords}\PYG{o}{=}\PYG{n}{ds\PYGZus{}l2}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{template}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{coords}\PYG{p}{,} \PYG{n}{dims}\PYG{o}{=}\PYG{n}{ds\PYGZus{}l2}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{template}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{dims}\PYG{p}{,}
                       \PYG{n}{attrs}\PYG{o}{=}\PYG{n}{ds\PYGZus{}l2}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{template}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{,} \PYG{n}{name}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{stdY}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{da\PYGZus{}stddy}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{long\PYGZus{}name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Standard deviation of y\PYGZhy{}component of Sea Ice Drift from the CIMR ice drift algorithm v}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{algo\PYGZus{}version}\PYG{p}{)}
\PYG{n}{da\PYGZus{}stddy}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{units}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{km}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{da\PYGZus{}stddy}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{coverage\PYGZus{}content\PYGZus{}type}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{auxiliaryInformation}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{da\PYGZus{}stddy}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{auxiliary\PYGZus{}variables}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{status\PYGZus{}flag}\PYG{l+s+s1}{\PYGZsq{}}

\PYG{c+c1}{\PYGZsh{} Create a DataArray for the status flag from the template}
\PYG{n}{da\PYGZus{}flag} \PYG{o}{=} \PYG{n}{xr}\PYG{o}{.}\PYG{n}{DataArray}\PYG{p}{(}\PYG{n}{dflag}\PYG{p}{,} \PYG{n}{coords}\PYG{o}{=}\PYG{n}{ds\PYGZus{}l2}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{template}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{coords}\PYG{p}{,} \PYG{n}{dims}\PYG{o}{=}\PYG{n}{ds\PYGZus{}l2}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{template}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{dims}\PYG{p}{,}
                       \PYG{n}{attrs}\PYG{o}{=}\PYG{n}{ds\PYGZus{}l2}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{template}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{,} \PYG{n}{name}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{status\PYGZus{}flag}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{da\PYGZus{}flag}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{long\PYGZus{}name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Status flag of Sea Ice Drift from the CIMR ice drift algorithm v}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{algo\PYGZus{}version}\PYG{p}{)}
\PYG{n}{da\PYGZus{}flag}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{units}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+m+mi}{1}
\PYG{n}{da\PYGZus{}flag}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{coverage\PYGZus{}content\PYGZus{}type}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{auxiliaryInformation}\PYG{l+s+s1}{\PYGZsq{}}

\PYG{c+c1}{\PYGZsh{} Add the data arrays to the ds\PYGZus{}l2 object}
\PYG{n}{ds\PYGZus{}l2} \PYG{o}{=} \PYG{n}{ds\PYGZus{}l2}\PYG{o}{.}\PYG{n}{merge}\PYG{p}{(}\PYG{n}{da\PYGZus{}dx}\PYG{p}{)}
\PYG{n}{ds\PYGZus{}l2} \PYG{o}{=} \PYG{n}{ds\PYGZus{}l2}\PYG{o}{.}\PYG{n}{merge}\PYG{p}{(}\PYG{n}{da\PYGZus{}dy}\PYG{p}{)}
\PYG{n}{ds\PYGZus{}l2} \PYG{o}{=} \PYG{n}{ds\PYGZus{}l2}\PYG{o}{.}\PYG{n}{merge}\PYG{p}{(}\PYG{n}{da\PYGZus{}stddx}\PYG{p}{)}
\PYG{n}{ds\PYGZus{}l2} \PYG{o}{=} \PYG{n}{ds\PYGZus{}l2}\PYG{o}{.}\PYG{n}{merge}\PYG{p}{(}\PYG{n}{da\PYGZus{}stddy}\PYG{p}{)}
\PYG{n}{ds\PYGZus{}l2} \PYG{o}{=} \PYG{n}{ds\PYGZus{}l2}\PYG{o}{.}\PYG{n}{merge}\PYG{p}{(}\PYG{n}{da\PYGZus{}flag}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Customize the global attributes}
\PYG{n}{ds\PYGZus{}l2}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{title}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{CIMR L2 Sea Ice Drift}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{ds\PYGZus{}l2}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{summary}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Sea Ice Drift computed with the prototype algorithm developed in the ESA CIMR DEVALGO study. The algorithm combines Ku and Ka imagery channels. The product file contains the sea ice drift, its uncertainties, and processing flags.}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{ds\PYGZus{}l2}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{l1b\PYGZus{}file}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{basename}\PYG{p}{(}\PYG{n}{l1bfile}\PYG{p}{)}
\PYG{n}{ds\PYGZus{}l2}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{algorithm\PYGZus{}version}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{algo\PYGZus{}version}

\PYG{n}{ds\PYGZus{}l2}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{creator\PYGZus{}name}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Emily Down and Thomas Lavergne}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{ds\PYGZus{}l2}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{creator\PYGZus{}email}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{emilyjd@met.no}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{ds\PYGZus{}l2}\PYG{o}{.}\PYG{n}{attrs}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{institution}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Norwegian Meteorological Institute}\PYG{l+s+s1}{\PYGZsq{}}

\PYG{c+c1}{\PYGZsh{} Remove the \PYGZsq{}template\PYGZsq{} variable (we don\PYGZsq{}t need it anymore)}
\PYG{n}{ds\PYGZus{}l2} \PYG{o}{=} \PYG{n}{ds\PYGZus{}l2}\PYG{o}{.}\PYG{n}{drop\PYGZus{}vars}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{template}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Write to file}
\PYG{n}{l2\PYGZus{}n} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{cimr\PYGZus{}devalgo\PYGZus{}l2\PYGZus{}sid\PYGZus{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{\PYGZus{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{.nc}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{og}\PYG{p}{,} \PYG{n}{test\PYGZus{}card}\PYG{p}{)}
\PYG{n}{l2\PYGZus{}n} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{driftpath}\PYG{p}{,} \PYG{n}{l2\PYGZus{}n}\PYG{p}{)}
\PYG{n}{ds\PYGZus{}l2}\PYG{o}{.}\PYG{n}{to\PYGZus{}netcdf}\PYG{p}{(}\PYG{n}{l2\PYGZus{}n}\PYG{p}{,} \PYG{n+nb}{format}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{NETCDF4\PYGZus{}CLASSIC}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{n}{l2\PYGZus{}n}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
/home/emilyjd/cimr\PYGZhy{}devalgo/SeaIceDrift\PYGZus{}ATBD\PYGZus{}v2/algorithm/../../data/icedrift/cimr\PYGZus{}devalgo\PYGZus{}l2\PYGZus{}sid\PYGZus{}nh\PYGZhy{}ease2\PYGZhy{}250\PYGZus{}radiometric.nc
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}

\section{Step 3: Plotting}
\label{\detokenize{CIMR_L2_Sea_Ice_Drift_algorithm:step-3-plotting}}
\sphinxAtStartPar
Here an example plot of the icedrift output is made.

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def} \PYG{n+nf}{crs\PYGZus{}create}\PYG{p}{(}\PYG{n}{gridtype}\PYG{p}{,} \PYG{n}{hemi}\PYG{p}{)}\PYG{p}{:}

    \PYG{c+c1}{\PYGZsh{} Define grid based on region}
    \PYG{k}{if} \PYG{n}{gridtype} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{polstere}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{k}{if} \PYG{n}{hemi} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{nh}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
            \PYG{n}{plot\PYGZus{}proj4\PYGZus{}params} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{proj}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{stere}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
                                 \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lat\PYGZus{}0}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{90.}\PYG{p}{,}
                                 \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lat\PYGZus{}ts}\PYG{l+s+s1}{\PYGZsq{}} \PYG{p}{:} \PYG{l+m+mf}{70.}\PYG{p}{,}
                                 \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lon\PYGZus{}0}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{45.0}\PYG{p}{,}
                                 \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{a}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{6378273}\PYG{p}{,}
                                 \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{6356889.44891}\PYG{p}{\PYGZcb{}}
            \PYG{n}{plot\PYGZus{}globe} \PYG{o}{=} \PYG{n}{ccrs}\PYG{o}{.}\PYG{n}{Globe}\PYG{p}{(}\PYG{n}{semimajor\PYGZus{}axis}\PYG{o}{=}\PYG{n}{plot\PYGZus{}proj4\PYGZus{}params}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{a}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,}
                                    \PYG{n}{semiminor\PYGZus{}axis}\PYG{o}{=}\PYG{n}{plot\PYGZus{}proj4\PYGZus{}params}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}
            \PYG{n}{plot\PYGZus{}crs} \PYG{o}{=} \PYG{n}{ccrs}\PYG{o}{.}\PYG{n}{NorthPolarStereo}\PYG{p}{(}
                \PYG{n}{central\PYGZus{}longitude}\PYG{o}{=}\PYG{n}{plot\PYGZus{}proj4\PYGZus{}params}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lon\PYGZus{}0}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{globe}\PYG{o}{=}\PYG{n}{plot\PYGZus{}globe}\PYG{p}{)}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{n}{plot\PYGZus{}proj4\PYGZus{}params} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{proj}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{stere}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
                                 \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lat\PYGZus{}0}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{90.}\PYG{p}{,}
                                 \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lat\PYGZus{}ts}\PYG{l+s+s1}{\PYGZsq{}} \PYG{p}{:} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{70.}\PYG{p}{,}
                                 \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lon\PYGZus{}0}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{0.}\PYG{p}{,}
                                 \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{a}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{6378273}\PYG{p}{,}
                                 \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{6356889.44891}\PYG{p}{\PYGZcb{}}
            \PYG{n}{plot\PYGZus{}globe} \PYG{o}{=} \PYG{n}{ccrs}\PYG{o}{.}\PYG{n}{Globe}\PYG{p}{(}\PYG{n}{semimajor\PYGZus{}axis}\PYG{o}{=}\PYG{n}{plot\PYGZus{}proj4\PYGZus{}params}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{a}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,}
                                    \PYG{n}{semiminor\PYGZus{}axis}\PYG{o}{=}\PYG{n}{plot\PYGZus{}proj4\PYGZus{}params}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}
            \PYG{n}{plot\PYGZus{}crs} \PYG{o}{=} \PYG{n}{ccrs}\PYG{o}{.}\PYG{n}{SouthPolarStereo}\PYG{p}{(}
                \PYG{n}{central\PYGZus{}longitude}\PYG{o}{=}\PYG{n}{plot\PYGZus{}proj4\PYGZus{}params}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lon\PYGZus{}0}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{globe}\PYG{o}{=}\PYG{n}{plot\PYGZus{}globe}\PYG{p}{)}
    \PYG{k}{elif} \PYG{n}{gridtype} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ease}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{k}{if} \PYG{n}{hemi} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{nh}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
            \PYG{n}{plot\PYGZus{}crs} \PYG{o}{=} \PYG{n}{ccrs}\PYG{o}{.}\PYG{n}{LambertAzimuthalEqualArea}\PYG{p}{(}\PYG{n}{central\PYGZus{}longitude}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,}
                                                      \PYG{n}{central\PYGZus{}latitude}\PYG{o}{=}\PYG{l+m+mi}{90}\PYG{p}{,}
                                                      \PYG{n}{false\PYGZus{}easting}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,}
                                                      \PYG{n}{false\PYGZus{}northing}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{n}{plot\PYGZus{}crs} \PYG{o}{=} \PYG{n}{ccrs}\PYG{o}{.}\PYG{n}{LambertAzimuthalEqualArea}\PYG{p}{(}\PYG{n}{central\PYGZus{}longitude}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,}
                                                      \PYG{n}{central\PYGZus{}latitude}\PYG{o}{=}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{90}\PYG{p}{,}
                                                      \PYG{n}{false\PYGZus{}easting}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,}
                                                      \PYG{n}{false\PYGZus{}northing}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}
    \PYG{k}{else}\PYG{p}{:}
        \PYG{k}{raise} \PYG{n+ne}{ValueError}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Unrecognised region }\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{region}\PYG{p}{)}\PYG{p}{)}

    \PYG{k}{return}\PYG{p}{(}\PYG{n}{plot\PYGZus{}crs}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}
\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def} \PYG{n+nf}{flag\PYGZus{}arrow\PYGZus{}col}\PYG{p}{(}\PYG{n}{flag}\PYG{p}{,} \PYG{n}{procfmt}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}\PYG{p}{:}

    \PYG{k}{if} \PYG{n}{procfmt}\PYG{p}{:}
        \PYG{n}{flgfmt} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{proc}\PYG{l+s+s1}{\PYGZsq{}}
    \PYG{k}{else}\PYG{p}{:}
        \PYG{n}{flgfmt} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{final}\PYG{l+s+s1}{\PYGZsq{}}

    \PYG{c+c1}{\PYGZsh{} Use colours from https://sashamaps.net/docs/resources/20\PYGZhy{}colors/}
    \PYG{n}{fblack} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}000000}\PYG{l+s+s1}{\PYGZsq{}}
    \PYG{n}{fmaroon} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}800000}\PYG{l+s+s1}{\PYGZsq{}}
    \PYG{n}{forange} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}f58231}\PYG{l+s+s1}{\PYGZsq{}}
    \PYG{n}{fnavy} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}000075}\PYG{l+s+s1}{\PYGZsq{}}
    \PYG{n}{fblue} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}4363d8}\PYG{l+s+s1}{\PYGZsq{}}
    \PYG{n}{flavender} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}dcbeff}\PYG{l+s+s1}{\PYGZsq{}}
    \PYG{n}{fgrey} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}a9a9a9}\PYG{l+s+s1}{\PYGZsq{}}

    \PYG{n}{fbrown} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}9A6324}\PYG{l+s+s1}{\PYGZsq{}}
    \PYG{n}{fteal} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}469990}\PYG{l+s+s1}{\PYGZsq{}}
    \PYG{n}{fgreen} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}3cb44b}\PYG{l+s+s1}{\PYGZsq{}}
    \PYG{n}{fcyan} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}42d4f4}\PYG{l+s+s1}{\PYGZsq{}}
    \PYG{n}{fmagenta} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}f032e6}\PYG{l+s+s1}{\PYGZsq{}}

    \PYG{n}{fred} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}e6194B}\PYG{l+s+s1}{\PYGZsq{}}
    \PYG{n}{fpurple} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}911eb4}\PYG{l+s+s1}{\PYGZsq{}}

    \PYG{n}{flag\PYGZus{}cols} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    \PYG{n}{flag\PYGZus{}cols}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{final}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{l+m+mi}{30}\PYG{p}{:} \PYG{n}{fblack}\PYG{p}{,}   \PYG{c+c1}{\PYGZsh{} Nominal quality}
                          \PYG{l+m+mi}{20}\PYG{p}{:} \PYG{n}{fbrown}\PYG{p}{,}   \PYG{c+c1}{\PYGZsh{} Single\PYGZhy{}sensor, with smaller pattern}
                                        \PYG{c+c1}{\PYGZsh{} block}
                          \PYG{l+m+mi}{21}\PYG{p}{:} \PYG{n}{forange}\PYG{p}{,}  \PYG{c+c1}{\PYGZsh{} Single\PYGZhy{}sensor, with neighbours as}
                                        \PYG{c+c1}{\PYGZsh{} constraint}
                          \PYG{l+m+mi}{22}\PYG{p}{:} \PYG{n}{fmaroon}\PYG{p}{,}  \PYG{c+c1}{\PYGZsh{} Interpolated}
                          \PYG{l+m+mi}{23}\PYG{p}{:} \PYG{n}{fcyan}\PYG{p}{,}    \PYG{c+c1}{\PYGZsh{} Gap filling in wind drift}
                          \PYG{l+m+mi}{24}\PYG{p}{:} \PYG{n}{fteal}\PYG{p}{,}    \PYG{c+c1}{\PYGZsh{} Vector replaced by wind drift}
                          \PYG{l+m+mi}{25}\PYG{p}{:} \PYG{n}{fnavy}\PYG{p}{,}    \PYG{c+c1}{\PYGZsh{} Blended satellite and wind drift}
\PYG{p}{\PYGZcb{}}
    \PYG{n}{flag\PYGZus{}cols}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{proc}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{l+m+mi}{0}\PYG{p}{:} \PYG{n}{fblack}\PYG{p}{,}     \PYG{c+c1}{\PYGZsh{} Nominal quality}
                         \PYG{l+m+mi}{16}\PYG{p}{:} \PYG{n}{fpurple}\PYG{p}{,}   \PYG{c+c1}{\PYGZsh{} Interpolated}
                         \PYG{l+m+mi}{13}\PYG{p}{:} \PYG{n}{fred}\PYG{p}{,}      \PYG{c+c1}{\PYGZsh{} Single\PYGZhy{}sensor, with neighbours as}
                                        \PYG{c+c1}{\PYGZsh{} constraint}
                         \PYG{l+m+mi}{17}\PYG{p}{:} \PYG{n}{fgreen}\PYG{p}{,}    \PYG{c+c1}{\PYGZsh{} Single\PYGZhy{}sensor, with smaller}
                                        \PYG{c+c1}{\PYGZsh{} pattern block}
\PYG{p}{\PYGZcb{}}

    \PYG{n}{default} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}
    \PYG{k}{if} \PYG{n}{flag} \PYG{o+ow}{in} \PYG{n}{flag\PYGZus{}cols}\PYG{p}{[}\PYG{n}{flgfmt}\PYG{p}{]}\PYG{o}{.}\PYG{n}{keys}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n}{flag\PYGZus{}cols}\PYG{p}{[}\PYG{n}{flgfmt}\PYG{p}{]}\PYG{p}{[}\PYG{n}{flag}\PYG{p}{]}
    \PYG{k}{else}\PYG{p}{:}
        \PYG{k}{return} \PYG{n}{default}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}
\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{scale} \PYG{o}{=} \PYG{l+m+mf}{1000.}
\PYG{n}{pc} \PYG{o}{=} \PYG{n}{ccrs}\PYG{o}{.}\PYG{n}{PlateCarree}\PYG{p}{(}\PYG{p}{)}

\PYG{k}{def} \PYG{n+nf}{plotdriftarr}\PYG{p}{(}\PYG{n}{ax}\PYG{p}{,} \PYG{n}{plot\PYGZus{}crs}\PYG{p}{,} \PYG{n}{data\PYGZus{}crs}\PYG{p}{,} \PYG{n}{lon}\PYG{p}{,} \PYG{n}{lat}\PYG{p}{,} \PYG{n}{dx}\PYG{p}{,} \PYG{n}{dy}\PYG{p}{,} \PYG{n}{sflag}\PYG{p}{,} \PYG{n}{driftflags}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}\PYG{p}{:}
    
    \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{dx}\PYG{o}{.}\PYG{n}{size}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{try}\PYG{p}{:}
            \PYG{n}{x0}\PYG{p}{,} \PYG{n}{y0} \PYG{o}{=} \PYG{n}{plot\PYGZus{}crs}\PYG{o}{.}\PYG{n}{transform\PYGZus{}point}\PYG{p}{(}\PYG{n}{lon}\PYG{p}{[}\PYG{o}{\PYGZti{}}\PYG{n}{dx}\PYG{o}{.}\PYG{n}{mask}\PYG{p}{]}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{,} \PYG{n}{lat}\PYG{p}{[}\PYG{o}{\PYGZti{}}\PYG{n}{dx}\PYG{o}{.}\PYG{n}{mask}\PYG{p}{]}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{,} \PYG{n}{src\PYGZus{}crs}\PYG{o}{=}\PYG{n}{pc}\PYG{p}{)}
            \PYG{n}{adx} \PYG{o}{=} \PYG{n}{dx}\PYG{p}{[}\PYG{o}{\PYGZti{}}\PYG{n}{dx}\PYG{o}{.}\PYG{n}{mask}\PYG{p}{]}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}
            \PYG{n}{ady} \PYG{o}{=} \PYG{n}{dy}\PYG{p}{[}\PYG{o}{\PYGZti{}}\PYG{n}{dy}\PYG{o}{.}\PYG{n}{mask}\PYG{p}{]}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}
            \PYG{n}{len\PYGZus{}arrow} \PYG{o}{=} \PYG{n}{math}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{n}{adx}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2} \PYG{o}{+} \PYG{n}{ady}\PYG{o}{*}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{p}{)}

            \PYG{c+c1}{\PYGZsh{} Calculate the endpoints and therefore dx, dy components of the drift arrows in the plot}
            \PYG{c+c1}{\PYGZsh{} coordinate system}
            \PYG{n}{xorig}\PYG{p}{,} \PYG{n}{yorig} \PYG{o}{=} \PYG{n}{data\PYGZus{}crs}\PYG{o}{.}\PYG{n}{transform\PYGZus{}point}\PYG{p}{(}\PYG{n}{lon}\PYG{p}{[}\PYG{o}{\PYGZti{}}\PYG{n}{dx}\PYG{o}{.}\PYG{n}{mask}\PYG{p}{]}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{,} \PYG{n}{lat}\PYG{p}{[}\PYG{o}{\PYGZti{}}\PYG{n}{dx}\PYG{o}{.}\PYG{n}{mask}\PYG{p}{]}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{p}{,} \PYG{n}{src\PYGZus{}crs}\PYG{o}{=}\PYG{n}{pc}\PYG{p}{)}
            \PYG{n}{xarr} \PYG{o}{=} \PYG{n}{xorig} \PYG{o}{+} \PYG{n}{adx}
            \PYG{n}{yarr} \PYG{o}{=} \PYG{n}{yorig} \PYG{o}{+} \PYG{n}{ady}
            \PYG{n}{x1}\PYG{p}{,} \PYG{n}{y1} \PYG{o}{=} \PYG{n}{plot\PYGZus{}crs}\PYG{o}{.}\PYG{n}{transform\PYGZus{}point}\PYG{p}{(}\PYG{n}{xarr}\PYG{p}{,} \PYG{n}{yarr}\PYG{p}{,} \PYG{n}{src\PYGZus{}crs}\PYG{o}{=}\PYG{n}{data\PYGZus{}crs}\PYG{p}{)}
            \PYG{n}{pdx} \PYG{o}{=} \PYG{p}{(}\PYG{n}{x1} \PYG{o}{\PYGZhy{}} \PYG{n}{x0}\PYG{p}{)} \PYG{o}{*} \PYG{n}{scale}
            \PYG{n}{pdy} \PYG{o}{=} \PYG{p}{(}\PYG{n}{y1} \PYG{o}{\PYGZhy{}} \PYG{n}{y0}\PYG{p}{)} \PYG{o}{*} \PYG{n}{scale}
            
            \PYG{c+c1}{\PYGZsh{} Set the colour of the drift arrows if this should be}
            \PYG{c+c1}{\PYGZsh{} done with status flags}
            \PYG{k}{if} \PYG{n}{driftflags}\PYG{p}{:}
                \PYG{n}{myflag} \PYG{o}{=} \PYG{n}{sflag}\PYG{p}{[}\PYG{o}{\PYGZti{}}\PYG{n}{dx}\PYG{o}{.}\PYG{n}{mask}\PYG{p}{]}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}
                \PYG{n}{ar\PYGZus{}col} \PYG{o}{=} \PYG{n}{flag\PYGZus{}arrow\PYGZus{}col}\PYG{p}{(}\PYG{n}{myflag}\PYG{p}{,} \PYG{n}{procfmt}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
            \PYG{k}{else}\PYG{p}{:}
                \PYG{n}{ar\PYGZus{}col} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{black}\PYG{l+s+s1}{\PYGZsq{}}

            \PYG{c+c1}{\PYGZsh{} If the arrow is too small, mark a symbol instead}
            \PYG{k}{if} \PYG{n}{len\PYGZus{}arrow} \PYG{o}{*} \PYG{n}{scale} \PYG{o}{\PYGZlt{}} \PYG{l+m+mi}{2000}\PYG{p}{:}
                \PYG{n}{plt}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{x0}\PYG{p}{,} \PYG{n}{y0}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{s}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{n}{ar\PYGZus{}col}\PYG{p}{,} \PYG{n}{markersize}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
            \PYG{k}{else}\PYG{p}{:}
                \PYG{n}{head\PYGZus{}length} \PYG{o}{=} \PYG{l+m+mf}{0.3} \PYG{o}{*} \PYG{n}{len\PYGZus{}arrow} \PYG{o}{*} \PYG{n}{scale}
                \PYG{n}{plt}\PYG{o}{.}\PYG{n}{arrow}\PYG{p}{(}\PYG{n}{x0}\PYG{p}{,} \PYG{n}{y0}\PYG{p}{,} \PYG{n}{pdx}\PYG{p}{,} \PYG{n}{pdy}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{n}{ar\PYGZus{}col}\PYG{p}{,}
                    \PYG{n}{shape}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{full}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{head\PYGZus{}length}\PYG{o}{=}\PYG{n}{head\PYGZus{}length}\PYG{p}{,}
                    \PYG{n}{head\PYGZus{}width}\PYG{o}{=}\PYG{l+m+mi}{15000}\PYG{p}{,}
                    \PYG{n}{fill}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{length\PYGZus{}includes\PYGZus{}head}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,}
                    \PYG{n}{width}\PYG{o}{=}\PYG{l+m+mi}{4000}\PYG{p}{)}

        \PYG{k}{except}\PYG{p}{:}
            \PYG{k}{pass} \PYG{c+c1}{\PYGZsh{} Outside the range of points}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}
\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Plotting the ice drift with arrows}
\PYG{c+c1}{\PYGZsh{} Modified from the SeaSurfaceTemperature\PYGZus{}ATBD\PYGZus{}v2, by Emy Alerskans}

\PYG{c+c1}{\PYGZsh{} Drift data}
\PYG{n}{xydata} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{dx}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{driftx}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{dy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{drifty}\PYG{p}{\PYGZcb{}}
\PYG{n}{limminxy} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{nanmin}\PYG{p}{(}\PYG{p}{[}\PYG{n}{np}\PYG{o}{.}\PYG{n}{nanmin}\PYG{p}{(}\PYG{n}{a}\PYG{p}{)} \PYG{k}{for} \PYG{n}{a} \PYG{o+ow}{in} \PYG{n}{xydata}\PYG{o}{.}\PYG{n}{values}\PYG{p}{(}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{limminxy} \PYG{o}{=} \PYG{n}{limminxy} \PYG{o}{\PYGZhy{}} \PYG{l+m+mf}{0.1} \PYG{o}{*} \PYG{n+nb}{abs}\PYG{p}{(}\PYG{n}{limminxy}\PYG{p}{)}
\PYG{n}{limmaxxy} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{nanmax}\PYG{p}{(}\PYG{p}{[}\PYG{n}{np}\PYG{o}{.}\PYG{n}{nanmax}\PYG{p}{(}\PYG{n}{a}\PYG{p}{)} \PYG{k}{for} \PYG{n}{a} \PYG{o+ow}{in} \PYG{n}{xydata}\PYG{o}{.}\PYG{n}{values}\PYG{p}{(}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{limmaxxy} \PYG{o}{=} \PYG{n}{limmaxxy} \PYG{o}{+} \PYG{l+m+mf}{0.1} \PYG{o}{*} \PYG{n+nb}{abs}\PYG{p}{(}\PYG{n}{limmaxxy}\PYG{p}{)}
\PYG{n}{limminflag} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{nanmin}\PYG{p}{(}\PYG{n}{flag}\PYG{p}{)}
\PYG{n}{limmaxflag} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{nanmax}\PYG{p}{(}\PYG{n}{flag}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Output lat/lons}
\PYG{n}{og} \PYG{o}{=} \PYG{n}{gridout}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{hemi}\PYG{p}{)}
\PYG{n}{out\PYGZus{}area\PYGZus{}def} \PYG{o}{=} \PYG{n}{parse\PYGZus{}area\PYGZus{}file}\PYG{p}{(}\PYG{n}{griddeffile}\PYG{p}{,} \PYG{n}{og}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
\PYG{n}{olons}\PYG{p}{,} \PYG{n}{olats} \PYG{o}{=} \PYG{n}{out\PYGZus{}area\PYGZus{}def}\PYG{o}{.}\PYG{n}{get\PYGZus{}lonlats}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Coordinate reference systems}
\PYG{n}{plot\PYGZus{}crs} \PYG{o}{=} \PYG{n}{crs\PYGZus{}create}\PYG{p}{(}\PYG{n}{gridtype}\PYG{p}{,} \PYG{n}{hemi}\PYG{p}{)}
\PYG{n}{pc} \PYG{o}{=} \PYG{n}{ccrs}\PYG{o}{.}\PYG{n}{PlateCarree}\PYG{p}{(}\PYG{p}{)}
\PYG{k}{if} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ease}\PYG{l+s+s1}{\PYGZsq{}} \PYG{o+ow}{in} \PYG{n}{gridout}\PYG{p}{:}
    \PYG{n}{data\PYGZus{}crs} \PYG{o}{=} \PYG{n}{crs\PYGZus{}create}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ease}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{hemi}\PYG{p}{)}
\PYG{k}{else}\PYG{p}{:}
    \PYG{n}{data\PYGZus{}crs} \PYG{o}{=} \PYG{n}{crs\PYGZus{}create}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{polstere}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{hemi}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plotting drift}
\PYG{n}{fig} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{ax} \PYG{o}{=} \PYG{n}{fig}\PYG{o}{.}\PYG{n}{add\PYGZus{}subplot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{projection}\PYG{o}{=}\PYG{n}{plot\PYGZus{}crs}\PYG{p}{)}

\PYG{n}{plotdriftarr}\PYG{p}{(}\PYG{n}{ax}\PYG{p}{,} \PYG{n}{plot\PYGZus{}crs}\PYG{p}{,} \PYG{n}{data\PYGZus{}crs}\PYG{p}{,} \PYG{n}{olons}\PYG{p}{[}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{:}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{:}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,} \PYG{n}{olats}\PYG{p}{[}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{:}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{:}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,} 
             \PYG{n}{driftx}\PYG{p}{[}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{:}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{:}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,} \PYG{n}{drifty}\PYG{p}{[}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{:}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{:}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,}
             \PYG{n}{flag}\PYG{p}{[}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{:}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{:}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,} \PYG{n}{driftflags}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}

\PYG{n}{ax}\PYG{o}{.}\PYG{n}{coastlines}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}extent}\PYG{p}{(}\PYG{p}{[}\PYG{n}{lon\PYGZus{}min}\PYG{p}{,} \PYG{n}{lon\PYGZus{}max}\PYG{p}{,} \PYG{n}{lat\PYGZus{}min}\PYG{p}{,} \PYG{n}{lat\PYGZus{}max}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{gl} \PYG{o}{=} \PYG{n}{ax}\PYG{o}{.}\PYG{n}{gridlines}\PYG{p}{(}\PYG{n}{crs}\PYG{o}{=}\PYG{n}{ccrs}\PYG{o}{.}\PYG{n}{PlateCarree}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{draw\PYGZus{}labels}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{:}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{gl}\PYG{o}{.}\PYG{n}{top\PYGZus{}labels} \PYG{o}{=} \PYG{k+kc}{False}
\PYG{n}{gl}\PYG{o}{.}\PYG{n}{right\PYGZus{}labels} \PYG{o}{=} \PYG{k+kc}{False}
\PYG{n}{gl}\PYG{o}{.}\PYG{n}{xlocator} \PYG{o}{=} \PYG{n}{mticker}\PYG{o}{.}\PYG{n}{FixedLocator}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{180}\PYG{p}{,} \PYG{l+m+mi}{180}\PYG{p}{,} \PYG{n}{lon\PYGZus{}step}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{gl}\PYG{o}{.}\PYG{n}{ylocator} \PYG{o}{=} \PYG{n}{mticker}\PYG{o}{.}\PYG{n}{FixedLocator}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{90}\PYG{p}{,} \PYG{l+m+mi}{90}\PYG{p}{,} \PYG{n}{lat\PYGZus{}step}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{gl}\PYG{o}{.}\PYG{n}{xlabel\PYGZus{}style} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{size}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{14}\PYG{p}{\PYGZcb{}}
\PYG{n}{gl}\PYG{o}{.}\PYG{n}{ylabel\PYGZus{}style} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{size}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{14}\PYG{p}{\PYGZcb{}}    

\PYG{k}{if} \PYG{n}{plotfigs}\PYG{p}{:}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{savefig}\PYG{p}{(}\PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{figpath}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{drift\PYGZus{}rad}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{.png}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{rad}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Status flags}
\PYG{n}{fig} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{ax} \PYG{o}{=} \PYG{n}{fig}\PYG{o}{.}\PYG{n}{add\PYGZus{}subplot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{projection}\PYG{o}{=}\PYG{n}{plot\PYGZus{}crs}\PYG{p}{)}
\PYG{n}{im} \PYG{o}{=} \PYG{n}{ax}\PYG{o}{.}\PYG{n}{pcolormesh}\PYG{p}{(}\PYG{n}{olons}\PYG{p}{[}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{:}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{:}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,} \PYG{n}{olats}\PYG{p}{[}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{:}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{:}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,} 
                    \PYG{n}{flag}\PYG{p}{[}\PYG{p}{:}\PYG{p}{]}\PYG{p}{[}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{:}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{:}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,} \PYG{n}{transform}\PYG{o}{=}\PYG{n}{pc}\PYG{p}{,}
                    \PYG{n}{cmap}\PYG{o}{=}\PYG{n}{cmap}\PYG{p}{,} \PYG{n}{vmin}\PYG{o}{=}\PYG{n}{limminflag}\PYG{p}{,} \PYG{n}{vmax}\PYG{o}{=}\PYG{n}{limmaxflag}\PYG{p}{)}
\PYG{n}{ax}\PYG{o}{.}\PYG{n}{coastlines}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}extent}\PYG{p}{(}\PYG{p}{[}\PYG{n}{lon\PYGZus{}min}\PYG{p}{,} \PYG{n}{lon\PYGZus{}max}\PYG{p}{,} \PYG{n}{lat\PYGZus{}min}\PYG{p}{,} \PYG{n}{lat\PYGZus{}max}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{gl} \PYG{o}{=} \PYG{n}{ax}\PYG{o}{.}\PYG{n}{gridlines}\PYG{p}{(}\PYG{n}{crs}\PYG{o}{=}\PYG{n}{ccrs}\PYG{o}{.}\PYG{n}{PlateCarree}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{draw\PYGZus{}labels}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{:}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{gl}\PYG{o}{.}\PYG{n}{top\PYGZus{}labels} \PYG{o}{=} \PYG{k+kc}{False}
\PYG{n}{gl}\PYG{o}{.}\PYG{n}{right\PYGZus{}labels} \PYG{o}{=} \PYG{k+kc}{False}
\PYG{n}{gl}\PYG{o}{.}\PYG{n}{xlocator} \PYG{o}{=} \PYG{n}{mticker}\PYG{o}{.}\PYG{n}{FixedLocator}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{180}\PYG{p}{,} \PYG{l+m+mi}{180}\PYG{p}{,} \PYG{n}{lon\PYGZus{}step}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{gl}\PYG{o}{.}\PYG{n}{ylocator} \PYG{o}{=} \PYG{n}{mticker}\PYG{o}{.}\PYG{n}{FixedLocator}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{90}\PYG{p}{,} \PYG{l+m+mi}{90}\PYG{p}{,} \PYG{n}{lat\PYGZus{}step}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{gl}\PYG{o}{.}\PYG{n}{xlabel\PYGZus{}style} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{size}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{14}\PYG{p}{\PYGZcb{}}
\PYG{n}{gl}\PYG{o}{.}\PYG{n}{ylabel\PYGZus{}style} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{size}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{14}\PYG{p}{\PYGZcb{}}
        
\PYG{c+c1}{\PYGZsh{} Colourbar}
\PYG{n}{divider} \PYG{o}{=} \PYG{n}{make\PYGZus{}axes\PYGZus{}locatable}\PYG{p}{(}\PYG{n}{ax}\PYG{p}{)}
\PYG{n}{cax} \PYG{o}{=} \PYG{n}{divider}\PYG{o}{.}\PYG{n}{append\PYGZus{}axes}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{right}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{size}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{3}\PYG{l+s+s2}{\PYGZpc{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{pad}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{2}\PYG{l+s+s2}{\PYGZpc{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{axes\PYGZus{}class}\PYG{o}{=}\PYG{n}{plt}\PYG{o}{.}\PYG{n}{Axes}\PYG{p}{)}
\PYG{n}{cb} \PYG{o}{=} \PYG{n}{fig}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{im}\PYG{p}{,} \PYG{n}{cax}\PYG{o}{=}\PYG{n}{cax}\PYG{p}{)}
\PYG{n}{cb}\PYG{o}{.}\PYG{n}{set\PYGZus{}label}\PYG{p}{(}\PYG{n}{label}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Flag}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{16}\PYG{p}{,} \PYG{n}{labelpad}\PYG{o}{=}\PYG{l+m+mf}{20.0}\PYG{p}{)}
\PYG{n}{cb}\PYG{o}{.}\PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylim}\PYG{p}{(}\PYG{n}{limminflag}\PYG{p}{,} \PYG{n}{limmaxflag}\PYG{p}{)}
        
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{FLAG VALUES }\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{Unprocessed pixel                              \PYGZhy{}1}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{Nominal                                        0}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{Outside image border                           1}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{Close to image border                          2}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{Pixel center over land                         3}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{No ice                                         4}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{Close to coast or edge                         5}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{Close to missing pixel                         6}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{Close to unprocessed pixel                     7}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{Icedrift optimisation failed                   8}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{Icedrift failed                                9}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{Icedrift with low correlation                  10}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{Icedrift calculation took too long             11}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{Icedrift calculation refused by neighbours     12}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{Icedrift calculation corrected by neighbours   13}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{Icedrift no average                            14}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{Icedrift masked due to summer season           15}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{Icedrift multi\PYGZhy{}oi interpolation                16}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{Icedrift calcuated with smaller pattern        17}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{Icedrift masked due to NWP                     18}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\noindent\sphinxincludegraphics{{ace377039b856cfc7fdcf6229d49d354c79ca57f19a974f36bada17f8b691bb9}.png}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
FLAG VALUES 
Unprocessed pixel                              \PYGZhy{}1
Nominal                                        0
Outside image border                           1
Close to image border                          2
Pixel center over land                         3
No ice                                         4
Close to coast or edge                         5
Close to missing pixel                         6
Close to unprocessed pixel                     7
Icedrift optimisation failed                   8
Icedrift failed                                9
Icedrift with low correlation                  10
Icedrift calculation took too long             11
Icedrift calculation refused by neighbours     12
Icedrift calculation corrected by neighbours   13
Icedrift no average                            14
Icedrift masked due to summer season           15
Icedrift multi\PYGZhy{}oi interpolation                16
Icedrift calcuated with smaller pattern        17
Icedrift masked due to NWP                     18
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{3e43a065d239042e7b0a5797505372f43db083d0ead6b35ce47e96c54b5eead7}.png}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}
\sphinxstepscope


\chapter{Performance Assessment}
\label{\detokenize{CIMR_L2_Sea_Ice_Drift_performanceAssessment:performance-assessment}}\label{\detokenize{CIMR_L2_Sea_Ice_Drift_performanceAssessment::doc}}
\sphinxAtStartPar
This notebook implements a prototype for a Level\sphinxhyphen{}2 SIED algorithm for the CIMR mission.

\sphinxAtStartPar
We refer to the corresponding \sphinxhref{https://cimr-algos.github.io/SeaIceDrift\_ATBD/intro.html}{ATBD} and especially the \sphinxhref{https://cimr-algos.github.io/SeaIceDrift\_ATBD/baseline\_algorithm\_definition.html\#baseline-algorithm-definition}{Baseline Algorithm Definition}.

\sphinxAtStartPar
In particular, the figure below illustrates the overall concept of the processing:



\section{Settings}
\label{\detokenize{CIMR_L2_Sea_Ice_Drift_performanceAssessment:settings}}
\sphinxAtStartPar
Imports and general settings

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Paths}

\PYG{c+c1}{\PYGZsh{} Getting the path of the notebook (NOTE: not totally safe)}
\PYG{c+c1}{\PYGZsh{} The paths assume that there is an umbrella CIMR directory (of any name) containing SeaIceDrift\PYGZus{}ATBD\PYGZus{}v2/ ,}
\PYG{c+c1}{\PYGZsh{} the CIMR Tools/ directory, and a directory data/L1B/ containing the L1B data, and data/conc/ containing}
\PYG{c+c1}{\PYGZsh{} a concentration file.}
\PYG{c+c1}{\PYGZsh{} Additionally, this code expects that the CIMR L2 Sea Ice Drift algorithm notebook has been run, to create}
\PYG{c+c1}{\PYGZsh{} the drift file}
\PYG{k+kn}{import} \PYG{n+nn}{os}
\PYG{n}{cpath} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{os}\PYG{o}{.}\PYG{n}{getcwd}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{../..}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{algpath} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{cpath}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{SeaIceDrift\PYGZus{}ATBD\PYGZus{}v2/algorithm/src\PYGZus{}sied}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{driftpath} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{cpath}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{data/icedrift}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{figpath} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{cpath}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{data/figs}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}
\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Imports}

\PYG{k+kn}{import} \PYG{n+nn}{sys}
\PYG{k+kn}{import} \PYG{n+nn}{math}
\PYG{k+kn}{import} \PYG{n+nn}{numpy} \PYG{k}{as} \PYG{n+nn}{np}
\PYG{k+kn}{import} \PYG{n+nn}{numpy}\PYG{n+nn}{.}\PYG{n+nn}{ma} \PYG{k}{as} \PYG{n+nn}{ma}
\PYG{k+kn}{from} \PYG{n+nn}{netCDF4} \PYG{k+kn}{import} \PYG{n}{Dataset}
\PYG{k+kn}{from} \PYG{n+nn}{matplotlib} \PYG{k+kn}{import} \PYG{n}{pylab} \PYG{k}{as} \PYG{n}{plt}
\PYG{k+kn}{import} \PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{ticker} \PYG{k}{as} \PYG{n+nn}{mticker}
\PYG{k+kn}{from} \PYG{n+nn}{mpl\PYGZus{}toolkits}\PYG{n+nn}{.}\PYG{n+nn}{axes\PYGZus{}grid1}\PYG{n+nn}{.}\PYG{n+nn}{axes\PYGZus{}divider} \PYG{k+kn}{import} \PYG{n}{make\PYGZus{}axes\PYGZus{}locatable}
\PYG{k+kn}{import} \PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{cm} \PYG{k}{as} \PYG{n+nn}{cm}
\PYG{k+kn}{import} \PYG{n+nn}{cmocean}
\PYG{k+kn}{import} \PYG{n+nn}{cartopy}
\PYG{k+kn}{import} \PYG{n+nn}{cartopy}\PYG{n+nn}{.}\PYG{n+nn}{crs} \PYG{k}{as} \PYG{n+nn}{ccrs}
\PYG{k+kn}{from} \PYG{n+nn}{pyresample} \PYG{k+kn}{import} \PYG{n}{parse\PYGZus{}area\PYGZus{}file}

\PYG{c+c1}{\PYGZsh{} Local modules contain software code that implement the SIED algorithm}
\PYG{k}{if} \PYG{n}{algpath} \PYG{o+ow}{not} \PYG{o+ow}{in} \PYG{n}{sys}\PYG{o}{.}\PYG{n}{path}\PYG{p}{:}
    \PYG{n}{sys}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{insert}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{algpath}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}
\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Plot settings}

\PYG{k+kn}{import} \PYG{n+nn}{matplotlib}
\PYG{n}{matplotlib}\PYG{o}{.}\PYG{n}{rc}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{xtick}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{labelsize}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)} 
\PYG{n}{matplotlib}\PYG{o}{.}\PYG{n}{rc}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ytick}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{labelsize}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)} 
\PYG{n}{matplotlib}\PYG{o}{.}\PYG{n}{rcParams}\PYG{o}{.}\PYG{n}{update}\PYG{p}{(}\PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{font.size}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{12}\PYG{p}{\PYGZcb{}}\PYG{p}{)}
\PYG{n}{matplotlib}\PYG{o}{.}\PYG{n}{rcParams}\PYG{o}{.}\PYG{n}{update}\PYG{p}{(}\PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{axes.labelsize}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{12}\PYG{p}{\PYGZcb{}}\PYG{p}{)}

\PYG{n}{font} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{family}\PYG{l+s+s1}{\PYGZsq{}} \PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{sans}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{weight}\PYG{l+s+s1}{\PYGZsq{}} \PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{normal}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
        \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{size}\PYG{l+s+s1}{\PYGZsq{}}   \PYG{p}{:} \PYG{l+m+mi}{12}\PYG{p}{\PYGZcb{}}

\PYG{n}{matplotlib}\PYG{o}{.}\PYG{n}{rc}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{font}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{o}{*}\PYG{o}{*}\PYG{n}{font}\PYG{p}{)}

\PYG{n}{cmap} \PYG{o}{=} \PYG{n}{cm}\PYG{o}{.}\PYG{n}{viridis}

\PYG{n}{gridtype} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ease}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{n}{gridout} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{\PYGZhy{}ease2\PYGZhy{}250}\PYG{l+s+s1}{\PYGZsq{}}
\PYG{c+c1}{\PYGZsh{} Some region parameters hard\PYGZhy{}coded to show only the relevant region}
\PYG{c+c1}{\PYGZsh{} Overall shape of input grid (4320, 4320)}
\PYG{n}{slo} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{200}\PYG{p}{,} \PYG{l+m+mi}{290}\PYG{p}{,} \PYG{l+m+mi}{200}\PYG{p}{,} \PYG{l+m+mi}{290}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} EASE plotting region}
\PYG{n}{lon\PYGZus{}min} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{15}
\PYG{n}{lon\PYGZus{}max} \PYG{o}{=} \PYG{l+m+mi}{95}
\PYG{n}{lat\PYGZus{}min} \PYG{o}{=} \PYG{l+m+mi}{74}
\PYG{n}{lat\PYGZus{}max} \PYG{o}{=} \PYG{l+m+mi}{90}

\PYG{c+c1}{\PYGZsh{} Settings for gridlines}
\PYG{n}{lon\PYGZus{}step} \PYG{o}{=} \PYG{l+m+mi}{10}
\PYG{n}{lat\PYGZus{}step} \PYG{o}{=} \PYG{l+m+mi}{5}

\PYG{n}{plotfigs}\PYG{o}{=}\PYG{k+kc}{True}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}

\section{Parametrize the run}
\label{\detokenize{CIMR_L2_Sea_Ice_Drift_performanceAssessment:parametrize-the-run}}
\sphinxAtStartPar
User\sphinxhyphen{}set parameters for the running of the whole notebook

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{hemi} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{nh}\PYG{l+s+s1}{\PYGZsq{}}

\PYG{n}{test\PYGZus{}card} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{radiometric}\PYG{l+s+s2}{\PYGZdq{}}

\PYG{n}{griddeffile} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{algpath}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{grids\PYGZus{}py.def}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{n}{ncfile} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{driftpath}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{cimr\PYGZus{}devalgo\PYGZus{}l2\PYGZus{}sid\PYGZus{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{\PYGZus{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{.nc}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{gridout}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{hemi}\PYG{p}{)}\PYG{p}{,} \PYG{n}{test\PYGZus{}card}\PYG{p}{)}\PYG{p}{)}

\PYG{n}{pixshx} \PYG{o}{=} \PYG{l+m+mi}{3}
\PYG{n}{pixshy} \PYG{o}{=} \PYG{l+m+mi}{4}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}

\section{Simple Performance Assessment}
\label{\detokenize{CIMR_L2_Sea_Ice_Drift_performanceAssessment:simple-performance-assessment}}
\sphinxAtStartPar
A simple performance assessment is conducted here for the prototype SID algorithm (see notebooks for pre\sphinxhyphen{}processing and algorithm) run on the Radiometric scene. The SID algorithm requires two scenes, with a displacement between them. We thus created a second gridded file by applying a 24\sphinxhyphen{}hour time displacement in the metadata, and a 3\sphinxhyphen{}pixel x\sphinxhyphen{}displacement and a 4\sphinxhyphen{}pixel y\sphinxhyphen{}displacement to all pixels. The SID was then calculated using the Continuous Maximum Cross\sphinxhyphen{}Correlation method between these two gridded files and is here compared to the shift values applied to create the second gridded file. This validation therefore excludes inaccuracies that may arise from the gridding phase, as well as such technical uncertainties such as geolocation.

\sphinxAtStartPar
The chosen 3\sphinxhyphen{}pixel displacement in x over a 24\sphinxhyphen{}hour period is equivalent in the 5km input grid to 15km/day ice drift, and 4\sphinxhyphen{}pixel displacement in y is equivalent to a 20 km/day ice drift. These are reasonably realistic SID values.

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{def} \PYG{n+nf}{crs\PYGZus{}create}\PYG{p}{(}\PYG{n}{gridtype}\PYG{p}{,} \PYG{n}{hemi}\PYG{p}{)}\PYG{p}{:}

    \PYG{c+c1}{\PYGZsh{} Define grid based on region}
    \PYG{k}{if} \PYG{n}{gridtype} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{polstere}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{k}{if} \PYG{n}{hemi} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{nh}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
            \PYG{n}{plot\PYGZus{}proj4\PYGZus{}params} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{proj}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{stere}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
                                 \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lat\PYGZus{}0}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{90.}\PYG{p}{,}
                                 \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lat\PYGZus{}ts}\PYG{l+s+s1}{\PYGZsq{}} \PYG{p}{:} \PYG{l+m+mf}{70.}\PYG{p}{,}
                                 \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lon\PYGZus{}0}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{45.0}\PYG{p}{,}
                                 \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{a}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{6378273}\PYG{p}{,}
                                 \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{6356889.44891}\PYG{p}{\PYGZcb{}}
            \PYG{n}{plot\PYGZus{}globe} \PYG{o}{=} \PYG{n}{ccrs}\PYG{o}{.}\PYG{n}{Globe}\PYG{p}{(}\PYG{n}{semimajor\PYGZus{}axis}\PYG{o}{=}\PYG{n}{plot\PYGZus{}proj4\PYGZus{}params}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{a}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,}
                                    \PYG{n}{semiminor\PYGZus{}axis}\PYG{o}{=}\PYG{n}{plot\PYGZus{}proj4\PYGZus{}params}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}
            \PYG{n}{plot\PYGZus{}crs} \PYG{o}{=} \PYG{n}{ccrs}\PYG{o}{.}\PYG{n}{NorthPolarStereo}\PYG{p}{(}
                \PYG{n}{central\PYGZus{}longitude}\PYG{o}{=}\PYG{n}{plot\PYGZus{}proj4\PYGZus{}params}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lon\PYGZus{}0}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{globe}\PYG{o}{=}\PYG{n}{plot\PYGZus{}globe}\PYG{p}{)}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{n}{plot\PYGZus{}proj4\PYGZus{}params} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{proj}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{stere}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
                                 \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lat\PYGZus{}0}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{90.}\PYG{p}{,}
                                 \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lat\PYGZus{}ts}\PYG{l+s+s1}{\PYGZsq{}} \PYG{p}{:} \PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{70.}\PYG{p}{,}
                                 \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lon\PYGZus{}0}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{0.}\PYG{p}{,}
                                 \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{a}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{6378273}\PYG{p}{,}
                                 \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mf}{6356889.44891}\PYG{p}{\PYGZcb{}}
            \PYG{n}{plot\PYGZus{}globe} \PYG{o}{=} \PYG{n}{ccrs}\PYG{o}{.}\PYG{n}{Globe}\PYG{p}{(}\PYG{n}{semimajor\PYGZus{}axis}\PYG{o}{=}\PYG{n}{plot\PYGZus{}proj4\PYGZus{}params}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{a}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,}
                                    \PYG{n}{semiminor\PYGZus{}axis}\PYG{o}{=}\PYG{n}{plot\PYGZus{}proj4\PYGZus{}params}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}
            \PYG{n}{plot\PYGZus{}crs} \PYG{o}{=} \PYG{n}{ccrs}\PYG{o}{.}\PYG{n}{SouthPolarStereo}\PYG{p}{(}
                \PYG{n}{central\PYGZus{}longitude}\PYG{o}{=}\PYG{n}{plot\PYGZus{}proj4\PYGZus{}params}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lon\PYGZus{}0}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{globe}\PYG{o}{=}\PYG{n}{plot\PYGZus{}globe}\PYG{p}{)}
    \PYG{k}{elif} \PYG{n}{gridtype} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ease}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
        \PYG{k}{if} \PYG{n}{hemi} \PYG{o}{==} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{nh}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:}
            \PYG{n}{plot\PYGZus{}crs} \PYG{o}{=} \PYG{n}{ccrs}\PYG{o}{.}\PYG{n}{LambertAzimuthalEqualArea}\PYG{p}{(}\PYG{n}{central\PYGZus{}longitude}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,}
                                                      \PYG{n}{central\PYGZus{}latitude}\PYG{o}{=}\PYG{l+m+mi}{90}\PYG{p}{,}
                                                      \PYG{n}{false\PYGZus{}easting}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,}
                                                      \PYG{n}{false\PYGZus{}northing}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{n}{plot\PYGZus{}crs} \PYG{o}{=} \PYG{n}{ccrs}\PYG{o}{.}\PYG{n}{LambertAzimuthalEqualArea}\PYG{p}{(}\PYG{n}{central\PYGZus{}longitude}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,}
                                                      \PYG{n}{central\PYGZus{}latitude}\PYG{o}{=}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{90}\PYG{p}{,}
                                                      \PYG{n}{false\PYGZus{}easting}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,}
                                                      \PYG{n}{false\PYGZus{}northing}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}
    \PYG{k}{else}\PYG{p}{:}
        \PYG{k}{raise} \PYG{n+ne}{ValueError}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Unrecognised region }\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{region}\PYG{p}{)}\PYG{p}{)}

    \PYG{k}{return}\PYG{p}{(}\PYG{n}{plot\PYGZus{}crs}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}
\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Reading NetCDF file}

\PYG{k}{def} \PYG{n+nf}{nc\PYGZus{}read}\PYG{p}{(}\PYG{n}{ncfile}\PYG{p}{,} \PYG{n}{var}\PYG{p}{,} \PYG{n}{skip}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{procfmt}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}\PYG{p}{:}

    \PYG{n}{ncdata} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}

    \PYG{k}{if} \PYG{n+nb}{isinstance}\PYG{p}{(}\PYG{n}{var}\PYG{p}{,} \PYG{n+nb}{list}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{v} \PYG{o}{=} \PYG{n}{var}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
    \PYG{k}{else}\PYG{p}{:}
        \PYG{n}{v} \PYG{o}{=} \PYG{n}{var}

    \PYG{c+c1}{\PYGZsh{} Reading from the NetCDF file}
    \PYG{k}{with} \PYG{n}{Dataset}\PYG{p}{(}\PYG{n}{ncfile}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)} \PYG{k}{as} \PYG{n}{dataset}\PYG{p}{:}

        \PYG{k}{try}\PYG{p}{:}
            \PYG{n}{ncdata}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{fv}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{dataset}\PYG{o}{.}\PYG{n}{variables}\PYG{p}{[}\PYG{n}{v}\PYG{p}{]}\PYG{o}{.}\PYG{n+nv+vm}{\PYGZus{}\PYGZus{}dict\PYGZus{}\PYGZus{}}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZus{}FillValue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
        \PYG{k}{except}\PYG{p}{:}
            \PYG{k}{pass}

        \PYG{k}{if} \PYG{n+nb}{isinstance}\PYG{p}{(}\PYG{n}{var}\PYG{p}{,} \PYG{n+nb}{list}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{varlist} \PYG{o}{=} \PYG{n}{var}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{n}{varlist} \PYG{o}{=} \PYG{p}{[}\PYG{n}{var}\PYG{p}{]}
        \PYG{k}{for} \PYG{n}{item} \PYG{o+ow}{in} \PYG{n}{varlist}\PYG{p}{:}
            \PYG{n}{vardata} \PYG{o}{=} \PYG{n}{dataset}\PYG{p}{[}\PYG{n}{item}\PYG{p}{]}\PYG{p}{[}\PYG{p}{:}\PYG{p}{]}
            \PYG{k}{if} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{vardata}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{)} \PYG{o}{==} \PYG{l+m+mi}{3}\PYG{p}{:}
                \PYG{k}{if} \PYG{n}{skip}\PYG{p}{:}
                    \PYG{n}{vardata} \PYG{o}{=} \PYG{n}{vardata}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{p}{:}\PYG{p}{:}\PYG{n}{skip}\PYG{p}{,} \PYG{p}{:}\PYG{p}{:}\PYG{n}{skip}\PYG{p}{]}
                \PYG{k}{else}\PYG{p}{:}
                    \PYG{n}{vardata} \PYG{o}{=} \PYG{n}{vardata}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]}
            \PYG{k}{else}\PYG{p}{:}
                \PYG{k}{if} \PYG{n}{skip}\PYG{p}{:}
                    \PYG{n}{vardata} \PYG{o}{=} \PYG{n}{vardata}\PYG{p}{[}\PYG{p}{:}\PYG{p}{:}\PYG{n}{skip}\PYG{p}{,} \PYG{p}{:}\PYG{p}{:}\PYG{n}{skip}\PYG{p}{]}
                \PYG{k}{else}\PYG{p}{:}
                    \PYG{n}{vardata} \PYG{o}{=} \PYG{n}{vardata}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{]}

            \PYG{c+c1}{\PYGZsh{} This is for reducing flags to the lowest integers}
            \PYG{k}{if} \PYG{n}{var} \PYG{o+ow}{in} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{statusflag}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{status\PYGZus{}flag}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{flag}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{:}
                \PYG{n}{vardata} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{asarray}\PYG{p}{(}\PYG{n}{vardata}\PYG{p}{,} \PYG{n+nb}{float}\PYG{p}{)} \PYG{o}{+} \PYG{l+m+mi}{100}
                \PYG{n}{uniques} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{unique}\PYG{p}{(}\PYG{n}{vardata}\PYG{p}{)}
                \PYG{n}{uniques} \PYG{o}{=} \PYG{n}{uniques}\PYG{p}{[}\PYG{n}{np}\PYG{o}{.}\PYG{n}{logical\PYGZus{}not}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{isnan}\PYG{p}{(}\PYG{n}{uniques}\PYG{p}{)}\PYG{p}{)}\PYG{p}{]}
                \PYG{k}{for} \PYG{n}{newval}\PYG{p}{,} \PYG{n}{origval} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{uniques}\PYG{p}{)}\PYG{p}{:}
                    \PYG{n}{vardata}\PYG{p}{[}\PYG{n}{vardata} \PYG{o}{==} \PYG{n}{origval}\PYG{p}{]} \PYG{o}{=} \PYG{n}{newval}
                \PYG{n}{ncdata}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{sf\PYGZus{}labs}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{p}{[}\PYG{n+nb}{str}\PYG{p}{(}\PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{u} \PYG{o}{\PYGZhy{}} \PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{)} \PYG{k}{for} \PYG{n}{u} \PYG{o+ow}{in} \PYG{n}{uniques}\PYG{p}{]}

            \PYG{c+c1}{\PYGZsh{} NOTE: Be very careful with the fill value here. Trying to}
            \PYG{c+c1}{\PYGZsh{} use ncdata[\PYGZsq{}fv\PYGZsq{}] as the fill\PYGZus{}value for a status array such}
            \PYG{c+c1}{\PYGZsh{} as \PYGZsq{}flag\PYGZsq{} means that flag values of 0 (i.e. nominal) are}
            \PYG{c+c1}{\PYGZsh{} masked out}
            \PYG{k}{if} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{fv}\PYG{l+s+s1}{\PYGZsq{}} \PYG{o+ow}{in} \PYG{n}{ncdata}\PYG{o}{.}\PYG{n}{keys}\PYG{p}{(}\PYG{p}{)} \PYG{o+ow}{and} \PYG{n}{item} \PYG{o+ow}{not} \PYG{o+ow}{in} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{statusflag}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}
                                                      \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{status\PYGZus{}flag}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{flag}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{:}
                \PYG{n}{ncdata}\PYG{p}{[}\PYG{n}{item}\PYG{p}{]} \PYG{o}{=} \PYG{n}{ma}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{vardata}\PYG{p}{,} \PYG{n}{fill\PYGZus{}value}\PYG{o}{=}\PYG{n}{ncdata}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{fv}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}
            \PYG{k}{else}\PYG{p}{:}
                \PYG{n}{ncdata}\PYG{p}{[}\PYG{n}{item}\PYG{p}{]} \PYG{o}{=} \PYG{n}{ma}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{n}{vardata}\PYG{p}{)}

            \PYG{k}{if} \PYG{n}{var} \PYG{o+ow}{in} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{statusflag}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{status\PYGZus{}flag}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{flag}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{:}
                \PYG{n}{ncdata}\PYG{p}{[}\PYG{n}{item}\PYG{p}{]}\PYG{o}{.}\PYG{n}{mask} \PYG{o}{=} \PYG{k+kc}{None}
            \PYG{k}{else}\PYG{p}{:}
                \PYG{n}{ncdata}\PYG{p}{[}\PYG{n}{item}\PYG{p}{]}\PYG{o}{.}\PYG{n}{mask} \PYG{o}{=} \PYG{n}{ncdata}\PYG{p}{[}\PYG{n}{item}\PYG{p}{]}\PYG{o}{.}\PYG{n}{data} \PYG{o}{==} \PYG{n}{ncdata}\PYG{p}{[}\PYG{n}{item}\PYG{p}{]}\PYG{o}{.}\PYG{n}{fill\PYGZus{}value}

        \PYG{k}{if} \PYG{n}{skip}\PYG{p}{:}
            \PYG{n}{ncdata}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lon}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{dataset}\PYG{o}{.}\PYG{n}{variables}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lon}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{[}\PYG{p}{:}\PYG{p}{:}\PYG{n}{skip}\PYG{p}{,} \PYG{p}{:}\PYG{p}{:}\PYG{n}{skip}\PYG{p}{]}
            \PYG{n}{ncdata}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lat}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{dataset}\PYG{o}{.}\PYG{n}{variables}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lat}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{[}\PYG{p}{:}\PYG{p}{:}\PYG{n}{skip}\PYG{p}{,} \PYG{p}{:}\PYG{p}{:}\PYG{n}{skip}\PYG{p}{]}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{n}{ncdata}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lon}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{dataset}\PYG{o}{.}\PYG{n}{variables}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lon}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{[}\PYG{p}{:}\PYG{p}{]}
            \PYG{n}{ncdata}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lat}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{dataset}\PYG{o}{.}\PYG{n}{variables}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lat}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{[}\PYG{p}{:}\PYG{p}{]}

        \PYG{c+c1}{\PYGZsh{} Try fetching time info}
        \PYG{k}{try}\PYG{p}{:}
            \PYG{k}{try}\PYG{p}{:}
                \PYG{n}{d0} \PYG{o}{=} \PYG{n}{datetime}\PYG{o}{.}\PYG{n}{strptime}\PYG{p}{(}\PYG{n}{dataset}\PYG{o}{.}\PYG{n}{start\PYGZus{}date}\PYG{p}{,}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{Y\PYGZhy{}}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{m\PYGZhy{}}\PYG{l+s+si}{\PYGZpc{}d}\PYG{l+s+s1}{ }\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{H:}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{M:}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{S}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
                \PYG{n}{d1} \PYG{o}{=} \PYG{n}{datetime}\PYG{o}{.}\PYG{n}{strptime}\PYG{p}{(}\PYG{n}{dataset}\PYG{o}{.}\PYG{n}{stop\PYGZus{}date}\PYG{p}{,}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{Y\PYGZhy{}}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{m\PYGZhy{}}\PYG{l+s+si}{\PYGZpc{}d}\PYG{l+s+s1}{ }\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{H:}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{M:}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{S}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
            \PYG{k}{except}\PYG{p}{:}
                \PYG{k}{try}\PYG{p}{:}
                    \PYG{n}{d0} \PYG{o}{=} \PYG{n}{datetime}\PYG{o}{.}\PYG{n}{strptime}\PYG{p}{(}\PYG{n}{dataset}\PYG{o}{.}\PYG{n}{start\PYGZus{}date\PYGZus{}and\PYGZus{}time}\PYG{p}{,}
                                           \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{Y\PYGZhy{}}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{m\PYGZhy{}}\PYG{l+s+si}{\PYGZpc{}d}\PYG{l+s+s1}{T}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{H:}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{M:}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{SZ}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
                    \PYG{n}{d1} \PYG{o}{=} \PYG{n}{datetime}\PYG{o}{.}\PYG{n}{strptime}\PYG{p}{(}\PYG{n}{dataset}\PYG{o}{.}\PYG{n}{end\PYGZus{}date\PYGZus{}and\PYGZus{}time}\PYG{p}{,}
                                           \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{Y\PYGZhy{}}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{m\PYGZhy{}}\PYG{l+s+si}{\PYGZpc{}d}\PYG{l+s+s1}{T}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{H:}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{M:}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{SZ}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
                \PYG{k}{except}\PYG{p}{:}
                    \PYG{n}{d0} \PYG{o}{=} \PYG{n}{datetime}\PYG{o}{.}\PYG{n}{strptime}\PYG{p}{(}\PYG{n}{dataset}\PYG{o}{.}\PYG{n}{time\PYGZus{}coverage\PYGZus{}start}\PYG{p}{,}
                                           \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{Y\PYGZhy{}}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{m\PYGZhy{}}\PYG{l+s+si}{\PYGZpc{}d}\PYG{l+s+s1}{T}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{H:}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{M:}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{SZ}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
                    \PYG{n}{d1} \PYG{o}{=} \PYG{n}{datetime}\PYG{o}{.}\PYG{n}{strptime}\PYG{p}{(}\PYG{n}{dataset}\PYG{o}{.}\PYG{n}{time\PYGZus{}coverage\PYGZus{}end}\PYG{p}{,}
                                           \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{Y\PYGZhy{}}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{m\PYGZhy{}}\PYG{l+s+si}{\PYGZpc{}d}\PYG{l+s+s1}{T}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{H:}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{M:}\PYG{l+s+s1}{\PYGZpc{}}\PYG{l+s+s1}{SZ}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
            \PYG{n}{d0\PYGZus{}00} \PYG{o}{=} \PYG{n}{datetime}\PYG{o}{.}\PYG{n}{combine}\PYG{p}{(}\PYG{n}{d0}\PYG{o}{.}\PYG{n}{date}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}\PYG{n}{time}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{d1\PYGZus{}00} \PYG{o}{=} \PYG{n}{datetime}\PYG{o}{.}\PYG{n}{combine}\PYG{p}{(}\PYG{n}{d1}\PYG{o}{.}\PYG{n}{date}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}\PYG{n}{time}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{ncdata}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{sdate}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{d0\PYGZus{}00}
            \PYG{n}{ncdata}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{edate}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{d1\PYGZus{}00}
            \PYG{n}{ncdata}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{tspan\PYGZus{}hours}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{p}{(}\PYG{n}{d1\PYGZus{}00} \PYG{o}{\PYGZhy{}} \PYG{n}{d0\PYGZus{}00}\PYG{p}{)}\PYG{o}{.}\PYG{n}{total\PYGZus{}seconds}\PYG{p}{(}\PYG{p}{)} \PYG{o}{/} \PYG{p}{(}\PYG{l+m+mf}{60.}\PYG{o}{*}\PYG{l+m+mf}{60.}\PYG{p}{)}
        \PYG{k}{except}\PYG{p}{:}
            \PYG{k}{pass}

        \PYG{n}{ncdata}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{time}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{dataset}\PYG{o}{.}\PYG{n}{variables}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{time}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}

    \PYG{k}{return} \PYG{n}{ncdata}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}
\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Reading in the data}

\PYG{n}{varlist} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{driftX}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{driftY}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{status\PYGZus{}flag}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
\PYG{n}{iddata} \PYG{o}{=} \PYG{n}{nc\PYGZus{}read}\PYG{p}{(}\PYG{n}{ncfile}\PYG{p}{,} \PYG{n}{varlist}\PYG{p}{,} \PYG{n}{skip}\PYG{o}{=}\PYG{k+kc}{None}\PYG{p}{,} \PYG{n}{procfmt}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}

\end{sphinxuseclass}
\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Plotting the ice drift}
\PYG{c+c1}{\PYGZsh{} Modified from the SeaSurfaceTemperature\PYGZus{}ATBD\PYGZus{}v2, by Emy Alerskans}

\PYG{c+c1}{\PYGZsh{} Drift data}
\PYG{n}{xydata} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{dx}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{iddata}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{driftX}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{dy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{iddata}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{driftY}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{\PYGZcb{}}
\PYG{n}{flag} \PYG{o}{=} \PYG{n}{iddata}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{status\PYGZus{}flag}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
\PYG{n}{limminxy} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{nanmin}\PYG{p}{(}\PYG{p}{[}\PYG{n}{np}\PYG{o}{.}\PYG{n}{nanmin}\PYG{p}{(}\PYG{n}{a}\PYG{p}{)} \PYG{k}{for} \PYG{n}{a} \PYG{o+ow}{in} \PYG{n}{xydata}\PYG{o}{.}\PYG{n}{values}\PYG{p}{(}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{limminxy} \PYG{o}{=} \PYG{n}{limminxy} \PYG{o}{\PYGZhy{}} \PYG{l+m+mf}{0.1} \PYG{o}{*} \PYG{n+nb}{abs}\PYG{p}{(}\PYG{n}{limminxy}\PYG{p}{)}
\PYG{n}{limmaxxy} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{nanmax}\PYG{p}{(}\PYG{p}{[}\PYG{n}{np}\PYG{o}{.}\PYG{n}{nanmax}\PYG{p}{(}\PYG{n}{a}\PYG{p}{)} \PYG{k}{for} \PYG{n}{a} \PYG{o+ow}{in} \PYG{n}{xydata}\PYG{o}{.}\PYG{n}{values}\PYG{p}{(}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{limmaxxy} \PYG{o}{=} \PYG{n}{limmaxxy} \PYG{o}{+} \PYG{l+m+mf}{0.1} \PYG{o}{*} \PYG{n+nb}{abs}\PYG{p}{(}\PYG{n}{limmaxxy}\PYG{p}{)}
\PYG{n}{limminflag} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{nanmin}\PYG{p}{(}\PYG{n}{flag}\PYG{p}{)}
\PYG{n}{limmaxflag} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{nanmax}\PYG{p}{(}\PYG{n}{flag}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Output lat/lons}
\PYG{n}{og} \PYG{o}{=} \PYG{n}{gridout}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{hemi}\PYG{p}{)}
\PYG{n}{out\PYGZus{}area\PYGZus{}def} \PYG{o}{=} \PYG{n}{parse\PYGZus{}area\PYGZus{}file}\PYG{p}{(}\PYG{n}{griddeffile}\PYG{p}{,} \PYG{n}{og}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
\PYG{n}{olons}\PYG{p}{,} \PYG{n}{olats} \PYG{o}{=} \PYG{n}{out\PYGZus{}area\PYGZus{}def}\PYG{o}{.}\PYG{n}{get\PYGZus{}lonlats}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Coordinate reference systems}
\PYG{n}{plot\PYGZus{}crs} \PYG{o}{=} \PYG{n}{crs\PYGZus{}create}\PYG{p}{(}\PYG{n}{gridtype}\PYG{p}{,} \PYG{n}{hemi}\PYG{p}{)}
\PYG{n}{pc} \PYG{o}{=} \PYG{n}{ccrs}\PYG{o}{.}\PYG{n}{PlateCarree}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plotting drift}
\PYG{n}{fig} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{]}\PYG{p}{)}
\PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{var} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n+nb}{list}\PYG{p}{(}\PYG{n}{xydata}\PYG{o}{.}\PYG{n}{keys}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{ax} \PYG{o}{=} \PYG{n}{fig}\PYG{o}{.}\PYG{n}{add\PYGZus{}subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{projection}\PYG{o}{=}\PYG{n}{plot\PYGZus{}crs}\PYG{p}{)}
    \PYG{n}{im} \PYG{o}{=} \PYG{n}{ax}\PYG{o}{.}\PYG{n}{pcolormesh}\PYG{p}{(}\PYG{n}{olons}\PYG{p}{[}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{:}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{:}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,} \PYG{n}{olats}\PYG{p}{[}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{:}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{:}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,} 
                       \PYG{n}{xydata}\PYG{p}{[}\PYG{n}{var}\PYG{p}{]}\PYG{p}{[}\PYG{p}{:}\PYG{p}{]}\PYG{p}{[}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{:}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{:}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,} \PYG{n}{transform}\PYG{o}{=}\PYG{n}{pc}\PYG{p}{,}
                       \PYG{n}{cmap}\PYG{o}{=}\PYG{n}{cmap}\PYG{p}{,} \PYG{n}{vmin}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{vmax}\PYG{o}{=}\PYG{n}{math}\PYG{o}{.}\PYG{n}{ceil}\PYG{p}{(}\PYG{n}{limmaxxy}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{coastlines}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}extent}\PYG{p}{(}\PYG{p}{[}\PYG{n}{lon\PYGZus{}min}\PYG{p}{,} \PYG{n}{lon\PYGZus{}max}\PYG{p}{,} \PYG{n}{lat\PYGZus{}min}\PYG{p}{,} \PYG{n}{lat\PYGZus{}max}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{gl} \PYG{o}{=} \PYG{n}{ax}\PYG{o}{.}\PYG{n}{gridlines}\PYG{p}{(}\PYG{n}{crs}\PYG{o}{=}\PYG{n}{ccrs}\PYG{o}{.}\PYG{n}{PlateCarree}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{draw\PYGZus{}labels}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{:}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{gl}\PYG{o}{.}\PYG{n}{top\PYGZus{}labels} \PYG{o}{=} \PYG{k+kc}{False}
    \PYG{n}{gl}\PYG{o}{.}\PYG{n}{right\PYGZus{}labels} \PYG{o}{=} \PYG{k+kc}{False}
    \PYG{n}{gl}\PYG{o}{.}\PYG{n}{xlocator} \PYG{o}{=} \PYG{n}{mticker}\PYG{o}{.}\PYG{n}{FixedLocator}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{180}\PYG{p}{,} \PYG{l+m+mi}{180}\PYG{p}{,} \PYG{n}{lon\PYGZus{}step}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{gl}\PYG{o}{.}\PYG{n}{ylocator} \PYG{o}{=} \PYG{n}{mticker}\PYG{o}{.}\PYG{n}{FixedLocator}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{90}\PYG{p}{,} \PYG{l+m+mi}{90}\PYG{p}{,} \PYG{n}{lat\PYGZus{}step}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{gl}\PYG{o}{.}\PYG{n}{xlabel\PYGZus{}style} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{size}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{14}\PYG{p}{\PYGZcb{}}
    \PYG{n}{gl}\PYG{o}{.}\PYG{n}{ylabel\PYGZus{}style} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{size}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{14}\PYG{p}{\PYGZcb{}}
        
    \PYG{c+c1}{\PYGZsh{} Colourbar}
    \PYG{n}{divider} \PYG{o}{=} \PYG{n}{make\PYGZus{}axes\PYGZus{}locatable}\PYG{p}{(}\PYG{n}{ax}\PYG{p}{)}
    \PYG{n}{cax} \PYG{o}{=} \PYG{n}{divider}\PYG{o}{.}\PYG{n}{append\PYGZus{}axes}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{right}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{size}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{3}\PYG{l+s+s2}{\PYGZpc{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{pad}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{2}\PYG{l+s+s2}{\PYGZpc{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{axes\PYGZus{}class}\PYG{o}{=}\PYG{n}{plt}\PYG{o}{.}\PYG{n}{Axes}\PYG{p}{)}
    \PYG{n}{cb} \PYG{o}{=} \PYG{n}{fig}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{im}\PYG{p}{,} \PYG{n}{cax}\PYG{o}{=}\PYG{n}{cax}\PYG{p}{)}
    \PYG{n}{cb}\PYG{o}{.}\PYG{n}{set\PYGZus{}label}\PYG{p}{(}\PYG{n}{label}\PYG{o}{=}\PYG{n}{var}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{16}\PYG{p}{,} \PYG{n}{labelpad}\PYG{o}{=}\PYG{l+m+mf}{20.0}\PYG{p}{)}
    \PYG{n}{cb}\PYG{o}{.}\PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylim}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{math}\PYG{o}{.}\PYG{n}{ceil}\PYG{p}{(}\PYG{n}{limmaxxy}\PYG{p}{)}\PYG{p}{)}
    

\PYG{c+c1}{\PYGZsh{} Status flags}
\PYG{n}{ax} \PYG{o}{=} \PYG{n}{fig}\PYG{o}{.}\PYG{n}{add\PYGZus{}subplot}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{projection}\PYG{o}{=}\PYG{n}{plot\PYGZus{}crs}\PYG{p}{)}
\PYG{n}{im} \PYG{o}{=} \PYG{n}{ax}\PYG{o}{.}\PYG{n}{pcolormesh}\PYG{p}{(}\PYG{n}{olons}\PYG{p}{[}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{:}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{:}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,} \PYG{n}{olats}\PYG{p}{[}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{:}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{:}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,} 
                    \PYG{n}{flag}\PYG{p}{[}\PYG{p}{:}\PYG{p}{]}\PYG{p}{[}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{:}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{:}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,} \PYG{n}{transform}\PYG{o}{=}\PYG{n}{pc}\PYG{p}{,}
                    \PYG{n}{cmap}\PYG{o}{=}\PYG{n}{cmap}\PYG{p}{,} \PYG{n}{vmin}\PYG{o}{=}\PYG{n}{limminflag}\PYG{p}{,} \PYG{n}{vmax}\PYG{o}{=}\PYG{n}{limmaxflag}\PYG{p}{)}
\PYG{n}{ax}\PYG{o}{.}\PYG{n}{coastlines}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}extent}\PYG{p}{(}\PYG{p}{[}\PYG{n}{lon\PYGZus{}min}\PYG{p}{,} \PYG{n}{lon\PYGZus{}max}\PYG{p}{,} \PYG{n}{lat\PYGZus{}min}\PYG{p}{,} \PYG{n}{lat\PYGZus{}max}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{gl} \PYG{o}{=} \PYG{n}{ax}\PYG{o}{.}\PYG{n}{gridlines}\PYG{p}{(}\PYG{n}{crs}\PYG{o}{=}\PYG{n}{ccrs}\PYG{o}{.}\PYG{n}{PlateCarree}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{draw\PYGZus{}labels}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{:}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{gl}\PYG{o}{.}\PYG{n}{top\PYGZus{}labels} \PYG{o}{=} \PYG{k+kc}{False}
\PYG{n}{gl}\PYG{o}{.}\PYG{n}{right\PYGZus{}labels} \PYG{o}{=} \PYG{k+kc}{False}
\PYG{n}{gl}\PYG{o}{.}\PYG{n}{xlocator} \PYG{o}{=} \PYG{n}{mticker}\PYG{o}{.}\PYG{n}{FixedLocator}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{180}\PYG{p}{,} \PYG{l+m+mi}{180}\PYG{p}{,} \PYG{n}{lon\PYGZus{}step}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{gl}\PYG{o}{.}\PYG{n}{ylocator} \PYG{o}{=} \PYG{n}{mticker}\PYG{o}{.}\PYG{n}{FixedLocator}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{90}\PYG{p}{,} \PYG{l+m+mi}{90}\PYG{p}{,} \PYG{n}{lat\PYGZus{}step}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{gl}\PYG{o}{.}\PYG{n}{xlabel\PYGZus{}style} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{size}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{14}\PYG{p}{\PYGZcb{}}
\PYG{n}{gl}\PYG{o}{.}\PYG{n}{ylabel\PYGZus{}style} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{size}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{14}\PYG{p}{\PYGZcb{}}
        
\PYG{c+c1}{\PYGZsh{} Colourbar}
\PYG{n}{divider} \PYG{o}{=} \PYG{n}{make\PYGZus{}axes\PYGZus{}locatable}\PYG{p}{(}\PYG{n}{ax}\PYG{p}{)}
\PYG{n}{cax} \PYG{o}{=} \PYG{n}{divider}\PYG{o}{.}\PYG{n}{append\PYGZus{}axes}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{right}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{size}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{3}\PYG{l+s+s2}{\PYGZpc{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{pad}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{2}\PYG{l+s+s2}{\PYGZpc{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{axes\PYGZus{}class}\PYG{o}{=}\PYG{n}{plt}\PYG{o}{.}\PYG{n}{Axes}\PYG{p}{)}
\PYG{n}{cb} \PYG{o}{=} \PYG{n}{fig}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{im}\PYG{p}{,} \PYG{n}{cax}\PYG{o}{=}\PYG{n}{cax}\PYG{p}{)}
\PYG{n}{cb}\PYG{o}{.}\PYG{n}{set\PYGZus{}label}\PYG{p}{(}\PYG{n}{label}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Flag}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{16}\PYG{p}{,} \PYG{n}{labelpad}\PYG{o}{=}\PYG{l+m+mf}{20.0}\PYG{p}{)}
\PYG{n}{cb}\PYG{o}{.}\PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylim}\PYG{p}{(}\PYG{n}{limminflag}\PYG{p}{,} \PYG{n}{limmaxflag}\PYG{p}{)}
        
\PYG{k}{if} \PYG{n}{plotfigs}\PYG{p}{:}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{savefig}\PYG{p}{(}\PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{figpath}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{dxdy.png}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}

\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{FLAG VALUES }\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{Unprocessed pixel                              \PYGZhy{}1}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{Nominal                                        0}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{Outside image border                           1}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{Close to image border                          2}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{Pixel center over land                         3}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{No ice                                         4}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{Close to coast or edge                         5}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{Close to missing pixel                         6}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{Close to unprocessed pixel                     7}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{Icedrift optimisation failed                   8}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{Icedrift failed                                9}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{Icedrift with low correlation                  10}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{Icedrift calculation took too long             11}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{Icedrift calculation refused by neighbours     12}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{Icedrift calculation corrected by neighbours   13}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{Icedrift no average                            14}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{Icedrift masked due to summer season           15}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{Icedrift multi\PYGZhy{}oi interpolation                16}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{Icedrift calcuated with smaller pattern        17}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{Icedrift masked due to NWP                     18}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\noindent\sphinxincludegraphics{{2602f1c197d2bb92a8f6b8ca87f4d5be8f4a4ae8d59e680172f644be06f80726}.png}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
FLAG VALUES 
Unprocessed pixel                              \PYGZhy{}1
Nominal                                        0
Outside image border                           1
Close to image border                          2
Pixel center over land                         3
No ice                                         4
Close to coast or edge                         5
Close to missing pixel                         6
Close to unprocessed pixel                     7
Icedrift optimisation failed                   8
Icedrift failed                                9
Icedrift with low correlation                  10
Icedrift calculation took too long             11
Icedrift calculation refused by neighbours     12
Icedrift calculation corrected by neighbours   13
Icedrift no average                            14
Icedrift masked due to summer season           15
Icedrift multi\PYGZhy{}oi interpolation                16
Icedrift calcuated with smaller pattern        17
Icedrift masked due to NWP                     18
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}
\sphinxAtStartPar
Here the output x\sphinxhyphen{} and y\sphinxhyphen{}components of drift are plotted. They are close to the 15 km/day in x and 20 km/day in y expected from the input data, except for one patch around 70E, 83N, which the ice drift algorithm has not calculated correctly for the x\sphinxhyphen{}direction. This is suspected to be due to the limitations of the Radiometric test card, which has somewhat “blocky” features, and for the next round of algorithm improvements emphasis will be on an improved set of test scenes. These are planned to be created from model data, transformed onto a set of swaths separated in time, and then run through the CIMR data simulator. Therefore these scenes will have the texture expected of satellite observations of sea ice at this resolution, and the algorithm will have more pattern to match.

\sphinxAtStartPar
There is also a region around 20W,86N where the vectors were interpolated and are thus less accurate.

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Plotting the residuals}
\PYG{c+c1}{\PYGZsh{} Modified from the SeaSurfaceTemperature\PYGZus{}ATBD\PYGZus{}v2, by Emy Alerskans}

\PYG{n}{pixsize} \PYG{o}{=} \PYG{l+m+mf}{5.0}
\PYG{n}{expectedx} \PYG{o}{=} \PYG{n}{pixshx} \PYG{o}{*} \PYG{n}{pixsize}
\PYG{n}{expectedy} \PYG{o}{=} \PYG{n}{pixshy} \PYG{o}{*} \PYG{n}{pixsize}
\PYG{n}{testx} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{full}\PYG{p}{(}\PYG{n}{iddata}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{driftX}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{,} \PYG{n}{expectedx}\PYG{p}{)}
\PYG{n}{testy} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{full}\PYG{p}{(}\PYG{n}{iddata}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{driftX}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{,} \PYG{n}{expectedy}\PYG{p}{)}

\PYG{n}{testdata} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{dx}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{testx}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{dy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{testy}\PYG{p}{\PYGZcb{}}
\PYG{n}{resx} \PYG{o}{=} \PYG{n}{iddata}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{driftX}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{testx}
\PYG{n}{resy} \PYG{o}{=} \PYG{n}{iddata}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{driftY}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{\PYGZhy{}} \PYG{n}{testy}
\PYG{n}{resdata} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{dx}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{resx}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{dy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{n}{resy}\PYG{p}{\PYGZcb{}}

\PYG{n}{limminres} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{nanmin}\PYG{p}{(}\PYG{p}{[}\PYG{n}{np}\PYG{o}{.}\PYG{n}{nanmin}\PYG{p}{(}\PYG{n}{a}\PYG{p}{)} \PYG{k}{for} \PYG{n}{a} \PYG{o+ow}{in} \PYG{n}{resdata}\PYG{o}{.}\PYG{n}{values}\PYG{p}{(}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{limminres} \PYG{o}{=} \PYG{n}{limminres} \PYG{o}{\PYGZhy{}} \PYG{l+m+mf}{0.1} \PYG{o}{*} \PYG{n+nb}{abs}\PYG{p}{(}\PYG{n}{limminres}\PYG{p}{)}
\PYG{n}{limmaxres} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{nanmax}\PYG{p}{(}\PYG{p}{[}\PYG{n}{np}\PYG{o}{.}\PYG{n}{nanmax}\PYG{p}{(}\PYG{n}{a}\PYG{p}{)} \PYG{k}{for} \PYG{n}{a} \PYG{o+ow}{in} \PYG{n}{resdata}\PYG{o}{.}\PYG{n}{values}\PYG{p}{(}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{limmaxres} \PYG{o}{=} \PYG{n}{limmaxres} \PYG{o}{+} \PYG{l+m+mf}{0.1} \PYG{o}{*} \PYG{n+nb}{abs}\PYG{p}{(}\PYG{n}{limmaxres}\PYG{p}{)}
\PYG{n}{lim} \PYG{o}{=} \PYG{n+nb}{max}\PYG{p}{(}\PYG{p}{[}\PYG{n+nb}{abs}\PYG{p}{(}\PYG{n}{limminres}\PYG{p}{)}\PYG{p}{,} \PYG{n}{limmaxres}\PYG{p}{]}\PYG{p}{)}

\PYG{n}{fig} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{]}\PYG{p}{)}
\PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{var} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n+nb}{list}\PYG{p}{(}\PYG{n}{resdata}\PYG{o}{.}\PYG{n}{keys}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{ax} \PYG{o}{=} \PYG{n}{fig}\PYG{o}{.}\PYG{n}{add\PYGZus{}subplot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{projection}\PYG{o}{=}\PYG{n}{plot\PYGZus{}crs}\PYG{p}{)}
    \PYG{n}{im} \PYG{o}{=} \PYG{n}{ax}\PYG{o}{.}\PYG{n}{pcolormesh}\PYG{p}{(}\PYG{n}{olons}\PYG{p}{[}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{:}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{:}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,} \PYG{n}{olats}\PYG{p}{[}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{:}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{:}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,} 
                       \PYG{n}{resdata}\PYG{p}{[}\PYG{n}{var}\PYG{p}{]}\PYG{p}{[}\PYG{p}{:}\PYG{p}{]}\PYG{p}{[}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{:}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{:}\PYG{n}{slo}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,} \PYG{n}{transform}\PYG{o}{=}\PYG{n}{pc}\PYG{p}{,}
                       \PYG{n}{cmap}\PYG{o}{=}\PYG{n}{cmocean}\PYG{o}{.}\PYG{n}{cm}\PYG{o}{.}\PYG{n}{balance}\PYG{p}{,} \PYG{n}{vmin}\PYG{o}{=}\PYG{o}{\PYGZhy{}}\PYG{n}{lim}\PYG{p}{,} \PYG{n}{vmax}\PYG{o}{=}\PYG{n}{lim}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{coastlines}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}extent}\PYG{p}{(}\PYG{p}{[}\PYG{n}{lon\PYGZus{}min}\PYG{p}{,} \PYG{n}{lon\PYGZus{}max}\PYG{p}{,} \PYG{n}{lat\PYGZus{}min}\PYG{p}{,} \PYG{n}{lat\PYGZus{}max}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{gl} \PYG{o}{=} \PYG{n}{ax}\PYG{o}{.}\PYG{n}{gridlines}\PYG{p}{(}\PYG{n}{crs}\PYG{o}{=}\PYG{n}{ccrs}\PYG{o}{.}\PYG{n}{PlateCarree}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{draw\PYGZus{}labels}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{:}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{gl}\PYG{o}{.}\PYG{n}{top\PYGZus{}labels} \PYG{o}{=} \PYG{k+kc}{False}
    \PYG{n}{gl}\PYG{o}{.}\PYG{n}{right\PYGZus{}labels} \PYG{o}{=} \PYG{k+kc}{False}
    \PYG{n}{gl}\PYG{o}{.}\PYG{n}{xlocator} \PYG{o}{=} \PYG{n}{mticker}\PYG{o}{.}\PYG{n}{FixedLocator}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{180}\PYG{p}{,} \PYG{l+m+mi}{180}\PYG{p}{,} \PYG{n}{lon\PYGZus{}step}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{gl}\PYG{o}{.}\PYG{n}{ylocator} \PYG{o}{=} \PYG{n}{mticker}\PYG{o}{.}\PYG{n}{FixedLocator}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{90}\PYG{p}{,} \PYG{l+m+mi}{90}\PYG{p}{,} \PYG{n}{lat\PYGZus{}step}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{gl}\PYG{o}{.}\PYG{n}{xlabel\PYGZus{}style} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{size}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{14}\PYG{p}{\PYGZcb{}}
    \PYG{n}{gl}\PYG{o}{.}\PYG{n}{ylabel\PYGZus{}style} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{size}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{:} \PYG{l+m+mi}{14}\PYG{p}{\PYGZcb{}}
        
    \PYG{c+c1}{\PYGZsh{} Colourbar}
    \PYG{n}{divider} \PYG{o}{=} \PYG{n}{make\PYGZus{}axes\PYGZus{}locatable}\PYG{p}{(}\PYG{n}{ax}\PYG{p}{)}
    \PYG{n}{cax} \PYG{o}{=} \PYG{n}{divider}\PYG{o}{.}\PYG{n}{append\PYGZus{}axes}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{right}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{size}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{3}\PYG{l+s+s2}{\PYGZpc{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{pad}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{2}\PYG{l+s+s2}{\PYGZpc{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{axes\PYGZus{}class}\PYG{o}{=}\PYG{n}{plt}\PYG{o}{.}\PYG{n}{Axes}\PYG{p}{)}
    \PYG{n}{cb} \PYG{o}{=} \PYG{n}{fig}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{im}\PYG{p}{,} \PYG{n}{cax}\PYG{o}{=}\PYG{n}{cax}\PYG{p}{)}
    \PYG{n}{cb}\PYG{o}{.}\PYG{n}{set\PYGZus{}label}\PYG{p}{(}\PYG{n}{label}\PYG{o}{=}\PYG{n}{var}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{16}\PYG{p}{,} \PYG{n}{labelpad}\PYG{o}{=}\PYG{l+m+mf}{20.0}\PYG{p}{)}
    \PYG{n}{cb}\PYG{o}{.}\PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylim}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n}{lim}\PYG{p}{,} \PYG{n}{lim}\PYG{p}{)}
        
\PYG{k}{if} \PYG{n}{plotfigs}\PYG{p}{:}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{savefig}\PYG{p}{(}\PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{figpath}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{resdxdy.png}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\noindent\sphinxincludegraphics{{9f162001f52dd5597f72fceb8aff993dd82c15c89cc6e18ed4a105b8c7693caf}.png}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}
\sphinxAtStartPar
Here the residuals are plotted, and again, the areas in which the algorithm did not fully succeed are highlighted, while most of the field has a well\sphinxhyphen{}calculated ice drift.

\begin{sphinxuseclass}{cell}\begin{sphinxVerbatimInput}

\begin{sphinxuseclass}{cell_input}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Plotting a histogram}

\PYG{n}{minbin} \PYG{o}{=} \PYG{n}{math}\PYG{o}{.}\PYG{n}{floor}\PYG{p}{(}\PYG{n}{limminres}\PYG{p}{)}
\PYG{n}{maxbin} \PYG{o}{=} \PYG{n}{math}\PYG{o}{.}\PYG{n}{ceil}\PYG{p}{(}\PYG{n}{limmaxres}\PYG{p}{)} \PYG{o}{+} \PYG{l+m+mi}{1}
\PYG{n}{hbins} \PYG{o}{=} \PYG{n+nb}{list}\PYG{p}{(}\PYG{n+nb}{range}\PYG{p}{(}\PYG{n}{minbin}\PYG{p}{,} \PYG{n}{maxbin}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}
\PYG{c+c1}{\PYGZsh{}step = 0.5}
\PYG{c+c1}{\PYGZsh{}hbins = [(step * x) + minbin for x in range((int(abs(maxbin \PYGZhy{} minbin) / step)))]}

\PYG{k+kn}{import} \PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{transforms} \PYG{k}{as} \PYG{n+nn}{transforms}

\PYG{n}{fig} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{ax} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
\PYG{n}{c} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
\PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{var} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n+nb}{list}\PYG{p}{(}\PYG{n}{resdata}\PYG{o}{.}\PYG{n}{keys}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{ax}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]} \PYG{o}{=} \PYG{n}{fig}\PYG{o}{.}\PYG{n}{add\PYGZus{}subplot}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{resdata}\PYG{p}{)}\PYG{p}{,}\PYG{n}{i}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}    
    \PYG{n}{ax}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{hist}\PYG{p}{(}\PYG{n}{resdata}\PYG{p}{[}\PYG{n}{var}\PYG{p}{]}\PYG{p}{[}\PYG{p}{:}\PYG{p}{]}\PYG{o}{.}\PYG{n}{flatten}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{bins}\PYG{o}{=}\PYG{n}{hbins}\PYG{p}{)}
    \PYG{n}{ax}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{\PYGZhy{}drift residuals}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{var}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{:}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{12}\PYG{p}{)}

    \PYG{n}{ax}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.39}\PYG{p}{,}\PYG{l+m+mf}{0.96}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{BIAS: }\PYG{l+s+si}{\PYGZob{}:.2f\PYGZcb{}}\PYG{l+s+s1}{ [km]}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{nanmean}\PYG{p}{(}\PYG{n}{resdata}\PYG{p}{[}\PYG{n}{var}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{transform}\PYG{o}{=}\PYG{n}{ax}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{transAxes}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{right}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{top}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{xx\PYGZhy{}small}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.39}\PYG{p}{,}\PYG{l+m+mf}{0.90}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{RMSE: }\PYG{l+s+si}{\PYGZob{}:.2f\PYGZcb{}}\PYG{l+s+s1}{ [km]}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{nanstd}\PYG{p}{(}\PYG{n}{resdata}\PYG{p}{[}\PYG{n}{var}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{transform}\PYG{o}{=}\PYG{n}{ax}\PYG{p}{[}\PYG{n}{i}\PYG{p}{]}\PYG{o}{.}\PYG{n}{transAxes}\PYG{p}{,} \PYG{n}{ha}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{right}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{va}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{top}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{xx\PYGZhy{}small}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{k}{if} \PYG{n}{plotfigs}\PYG{p}{:}
    \PYG{n}{plt}\PYG{o}{.}\PYG{n}{savefig}\PYG{p}{(}\PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{figpath}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{hist\PYGZus{}res.png}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}

\end{sphinxuseclass}\end{sphinxVerbatimInput}
\begin{sphinxVerbatimOutput}

\begin{sphinxuseclass}{cell_output}
\noindent\sphinxincludegraphics{{e6f007b9eb700f008c9c48789891bad8be68affa62569c2b20fcd4c687633e2b}.png}

\end{sphinxuseclass}\end{sphinxVerbatimOutput}

\end{sphinxuseclass}
\sphinxAtStartPar
The histograms of residuals are shown here. The RMSE for this artifical data is below the target value of 2.6 km/day from the MRD, \textasciitilde{}2 km (lower for y\sphinxhyphen{}direction). The bias is also reasonably low, \sphinxhyphen{}0.3 km (lower for y\sphinxhyphen{}direction). The mismatch between x and y here is due to the fact that the bulk of the error comes from the one single patch that the algorithm did not calculate well in the x\sphinxhyphen{}direction. It is predicted that this will not be an issue with more realistic test scenes.

\sphinxAtStartPar
In addition, the residuals here are not expected to be accurate, due to the lack of natural features in the test card, and the fact that the second gridded image was exactly the first gridded image but with a shift. We will be able to characterise likely residuals better with the more realistic test cards we are planning to use in L2PAD.

\sphinxstepscope


\chapter{Roadmap for future ATBD development}
\label{\detokenize{roadmap_for_future_atbd_developments:roadmap-for-future-atbd-development}}\label{\detokenize{roadmap_for_future_atbd_developments::doc}}
\sphinxAtStartPar
The SID ATBD was prepared by gathering text and equations from a number of existing documentations, for example from the EUMETSAT OSI SAF or CIMR MRC. This was greatly facilitated by the similarities between the LaTeX and Markdown syntax for mathematical expressions.

\sphinxAtStartPar
In terms of algorithm, we continue the approach introduced in CIMR MRC to do Level\sphinxhyphen{}2 “swath\sphinxhyphen{}to\sphinxhyphen{}swath” retrievals of sea\sphinxhyphen{}ice motion, instead of the classical approach to prepare sea\sphinxhyphen{}ice motion products at Level\sphinxhyphen{}3 from daily aggregated maps of brightness temperatures. Several characteristics of the L2 SID product will put specific requirements on the future CIMR ground segment: it is one of the only products that will start with a remapping of the L1B TB onto an EASE2 grid as sea\sphinxhyphen{}ice drift cannot be processed in swath projection. In addition, sea\sphinxhyphen{}ice drift cannot be computed from a single incoming L1B swath but requires two swaths: the incoming swath, and a previous swath that is accessible to the processing and stored from a previous run. If multiple processors or computing nodes are available for the SID processor, one can prepare several sea\sphinxhyphen{}ice drift products for each incoming swath, to fully exploit the frequent revisit time of the CIMR mission.

\sphinxAtStartPar
Since the core SID algorithm has been long used in other projects, and has already been investigated for “swath\sphinxhyphen{}to\sphinxhyphen{}swath use”, the future development work is therefore largely focused on the niche requirements for CIMR test cards needed to thoroughly validate this algorithm. There are two technical points in the algorithm itself which will be investigated during the L2PAD project. Firstly, the core cross\sphinxhyphen{}correlation algorithm used for the calculation of SID optimizes multiple channels at once. This is currently able to optimize up to 6 channels simultaneously, however, since we require 8 channels (Ku\sphinxhyphen{}band and Ka\sphinxhyphen{}band, V and H\sphinxhyphen{}polarizations, and forward and back scans in all permutations), this code needs expansion to ensure that it can run without encountering memory issues. The current demonstration uses only Ka\sphinxhyphen{}band. Secondly, there is a time delay of around \textasciitilde{}5 minutes between the forward and backward scans of CIMR (at the center of the swaths). This is currently ignored as being significantly less than the 24\sphinxhyphen{}hour period used for the manufactured test data, however, when we investigate shorter time delays between swaths, this short time delay will become more significant, so we will investigate if this should be corrected to improve accuracy of the calculated drift.

\sphinxAtStartPar
A significant part of the work for the next phase will be to investigate possible separation times between the incoming swaths, and which swaths should be paired to give the most accurate ice drift with the shortest waiting time. The longer the period between two swaths, the easier it is to extract accurate sea\sphinxhyphen{}ice motion as the ice features have travelled a longer distance. However, since the trajectories of the sea ice are not measured, but instead the displacement vector between the two timepoints, the shorter the delay between each measurement, the better picture overall can be built up of the motion, given many successive measurements. In addition, we wish to provide users with as recent information as possible, approaching a near\sphinxhyphen{}real time option. It is not realistic to pair each and every swath with every other, given the large number per 24\sphinxhyphen{}hour period, so we need to determine the optimal swath pairings.

\sphinxAtStartPar
The biggest limitation with the current performance assessment is the test data available. Since we must use two swaths separated in time to calculate the ice drift, we require this kind of test data. The algorithm cross\sphinxhyphen{}correlates sea\sphinxhyphen{}ice features between two swaths, and so we also require reasonably physical sea\sphinxhyphen{}ice texture in the test scenes. We saw in the initial performance assessment that the algorithm gave “blocky” results due to the blockiness of the Radiometric test card. The plan for L2PAD is to obtain model data of brightness temperature and ice drift for a set of timestamps, for example from neXtSIM, to grid this model data onto simulated CIMR swaths according to the timestamps, and then to use these data as input to create simulated CIMR swath test scenes. This will allow us to make realistic validations, ideally on a range of different time delays between swath pairs.

\sphinxstepscope


\chapter{References}
\label{\detokenize{references:references}}\label{\detokenize{references::doc}}
\begin{sphinxthebibliography}{10}
\bibitem[1]{references:id2}
\sphinxAtStartPar
T. A. Agnew, Hao Le, and T. Hirose. Estimation of large scale sea ice motion from SSMI 85.5 GHz imagery. \sphinxstyleemphasis{Annals of Glaciology}, 24:305–311, 1997.
\bibitem[2]{references:id3}
\sphinxAtStartPar
M. J. Brodzik, B. Billingsley, T. Haran, B. Raup, and M. H. Savoie. EASE\sphinxhyphen{}Grid 2.0: incremental but significant improvements for earth\sphinxhyphen{}gridded data sets. \sphinxstyleemphasis{ISPRS International Journal of Geo\sphinxhyphen{}Information}, 1(1):32 – 45, 2012. \sphinxhref{https://doi.org/10.3390/ijgi1010032}{doi:10.3390/ijgi1010032}.
\bibitem[3]{references:id6}
\sphinxAtStartPar
W. J. Emery, C. W. Fowler, J. Hawkins, and R. H. Preller. Fram Strait satellite image\sphinxhyphen{}derived ice motions. \sphinxstyleemphasis{Journal of Geophysical Research}, 96(C3):4751–4768, March 1991.
\bibitem[4]{references:id4}
\sphinxAtStartPar
W. J. Emery, A. C. Thomas, M. J. Collins, W. R. Crawford, and D. L. Mackas. An objective method for computing advective surface velocities from sequential infrared satellite images. \sphinxstyleemphasis{Journal of Geophysical Research}, 91:12865–12878, 1986.
\bibitem[5]{references:id5}
\sphinxAtStartPar
Robert Ezraty, Fanny Girard\sphinxhyphen{}Ardhuin, and D. Croizé\sphinxhyphen{}Fillon. Sea ice drift in the central Arctic estimated using the 89 GHz brightness temperatures of the Advanced Microwave Scanning Radiometer – User's manual. v2.0, CERSAT, IFREMER, France, February 2007.
\bibitem[6]{references:id7}
\sphinxAtStartPar
Fanny Girard\sphinxhyphen{}Ardhuin and Robert Ezraty. Enhanced arctic sea ice drift estimation merging radiometer and scatterometer data. \sphinxstyleemphasis{IEEE Transactions on Geoscience and Remote Sensing}, 50(7):2639–2648, 2012. \sphinxhref{https://doi.org/10.1109/TGRS.2012.2184124}{doi:10.1109/TGRS.2012.2184124}.
\bibitem[7]{references:id9}
\sphinxAtStartPar
J. Haarpaintner. Arctic\sphinxhyphen{}wide operational sea ice drift from enhanced\sphinxhyphen{}resolution Quikscat/SeaWinds scatterometry and its validation. \sphinxstyleemphasis{IEEE Transactions on Geoscience and Remote Sensing}, 44(1):102–107, January 2006.
\bibitem[8]{references:id8}
\sphinxAtStartPar
T. W. Haine. Arctic freshwater export: status, mechanisms, and prospects. \sphinxstyleemphasis{Global Planet. Change}, 125:13–35, 2015.
\bibitem[9]{references:id10}
\sphinxAtStartPar
P. Holland and R Kwok. Wind\sphinxhyphen{}driven trends in antarctic sea\sphinxhyphen{}ice drift. \sphinxstyleemphasis{Nature Geosciencies}, 2012. \sphinxhref{https://doi.org/https://doi.org/10.1038/ngeo1627}{doi:https://doi.org/10.1038/ngeo1627}.
\bibitem[10]{references:id11}
\sphinxAtStartPar
Alexander S. Komarov and David G. Barber. Sea ice motion tracking from sequential dual\sphinxhyphen{}polarization radarsat\sphinxhyphen{}2 images. \sphinxstyleemphasis{IEEE Transactions on Geoscience and Remote Sensing}, 52(1):121–136, 2014. \sphinxhref{https://doi.org/10.1109/TGRS.2012.2236845}{doi:10.1109/TGRS.2012.2236845}.
\bibitem[11]{references:id12}
\sphinxAtStartPar
T. Krumpen, H.J. Belter, and A. et al. Boetius. Arctic warming interrupts the transpolar drift and affects long\sphinxhyphen{}range transport of sea ice and ice\sphinxhyphen{}rafted matter. \sphinxstyleemphasis{Sci Rep}, 2019. \sphinxhref{https://doi.org/https://doi.org/10.1038/s41598-019-41456-y}{doi:https://doi.org/10.1038/s41598\sphinxhyphen{}019\sphinxhyphen{}41456\sphinxhyphen{}y}.
\bibitem[12]{references:id15}
\sphinxAtStartPar
R. Kwok. Summer sea ice motion from the 18 GHz channel of AMSR\sphinxhyphen{}E and the exchange of sea ice between the Pacific and Atlantic sectors. \sphinxstyleemphasis{Geophysical Research Letters}, 2008. \sphinxhref{https://doi.org/10.1029/2007GL032692}{doi:10.1029/2007GL032692}.
\bibitem[13]{references:id13}
\sphinxAtStartPar
R. Kwok, J. C. Curlander, R. McConnel, and S. Pang. An ice\sphinxhyphen{}motion tracking system at the Alaska SAR Facility. \sphinxstyleemphasis{IEEE Journal of Oceanic Engineering}, 15:44–54, 1990.
\bibitem[14]{references:id14}
\sphinxAtStartPar
R. Kwok, A. Schweiger, D. A. Rothrock, S. Pang, and C. Kottmeier. Sea ice motion from satellite passive microwave imagery assessed with ERS SAR and buoy motions. \sphinxstyleemphasis{Journal of Geophysical Research}, 103:8191–8214, April 1998. \sphinxhref{https://doi.org/10.1029/97JC03334}{doi:10.1029/97JC03334}.
\bibitem[15]{references:id16}
\sphinxAtStartPar
R. Kwok, G. Spreen, and S. Pang. Arctic sea ice circulation and drift speed: decadal trends and ocean currents. \sphinxstyleemphasis{Journal of Geophysical Research: Oceans}, 118(5):2408–2425, 2013. URL: \sphinxurl{https://agupubs.onlinelibrary.wiley.com/doi/abs/10.1002/jgrc.20191}, \sphinxhref{https://arxiv.org/abs/https://agupubs.onlinelibrary.wiley.com/doi/pdf/10.1002/jgrc.20191}{arXiv:https://agupubs.onlinelibrary.wiley.com/doi/pdf/10.1002/jgrc.20191}, \sphinxhref{https://doi.org/https://doi.org/10.1002/jgrc.20191}{doi:https://doi.org/10.1002/jgrc.20191}.
\bibitem[16]{references:id17}
\sphinxAtStartPar
Ron Kwok, Shirley S. Pang, and Sahra Kacimi. Sea ice drift in the Southern Ocean: Regional patterns, variability, and trends. \sphinxstyleemphasis{Elementa: Science of the Anthropocene}, 06 2017. 32. \sphinxhref{https://doi.org/10.1525/elementa.226}{doi:10.1525/elementa.226}.
\bibitem[17]{references:id18}
\sphinxAtStartPar
Jeffrey C. Lagarias, James A. Reeds, Margaret H. Wright, and Paul E. Wright. Convergence properties of the Nelder\sphinxhyphen{}Mead simplex method in low dimensions. \sphinxstyleemphasis{SIAM Journal on Optimization}, 9:112–147, 1998.
\bibitem[18]{references:id20}
\sphinxAtStartPar
T. Lavergne, M. Piñol Solé, E. Down, and C. Donlon. Towards a swath\sphinxhyphen{}to\sphinxhyphen{}swath sea\sphinxhyphen{}ice drift product for the copernicus imaging microwave radiometer mission. \sphinxstyleemphasis{The Cryosphere}, 15(8):3681–3698, 2021. URL: \sphinxurl{https://tc.copernicus.org/articles/15/3681/2021/}, \sphinxhref{https://doi.org/10.5194/tc-15-3681-2021}{doi:10.5194/tc\sphinxhyphen{}15\sphinxhyphen{}3681\sphinxhyphen{}2021}.
\bibitem[19]{references:id19}
\sphinxAtStartPar
Thomas Lavergne, Steinar Eastwood, Zakaria Teffah, Harald Schyberg, and Lars\sphinxhyphen{}Anders Breivik. Sea ice motion from low resolution satellite sensors: an alternative method and its validation in the Arctic. \sphinxstyleemphasis{Journal of Geophysical Research}, 2010. \sphinxhref{https://doi.org/10.1029/2009JC005958}{doi:10.1029/2009JC005958}.
\bibitem[20]{references:id21}
\sphinxAtStartPar
M. Leppäranta. \sphinxstyleemphasis{The drift of sea ice}. Springer\sphinxhyphen{}Praxis Books in Geophysical Sciences. Springer\sphinxhyphen{}Verlag, 2nd edition, 2011.
\bibitem[21]{references:id22}
\sphinxAtStartPar
Anthony K. Liu, Yunhe Zhao, and Sunny Y. Wu. Arctic sea ice drift from wavelet analysis of NSCAT and Special Sensor Microwave Imager data. \sphinxstyleemphasis{Journal of Geophysical Research}, 104(C5):11529–11538, 1999.
\bibitem[22]{references:id27}
\sphinxAtStartPar
J. Maslanik, T. Agnew, M. Drinkwater, W. Emery, C. Fowler, R. Kwok, and A. Liu. Summary of ice\sphinxhyphen{}motion mapping using passive microwave data. Technical Report Special Publication 8, NSIDC — National Snow and Ice Data Center, November 1998. URL: \sphinxurl{\{http://nsidc.org/pubs/special/nsidc\_special\_report\_8.pdf\}}.
\bibitem[23]{references:id23}
\sphinxAtStartPar
S. Muckenhuber, A. A. Korosov, and S. Sandven. Open\sphinxhyphen{}source feature\sphinxhyphen{}tracking algorithm for sea ice \textbackslash{}hack \textbackslash{}newline  drift retrieval from sentinel\sphinxhyphen{}1 sar imagery. \sphinxstyleemphasis{The Cryosphere}, 10(2):913–925, 2016. URL: \sphinxurl{https://tc.copernicus.org/articles/10/913/2016/}, \sphinxhref{https://doi.org/10.5194/tc-10-913-2016}{doi:10.5194/tc\sphinxhyphen{}10\sphinxhyphen{}913\sphinxhyphen{}2016}.
\bibitem[24]{references:id24}
\sphinxAtStartPar
J. A. Nelder and R. Mead. A simplex method for function minimization. \sphinxstyleemphasis{Computational Journal}, 7:308–313, 1968.
\bibitem[25]{references:id25}
\sphinxAtStartPar
R. M. Ninnis, W. J. Emery, and M. J. Collins. Automated extraction of pack ice motion from advanced very high\sphinxhyphen{}resolution radiometry. \sphinxstyleemphasis{Journal of Geophysical Research}, 91:10725–10734, 1986. \sphinxhref{https://doi.org/10.1029/JC091iC09p10725}{doi:10.1029/JC091iC09p10725}.
\bibitem[26]{references:id26}
\sphinxAtStartPar
Giulio Notarstefano, Pierre\sphinxhyphen{}Marie Poulain, and Elena Mauri. Estimation of surface currents in the Adriatic sea from sequential infrared satellite images. \sphinxstyleemphasis{Journal of Atmospheric and Oceanic Technology}, 25:271–285, May 2007. \sphinxhref{https://doi.org/10.1175/2007JTECHO527.1}{doi:10.1175/2007JTECHO527.1}.
\bibitem[27]{references:id28}
\sphinxAtStartPar
K.I. Ohshima, S. Nihashi, and K. Iwamoto. Global view of sea\sphinxhyphen{}ice production in polynyas and its linkage to dense/bottom water formation. \sphinxstyleemphasis{Geosci. Lett. 3, 13}, 2016. \sphinxhref{https://doi.org/https://doi.org/10.1186/s40562-016-0045-4}{doi:https://doi.org/10.1186/s40562\sphinxhyphen{}016\sphinxhyphen{}0045\sphinxhyphen{}4}.
\bibitem[28]{references:id29}
\sphinxAtStartPar
Johannes Schmetz, Kenneth Holmlund, Joel Hoffman, Bernard Strauss, Brian Mason, Volker Gærtner, Arno Koch, and Leo van de Berg. Operational cloud\sphinxhyphen{}motion winds from Meteosat infrared images. \sphinxstyleemphasis{Journal of Applied Meteorology}, 32:1206–1225, July 1993.
\bibitem[29]{references:id30}
\sphinxAtStartPar
Gunnar Spreen, Ron Kwok, and Dimitris Menemenlis. Trends in arctic sea ice drift and role of wind forcing: 1992–2009. \sphinxstyleemphasis{Geophysical Research Letters}, 38(19):, 2011. URL: \sphinxurl{https://agupubs.onlinelibrary.wiley.com/doi/abs/10.1029/2011GL048970}, \sphinxhref{https://arxiv.org/abs/https://agupubs.onlinelibrary.wiley.com/doi/pdf/10.1029/2011GL048970}{arXiv:https://agupubs.onlinelibrary.wiley.com/doi/pdf/10.1029/2011GL048970}, \sphinxhref{https://doi.org/https://doi.org/10.1029/2011GL048970}{doi:https://doi.org/10.1029/2011GL048970}.
\bibitem[30]{references:id31}
\sphinxAtStartPar
Mary\sphinxhyphen{}Louise Timmermans and John Marshall. Understanding arctic ocean circulation: a review of ocean dynamics in a changing climate. \sphinxstyleemphasis{Journal of Geophysical Research: Oceans}, 125(4):e2018JC014378, 2020. e2018JC014378 10.1029/2018JC014378. URL: \sphinxurl{https://agupubs.onlinelibrary.wiley.com/doi/abs/10.1029/2018JC014378}, \sphinxhref{https://arxiv.org/abs/https://agupubs.onlinelibrary.wiley.com/doi/pdf/10.1029/2018JC014378}{arXiv:https://agupubs.onlinelibrary.wiley.com/doi/pdf/10.1029/2018JC014378}, \sphinxhref{https://doi.org/https://doi.org/10.1029/2018JC014378}{doi:https://doi.org/10.1029/2018JC014378}.
\end{sphinxthebibliography}







\renewcommand{\indexname}{Index}
\printindex
\end{document}
