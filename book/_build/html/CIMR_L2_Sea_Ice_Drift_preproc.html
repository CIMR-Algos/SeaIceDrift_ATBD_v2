
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Preprocessing &#8212; CIMR L2 Sea Ice Drift ATBD v1</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=87e54e7c" />
    <link rel="stylesheet" type="text/css" href="_static/styles.css?v=3437f865" />
    <link rel="stylesheet" type="text/css" href="_static/watermark.css?v=80f188f4" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=3ee479438cf8b5e0d341"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'CIMR_L2_Sea_Ice_Drift_preproc';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Algorithm" href="CIMR_L2_Sea_Ice_Drift_algorithm.html" />
    <link rel="prev" title="Algorithm Input and Output Data Definition (IODD)" href="algorithm_input_output_data_definition.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/logo.jpg" class="logo__image only-light" alt="CIMR L2 Sea Ice Drift ATBD v1 - Home"/>
    <script>document.write(`<img src="_static/logo.jpg" class="logo__image only-dark" alt="CIMR L2 Sea Ice Drift ATBD v1 - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    CIMR L2 Sea Ice Drift ATBD
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="abstract.html">Abstract</a></li>
<li class="toctree-l1"><a class="reference internal" href="applicable_ref_docs.html">Applicable and Reference Documents</a></li>
<li class="toctree-l1"><a class="reference internal" href="acronyms.html">Acronyms</a></li>
<li class="toctree-l1"><a class="reference internal" href="definitions.html">Definitions</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction_purpose_scope.html">Introduction, purpose and scope</a></li>
<li class="toctree-l1"><a class="reference internal" href="background_justification_algorithm.html">Background and justification of selected algorithm</a></li>
<li class="toctree-l1"><a class="reference internal" href="L2_product_definition.html">Level-2 product definition</a></li>
<li class="toctree-l1"><a class="reference internal" href="baseline_algorithm_definition.html">Baseline Algorithm Definition</a></li>
<li class="toctree-l1"><a class="reference internal" href="algorithm_input_output_data_definition.html">Algorithm Input and Output Data Definition (IODD)</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Preprocessing</a></li>

<li class="toctree-l1"><a class="reference internal" href="CIMR_L2_Sea_Ice_Drift_algorithm.html">Algorithm</a></li>

<li class="toctree-l1"><a class="reference internal" href="CIMR_L2_Sea_Ice_Drift_performanceAssessment.html">Performance Assessment</a></li>

<li class="toctree-l1"><a class="reference internal" href="roadmap_for_future_atbd_developments.html">Roadmap for future ATBD developments (ATBD v2)</a></li>
<li class="toctree-l1"><a class="reference internal" href="references.html">References</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/CIMR-Algos/SeaIceDrift_ATBD" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/CIMR_L2_Sea_Ice_Drift_preproc.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Preprocessing</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Preprocessing</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#level-2-sea-ice-drift-sid-algorithm-for-cimr">Level-2 Sea Ice Drift (SID) algorithm for CIMR</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#settings">Settings</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#parametrize-the-run">Parametrize the run</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-creating-and-regridding-the-ice-mask">Step 1:  Creating and regridding the ice mask</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2-loading-the-data">Step 2: Loading the data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-3-regridding-the-data">Step 3: Regridding the data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-4-laplacian-pre-processing">Step 4: Laplacian pre-processing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-5-writing-out-the-file">Step 5: Writing out the file</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-6-temporary-creating-a-test-gridded-file-with-time-difference-24h-and-pixel-shifts-added-in-each-x-and-y">Step 6 (temporary): Creating a test gridded file with “time difference” 24h and pixel shifts added in each x and y</a></li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="preprocessing">
<h1>Preprocessing<a class="headerlink" href="#preprocessing" title="Link to this heading">#</a></h1>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="level-2-sea-ice-drift-sid-algorithm-for-cimr">
<h1>Level-2 Sea Ice Drift (SID) algorithm for CIMR<a class="headerlink" href="#level-2-sea-ice-drift-sid-algorithm-for-cimr" title="Link to this heading">#</a></h1>
<p>This notebook implements a prototype for a Level-2 SIED algorithm for the CIMR mission.</p>
<p>We refer to the corresponding <a class="reference external" href="https://cimr-algos.github.io/SeaIceDrift_ATBD/intro.html">ATBD</a> and especially the <a class="reference external" href="https://cimr-algos.github.io/SeaIceDrift_ATBD/baseline_algorithm_definition.html#baseline-algorithm-definition">Baseline Algorithm Definition</a>.</p>
<p>In particular, the figure below illustrates the overall concept of the processing:
<img src="https://cimr-algos.github.io/SeaIceDrift_ATBD/_images/CIMR_L2_Sea_Ice_Drift_Flow_Diagram.png" width="100%"/></p>
<section id="settings">
<h2>Settings<a class="headerlink" href="#settings" title="Link to this heading">#</a></h2>
<p>Imports and general settings</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Paths</span>

<span class="c1"># Getting the path of the notebook (NOTE: not totally safe)</span>

<span class="c1"># The paths assume that there is an umbrella CIMR directory (of any name) containing SeaIceDrift_ATBD_v2/ ,</span>
<span class="c1"># the CIMR Tools/ directory, and a directory data/L1B/ containing the L1B data, and data/conc/ containing</span>
<span class="c1"># a concentration file</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="n">cpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;../..&#39;</span><span class="p">)</span>
<span class="n">algpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cpath</span><span class="p">,</span> <span class="s1">&#39;SeaIceDrift_ATBD_v2/algorithm/src_sied&#39;</span><span class="p">)</span>
<span class="n">toolpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cpath</span><span class="p">,</span> <span class="s1">&#39;Tools&#39;</span><span class="p">)</span>
<span class="n">l1bpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cpath</span><span class="p">,</span> <span class="s1">&#39;data/L1B&#39;</span><span class="p">)</span>
<span class="n">griddeffile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cpath</span><span class="p">,</span> <span class="s1">&#39;Overall_ATBD/etc/grids_py.def&#39;</span><span class="p">)</span>

<span class="c1"># Creating a directory structure for processing</span>
<span class="n">concpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cpath</span><span class="p">,</span> <span class="s1">&#39;data/conc&#39;</span><span class="p">)</span>
<span class="n">icemaskpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cpath</span><span class="p">,</span> <span class="s1">&#39;data/icemask&#39;</span><span class="p">)</span>
<span class="n">swathpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cpath</span><span class="p">,</span> <span class="s1">&#39;data/swaths&#39;</span><span class="p">)</span>
<span class="n">procpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cpath</span><span class="p">,</span> <span class="s1">&#39;data/processing&#39;</span><span class="p">)</span>
<span class="n">driftpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cpath</span><span class="p">,</span> <span class="s1">&#39;data/icedrift&#39;</span><span class="p">)</span>
<span class="n">logpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cpath</span><span class="p">,</span> <span class="s1">&#39;data/logs&#39;</span><span class="p">)</span>
<span class="n">figpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cpath</span><span class="p">,</span> <span class="s1">&#39;data/figs&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">pth</span> <span class="ow">in</span> <span class="p">[</span><span class="n">concpath</span><span class="p">,</span> <span class="n">icemaskpath</span><span class="p">,</span> <span class="n">swathpath</span><span class="p">,</span> <span class="n">procpath</span><span class="p">,</span> <span class="n">driftpath</span><span class="p">,</span> <span class="n">logpath</span><span class="p">,</span> <span class="n">figpath</span><span class="p">]:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">pth</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">pth</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Imports</span>
<span class="kn">from</span> <span class="nn">importlib</span> <span class="kn">import</span> <span class="n">reload</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">dateutil.relativedelta</span> <span class="kn">import</span> <span class="n">relativedelta</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">from</span> <span class="nn">netCDF4</span> <span class="kn">import</span> <span class="n">Dataset</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pylab</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.cm</span> <span class="k">as</span> <span class="nn">cm</span>
<span class="kn">from</span> <span class="nn">pyresample</span> <span class="kn">import</span> <span class="n">parse_area_file</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">laplace</span>

<span class="c1"># Local modules contain software code that implement the SIED algorithm</span>
<span class="k">if</span> <span class="n">algpath</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">algpath</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">process_ice_mask</span> <span class="kn">import</span> <span class="n">process_ice_mask</span>
<span class="kn">from</span> <span class="nn">cp_and_date_change_iceconc</span> <span class="kn">import</span> <span class="n">cp_and_date_change_iceconc</span>

<span class="c1"># Prototype re-gridding toolbox to handle the L1B input</span>
<span class="k">if</span> <span class="n">toolpath</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">toolpath</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">tools</span> <span class="kn">import</span> <span class="n">io_handler</span> <span class="k">as</span> <span class="n">io</span>
<span class="kn">from</span> <span class="nn">tools</span> <span class="kn">import</span> <span class="n">collocation</span> <span class="k">as</span> <span class="n">coll</span>
<span class="kn">from</span> <span class="nn">tools</span> <span class="kn">import</span> <span class="n">l2_format</span> <span class="k">as</span> <span class="n">l2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot settings</span>

<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;xtick&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> 
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;ytick&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> 
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">})</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;axes.labelsize&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">})</span>

<span class="n">font</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;family&#39;</span> <span class="p">:</span> <span class="s1">&#39;sans&#39;</span><span class="p">,</span>
        <span class="s1">&#39;weight&#39;</span> <span class="p">:</span> <span class="s1">&#39;normal&#39;</span><span class="p">,</span>
        <span class="s1">&#39;size&#39;</span>   <span class="p">:</span> <span class="mi">12</span><span class="p">}</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">font</span><span class="p">)</span>

<span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">viridis</span>
<span class="n">cmapland</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">ListedColormap</span><span class="p">([</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="s1">&#39;grey&#39;</span><span class="p">])</span>

<span class="n">gridin</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">-ease2-050&#39;</span>
<span class="n">gridout</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">-ease2-250&#39;</span>
<span class="c1"># Some region parameters hard-coded to show only the relevant region</span>
<span class="c1"># Overall shape of input grid (4320, 4320)</span>
<span class="n">sl</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1050</span><span class="p">,</span> <span class="mi">1400</span><span class="p">,</span> <span class="mi">1050</span><span class="p">,</span> <span class="mi">1400</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="parametrize-the-run">
<h2>Parametrize the run<a class="headerlink" href="#parametrize-the-run" title="Link to this heading">#</a></h2>
<p>User-set parameters for the running of the whole notebook. Note that here a helper script is used to copy a starter ice concentration file from the MET Norway thredds server and change the dates in this. The date changes are required due to the sample input file having a date in the future (2028).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hemi</span> <span class="o">=</span> <span class="s1">&#39;nh&#39;</span>
<span class="n">algos</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;KU&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;channels&#39;</span><span class="p">:(</span><span class="s1">&#39;tb19v&#39;</span><span class="p">,</span> <span class="s1">&#39;tb19h&#39;</span><span class="p">),</span> <span class="s1">&#39;target_band&#39;</span><span class="p">:</span><span class="s1">&#39;KU&#39;</span><span class="p">},</span>
         <span class="s1">&#39;KA&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;channels&#39;</span><span class="p">:(</span><span class="s1">&#39;tb37v&#39;</span><span class="p">,</span> <span class="s1">&#39;tb37h&#39;</span><span class="p">),</span> <span class="s1">&#39;target_band&#39;</span><span class="p">:</span><span class="s1">&#39;KA&#39;</span><span class="p">}}</span>
<span class="n">wbs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">algos</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">fwdbck</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fw&#39;</span><span class="p">,</span> <span class="s1">&#39;bk&#39;</span><span class="p">]</span>
<span class="n">polarisation</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;V&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
<span class="n">pols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">polarisation</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<span class="n">test_card</span> <span class="o">=</span> <span class="s2">&quot;radiometric&quot;</span>
<span class="k">if</span> <span class="n">test_card</span> <span class="o">==</span> <span class="s2">&quot;geometric&quot;</span><span class="p">:</span>
    <span class="c1"># DEVALGO&#39;s simulated geometric test card</span>
    <span class="n">l1bfn</span> <span class="o">=</span> <span class="s1">&#39;W_PT-DME-Lisbon-SAT-CIMR-1B_C_DME_20230417T105425_LD_20280110T114800_20280110T115700_TN.nc&#39;</span>
<span class="k">elif</span> <span class="n">test_card</span> <span class="o">==</span> <span class="s2">&quot;radiometric&quot;</span><span class="p">:</span>
    <span class="c1"># DEVALGO&#39;s simulated radiometric test card</span>
    <span class="n">l1bfn</span> <span class="o">=</span> <span class="s1">&#39;W_PT-DME-Lisbon-SAT-CIMR-1B_C_DME_20230420T103323_LD_20280110T114800_20280110T115700_TN.nc&#39;</span>

<span class="n">l1bfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">l1bpath</span><span class="p">,</span> <span class="n">l1bfn</span><span class="p">)</span>

<span class="n">pdate</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s1">&#39;20280110&#39;</span><span class="p">,</span> <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">tdate</span> <span class="o">=</span> <span class="n">pdate</span> <span class="o">-</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">qdate</span> <span class="o">=</span> <span class="n">pdate</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Icemask data and output locations</span>
<span class="n">icemaskinputdir</span> <span class="o">=</span> <span class="s1">&#39;https://thredds.met.no/thredds/dodsC/osisaf/met.no/reprocessed/ice/conc_450a_files/{:%Y}/{:%m}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tdate</span><span class="p">,</span> <span class="n">tdate</span><span class="p">)</span>
<span class="n">icemaskinputfile</span> <span class="o">=</span> <span class="s1">&#39;ice_conc_</span><span class="si">{}</span><span class="s1">_ease2-250_cdr-v3p0_{:%Y%m</span><span class="si">%d</span><span class="s1">}1200.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hemi</span><span class="p">,</span> <span class="n">tdate</span><span class="p">)</span>
<span class="n">icemaskinput</span> <span class="o">=</span> <span class="n">cp_and_date_change_iceconc</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">icemaskinputdir</span><span class="p">,</span> <span class="n">icemaskinputfile</span><span class="p">),</span> <span class="n">concpath</span><span class="p">,</span> <span class="n">pdate</span><span class="p">)</span>

<span class="n">algo_version</span> <span class="o">=</span> <span class="s1">&#39;0.1&#39;</span>

<span class="n">pixshx</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">pixshy</span> <span class="o">=</span> <span class="mi">4</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Written a version of https://thredds.met.no/thredds/dodsC/osisaf/met.no/reprocessed/ice/conc_450a_files/2018/01/ice_conc_nh_ease2-250_cdr-v3p0_201801101200.nc to /home/emilyjd/cimr-devalgo/SeaIceDrift_ATBD_v2/algorithm/../../data/conc/ice_conc_nh_ease2-250_cdr-v3p0_202801101200.nc
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-1-creating-and-regridding-the-ice-mask">
<h2>Step 1:  Creating and regridding the ice mask<a class="headerlink" href="#step-1-creating-and-regridding-the-ice-mask" title="Link to this heading">#</a></h2>
<p>A land/ocean/ice mask is required to define the areas with ice to the algorithm. This is created from a concentration file, and is stored for future use. Since there can be multiple ice drift calculations per day on different swaths, the mask can be reused once created.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Creating the ice mask</span>
<span class="n">gridname</span> <span class="o">=</span> <span class="n">gridin</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hemi</span><span class="p">)</span>
<span class="n">icemaskname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">icemaskpath</span><span class="p">,</span> <span class="s1">&#39;icemask-multi-</span><span class="si">{}</span><span class="s1">-{:%Y%m</span><span class="si">%d</span><span class="s1">}12.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gridname</span><span class="p">,</span> <span class="n">pdate</span><span class="p">))</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">icemaskname</span><span class="p">):</span>
    <span class="c1"># Suppress the proj4 string warning on this</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="n">process_ice_mask</span><span class="p">(</span><span class="n">icemaskinput</span><span class="p">,</span> <span class="n">icemaskpath</span><span class="p">,</span> <span class="n">griddeffile</span><span class="p">,</span> <span class="n">gridname</span><span class="p">)</span>

<span class="c1"># Reading in the ice mask</span>
<span class="n">ie_data</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">icemaskname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">ie</span> <span class="o">=</span> <span class="n">ie_data</span><span class="p">[</span><span class="s1">&#39;ice_edge&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>

<span class="c1"># And the same for the output grid</span>
<span class="n">gridnameout</span> <span class="o">=</span> <span class="n">gridout</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hemi</span><span class="p">)</span>
<span class="n">icemasknameout</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">icemaskpath</span><span class="p">,</span> <span class="s1">&#39;icemask-multi-</span><span class="si">{}</span><span class="s1">-{:%Y%m</span><span class="si">%d</span><span class="s1">}12.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gridnameout</span><span class="p">,</span> <span class="n">pdate</span><span class="p">))</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">icemasknameout</span><span class="p">):</span>
    <span class="c1"># Suppress the proj4 string warning on this</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="n">process_ice_mask</span><span class="p">(</span><span class="n">icemaskinput</span><span class="p">,</span> <span class="n">icemaskpath</span><span class="p">,</span> <span class="n">griddeffile</span><span class="p">,</span> <span class="n">gridnameout</span><span class="p">)</span>
<span class="n">ie_data_out</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">icemasknameout</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">ieout</span> <span class="o">=</span> <span class="n">ie_data_out</span><span class="p">[</span><span class="s1">&#39;ice_edge&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>

<span class="c1"># Plotting the ice mask</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">c1</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ie</span><span class="p">[:],</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Ice mask&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelleft</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>

<span class="c1"># Input landmask</span>
<span class="n">landmask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">ie</span><span class="p">)</span>
<span class="n">landmask</span><span class="p">[</span><span class="n">ie</span> <span class="o">==</span> <span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># Output landmask</span>
<span class="n">landmaskout</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">ieout</span><span class="p">)</span>
<span class="n">landmaskout</span><span class="p">[</span><span class="n">ieout</span> <span class="o">==</span> <span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/1154b83df23d79e4dfb95aba3a677889659318052d1675f0ce77a28ec75deade.png" src="_images/1154b83df23d79e4dfb95aba3a677889659318052d1675f0ce77a28ec75deade.png" />
</div>
</div>
</section>
<section id="step-2-loading-the-data">
<h2>Step 2: Loading the data<a class="headerlink" href="#step-2-loading-the-data" title="Link to this heading">#</a></h2>
<p>The L1B data is read in and split into forward and backward scans using software from the <code class="docutils literal notranslate"><span class="pre">Tools/</span></code> repository (a prototype CIMR Regridding Toolbox developed in the CIMR DEVALGO study). These forward and backward scans can be used independently in the algorithm in the same way as different channels and polarisations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read the bands needed of the L1B data</span>
<span class="n">reload</span><span class="p">(</span><span class="n">io</span><span class="p">)</span>

<span class="n">tb_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tb01&#39;</span><span class="p">:</span><span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;tb06&#39;</span><span class="p">:</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;tb10&#39;</span><span class="p">:</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;tb19&#39;</span><span class="p">:</span><span class="s1">&#39;KU&#39;</span><span class="p">,</span> <span class="s1">&#39;tb37&#39;</span><span class="p">:</span><span class="s1">&#39;KA&#39;</span><span class="p">}</span>
<span class="n">rev_tb_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">tb_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<span class="n">bands_needed</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">alg</span> <span class="ow">in</span> <span class="n">algos</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">bands_needed</span> <span class="o">+=</span> <span class="n">algos</span><span class="p">[</span><span class="n">alg</span><span class="p">][</span><span class="s1">&#39;channels&#39;</span><span class="p">]</span>
<span class="n">bands_needed</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">tb_dict</span><span class="p">[</span><span class="n">b</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bands_needed</span><span class="p">]))</span>

<span class="n">full_l1b</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">CIMR_L1B</span><span class="p">(</span><span class="n">l1bfile</span><span class="p">,</span> <span class="n">selected_bands</span><span class="o">=</span><span class="n">bands_needed</span><span class="p">,</span> <span class="n">keep_calibration_view</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Split into forward / backward scan</span>

<span class="n">l1b</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">l1b</span><span class="p">[</span><span class="s1">&#39;fw&#39;</span><span class="p">],</span> <span class="n">l1b</span><span class="p">[</span><span class="s1">&#39;bk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_l1b</span><span class="o">.</span><span class="n">split_forward_backward_scans</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;horn_scan_angle&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-3-regridding-the-data">
<h2>Step 3: Regridding the data<a class="headerlink" href="#step-3-regridding-the-data" title="Link to this heading">#</a></h2>
<p>The horns are interleaved, and then the data is regridded. These are again done with software from <code class="docutils literal notranslate"><span class="pre">Tools/</span></code>. The ice drift will be calculated individually on 8 fields based on the forward and backward scans, waveband (Ku or Ka), and polarity (V or H). A fine EASE2 grid spacing of 5km is chosen for this regridding.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Regridding the data</span>

<span class="n">reload</span><span class="p">(</span><span class="n">coll</span><span class="p">)</span>

<span class="c1"># Reshaping</span>
<span class="n">l1b_r</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">fb</span> <span class="ow">in</span> <span class="n">fwdbck</span><span class="p">:</span>
    <span class="n">l1b_r</span><span class="p">[</span><span class="n">fb</span><span class="p">]</span> <span class="o">=</span> <span class="n">l1b</span><span class="p">[</span><span class="n">fb</span><span class="p">]</span><span class="o">.</span><span class="n">reshape_interleave_feed</span><span class="p">()</span>

<span class="c1"># Loading the target grid information</span>
<span class="n">gridname</span> <span class="o">=</span> <span class="n">gridin</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hemi</span><span class="p">)</span>
<span class="n">new_area_def</span> <span class="o">=</span> <span class="n">parse_area_file</span><span class="p">(</span><span class="n">griddeffile</span><span class="p">,</span> <span class="n">gridname</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">new_lons</span><span class="p">,</span> <span class="n">new_lats</span> <span class="o">=</span> <span class="n">new_area_def</span><span class="o">.</span><span class="n">get_lonlats</span><span class="p">()</span>

<span class="c1"># Getting the input lat/lons</span>
<span class="n">lonlats</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">]:</span>
    <span class="n">lonlats</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">fb</span> <span class="ow">in</span> <span class="n">fwdbck</span><span class="p">:</span>
        <span class="n">lonlats</span><span class="p">[</span><span class="n">ll</span><span class="p">][</span><span class="n">fb</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">wb</span> <span class="ow">in</span> <span class="n">wbs</span><span class="p">:</span>
            <span class="n">lonlats</span><span class="p">[</span><span class="n">ll</span><span class="p">][</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">]</span> <span class="o">=</span> <span class="n">l1b_r</span><span class="p">[</span><span class="n">fb</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">wb</span><span class="p">][</span><span class="n">ll</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

<span class="c1"># Creating data arrays with the V and H layers</span>
<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;brightness_temperature_v&#39;</span><span class="p">,</span> <span class="s1">&#39;brightness_temperature_h&#39;</span><span class="p">)</span>
<span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;method&#39;</span><span class="p">:</span><span class="s1">&#39;gauss&#39;</span><span class="p">,</span> <span class="s1">&#39;sigmas&#39;</span><span class="p">:</span><span class="mi">25000</span><span class="p">,</span> <span class="s1">&#39;neighbours&#39;</span><span class="p">:</span><span class="mi">55</span><span class="p">}</span>
<span class="n">stack_shape</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">stack</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">regrid</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">fb</span> <span class="ow">in</span> <span class="n">fwdbck</span><span class="p">:</span>
    <span class="n">stack_shape</span><span class="p">[</span><span class="n">fb</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">stack</span><span class="p">[</span><span class="n">fb</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">regrid</span><span class="p">[</span><span class="n">fb</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">wb</span> <span class="ow">in</span> <span class="n">wbs</span><span class="p">:</span>
        <span class="n">stack_shape</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">lonlats</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">][</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">what</span><span class="p">),])</span>
        <span class="n">stack</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">stack_shape</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">iw</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">what</span><span class="p">):</span>
            <span class="n">stack</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">][</span><span class="o">...</span><span class="p">,</span><span class="n">iw</span><span class="p">]</span> <span class="o">=</span> <span class="n">l1b_r</span><span class="p">[</span><span class="n">fb</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">wb</span><span class="p">][</span><span class="n">w</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="c1"># Regridding</span>
            <span class="c1"># TODO - Add passing of params, currently a nearest-neighbour approach with ROI 15000 is used</span>
            <span class="n">regrid</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">]</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">_regrid_fields</span><span class="p">(</span><span class="n">new_lons</span><span class="p">,</span> <span class="n">new_lats</span><span class="p">,</span> 
                                                 <span class="n">lonlats</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">][</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">],</span> <span class="n">lonlats</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">][</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">],</span> <span class="n">stack</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot regridded</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">c</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">shapelayout</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fwdbck</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">wbs</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">pols</span><span class="p">))</span>
<span class="n">axindex</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">for</span> <span class="n">fb</span> <span class="ow">in</span> <span class="n">fwdbck</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">wb</span> <span class="ow">in</span> <span class="n">wbs</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="n">pols</span><span class="p">:</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">axindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="o">*</span><span class="n">shapelayout</span><span class="p">,</span> <span class="n">axindex</span><span class="p">)</span>
            <span class="n">c</span><span class="p">[</span><span class="n">axindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">axindex</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">regrid</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">polarisation</span><span class="p">[</span><span class="n">pol</span><span class="p">]][</span><span class="n">sl</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">sl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sl</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">sl</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span> 
                                            <span class="n">interpolation</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
            <span class="n">overland</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">axindex</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">landmask</span><span class="p">[</span><span class="n">sl</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">sl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sl</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">sl</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                                          <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmapland</span><span class="p">)</span>            
            <span class="n">ax</span><span class="p">[</span><span class="n">axindex</span><span class="p">]</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">axindex</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wb</span><span class="p">,</span> <span class="n">pol</span><span class="p">,</span> <span class="n">fb</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">axindex</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">axindex</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelleft</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">axindex</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">axindex</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
            <span class="n">axindex</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">cbar_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.colorbar.Colorbar at 0x7fc98da9a190&gt;
</pre></div>
</div>
<img alt="_images/dea07a3f183c37952dee3e6dd84b34d24f999b897587b737be11a583fb630c6a.png" src="_images/dea07a3f183c37952dee3e6dd84b34d24f999b897587b737be11a583fb630c6a.png" />
</div>
</div>
</section>
<section id="step-4-laplacian-pre-processing">
<h2>Step 4: Laplacian pre-processing<a class="headerlink" href="#step-4-laplacian-pre-processing" title="Link to this heading">#</a></h2>
<p>Instead of directly using the brightness temperatures in the motion tracking algorithm, the ice features are stabilised and enhanced by applying a Laplacian filter (see ATBD for mathmatical description).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Replace fill value by NaN and remove mask</span>
<span class="k">def</span> <span class="nf">_get_nans</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
    <span class="n">img_masked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">img_masked</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

<span class="c1"># Replace NaN by fill value and add mask</span>
<span class="k">def</span> <span class="nf">_mask_nans</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

<span class="n">nan</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">lap</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">fv</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">fb</span> <span class="ow">in</span> <span class="n">fwdbck</span><span class="p">:</span>
    <span class="n">nan</span><span class="p">[</span><span class="n">fb</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">lap</span><span class="p">[</span><span class="n">fb</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">fv</span><span class="p">[</span><span class="n">fb</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">wb</span> <span class="ow">in</span> <span class="n">wbs</span><span class="p">:</span>
        <span class="c1"># Convert fill values to NaNs</span>
        <span class="n">nan</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">]</span> <span class="o">=</span> <span class="n">_get_nans</span><span class="p">(</span><span class="n">regrid</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">])</span>
        <span class="c1"># Laplacian transform</span>
        <span class="n">lap</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">]</span> <span class="o">=</span> <span class="n">laplace</span><span class="p">(</span><span class="n">nan</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">])</span>
        <span class="c1"># Converting NaNs to fill values</span>
        <span class="n">fv</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">]</span> <span class="o">=</span> <span class="n">_mask_nans</span><span class="p">(</span><span class="n">lap</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">])</span>

<span class="c1"># Creating a flag field</span>
<span class="c1">#define TCIMAGE_OUTSIDE_GRID              -2</span>
<span class="c1">#define TCIMAGE_NODATA                    -1</span>
<span class="c1">#define TCIMAGE_OK                         0</span>
<span class="c1">#define TCIMAGE_UNPROCESSED                1</span>
<span class="c1">#define TCIMAGE_FAILED                     2</span>
<span class="n">flag</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">fb</span> <span class="ow">in</span> <span class="n">fwdbck</span><span class="p">:</span>
    <span class="n">flag</span><span class="p">[</span><span class="n">fb</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">wb</span> <span class="ow">in</span> <span class="n">wbs</span><span class="p">:</span>
        <span class="n">flag</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">fv</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">])</span>
        <span class="c1"># Masking where the Laplacian didn&#39;t work</span>
        <span class="n">flag</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">][</span><span class="n">fv</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="c1"># Masking where the land and ocean is</span>
        <span class="n">landocean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">ie</span> <span class="o">==</span> <span class="mi">9</span><span class="p">,</span> <span class="n">ie</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">flag</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">][</span><span class="n">landocean</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot Laplacian</span>

<span class="n">vmin</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span>
<span class="n">vmax</span> <span class="o">=</span> <span class="mi">100</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">c</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">shapelayout</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fwdbck</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">wbs</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">pols</span><span class="p">))</span>
<span class="n">axindex</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">for</span> <span class="n">fb</span> <span class="ow">in</span> <span class="n">fwdbck</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">wb</span> <span class="ow">in</span> <span class="n">wbs</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="n">pols</span><span class="p">:</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">axindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="o">*</span><span class="n">shapelayout</span><span class="p">,</span> <span class="n">axindex</span><span class="p">)</span>
            <span class="n">c</span><span class="p">[</span><span class="n">axindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">axindex</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">fv</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">polarisation</span><span class="p">[</span><span class="n">pol</span><span class="p">]][</span><span class="n">sl</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">sl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sl</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">sl</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span> 
                                            <span class="n">interpolation</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> 
                                            <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
            <span class="n">overland</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">axindex</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">landmask</span><span class="p">[</span><span class="n">sl</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">sl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sl</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">sl</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                                          <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmapland</span><span class="p">)</span>            
            <span class="n">ax</span><span class="p">[</span><span class="n">axindex</span><span class="p">]</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">axindex</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wb</span><span class="p">,</span> <span class="n">pol</span><span class="p">,</span> <span class="n">fb</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">axindex</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">axindex</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelleft</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">axindex</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">axindex</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
            <span class="n">axindex</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">cbar_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.colorbar.Colorbar at 0x7fc98787f4f0&gt;
</pre></div>
</div>
<img alt="_images/9c5eb92e51b62c9765ecd176d8dcd1cddb7d7e4fc17cad0a6ec349697f7cc8ac.png" src="_images/9c5eb92e51b62c9765ecd176d8dcd1cddb7d7e4fc17cad0a6ec349697f7cc8ac.png" />
</div>
</div>
</section>
<section id="step-5-writing-out-the-file">
<h2>Step 5: Writing out the file<a class="headerlink" href="#step-5-writing-out-the-file" title="Link to this heading">#</a></h2>
<p>For ice drift, it is not possible to keep the data only internally. Since two gridded files at different timepoints are required to create each gridded map of icedrift vectors, it is necessary to write each gridded swath file to disk so that it can be read in to be compared with other gridded swath files.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Note: It is deprecated, but the wrapper and C code still expect a input proj4_string, so accept the </span>
<span class="c1"># deprecation warning for now.</span>
<span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
    <span class="n">crs_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;proj4_string&#39;</span><span class="p">:</span> <span class="n">new_area_def</span><span class="o">.</span><span class="n">proj4_string</span><span class="p">,</span>
                 <span class="s1">&#39;area_id&#39;</span><span class="p">:</span> <span class="n">new_area_def</span><span class="o">.</span><span class="n">area_id</span><span class="p">,</span>
                 <span class="s1">&#39;semi_major_axis&#39;</span><span class="p">:</span> <span class="mf">6378137.</span><span class="p">,</span>
                 <span class="s1">&#39;semi_minor_axis&#39;</span><span class="p">:</span> <span class="mf">6356752.31424518</span><span class="p">,</span>
                 <span class="s1">&#39;inverse_flattening&#39;</span><span class="p">:</span> <span class="mf">298.257223563</span><span class="p">,</span>
                 <span class="s1">&#39;reference_ellipsoid_name&#39;</span><span class="p">:</span> <span class="s2">&quot;WGS 84&quot;</span><span class="p">,</span>
                 <span class="s1">&#39;longitude_of_prime_meridian&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>
                 <span class="s1">&#39;prime_meridian_name&#39;</span><span class="p">:</span> <span class="s2">&quot;Greenwich&quot;</span><span class="p">,</span>
                 <span class="s1">&#39;geographic_crs_name&#39;</span><span class="p">:</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
                 <span class="s1">&#39;horizontal_datum_name&#39;</span><span class="p">:</span> <span class="s2">&quot;World Geodetic System 1984&quot;</span><span class="p">,</span>
                 <span class="s1">&#39;projected_crs_name&#39;</span><span class="p">:</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
                 <span class="s1">&#39;grid_mapping_name&#39;</span><span class="p">:</span> <span class="s2">&quot;lambert_azimuthal_equal_area&quot;</span><span class="p">,</span>
                 <span class="s1">&#39;latitude_of_projection_origin&#39;</span><span class="p">:</span> <span class="mf">90.</span><span class="p">,</span>
                 <span class="s1">&#39;longitude_of_projection_origin&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>
                 <span class="s1">&#39;false_easting&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>
                 <span class="s1">&#39;false_northing&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">reload</span><span class="p">(</span><span class="n">l2</span><span class="p">)</span>

<span class="c1"># Get a template L2 format (netCDF/CF) from the Tools module</span>
<span class="n">ds_l2</span> <span class="o">=</span> <span class="n">l2</span><span class="o">.</span><span class="n">get_CIMR_L2_template</span><span class="p">(</span><span class="s1">&#39;grid&#39;</span><span class="p">,</span> <span class="n">geo_def</span><span class="o">=</span><span class="n">new_area_def</span><span class="p">,</span> <span class="n">add_time</span><span class="o">=</span><span class="p">[</span><span class="n">pdate</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()])</span>

<span class="c1"># Create data arrays for the brightness temperatures, laplacian processed and status flags from the template</span>
<span class="n">shp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">regrid</span><span class="p">[</span><span class="n">fwdbck</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">wbs</span><span class="p">[</span><span class="mi">0</span><span class="p">]][:,</span> <span class="p">:,</span> <span class="n">polarisation</span><span class="p">[</span><span class="n">pol</span><span class="p">]]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">ds_tb</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">ds_lap</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">ds_flag</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">fb</span> <span class="ow">in</span> <span class="n">fwdbck</span><span class="p">:</span>
    <span class="n">ds_tb</span><span class="p">[</span><span class="n">fb</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">ds_lap</span><span class="p">[</span><span class="n">fb</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">ds_flag</span><span class="p">[</span><span class="n">fb</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">wb</span> <span class="ow">in</span> <span class="n">wbs</span><span class="p">:</span>
        <span class="n">ds_tb</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">ds_lap</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">ds_flag</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="n">pols</span><span class="p">:</span>
            <span class="n">chan</span> <span class="o">=</span> <span class="n">algos</span><span class="p">[</span><span class="n">wb</span><span class="p">][</span><span class="s1">&#39;channels&#39;</span><span class="p">][</span><span class="n">polarisation</span><span class="p">[</span><span class="n">pol</span><span class="p">]]</span>
            <span class="n">ds_tb</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">][</span><span class="n">pol</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">regrid</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">polarisation</span><span class="p">[</span><span class="n">pol</span><span class="p">]]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shp</span><span class="p">),</span>
                                              <span class="n">coords</span><span class="o">=</span><span class="n">ds_l2</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">ds_l2</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span>
                                              <span class="n">attrs</span><span class="o">=</span><span class="n">ds_l2</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">fb</span><span class="p">))</span>
            <span class="n">ds_tb</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">][</span><span class="n">pol</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;standard_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;brightness_temperature&#39;</span>
            <span class="n">ds_tb</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">][</span><span class="n">pol</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Brightness temperature </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">fb</span><span class="p">)</span>
            <span class="n">ds_tb</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">][</span><span class="n">pol</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;coverage_content_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;physicalMeasurement&#39;</span>
            <span class="n">ds_tb</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">][</span><span class="n">pol</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;K&#39;</span>
            <span class="n">ds_l2</span> <span class="o">=</span> <span class="n">ds_l2</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ds_tb</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">][</span><span class="n">pol</span><span class="p">])</span>
            
            <span class="n">ds_lap</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">][</span><span class="n">pol</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">fv</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">polarisation</span><span class="p">[</span><span class="n">pol</span><span class="p">]]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shp</span><span class="p">),</span>
                                               <span class="n">coords</span><span class="o">=</span><span class="n">ds_l2</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">ds_l2</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span>
                                               <span class="n">attrs</span><span class="o">=</span><span class="n">ds_l2</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">_lap&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">fb</span><span class="p">))</span>
            <span class="n">ds_lap</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">][</span><span class="n">pol</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Laplacian of brightness temperature </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">fb</span><span class="p">)</span>
            <span class="n">ds_lap</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">][</span><span class="n">pol</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;coverage_content_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;auxiliaryInformation&#39;</span>
            <span class="n">ds_lap</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">][</span><span class="n">pol</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">ds_l2</span> <span class="o">=</span> <span class="n">ds_l2</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ds_lap</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">][</span><span class="n">pol</span><span class="p">])</span>
            
            <span class="n">ds_flag</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">][</span><span class="n">pol</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">flag</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">polarisation</span><span class="p">[</span><span class="n">pol</span><span class="p">]]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shp</span><span class="p">),</span>
                                                <span class="n">coords</span><span class="o">=</span><span class="n">ds_l2</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">ds_l2</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span>
                                                <span class="n">attrs</span><span class="o">=</span><span class="n">ds_l2</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">,</span> 
                                                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">_lap_flag&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">fb</span><span class="p">))</span>
            <span class="n">ds_flag</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">][</span><span class="n">pol</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;standard_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;status_flag&#39;</span>
            <span class="n">ds_flag</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">][</span><span class="n">pol</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Status flag for Laplacian of brightness temperature </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">fb</span><span class="p">)</span>
            <span class="n">ds_flag</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">][</span><span class="n">pol</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;coverage_content_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;qualityInformation&#39;</span>
            <span class="n">ds_flag</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">][</span><span class="n">pol</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">ds_l2</span> <span class="o">=</span> <span class="n">ds_l2</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ds_flag</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">][</span><span class="n">pol</span><span class="p">])</span>

<span class="c1"># Create a data array for dtime from the template</span>
<span class="n">dtime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">regrid</span><span class="p">[</span><span class="n">fwdbck</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">wbs</span><span class="p">[</span><span class="mi">0</span><span class="p">]][:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">pdate</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shp</span><span class="p">)</span>
<span class="n">ds_dtime</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">dtime</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">ds_l2</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">ds_l2</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span>
                        <span class="n">attrs</span><span class="o">=</span><span class="n">ds_l2</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dtime&#39;</span><span class="p">)</span>
<span class="n">ds_dtime</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Time&#39;</span>
<span class="n">ds_dtime</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;standard_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;time&#39;</span>
<span class="n">ds_dtime</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;coverage_content_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;auxiliaryInformation&#39;</span>
<span class="n">ds_dtime</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;seconds since 1970-01-01 00:00:00&#39;</span>
<span class="n">ds_l2</span> <span class="o">=</span> <span class="n">ds_l2</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ds_dtime</span><span class="p">)</span>

<span class="c1"># Create a data array for ice edge from the template</span>
<span class="n">ds_ie</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">ie</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shp</span><span class="p">),</span> <span class="n">coords</span><span class="o">=</span><span class="n">ds_l2</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">ds_l2</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span>
                     <span class="n">attrs</span><span class="o">=</span><span class="n">ds_l2</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ice_edge&#39;</span><span class="p">)</span>
<span class="n">ds_ie</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Ice edge&#39;</span>
<span class="n">ds_ie</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;coverage_content_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;auxiliaryInformation&#39;</span>
<span class="n">ds_ie</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">ds_l2</span> <span class="o">=</span> <span class="n">ds_l2</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ds_ie</span><span class="p">)</span>

<span class="c1"># Create a data array for time, needed by the C code</span>
<span class="n">timedata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">regrid</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">pdate</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
<span class="n">ds_l2</span><span class="p">[</span><span class="s1">&#39;vtime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;time&#39;</span><span class="p">),</span> <span class="n">timedata</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,))</span>
<span class="n">ds_l2</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s2">&quot;seconds since 1970-01-01 00:00:00&quot;</span><span class="p">}</span>
<span class="n">ds_l2</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Time&#39;</span>
<span class="n">ds_l2</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;coverage_content_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;auxiliaryInformation&#39;</span>
<span class="n">ds_l2</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;seconds since 1970-01-01 00:00:00&quot;</span>

<span class="c1"># Customize the global attributes</span>
<span class="n">ds_l2</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;CIMR intermediate brightness temperatures for ice drift calculation&#39;</span>
<span class="n">ds_l2</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Intermediate brightness temperatures and Laplacian-processed fields with their status flags, written as intermadiate-processing file for ice drift calculations&#39;</span>
<span class="n">ds_l2</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;l1b_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">l1bfn</span>
<span class="n">ds_l2</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;algorithm_version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">algo_version</span>
<span class="n">ds_l2</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;creator_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Emily Down&#39;</span>
<span class="n">ds_l2</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;creator_email&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;emilyjd@met.no&#39;</span>
<span class="n">ds_l2</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;institution&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Norwegian Meteorological Institute&#39;</span>

<span class="c1"># CRS information needed for C code</span>
<span class="n">ds_l2</span><span class="p">[</span><span class="s1">&#39;crs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">crs_info</span>

<span class="c1"># Need to rename x and y to xc and yc for X code</span>
<span class="n">ds_l2</span><span class="o">=</span> <span class="n">ds_l2</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="s1">&#39;xc&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="s1">&#39;yc&#39;</span><span class="p">})</span>
    
<span class="c1"># Remove the &#39;template&#39; variable (we don&#39;t need it anymore)</span>
<span class="c1">#ds_l2 = ds_l2.drop(&#39;template&#39;)</span>

<span class="c1"># Write to file</span>
<span class="n">dsname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">procpath</span><span class="p">,</span> <span class="s1">&#39;bt_</span><span class="si">{}</span><span class="s1">_{:%Y%m</span><span class="si">%d</span><span class="s1">}.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gridname</span><span class="p">,</span> <span class="n">pdate</span><span class="p">))</span>
<span class="n">ds_l2</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">dsname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;NETCDF4_CLASSIC&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Written </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dsname</span><span class="p">))</span>

<span class="c1"># Setting this up for potential reruns</span>
<span class="n">ds_l2_copy</span> <span class="o">=</span> <span class="n">ds_l2</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Written /home/emilyjd/cimr-devalgo/SeaIceDrift_ATBD_v2/algorithm/../../data/processing/bt_nh-ease2-050_20280110.nc
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-6-temporary-creating-a-test-gridded-file-with-time-difference-24h-and-pixel-shifts-added-in-each-x-and-y">
<h2>Step 6 (temporary): Creating a test gridded file with “time difference” 24h and pixel shifts added in each x and y<a class="headerlink" href="#step-6-temporary-creating-a-test-gridded-file-with-time-difference-24h-and-pixel-shifts-added-in-each-x-and-y" title="Link to this heading">#</a></h2>
<p>This is a temporary part of this notebook, to create a “test” file with different gridded brightness temperatures and a different timepoint. This is required for calculation of ice drift vectors. In this example, a constant shift of +3 pixels in the x-direction and +4 pixels in the y-direction is chosen. In operation, two swaths at different timepoints will be processed in the algorithm to retrieve the icedrift.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a shifted file with fixed pixels.</span>

<span class="c1"># Take a copy of the data xarray</span>
<span class="n">ds_shift</span> <span class="o">=</span> <span class="n">ds_l2_copy</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Add the Laplacian mask variable</span>
<span class="n">ds_msk</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">ds_msk</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">ds_msk</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">fb</span> <span class="ow">in</span> <span class="n">fwdbck</span><span class="p">:</span>
    <span class="n">ds_msk</span><span class="p">[</span><span class="n">fb</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">wb</span> <span class="ow">in</span> <span class="n">wbs</span><span class="p">:</span>
        <span class="n">ds_msk</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="n">pols</span><span class="p">:</span>
            <span class="n">chan</span> <span class="o">=</span> <span class="n">algos</span><span class="p">[</span><span class="n">wb</span><span class="p">][</span><span class="s1">&#39;channels&#39;</span><span class="p">][</span><span class="n">polarisation</span><span class="p">[</span><span class="n">pol</span><span class="p">]]</span>
            <span class="n">ds_msk</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">][</span><span class="n">pol</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">fv</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">polarisation</span><span class="p">[</span><span class="n">pol</span><span class="p">]]</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shp</span><span class="p">),</span>
                                               <span class="n">coords</span><span class="o">=</span><span class="n">ds_shift</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">ds_shift</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span>
                                               <span class="n">attrs</span><span class="o">=</span><span class="n">ds_shift</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">_msk&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">fb</span><span class="p">))</span>
            <span class="n">ds_msk</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">][</span><span class="n">pol</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Mask for Laplacian of brightness temperature </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">fb</span><span class="p">)</span>
            <span class="n">ds_msk</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">][</span><span class="n">pol</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;coverage_content_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;auxiliaryInformation&#39;</span>
            <span class="n">ds_msk</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">][</span><span class="n">pol</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">ds_shift</span> <span class="o">=</span> <span class="n">ds_shift</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ds_msk</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">][</span><span class="n">pol</span><span class="p">])</span>

<span class="c1"># Shifting the data pixels of the arrays</span>
<span class="n">ds_shift_tb</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">ds_shift_lap</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">ds_shift_flag</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">fb</span> <span class="ow">in</span> <span class="n">fwdbck</span><span class="p">:</span>
    <span class="n">ds_shift_tb</span><span class="p">[</span><span class="n">fb</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">ds_shift_lap</span><span class="p">[</span><span class="n">fb</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">ds_shift_flag</span><span class="p">[</span><span class="n">fb</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">wb</span> <span class="ow">in</span> <span class="n">wbs</span><span class="p">:</span>
        <span class="n">ds_shift_tb</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">ds_shift_lap</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">ds_shift_flag</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="n">pols</span><span class="p">:</span>
            <span class="n">chan</span> <span class="o">=</span> <span class="n">algos</span><span class="p">[</span><span class="n">wb</span><span class="p">][</span><span class="s1">&#39;channels&#39;</span><span class="p">][</span><span class="n">polarisation</span><span class="p">[</span><span class="n">pol</span><span class="p">]]</span>
            <span class="c1"># Shift can be used in xarray to shift dimension by number of pix. Note that the dimensions must be</span>
            <span class="c1"># called x and y within xarray</span>
            <span class="n">chan</span> <span class="o">=</span> <span class="n">algos</span><span class="p">[</span><span class="n">wb</span><span class="p">][</span><span class="s1">&#39;channels&#39;</span><span class="p">][</span><span class="n">polarisation</span><span class="p">[</span><span class="n">pol</span><span class="p">]]</span>
            <span class="n">tbname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">fb</span><span class="p">)</span>
            <span class="n">ds_shift_tb</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds_shift</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tbname</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">xc</span><span class="o">=</span><span class="n">pixshx</span><span class="p">,</span> <span class="n">yc</span><span class="o">=</span><span class="n">pixshy</span><span class="p">)</span>
            <span class="n">ds_shift</span><span class="p">[</span><span class="n">tbname</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">ds_shift_tb</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">]</span>
            <span class="c1"># Shifting the Laplacian field</span>
            <span class="n">lapname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">_lap&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">fb</span><span class="p">)</span>
            <span class="n">ds_shift_lap</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds_shift</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">lapname</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">xc</span><span class="o">=</span><span class="n">pixshx</span><span class="p">,</span> <span class="n">yc</span><span class="o">=</span><span class="n">pixshy</span><span class="p">)</span>
            <span class="n">ds_shift</span><span class="p">[</span><span class="n">lapname</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">ds_shift_lap</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">]</span>
            <span class="c1"># Flag field (want the data shifted, the landmask not)  </span>
            <span class="n">flagname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">_lap_flag&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">fb</span><span class="p">)</span>
            <span class="n">ds_shift_flag</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">ds_shift_lap</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">])</span>
            <span class="c1"># Masking where the Laplacian failed</span>
            <span class="n">maskname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">_msk&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">fb</span><span class="p">)</span>
            <span class="n">fmsk_shft</span> <span class="o">=</span> <span class="n">ds_shift</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">maskname</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">xc</span><span class="o">=</span><span class="n">pixshx</span><span class="p">,</span> <span class="n">yc</span><span class="o">=</span><span class="n">pixshy</span><span class="p">)</span>
            <span class="n">ds_shift_flag</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">][</span><span class="n">fmsk_shft</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="c1"># Masking where the land and ocean is</span>
            <span class="n">landocean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">ie</span> <span class="o">==</span> <span class="mi">9</span><span class="p">,</span> <span class="n">ie</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shp</span><span class="p">)</span>
            <span class="p">(</span><span class="n">ds_shift_flag</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">])[</span><span class="n">landocean</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">ds_shift</span><span class="p">[</span><span class="n">flagname</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">ds_shift_flag</span><span class="p">[</span><span class="n">fb</span><span class="p">][</span><span class="n">wb</span><span class="p">]</span>

<span class="c1"># Shift time by 24h</span>
<span class="n">ds_shift</span><span class="p">[</span><span class="s1">&#39;dtime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">regrid</span><span class="p">[</span><span class="n">fwdbck</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">wbs</span><span class="p">[</span><span class="mi">0</span><span class="p">]][:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">qdate</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shp</span><span class="p">)</span>
<span class="n">ds_shift</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">time</span> <span class="o">=</span> <span class="p">[</span><span class="n">qdate</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()])</span>

<span class="c1"># Remove the mask variables (we don&#39;t need them anymore)</span>
<span class="k">for</span> <span class="n">fb</span> <span class="ow">in</span> <span class="n">fwdbck</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">wb</span> <span class="ow">in</span> <span class="n">wbs</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="n">pols</span><span class="p">:</span>
            <span class="n">chan</span> <span class="o">=</span> <span class="n">algos</span><span class="p">[</span><span class="n">wb</span><span class="p">][</span><span class="s1">&#39;channels&#39;</span><span class="p">][</span><span class="n">polarisation</span><span class="p">[</span><span class="n">pol</span><span class="p">]]</span>
            <span class="n">maskname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">_msk&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">fb</span><span class="p">)</span>
            <span class="n">ds_shift</span> <span class="o">=</span> <span class="n">ds_shift</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="n">maskname</span><span class="p">)</span>

<span class="c1"># Write to file</span>
<span class="n">dsname2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">procpath</span><span class="p">,</span> <span class="s1">&#39;bt_</span><span class="si">{}</span><span class="s1">_{:%Y%m</span><span class="si">%d</span><span class="s1">}.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gridname</span><span class="p">,</span> <span class="n">qdate</span><span class="p">))</span>
<span class="n">ds_shift</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">dsname2</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;NETCDF4_CLASSIC&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Written </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dsname2</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Written /home/emilyjd/cimr-devalgo/SeaIceDrift_ATBD_v2/algorithm/../../data/processing/bt_nh-ease2-050_20280111.nc
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="algorithm_input_output_data_definition.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Algorithm Input and Output Data Definition (IODD)</p>
      </div>
    </a>
    <a class="right-next"
       href="CIMR_L2_Sea_Ice_Drift_algorithm.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Algorithm</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Preprocessing</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#level-2-sea-ice-drift-sid-algorithm-for-cimr">Level-2 Sea Ice Drift (SID) algorithm for CIMR</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#settings">Settings</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#parametrize-the-run">Parametrize the run</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-creating-and-regridding-the-ice-mask">Step 1:  Creating and regridding the ice mask</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2-loading-the-data">Step 2: Loading the data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-3-regridding-the-data">Step 3: Regridding the data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-4-laplacian-pre-processing">Step 4: Laplacian pre-processing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-5-writing-out-the-file">Step 5: Writing out the file</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-6-temporary-creating-a-test-gridded-file-with-time-difference-24h-and-pixel-shifts-added-in-each-x-and-y">Step 6 (temporary): Creating a test gridded file with “time difference” 24h and pixel shifts added in each x and y</a></li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Thomas Lavergne and Emily Down, Norwegian Meteorological Institute
</p>

  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  <p>
This ATBD was developed in the context of the ESA-funded CIMR DEVALGO study (2022-2024) (contract 4000137493).
<br>
ESA is not responsible in any way for the content of this document.
</p>

</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>