
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Algorithm &#8212; CIMR L2 Sea Ice Drift ATBD v2</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=87e54e7c" />
    <link rel="stylesheet" type="text/css" href="_static/styles.css?v=3437f865" />
    <link rel="stylesheet" type="text/css" href="_static/watermark.css?v=80f188f4" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=3ee479438cf8b5e0d341"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'CIMR_L2_Sea_Ice_Drift_algorithm';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Performance Assessment" href="CIMR_L2_Sea_Ice_Drift_performanceAssessment.html" />
    <link rel="prev" title="Preprocessing" href="CIMR_L2_Sea_Ice_Drift_preproc.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/logo.jpg" class="logo__image only-light" alt="CIMR L2 Sea Ice Drift ATBD v2 - Home"/>
    <script>document.write(`<img src="_static/logo.jpg" class="logo__image only-dark" alt="CIMR L2 Sea Ice Drift ATBD v2 - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    CIMR L2 Sea Ice Drift ATBD
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="abstract.html">Abstract</a></li>
<li class="toctree-l1"><a class="reference internal" href="applicable_ref_docs.html">Applicable and Reference Documents</a></li>
<li class="toctree-l1"><a class="reference internal" href="acronyms.html">Acronyms</a></li>
<li class="toctree-l1"><a class="reference internal" href="definitions.html">Definitions</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction_purpose_scope.html">Introduction, purpose and scope</a></li>
<li class="toctree-l1"><a class="reference internal" href="background_justification_algorithm.html">Background and justification of selected algorithm</a></li>
<li class="toctree-l1"><a class="reference internal" href="L2_product_definition.html">Level-2 product definition</a></li>
<li class="toctree-l1"><a class="reference internal" href="baseline_algorithm_definition.html">Baseline Algorithm Definition</a></li>
<li class="toctree-l1"><a class="reference internal" href="algorithm_input_output_data_definition.html">Algorithm Input and Output Data Definition (IODD)</a></li>
<li class="toctree-l1"><a class="reference internal" href="CIMR_L2_Sea_Ice_Drift_preproc.html">Preprocessing</a></li>

<li class="toctree-l1 current active"><a class="current reference internal" href="#">Algorithm</a></li>

<li class="toctree-l1"><a class="reference internal" href="CIMR_L2_Sea_Ice_Drift_performanceAssessment.html">Performance Assessment</a></li>

<li class="toctree-l1"><a class="reference internal" href="roadmap_for_future_atbd_developments.html">Roadmap for future ATBD developments (ATBD v2)</a></li>
<li class="toctree-l1"><a class="reference internal" href="references.html">References</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/CIMR-Algos/SeaIceDrift_ATBD" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/CIMR_L2_Sea_Ice_Drift_algorithm.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Algorithm</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Algorithm</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#level-2-sea-ice-drift-sid-algorithm-for-cimr">Level-2 Sea Ice Drift (SID) algorithm for CIMR</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#settings">Settings</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#parametrize-the-run">Parametrize the run</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-cross-correlation-algorithm-to-find-ice-drift">Step 1: Cross-correlation algorithm to find ice drift</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2-format-l2-file-and-write-to-disk">Step 2: Format L2 file and write to disk</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-3-plotting">Step 3: Plotting</a></li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="algorithm">
<h1>Algorithm<a class="headerlink" href="#algorithm" title="Link to this heading">#</a></h1>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="level-2-sea-ice-drift-sid-algorithm-for-cimr">
<h1>Level-2 Sea Ice Drift (SID) algorithm for CIMR<a class="headerlink" href="#level-2-sea-ice-drift-sid-algorithm-for-cimr" title="Link to this heading">#</a></h1>
<p>This notebook implements a prototype for a Level-2 SIED algorithm for the CIMR mission.</p>
<p>We refer to the corresponding <a class="reference external" href="https://cimr-algos.github.io/SeaIceDrift_ATBD/intro.html">ATBD</a> and especially the <a class="reference external" href="https://cimr-algos.github.io/SeaIceDrift_ATBD/baseline_algorithm_definition.html#baseline-algorithm-definition">Baseline Algorithm Definition</a>.</p>
<p>In particular, the figure below illustrates the overall concept of the processing:
<img src="https://cimr-algos.github.io/SeaIceDrift_ATBD/_images/CIMR_L2_Sea_Ice_Drift_Flow_Diagram.png" width="100%"/></p>
<section id="settings">
<h2>Settings<a class="headerlink" href="#settings" title="Link to this heading">#</a></h2>
<p>Imports and general settings</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> cython
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Paths</span>

<span class="c1"># Getting the path of the notebook (NOTE: not totally safe)</span>

<span class="c1"># The paths assume that there is an umbrella CIMR directory (of any name) containing SeaIceDrift_ATBD_v2/ ,</span>
<span class="c1"># the CIMR Tools/ directory, and a directory data/L1B/ containing the L1B data, and data/conc/ containing</span>
<span class="c1"># a concentration file</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="n">cpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;../..&#39;</span><span class="p">)</span>
<span class="n">algpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cpath</span><span class="p">,</span> <span class="s1">&#39;SeaIceDrift_ATBD_v2/algorithm/src_sied&#39;</span><span class="p">)</span>
<span class="n">toolpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cpath</span><span class="p">,</span> <span class="s1">&#39;Tools&#39;</span><span class="p">)</span>
<span class="n">l1bpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cpath</span><span class="p">,</span> <span class="s1">&#39;data/L1B&#39;</span><span class="p">)</span>
<span class="n">griddeffile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cpath</span><span class="p">,</span> <span class="s1">&#39;Overall_ATBD/etc/grids_py.def&#39;</span><span class="p">)</span>

<span class="c1"># Processing directories</span>
<span class="n">procpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cpath</span><span class="p">,</span> <span class="s1">&#39;data/processing&#39;</span><span class="p">)</span>
<span class="n">driftpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cpath</span><span class="p">,</span> <span class="s1">&#39;data/icedrift&#39;</span><span class="p">)</span>
<span class="n">logpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cpath</span><span class="p">,</span> <span class="s1">&#39;data/logs&#39;</span><span class="p">)</span>
<span class="n">figpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cpath</span><span class="p">,</span> <span class="s1">&#39;data/figs&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Imports</span>

<span class="kn">from</span> <span class="nn">importlib</span> <span class="kn">import</span> <span class="n">reload</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.ma</span> <span class="k">as</span> <span class="nn">ma</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="c1">#from netCDF4 import Dataset</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pylab</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.ticker</span> <span class="k">as</span> <span class="nn">mticker</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1.axes_divider</span> <span class="kn">import</span> <span class="n">make_axes_locatable</span>
<span class="kn">import</span> <span class="nn">matplotlib.cm</span> <span class="k">as</span> <span class="nn">cm</span>
<span class="c1">#import cmocean</span>
<span class="c1">#import cartopy</span>
<span class="kn">import</span> <span class="nn">cartopy.crs</span> <span class="k">as</span> <span class="nn">ccrs</span>
<span class="kn">from</span> <span class="nn">pyresample</span> <span class="kn">import</span> <span class="n">parse_area_file</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">dateutil.relativedelta</span> <span class="kn">import</span> <span class="n">relativedelta</span>

<span class="c1"># Local modules contain software code that implement the SIED algorithm</span>
<span class="k">if</span> <span class="n">algpath</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">algpath</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">icedrift_wrapper</span> <span class="kn">import</span> <span class="n">icedrift_wrapper</span>
<span class="c1">#from process_ice_mask import process_ice_mask</span>
<span class="c1">#from cp_and_date_change_iceconc import cp_and_date_change_iceconc</span>

<span class="c1"># Prototype re-gridding toolbox to handle the L1B input</span>
<span class="k">if</span> <span class="n">toolpath</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">toolpath</span><span class="p">)</span>
<span class="c1">#from tools import io_handler as io</span>
<span class="c1">#from tools import collocation as coll</span>
<span class="kn">from</span> <span class="nn">tools</span> <span class="kn">import</span> <span class="n">l2_format</span> <span class="k">as</span> <span class="n">l2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot settings</span>

<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;xtick&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> 
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;ytick&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> 
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">})</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;axes.labelsize&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">})</span>

<span class="n">font</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;family&#39;</span> <span class="p">:</span> <span class="s1">&#39;sans&#39;</span><span class="p">,</span>
        <span class="s1">&#39;weight&#39;</span> <span class="p">:</span> <span class="s1">&#39;normal&#39;</span><span class="p">,</span>
        <span class="s1">&#39;size&#39;</span>   <span class="p">:</span> <span class="mi">12</span><span class="p">}</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">font</span><span class="p">)</span>

<span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">viridis</span>
<span class="c1">#cmapland = matplotlib.colors.ListedColormap([&#39;none&#39;, &#39;grey&#39;])</span>

<span class="n">gridtype</span> <span class="o">=</span> <span class="s1">&#39;ease&#39;</span>
<span class="n">gridin</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">-ease2-050&#39;</span>
<span class="n">gridout</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">-ease2-250&#39;</span>
<span class="c1"># Some region parameters hard-coded to show only the relevant region</span>
<span class="c1"># Overall shape of input grid (4320, 4320)</span>
<span class="c1">#sl = (1050, 1400, 1050, 1400)</span>
<span class="n">slo</span> <span class="o">=</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">290</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">290</span><span class="p">)</span>

<span class="c1"># EASE plotting region</span>
<span class="n">lon_min</span> <span class="o">=</span> <span class="o">-</span><span class="mi">15</span>
<span class="n">lon_max</span> <span class="o">=</span> <span class="mi">95</span>
<span class="n">lat_min</span> <span class="o">=</span> <span class="mi">74</span>
<span class="n">lat_max</span> <span class="o">=</span> <span class="mi">90</span>

<span class="c1"># Settings for gridlines</span>
<span class="n">lon_step</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">lat_step</span> <span class="o">=</span> <span class="mi">5</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="parametrize-the-run">
<h2>Parametrize the run<a class="headerlink" href="#parametrize-the-run" title="Link to this heading">#</a></h2>
<p>User-set parameters for the running of the whole notebook. Note that here a helper script is used to copy a starter ice concentration file from the MET Norway thredds server and change the dates in this. The date changes are required due to the sample input file having a date in the future (2028).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hemi</span> <span class="o">=</span> <span class="s1">&#39;nh&#39;</span>
<span class="c1">#algos = {&#39;KU&#39;: {&#39;channels&#39;:(&#39;tb19v&#39;, &#39;tb19h&#39;), &#39;target_band&#39;:&#39;KU&#39;},</span>
<span class="c1">#         &#39;KA&#39;: {&#39;channels&#39;:(&#39;tb37v&#39;, &#39;tb37h&#39;), &#39;target_band&#39;:&#39;KA&#39;}}</span>
<span class="c1">#wbs = list(algos.keys())</span>
<span class="c1">#fwdbck = [&#39;fw&#39;, &#39;bk&#39;]</span>
<span class="c1">#polarisation = {&#39;V&#39;: 0, &#39;H&#39;: 1}</span>
<span class="c1">#pols = list(polarisation.keys())</span>

<span class="n">test_card</span> <span class="o">=</span> <span class="s2">&quot;radiometric&quot;</span>
<span class="k">if</span> <span class="n">test_card</span> <span class="o">==</span> <span class="s2">&quot;geometric&quot;</span><span class="p">:</span>
    <span class="c1"># DEVALGO&#39;s simulated geometric test card</span>
    <span class="n">l1bfn</span> <span class="o">=</span> <span class="s1">&#39;W_PT-DME-Lisbon-SAT-CIMR-1B_C_DME_20230417T105425_LD_20280110T114800_20280110T115700_TN.nc&#39;</span>
<span class="k">elif</span> <span class="n">test_card</span> <span class="o">==</span> <span class="s2">&quot;radiometric&quot;</span><span class="p">:</span>
    <span class="c1"># DEVALGO&#39;s simulated radiometric test card</span>
    <span class="n">l1bfn</span> <span class="o">=</span> <span class="s1">&#39;W_PT-DME-Lisbon-SAT-CIMR-1B_C_DME_20230420T103323_LD_20280110T114800_20280110T115700_TN.nc&#39;</span>

<span class="c1">#dt = datetime.strptime(&#39;20230420T103323&#39;, &#39;%Y%m%dT%H%M%S&#39;)</span>

<span class="n">l1bfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">l1bpath</span><span class="p">,</span> <span class="n">l1bfn</span><span class="p">)</span>

<span class="n">pdate</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s1">&#39;20280110&#39;</span><span class="p">,</span> <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">tdate</span> <span class="o">=</span> <span class="n">pdate</span> <span class="o">-</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">qdate</span> <span class="o">=</span> <span class="n">pdate</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Icemask data and output locations</span>
<span class="c1">#icemaskinputdir = &#39;https://thredds.met.no/thredds/dodsC/osisaf/met.no/reprocessed/ice/conc_450a_files/{:%Y}/{:%m}&#39;.format(tdate, tdate)</span>
<span class="c1">#icemaskinputfile = &#39;ice_conc_{}_ease2-250_cdr-v3p0_{:%Y%m%d}1200.nc&#39;.format(hemi, tdate)</span>
<span class="c1">#icemaskinput = cp_and_date_change_iceconc(os.path.join(icemaskinputdir, icemaskinputfile), concpath, pdate)</span>

<span class="n">algo_version</span> <span class="o">=</span> <span class="s1">&#39;0.1&#39;</span>

<span class="n">plotfigs</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-1-cross-correlation-algorithm-to-find-ice-drift">
<h2>Step 1: Cross-correlation algorithm to find ice drift<a class="headerlink" href="#step-1-cross-correlation-algorithm-to-find-ice-drift" title="Link to this heading">#</a></h2>
<p>For the Continuous Maximum Cross-Correlation algorithm, two brightness temperature gridded files, enhanced by the Laplacian algorithm and with different timestamps, are required. The algorithm matches features between these images on a fractional pixel grid.</p>
<p>The steps of the cross-correlation algorithm are:</p>
<ol class="arabic simple">
<li><p>Determination of which pixels should be included in the cross-correlation, excluding land and ocean pixels.</p></li>
<li><p>Fractional pixel cross-correlation simultaneously on the gridded swaths - forward/back scans, V and H polarisations, K and Ka channels.</p></li>
<li><p>Correction of erroneous vectors using the nearest neighbour method and creation of status flags.</p></li>
</ol>
<p>Currently the C code has limited memory for channels, so the Ka-band forward and backward scans with V and H polarisations are accepted by the code. It should be possible to add K-band later.</p>
<p>In addition, the forward and backward scans are treated here as having the same timestamp, later it can be refined to include the 7-minute delay between these two.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Copying the files with new names, to interface with the C-code</span>

<span class="n">gridname</span> <span class="o">=</span> <span class="n">gridin</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hemi</span><span class="p">)</span>
<span class="n">chanstr</span> <span class="o">=</span> <span class="s1">&#39;tb19hfw-tb19vfw-tb19hbk-tb19vbk-tb37hfw-tb37vfw-tb37hbk-tb37vbk&#39;</span>

<span class="n">dsname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">procpath</span><span class="p">,</span> <span class="s1">&#39;bt_</span><span class="si">{}</span><span class="s1">_{:%Y%m</span><span class="si">%d</span><span class="s1">}.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gridname</span><span class="p">,</span> <span class="n">pdate</span><span class="p">))</span>
<span class="n">dsname2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">procpath</span><span class="p">,</span> <span class="s1">&#39;bt_</span><span class="si">{}</span><span class="s1">_{:%Y%m</span><span class="si">%d</span><span class="s1">}.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gridname</span><span class="p">,</span> <span class="n">qdate</span><span class="p">))</span>

<span class="n">newname1</span> <span class="o">=</span> <span class="s1">&#39;tc_wght_cimr-cimr_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">12.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chanstr</span><span class="p">,</span> <span class="n">gridin</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hemi</span><span class="p">),</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">pdate</span><span class="p">,</span> <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">))</span>
<span class="n">newname2</span> <span class="o">=</span> <span class="s1">&#39;tc_wght_cimr-cimr_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">12.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chanstr</span><span class="p">,</span> <span class="n">gridin</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hemi</span><span class="p">),</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">qdate</span><span class="p">,</span> <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">))</span>
<span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">dsname</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">dsname</span><span class="p">),</span> <span class="n">newname1</span><span class="p">))</span>
<span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">dsname2</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">dsname</span><span class="p">),</span> <span class="n">newname2</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;/home/emilyjd/cimr-devalgo/SeaIceDrift_ATBD_v2/algorithm/../../data/processing/tc_wght_cimr-cimr_tb19hfw-tb19vfw-tb19hbk-tb19vbk-tb37hfw-tb37vfw-tb37hbk-tb37vbk_nh-ease2-050_2028011112.nc&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span>

<span class="kn">from</span> <span class="nn">icedrift_wrapper</span> <span class="kn">import</span> <span class="n">icedrift_wrapper</span>
<span class="n">rad</span> <span class="o">=</span> <span class="mf">100.</span>
<span class="n">rad_neigh</span> <span class="o">=</span> <span class="mf">150.</span>
<span class="c1"># Original rad=75. rad_neigh=125.</span>
<span class="c1"># Worked with rad=100. rad_neigh=150.</span>
<span class="c1"># rad = 25. rad_neigh=150. has lots of corrected by neighbours, but a better field</span>
<span class="n">chan_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tb37hfw_lap&#39;</span><span class="p">,</span> <span class="s1">&#39;tb37vfw_lap&#39;</span><span class="p">,</span> <span class="s1">&#39;tb37hbk_lap&#39;</span><span class="p">,</span> <span class="s1">&#39;tb37vbk_lap&#39;</span><span class="p">]</span>
<span class="c1"># Suppress the proj4 string warning on this</span>
<span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

    <span class="n">idrift</span> <span class="o">=</span> <span class="n">icedrift_wrapper</span><span class="p">(</span><span class="n">pdate</span><span class="p">,</span> <span class="n">qdate</span><span class="p">,</span> <span class="n">procpath</span><span class="p">,</span> <span class="n">procpath</span><span class="p">,</span> <span class="n">driftpath</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">logpath</span><span class="p">,</span> <span class="s1">&#39;cmcc-test.log&#39;</span><span class="p">),</span>
                          <span class="s1">&#39;cimr-cimr&#39;</span><span class="p">,</span> <span class="n">gridin</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hemi</span><span class="p">),</span> <span class="n">chan_list</span><span class="p">,</span> <span class="n">rad</span><span class="p">,</span> <span class="n">rad_neigh</span><span class="p">,</span> 
                          <span class="n">area_out</span><span class="o">=</span><span class="n">gridout</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hemi</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Daily maps found (cimr-cimr):

	Day 1 : /home/emilyjd/cimr-devalgo/SeaIceDrift_ATBD_v2/algorithm/../../data/processing/tc_wght_cimr-cimr_tb19hfw-tb19vfw-tb19hbk-tb19vbk-tb37hfw-tb37vfw-tb37hbk-tb37vbk_nh-ease2-050_2028011012.nc 

	Day 2 : /home/emilyjd/cimr-devalgo/SeaIceDrift_ATBD_v2/algorithm/../../data/processing/tc_wght_cimr-cimr_tb19hfw-tb19vfw-tb19hbk-tb19vbk-tb37hfw-tb37vfw-tb37hbk-tb37vbk_nh-ease2-050_2028011112.nc 



Calling the C core code...
 
 LOGMSG [icedrift_solve_core 2024-06-27 11:22]:
	Start processing.
 
	Log file is &lt;/home/emilyjd/cimr-devalgo/SeaIceDrift_ATBD_v2/algorithm/../../data/logs/cmcc-test.log&gt;
	Radius for pattern #0 is 100.0km
	Radius for pattern #1 is 50.0km
	Maximum drift distance is 38.88km
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-2-format-l2-file-and-write-to-disk">
<h2>Step 2: Format L2 file and write to disk<a class="headerlink" href="#step-2-format-l2-file-and-write-to-disk" title="Link to this heading">#</a></h2>
<p>The output icedrift file is processed and written, with metadata.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">driftx</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">idrift</span><span class="p">[</span><span class="s1">&#39;drift_x&#39;</span><span class="p">])</span>
<span class="n">driftx</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">driftx</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1e9</span>
<span class="n">drifty</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">idrift</span><span class="p">[</span><span class="s1">&#39;drift_y&#39;</span><span class="p">])</span>
<span class="n">drifty</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">drifty</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1e9</span>
<span class="n">flag</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">idrift</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">])</span>

<span class="n">dms</span> <span class="o">=</span> <span class="n">driftx</span><span class="o">.</span><span class="n">shape</span>
<span class="n">ddx</span> <span class="o">=</span> <span class="n">driftx</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dms</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ddy</span> <span class="o">=</span> <span class="n">drifty</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dms</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">stdx</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">idrift</span><span class="p">[</span><span class="s1">&#39;std_x&#39;</span><span class="p">])</span>
<span class="n">stdx</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">stdx</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1e9</span>
<span class="n">stdx</span> <span class="o">=</span> <span class="n">stdx</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dms</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">stdy</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">idrift</span><span class="p">[</span><span class="s1">&#39;std_y&#39;</span><span class="p">])</span>
<span class="n">stdy</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">stdy</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1e9</span>
<span class="n">stdy</span> <span class="o">=</span> <span class="n">stdy</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dms</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">dflag</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">idrift</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">])</span>
<span class="n">dflag</span> <span class="o">=</span> <span class="n">flag</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dms</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">reload</span><span class="p">(</span><span class="n">l2</span><span class="p">)</span>

<span class="c1"># Output grid</span>
<span class="n">og</span> <span class="o">=</span> <span class="n">gridout</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hemi</span><span class="p">)</span>
<span class="n">out_area_def</span> <span class="o">=</span> <span class="n">parse_area_file</span><span class="p">(</span><span class="n">griddeffile</span><span class="p">,</span> <span class="n">og</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">olons</span><span class="p">,</span> <span class="n">olats</span> <span class="o">=</span> <span class="n">out_area_def</span><span class="o">.</span><span class="n">get_lonlats</span><span class="p">()</span>

<span class="c1"># Get a template L2 format (netCDF/CF) from the Tools module</span>
<span class="n">ds_l2</span> <span class="o">=</span> <span class="n">l2</span><span class="o">.</span><span class="n">get_CIMR_L2_template</span><span class="p">(</span><span class="s1">&#39;grid&#39;</span><span class="p">,</span> <span class="n">geo_def</span><span class="o">=</span><span class="n">out_area_def</span><span class="p">,</span> <span class="n">add_time</span><span class="o">=</span><span class="p">[</span><span class="n">pdate</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()])</span>

<span class="c1"># Create a DataArray for x and y icedrift from the template</span>
<span class="n">da_dx</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">ddx</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">ds_l2</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">ds_l2</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span>
                       <span class="n">attrs</span><span class="o">=</span><span class="n">ds_l2</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;driftX&#39;</span><span class="p">)</span>
<span class="n">da_dx</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;x-component of Sea Ice Drift from the CIMR ice drift algorithm v</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">algo_version</span><span class="p">)</span>
<span class="n">da_dx</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;standard_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;x_component_sea_ice_drift&#39;</span>
<span class="n">da_dx</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;km&#39;</span>
<span class="n">da_dx</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;coverage_content_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;physicalMeasurement&#39;</span>
<span class="n">da_dx</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;auxiliary_variables&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;status_flag&#39;</span>
<span class="n">da_dy</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">ddy</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">ds_l2</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">ds_l2</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span>
                       <span class="n">attrs</span><span class="o">=</span><span class="n">ds_l2</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;driftY&#39;</span><span class="p">)</span>
<span class="n">da_dy</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;y-component of Sea Ice Drift from the CIMR ice drift algorithm v</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">algo_version</span><span class="p">)</span>
<span class="n">da_dy</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;standard_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;y_component_sea_ice_drift&#39;</span>
<span class="n">da_dy</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;km&#39;</span>
<span class="n">da_dy</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;coverage_content_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;physicalMeasurement&#39;</span>
<span class="n">da_dy</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;auxiliary_variables&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;status_flag&#39;</span>

<span class="c1"># Create a DataArray for std x and y icedrift from the template</span>
<span class="n">da_stddx</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">stdx</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">ds_l2</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">ds_l2</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span>
                       <span class="n">attrs</span><span class="o">=</span><span class="n">ds_l2</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;stdX&#39;</span><span class="p">)</span>
<span class="n">da_stddx</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Standard deviation of x-component of Sea Ice Drift from the CIMR ice drift algorithm v</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">algo_version</span><span class="p">)</span>
<span class="n">da_stddx</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;km&#39;</span>
<span class="n">da_stddx</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;coverage_content_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;auxiliaryInformation&#39;</span>
<span class="n">da_stddx</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;auxiliary_variables&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;status_flag&#39;</span>
<span class="n">da_stddy</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">stdy</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">ds_l2</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">ds_l2</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span>
                       <span class="n">attrs</span><span class="o">=</span><span class="n">ds_l2</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;stdY&#39;</span><span class="p">)</span>
<span class="n">da_stddy</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Standard deviation of y-component of Sea Ice Drift from the CIMR ice drift algorithm v</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">algo_version</span><span class="p">)</span>
<span class="n">da_stddy</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;km&#39;</span>
<span class="n">da_stddy</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;coverage_content_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;auxiliaryInformation&#39;</span>
<span class="n">da_stddy</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;auxiliary_variables&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;status_flag&#39;</span>

<span class="c1"># Create a DataArray for the status flag from the template</span>
<span class="n">da_flag</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">dflag</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">ds_l2</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">ds_l2</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span>
                       <span class="n">attrs</span><span class="o">=</span><span class="n">ds_l2</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;status_flag&#39;</span><span class="p">)</span>
<span class="n">da_flag</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Status flag of Sea Ice Drift from the CIMR ice drift algorithm v</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">algo_version</span><span class="p">)</span>
<span class="n">da_flag</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">da_flag</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;coverage_content_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;auxiliaryInformation&#39;</span>

<span class="c1"># Add the data arrays to the ds_l2 object</span>
<span class="n">ds_l2</span> <span class="o">=</span> <span class="n">ds_l2</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">da_dx</span><span class="p">)</span>
<span class="n">ds_l2</span> <span class="o">=</span> <span class="n">ds_l2</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">da_dy</span><span class="p">)</span>
<span class="n">ds_l2</span> <span class="o">=</span> <span class="n">ds_l2</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">da_stddx</span><span class="p">)</span>
<span class="n">ds_l2</span> <span class="o">=</span> <span class="n">ds_l2</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">da_stddy</span><span class="p">)</span>
<span class="n">ds_l2</span> <span class="o">=</span> <span class="n">ds_l2</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">da_flag</span><span class="p">)</span>

<span class="c1"># Customize the global attributes</span>
<span class="n">ds_l2</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;CIMR L2 Sea Ice Drift&#39;</span>
<span class="n">ds_l2</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Sea Ice Drift computed with the prototype algorithm developed in the ESA CIMR DEVALGO study. The algorithm combines Ku and Ka imagery channels. The product file contains the sea ice drift, its uncertainties, and processing flags.&#39;</span>
<span class="n">ds_l2</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;l1b_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">l1bfile</span><span class="p">)</span>
<span class="n">ds_l2</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;algorithm_version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">algo_version</span>

<span class="n">ds_l2</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;creator_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Emily Down and Thomas Lavergne&#39;</span>
<span class="n">ds_l2</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;creator_email&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;emilyjd@met.no&#39;</span>
<span class="n">ds_l2</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;institution&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Norwegian Meteorological Institute&#39;</span>

<span class="c1"># Remove the &#39;template&#39; variable (we don&#39;t need it anymore)</span>
<span class="n">ds_l2</span> <span class="o">=</span> <span class="n">ds_l2</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;template&#39;</span><span class="p">)</span>

<span class="c1"># Write to file</span>
<span class="n">l2_n</span> <span class="o">=</span> <span class="s1">&#39;cimr_devalgo_l2_sid_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">og</span><span class="p">,</span> <span class="n">test_card</span><span class="p">)</span>
<span class="n">l2_n</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">driftpath</span><span class="p">,</span> <span class="n">l2_n</span><span class="p">)</span>
<span class="n">ds_l2</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">l2_n</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;NETCDF4_CLASSIC&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">l2_n</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/emilyjd/cimr-devalgo/SeaIceDrift_ATBD_v2/algorithm/../../data/icedrift/cimr_devalgo_l2_sid_nh-ease2-250_radiometric.nc
</pre></div>
</div>
</div>
</div>
</section>
<section id="step-3-plotting">
<h2>Step 3: Plotting<a class="headerlink" href="#step-3-plotting" title="Link to this heading">#</a></h2>
<p>Here an example plot of the icedrift output is made.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">crs_create</span><span class="p">(</span><span class="n">gridtype</span><span class="p">,</span> <span class="n">hemi</span><span class="p">):</span>

    <span class="c1"># Define grid based on region</span>
    <span class="k">if</span> <span class="n">gridtype</span> <span class="o">==</span> <span class="s1">&#39;polstere&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">hemi</span> <span class="o">==</span> <span class="s1">&#39;nh&#39;</span><span class="p">:</span>
            <span class="n">plot_proj4_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;proj&#39;</span><span class="p">:</span> <span class="s1">&#39;stere&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;lat_0&#39;</span><span class="p">:</span> <span class="mf">90.</span><span class="p">,</span>
                                 <span class="s1">&#39;lat_ts&#39;</span> <span class="p">:</span> <span class="mf">70.</span><span class="p">,</span>
                                 <span class="s1">&#39;lon_0&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">45.0</span><span class="p">,</span>
                                 <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">6378273</span><span class="p">,</span>
                                 <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mf">6356889.44891</span><span class="p">}</span>
            <span class="n">plot_globe</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">Globe</span><span class="p">(</span><span class="n">semimajor_axis</span><span class="o">=</span><span class="n">plot_proj4_params</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">],</span>
                                    <span class="n">semiminor_axis</span><span class="o">=</span><span class="n">plot_proj4_params</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">])</span>
            <span class="n">plot_crs</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">NorthPolarStereo</span><span class="p">(</span>
                <span class="n">central_longitude</span><span class="o">=</span><span class="n">plot_proj4_params</span><span class="p">[</span><span class="s1">&#39;lon_0&#39;</span><span class="p">],</span> <span class="n">globe</span><span class="o">=</span><span class="n">plot_globe</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plot_proj4_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;proj&#39;</span><span class="p">:</span> <span class="s1">&#39;stere&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;lat_0&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">90.</span><span class="p">,</span>
                                 <span class="s1">&#39;lat_ts&#39;</span> <span class="p">:</span> <span class="o">-</span><span class="mf">70.</span><span class="p">,</span>
                                 <span class="s1">&#39;lon_0&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>
                                 <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">6378273</span><span class="p">,</span>
                                 <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mf">6356889.44891</span><span class="p">}</span>
            <span class="n">plot_globe</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">Globe</span><span class="p">(</span><span class="n">semimajor_axis</span><span class="o">=</span><span class="n">plot_proj4_params</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">],</span>
                                    <span class="n">semiminor_axis</span><span class="o">=</span><span class="n">plot_proj4_params</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">])</span>
            <span class="n">plot_crs</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">SouthPolarStereo</span><span class="p">(</span>
                <span class="n">central_longitude</span><span class="o">=</span><span class="n">plot_proj4_params</span><span class="p">[</span><span class="s1">&#39;lon_0&#39;</span><span class="p">],</span> <span class="n">globe</span><span class="o">=</span><span class="n">plot_globe</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">gridtype</span> <span class="o">==</span> <span class="s1">&#39;ease&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">hemi</span> <span class="o">==</span> <span class="s1">&#39;nh&#39;</span><span class="p">:</span>
            <span class="n">plot_crs</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">LambertAzimuthalEqualArea</span><span class="p">(</span><span class="n">central_longitude</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                      <span class="n">central_latitude</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
                                                      <span class="n">false_easting</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                      <span class="n">false_northing</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plot_crs</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">LambertAzimuthalEqualArea</span><span class="p">(</span><span class="n">central_longitude</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                      <span class="n">central_latitude</span><span class="o">=-</span><span class="mi">90</span><span class="p">,</span>
                                                      <span class="n">false_easting</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                      <span class="n">false_northing</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unrecognised region </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">region</span><span class="p">))</span>

    <span class="k">return</span><span class="p">(</span><span class="n">plot_crs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">flag_arrow_col</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">procfmt</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">procfmt</span><span class="p">:</span>
        <span class="n">flgfmt</span> <span class="o">=</span> <span class="s1">&#39;proc&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flgfmt</span> <span class="o">=</span> <span class="s1">&#39;final&#39;</span>

    <span class="c1"># Use colours from https://sashamaps.net/docs/resources/20-colors/</span>
    <span class="n">fblack</span> <span class="o">=</span> <span class="s1">&#39;#000000&#39;</span>
    <span class="n">fmaroon</span> <span class="o">=</span> <span class="s1">&#39;#800000&#39;</span>
    <span class="n">forange</span> <span class="o">=</span> <span class="s1">&#39;#f58231&#39;</span>
    <span class="n">fnavy</span> <span class="o">=</span> <span class="s1">&#39;#000075&#39;</span>
    <span class="n">fblue</span> <span class="o">=</span> <span class="s1">&#39;#4363d8&#39;</span>
    <span class="n">flavender</span> <span class="o">=</span> <span class="s1">&#39;#dcbeff&#39;</span>
    <span class="n">fgrey</span> <span class="o">=</span> <span class="s1">&#39;#a9a9a9&#39;</span>

    <span class="n">fbrown</span> <span class="o">=</span> <span class="s1">&#39;#9A6324&#39;</span>
    <span class="n">fteal</span> <span class="o">=</span> <span class="s1">&#39;#469990&#39;</span>
    <span class="n">fgreen</span> <span class="o">=</span> <span class="s1">&#39;#3cb44b&#39;</span>
    <span class="n">fcyan</span> <span class="o">=</span> <span class="s1">&#39;#42d4f4&#39;</span>
    <span class="n">fmagenta</span> <span class="o">=</span> <span class="s1">&#39;#f032e6&#39;</span>

    <span class="n">fred</span> <span class="o">=</span> <span class="s1">&#39;#e6194B&#39;</span>
    <span class="n">fpurple</span> <span class="o">=</span> <span class="s1">&#39;#911eb4&#39;</span>

    <span class="n">flag_cols</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">flag_cols</span><span class="p">[</span><span class="s1">&#39;final&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">30</span><span class="p">:</span> <span class="n">fblack</span><span class="p">,</span>   <span class="c1"># Nominal quality</span>
                          <span class="mi">20</span><span class="p">:</span> <span class="n">fbrown</span><span class="p">,</span>   <span class="c1"># Single-sensor, with smaller pattern</span>
                                        <span class="c1"># block</span>
                          <span class="mi">21</span><span class="p">:</span> <span class="n">forange</span><span class="p">,</span>  <span class="c1"># Single-sensor, with neighbours as</span>
                                        <span class="c1"># constraint</span>
                          <span class="mi">22</span><span class="p">:</span> <span class="n">fmaroon</span><span class="p">,</span>  <span class="c1"># Interpolated</span>
                          <span class="mi">23</span><span class="p">:</span> <span class="n">fcyan</span><span class="p">,</span>    <span class="c1"># Gap filling in wind drift</span>
                          <span class="mi">24</span><span class="p">:</span> <span class="n">fteal</span><span class="p">,</span>    <span class="c1"># Vector replaced by wind drift</span>
                          <span class="mi">25</span><span class="p">:</span> <span class="n">fnavy</span><span class="p">,</span>    <span class="c1"># Blended satellite and wind drift</span>
<span class="p">}</span>
    <span class="n">flag_cols</span><span class="p">[</span><span class="s1">&#39;proc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="n">fblack</span><span class="p">,</span>     <span class="c1"># Nominal quality</span>
                         <span class="mi">16</span><span class="p">:</span> <span class="n">fpurple</span><span class="p">,</span>   <span class="c1"># Interpolated</span>
                         <span class="mi">13</span><span class="p">:</span> <span class="n">fred</span><span class="p">,</span>      <span class="c1"># Single-sensor, with neighbours as</span>
                                        <span class="c1"># constraint</span>
                         <span class="mi">17</span><span class="p">:</span> <span class="n">fgreen</span><span class="p">,</span>    <span class="c1"># Single-sensor, with smaller</span>
                                        <span class="c1"># pattern block</span>
<span class="p">}</span>

    <span class="n">default</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span>
    <span class="k">if</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">flag_cols</span><span class="p">[</span><span class="n">flgfmt</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">flag_cols</span><span class="p">[</span><span class="n">flgfmt</span><span class="p">][</span><span class="n">flag</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">default</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scale</span> <span class="o">=</span> <span class="mf">1000.</span>
<span class="n">pc</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">plotdriftarr</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">plot_crs</span><span class="p">,</span> <span class="n">data_crs</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">sflag</span><span class="p">,</span> <span class="n">driftflags</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dx</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="n">plot_crs</span><span class="o">.</span><span class="n">transform_point</span><span class="p">(</span><span class="n">lon</span><span class="p">[</span><span class="o">~</span><span class="n">dx</span><span class="o">.</span><span class="n">mask</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">lat</span><span class="p">[</span><span class="o">~</span><span class="n">dx</span><span class="o">.</span><span class="n">mask</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">src_crs</span><span class="o">=</span><span class="n">pc</span><span class="p">)</span>
            <span class="n">adx</span> <span class="o">=</span> <span class="n">dx</span><span class="p">[</span><span class="o">~</span><span class="n">dx</span><span class="o">.</span><span class="n">mask</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="n">ady</span> <span class="o">=</span> <span class="n">dy</span><span class="p">[</span><span class="o">~</span><span class="n">dy</span><span class="o">.</span><span class="n">mask</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="n">len_arrow</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">adx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">ady</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

            <span class="c1"># Calculate the endpoints and therefore dx, dy components of the drift arrows in the plot</span>
            <span class="c1"># coordinate system</span>
            <span class="n">xorig</span><span class="p">,</span> <span class="n">yorig</span> <span class="o">=</span> <span class="n">data_crs</span><span class="o">.</span><span class="n">transform_point</span><span class="p">(</span><span class="n">lon</span><span class="p">[</span><span class="o">~</span><span class="n">dx</span><span class="o">.</span><span class="n">mask</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">lat</span><span class="p">[</span><span class="o">~</span><span class="n">dx</span><span class="o">.</span><span class="n">mask</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">src_crs</span><span class="o">=</span><span class="n">pc</span><span class="p">)</span>
            <span class="n">xarr</span> <span class="o">=</span> <span class="n">xorig</span> <span class="o">+</span> <span class="n">adx</span>
            <span class="n">yarr</span> <span class="o">=</span> <span class="n">yorig</span> <span class="o">+</span> <span class="n">ady</span>
            <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">plot_crs</span><span class="o">.</span><span class="n">transform_point</span><span class="p">(</span><span class="n">xarr</span><span class="p">,</span> <span class="n">yarr</span><span class="p">,</span> <span class="n">src_crs</span><span class="o">=</span><span class="n">data_crs</span><span class="p">)</span>
            <span class="n">pdx</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span>
            <span class="n">pdy</span> <span class="o">=</span> <span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span>
            
            <span class="c1"># Set the colour of the drift arrows if this should be</span>
            <span class="c1"># done with status flags</span>
            <span class="k">if</span> <span class="n">driftflags</span><span class="p">:</span>
                <span class="n">myflag</span> <span class="o">=</span> <span class="n">sflag</span><span class="p">[</span><span class="o">~</span><span class="n">dx</span><span class="o">.</span><span class="n">mask</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="n">ar_col</span> <span class="o">=</span> <span class="n">flag_arrow_col</span><span class="p">(</span><span class="n">myflag</span><span class="p">,</span> <span class="n">procfmt</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ar_col</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span>

            <span class="c1"># If the arrow is too small, mark a symbol instead</span>
            <span class="k">if</span> <span class="n">len_arrow</span> <span class="o">*</span> <span class="n">scale</span> <span class="o">&lt;</span> <span class="mi">2000</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">ar_col</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">head_length</span> <span class="o">=</span> <span class="mf">0.3</span> <span class="o">*</span> <span class="n">len_arrow</span> <span class="o">*</span> <span class="n">scale</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">arrow</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">pdx</span><span class="p">,</span> <span class="n">pdy</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">ar_col</span><span class="p">,</span>
                    <span class="n">shape</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">,</span> <span class="n">head_length</span><span class="o">=</span><span class="n">head_length</span><span class="p">,</span>
                    <span class="n">head_width</span><span class="o">=</span><span class="mi">15000</span><span class="p">,</span>
                    <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">length_includes_head</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">width</span><span class="o">=</span><span class="mi">4000</span><span class="p">)</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c1"># Outside the range of points</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plotting the ice drift with arrows</span>
<span class="c1"># Modified from the SeaSurfaceTemperature_ATBD_v2, by Emy Alerskans</span>

<span class="c1"># Drift data</span>
<span class="n">xydata</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dx&#39;</span><span class="p">:</span> <span class="n">driftx</span><span class="p">,</span> <span class="s1">&#39;dy&#39;</span><span class="p">:</span> <span class="n">drifty</span><span class="p">}</span>
<span class="n">limminxy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">xydata</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
<span class="n">limminxy</span> <span class="o">=</span> <span class="n">limminxy</span> <span class="o">-</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">limminxy</span><span class="p">)</span>
<span class="n">limmaxxy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">xydata</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
<span class="n">limmaxxy</span> <span class="o">=</span> <span class="n">limmaxxy</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">limmaxxy</span><span class="p">)</span>
<span class="n">limminflag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
<span class="n">limmaxflag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>

<span class="c1"># Output lat/lons</span>
<span class="n">og</span> <span class="o">=</span> <span class="n">gridout</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hemi</span><span class="p">)</span>
<span class="n">out_area_def</span> <span class="o">=</span> <span class="n">parse_area_file</span><span class="p">(</span><span class="n">griddeffile</span><span class="p">,</span> <span class="n">og</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">olons</span><span class="p">,</span> <span class="n">olats</span> <span class="o">=</span> <span class="n">out_area_def</span><span class="o">.</span><span class="n">get_lonlats</span><span class="p">()</span>

<span class="c1"># Coordinate reference systems</span>
<span class="n">plot_crs</span> <span class="o">=</span> <span class="n">crs_create</span><span class="p">(</span><span class="n">gridtype</span><span class="p">,</span> <span class="n">hemi</span><span class="p">)</span>
<span class="n">pc</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()</span>
<span class="k">if</span> <span class="s1">&#39;ease&#39;</span> <span class="ow">in</span> <span class="n">gridout</span><span class="p">:</span>
    <span class="n">data_crs</span> <span class="o">=</span> <span class="n">crs_create</span><span class="p">(</span><span class="s1">&#39;ease&#39;</span><span class="p">,</span> <span class="n">hemi</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">data_crs</span> <span class="o">=</span> <span class="n">crs_create</span><span class="p">(</span><span class="s1">&#39;polstere&#39;</span><span class="p">,</span> <span class="n">hemi</span><span class="p">)</span>

<span class="c1"># Plotting drift</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">plot_crs</span><span class="p">)</span>

<span class="n">plotdriftarr</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">plot_crs</span><span class="p">,</span> <span class="n">data_crs</span><span class="p">,</span> <span class="n">olons</span><span class="p">[</span><span class="n">slo</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">slo</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">slo</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">slo</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span> <span class="n">olats</span><span class="p">[</span><span class="n">slo</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">slo</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">slo</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">slo</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span> 
             <span class="n">driftx</span><span class="p">[</span><span class="n">slo</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">slo</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">slo</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">slo</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span> <span class="n">drifty</span><span class="p">[</span><span class="n">slo</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">slo</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">slo</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">slo</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span>
             <span class="n">flag</span><span class="p">[</span><span class="n">slo</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">slo</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">slo</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">slo</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span> <span class="n">driftflags</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_extent</span><span class="p">([</span><span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">,</span> <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span><span class="p">])</span>
<span class="n">gl</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">gridlines</span><span class="p">(</span><span class="n">crs</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">draw_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
<span class="n">gl</span><span class="o">.</span><span class="n">top_labels</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">gl</span><span class="o">.</span><span class="n">right_labels</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">gl</span><span class="o">.</span><span class="n">xlocator</span> <span class="o">=</span> <span class="n">mticker</span><span class="o">.</span><span class="n">FixedLocator</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="n">lon_step</span><span class="p">))</span>
<span class="n">gl</span><span class="o">.</span><span class="n">ylocator</span> <span class="o">=</span> <span class="n">mticker</span><span class="o">.</span><span class="n">FixedLocator</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="n">lat_step</span><span class="p">))</span>
<span class="n">gl</span><span class="o">.</span><span class="n">xlabel_style</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">}</span>
<span class="n">gl</span><span class="o">.</span><span class="n">ylabel_style</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">}</span>    

<span class="k">if</span> <span class="n">plotfigs</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">figpath</span><span class="p">,</span> <span class="s1">&#39;drift_rad</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">rad</span><span class="p">))))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Status flags</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">plot_crs</span><span class="p">)</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">olons</span><span class="p">[</span><span class="n">slo</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">slo</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">slo</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">slo</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span> <span class="n">olats</span><span class="p">[</span><span class="n">slo</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">slo</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">slo</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">slo</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span> 
                    <span class="n">flag</span><span class="p">[:][</span><span class="n">slo</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">slo</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">slo</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">slo</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span> <span class="n">transform</span><span class="o">=</span><span class="n">pc</span><span class="p">,</span>
                    <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">limminflag</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">limmaxflag</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_extent</span><span class="p">([</span><span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">,</span> <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span><span class="p">])</span>
<span class="n">gl</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">gridlines</span><span class="p">(</span><span class="n">crs</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">draw_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
<span class="n">gl</span><span class="o">.</span><span class="n">top_labels</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">gl</span><span class="o">.</span><span class="n">right_labels</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">gl</span><span class="o">.</span><span class="n">xlocator</span> <span class="o">=</span> <span class="n">mticker</span><span class="o">.</span><span class="n">FixedLocator</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="n">lon_step</span><span class="p">))</span>
<span class="n">gl</span><span class="o">.</span><span class="n">ylocator</span> <span class="o">=</span> <span class="n">mticker</span><span class="o">.</span><span class="n">FixedLocator</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="n">lat_step</span><span class="p">))</span>
<span class="n">gl</span><span class="o">.</span><span class="n">xlabel_style</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">}</span>
<span class="n">gl</span><span class="o">.</span><span class="n">ylabel_style</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">}</span>
        
<span class="c1"># Colourbar</span>
<span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;3%&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="s2">&quot;2%&quot;</span><span class="p">,</span> <span class="n">axes_class</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">)</span>
<span class="n">cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span>
<span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Flag&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mf">20.0</span><span class="p">)</span>
<span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">limminflag</span><span class="p">,</span> <span class="n">limmaxflag</span><span class="p">)</span>
        
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\</span>
<span class="s2">FLAG VALUES </span><span class="se">\n\</span>
<span class="s2">Unprocessed pixel                              -1</span><span class="se">\n\</span>
<span class="s2">Nominal                                        0</span><span class="se">\n\</span>
<span class="s2">Outside image border                           1</span><span class="se">\n\</span>
<span class="s2">Close to image border                          2</span><span class="se">\n\</span>
<span class="s2">Pixel center over land                         3</span><span class="se">\n\</span>
<span class="s2">No ice                                         4</span><span class="se">\n\</span>
<span class="s2">Close to coast or edge                         5</span><span class="se">\n\</span>
<span class="s2">Close to missing pixel                         6</span><span class="se">\n\</span>
<span class="s2">Close to unprocessed pixel                     7</span><span class="se">\n\</span>
<span class="s2">Icedrift optimisation failed                   8</span><span class="se">\n\</span>
<span class="s2">Icedrift failed                                9</span><span class="se">\n\</span>
<span class="s2">Icedrift with low correlation                  10</span><span class="se">\n\</span>
<span class="s2">Icedrift calculation took too long             11</span><span class="se">\n\</span>
<span class="s2">Icedrift calculation refused by neighbours     12</span><span class="se">\n\</span>
<span class="s2">Icedrift calculation corrected by neighbours   13</span><span class="se">\n\</span>
<span class="s2">Icedrift no average                            14</span><span class="se">\n\</span>
<span class="s2">Icedrift masked due to summer season           15</span><span class="se">\n\</span>
<span class="s2">Icedrift multi-oi interpolation                16</span><span class="se">\n\</span>
<span class="s2">Icedrift calcuated with smaller pattern        17</span><span class="se">\n\</span>
<span class="s2">Icedrift masked due to NWP                     18</span><span class="se">\n\</span>
<span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/ace377039b856cfc7fdcf6229d49d354c79ca57f19a974f36bada17f8b691bb9.png" src="_images/ace377039b856cfc7fdcf6229d49d354c79ca57f19a974f36bada17f8b691bb9.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>FLAG VALUES 
Unprocessed pixel                              -1
Nominal                                        0
Outside image border                           1
Close to image border                          2
Pixel center over land                         3
No ice                                         4
Close to coast or edge                         5
Close to missing pixel                         6
Close to unprocessed pixel                     7
Icedrift optimisation failed                   8
Icedrift failed                                9
Icedrift with low correlation                  10
Icedrift calculation took too long             11
Icedrift calculation refused by neighbours     12
Icedrift calculation corrected by neighbours   13
Icedrift no average                            14
Icedrift masked due to summer season           15
Icedrift multi-oi interpolation                16
Icedrift calcuated with smaller pattern        17
Icedrift masked due to NWP                     18
</pre></div>
</div>
<img alt="_images/3e43a065d239042e7b0a5797505372f43db083d0ead6b35ce47e96c54b5eead7.png" src="_images/3e43a065d239042e7b0a5797505372f43db083d0ead6b35ce47e96c54b5eead7.png" />
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="CIMR_L2_Sea_Ice_Drift_preproc.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Preprocessing</p>
      </div>
    </a>
    <a class="right-next"
       href="CIMR_L2_Sea_Ice_Drift_performanceAssessment.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Performance Assessment</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Algorithm</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#level-2-sea-ice-drift-sid-algorithm-for-cimr">Level-2 Sea Ice Drift (SID) algorithm for CIMR</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#settings">Settings</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#parametrize-the-run">Parametrize the run</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-cross-correlation-algorithm-to-find-ice-drift">Step 1: Cross-correlation algorithm to find ice drift</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2-format-l2-file-and-write-to-disk">Step 2: Format L2 file and write to disk</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-3-plotting">Step 3: Plotting</a></li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Thomas Lavergne and Emily Down, Norwegian Meteorological Institute
</p>

  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  <p>
This ATBD was developed in the context of the ESA-funded CIMR DEVALGO study (2022-2024) (contract 4000137493).
<br>
ESA is not responsible in any way for the content of this document.
</p>

</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>